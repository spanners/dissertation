


(function(){
var root=this;var previousUnderscore=root._;var breaker={};var ArrayProto=Array.prototype,ObjProto=Object.prototype,FuncProto=Function.prototype;var push=ArrayProto.push,slice=ArrayProto.slice,concat=ArrayProto.concat,toString=ObjProto.toString,hasOwnProperty=ObjProto.hasOwnProperty;
var
nativeForEach=ArrayProto.forEach,nativeMap=ArrayProto.map,nativeReduce=ArrayProto.reduce,nativeReduceRight=ArrayProto.reduceRight,nativeFilter=ArrayProto.filter,nativeEvery=ArrayProto.every,nativeSome=ArrayProto.some,nativeIndexOf=ArrayProto.indexOf,nativeLastIndexOf=ArrayProto.lastIndexOf,nativeIsArray=Array.isArray,nativeKeys=Object.keys,nativeBind=FuncProto.bind;var _=function(obj){if(obj instanceof _)return obj;if(!(this instanceof _))return new _(obj);this._wrapped=obj;};

if(typeof exports!=='undefined'){if(typeof module!=='undefined'&&module.exports){exports=module.exports=_;}
exports._=_;}else{root._=_;}
_.VERSION='1.4.4';
var each=_.each=_.forEach=function(obj,iterator,context){if(obj==null)return;if(nativeForEach&&obj.forEach===nativeForEach){obj.forEach(iterator,context);}else if(obj.length===+obj.length){for(var i=0,l=obj.length;i<l;i++){if(iterator.call(context,obj[i],i,obj)===breaker)return;}}else{for(var key in obj){if(_.has(obj,key)){if(iterator.call(context,obj[key],key,obj)===breaker)return;}}}};_.map=_.collect=function(obj,iterator,context){var results=[];if(obj==null)return results;if(nativeMap&&obj.map===nativeMap)return obj.map(iterator,context);each(obj,function(value,index,list){results[results.length]=iterator.call(context,value,index,list);});return results;};var reduceError='Reduce of empty array with no initial value';_.reduce=_.foldl=_.inject=function(obj,iterator,memo,context){var initial=arguments.length>2;if(obj==null)obj=[];if(nativeReduce&&obj.reduce===nativeReduce){if(context)iterator=_.bind(iterator,context);return initial?obj.reduce(iterator,memo):obj.reduce(iterator);}
each(obj,function(value,index,list){if(!initial){memo=value;initial=true;}else{memo=iterator.call(context,memo,value,index,list);}});if(!initial)throw new TypeError(reduceError);return memo;};_.reduceRight=_.foldr=function(obj,iterator,memo,context){var initial=arguments.length>2;if(obj==null)obj=[];if(nativeReduceRight&&obj.reduceRight===nativeReduceRight){if(context)iterator=_.bind(iterator,context);return initial?obj.reduceRight(iterator,memo):obj.reduceRight(iterator);}
var length=obj.length;if(length!==+length){var keys=_.keys(obj);length=keys.length;}
each(obj,function(value,index,list){index=keys?keys[--length]:--length;if(!initial){memo=obj[index];initial=true;}else{memo=iterator.call(context,memo,obj[index],index,list);}});if(!initial)throw new TypeError(reduceError);return memo;};_.find=_.detect=function(obj,iterator,context){var result;any(obj,function(value,index,list){if(iterator.call(context,value,index,list)){result=value;return true;}});return result;};_.filter=_.select=function(obj,iterator,context){var results=[];if(obj==null)return results;if(nativeFilter&&obj.filter===nativeFilter)return obj.filter(iterator,context);each(obj,function(value,index,list){if(iterator.call(context,value,index,list))results[results.length]=value;});return results;};_.reject=function(obj,iterator,context){return _.filter(obj,function(value,index,list){return!iterator.call(context,value,index,list);},context);};_.every=_.all=function(obj,iterator,context){iterator||(iterator=_.identity);var result=true;if(obj==null)return result;if(nativeEvery&&obj.every===nativeEvery)return obj.every(iterator,context);each(obj,function(value,index,list){if(!(result=result&&iterator.call(context,value,index,list)))return breaker;});return!!result;};var any=_.some=_.any=function(obj,iterator,context){iterator||(iterator=_.identity);var result=false;if(obj==null)return result;if(nativeSome&&obj.some===nativeSome)return obj.some(iterator,context);each(obj,function(value,index,list){if(result||(result=iterator.call(context,value,index,list)))return breaker;});return!!result;};_.contains=_.include=function(obj,target){if(obj==null)return false;if(nativeIndexOf&&obj.indexOf===nativeIndexOf)return obj.indexOf(target)!=-1;return any(obj,function(value){return value===target;});};_.invoke=function(obj,method){var args=slice.call(arguments,2);var isFunc=_.isFunction(method);return _.map(obj,function(value){return(isFunc?method:value[method]).apply(value,args);});};_.pluck=function(obj,key){return _.map(obj,function(value){return value[key];});};
_.where=function(obj,attrs,first){if(_.isEmpty(attrs))return first?null:[];return _[first?'find':'filter'](obj,function(value){for(var key in attrs){if(attrs[key]!==value[key])return false;}
return true;});};
_.findWhere=function(obj,attrs){return _.where(obj,attrs,true);}; _.max=function(obj,iterator,context){if(!iterator&&_.isArray(obj)&&obj[0]===+obj[0]&&obj.length<65535){return Math.max.apply(Math,obj);}
if(!iterator&&_.isEmpty(obj))return-Infinity;var result={computed:-Infinity,value:-Infinity};each(obj,function(value,index,list){var computed=iterator?iterator.call(context,value,index,list):value;computed>=result.computed&&(result={value:value,computed:computed});});return result.value;};_.min=function(obj,iterator,context){if(!iterator&&_.isArray(obj)&&obj[0]===+obj[0]&&obj.length<65535){return Math.min.apply(Math,obj);}
if(!iterator&&_.isEmpty(obj))return Infinity;var result={computed:Infinity,value:Infinity};each(obj,function(value,index,list){var computed=iterator?iterator.call(context,value,index,list):value;computed<result.computed&&(result={value:value,computed:computed});});return result.value;};_.shuffle=function(obj){var rand;var index=0;var shuffled=[];each(obj,function(value){rand=_.random(index++);shuffled[index-1]=shuffled[rand];shuffled[rand]=value;});return shuffled;};var lookupIterator=function(value){return _.isFunction(value)?value:function(obj){return obj[value];};};_.sortBy=function(obj,value,context){var iterator=lookupIterator(value);return _.pluck(_.map(obj,function(value,index,list){return{value:value,index:index,criteria:iterator.call(context,value,index,list)};}).sort(function(left,right){var a=left.criteria;var b=right.criteria;if(a!==b){if(a>b||a===void 0)return 1;if(a<b||b===void 0)return-1;}
return left.index<right.index?-1:1;}),'value');};var group=function(obj,value,context,behavior){var result={};var iterator=lookupIterator(value||_.identity);each(obj,function(value,index){var key=iterator.call(context,value,index,obj);behavior(result,key,value);});return result;};
_.groupBy=function(obj,value,context){return group(obj,value,context,function(result,key,value){(_.has(result,key)?result[key]:(result[key]=[])).push(value);});};

_.countBy=function(obj,value,context){return group(obj,value,context,function(result,key){if(!_.has(result,key))result[key]=0;result[key]++;});};
_.sortedIndex=function(array,obj,iterator,context){iterator=iterator==null?_.identity:lookupIterator(iterator);var value=iterator.call(context,obj);var low=0,high=array.length;while(low<high){var mid=(low+high)>>>1;iterator.call(context,array[mid])<value?low=mid+1:high=mid;}
return low;};_.toArray=function(obj){if(!obj)return[];if(_.isArray(obj))return slice.call(obj);if(obj.length===+obj.length)return _.map(obj,_.identity);return _.values(obj);};_.size=function(obj){if(obj==null)return 0;return(obj.length===+obj.length)?obj.length:_.keys(obj).length;};


_.first=_.head=_.take=function(array,n,guard){if(array==null)return void 0;return(n!=null)&&!guard?slice.call(array,0,n):array[0];};


_.initial=function(array,n,guard){return slice.call(array,0,array.length-((n==null)||guard?1:n));};
_.last=function(array,n,guard){if(array==null)return void 0;if((n!=null)&&!guard){return slice.call(array,Math.max(array.length-n,0));}else{return array[array.length-1];}};
_.rest=_.tail=_.drop=function(array,n,guard){return slice.call(array,(n==null)||guard?1:n);};_.compact=function(array){return _.filter(array,_.identity);};var flatten=function(input,shallow,output){each(input,function(value){if(_.isArray(value)){shallow?push.apply(output,value):flatten(value,shallow,output);}else{output.push(value);}});return output;};_.flatten=function(array,shallow){return flatten(array,shallow,[]);};_.without=function(array){return _.difference(array,slice.call(arguments,1));};
_.uniq=_.unique=function(array,isSorted,iterator,context){if(_.isFunction(isSorted)){context=iterator;iterator=isSorted;isSorted=false;}
var initial=iterator?_.map(array,iterator,context):array;var results=[];var seen=[];each(initial,function(value,index){if(isSorted?(!index||seen[seen.length-1]!==value):!_.contains(seen,value)){seen.push(value);results.push(array[index]);}});return results;};
_.union=function(){return _.uniq(concat.apply(ArrayProto,arguments));};
_.intersection=function(array){var rest=slice.call(arguments,1);return _.filter(_.uniq(array),function(item){return _.every(rest,function(other){return _.indexOf(other,item)>=0;});});};_.difference=function(array){var rest=concat.apply(ArrayProto,slice.call(arguments,1));return _.filter(array,function(value){return!_.contains(rest,value);});};
_.zip=function(){var args=slice.call(arguments);var length=_.max(_.pluck(args,'length'));var results=new Array(length);for(var i=0;i<length;i++){results[i]=_.pluck(args,""+i);}
return results;};
_.object=function(list,values){if(list==null)return{};var result={};for(var i=0,l=list.length;i<l;i++){if(values){result[list[i]]=values[i];}else{result[list[i][0]]=list[i][1];}}
return result;};
_.indexOf=function(array,item,isSorted){if(array==null)return-1;var i=0,l=array.length;if(isSorted){if(typeof isSorted=='number'){i=(isSorted<0?Math.max(0,l+isSorted):isSorted);}else{i=_.sortedIndex(array,item);return array[i]===item?i:-1;}}
if(nativeIndexOf&&array.indexOf===nativeIndexOf)return array.indexOf(item,isSorted);for(;i<l;i++)if(array[i]===item)return i;return-1;};_.lastIndexOf=function(array,item,from){if(array==null)return-1;var hasIndex=from!=null;if(nativeLastIndexOf&&array.lastIndexOf===nativeLastIndexOf){return hasIndex?array.lastIndexOf(item,from):array.lastIndexOf(item);}
var i=(hasIndex?from:array.length);while(i--)if(array[i]===item)return i;return-1;};

_.range=function(start,stop,step){if(arguments.length<=1){stop=start||0;start=0;}
step=arguments[2]||1;var len=Math.max(Math.ceil((stop-start)/step),0);var idx=0;var range=new Array(len);while(idx<len){range[idx++]=start;start+=step;}
return range;};

_.bind=function(func,context){if(func.bind===nativeBind&&nativeBind)return nativeBind.apply(func,slice.call(arguments,1));var args=slice.call(arguments,2);return function(){return func.apply(context,args.concat(slice.call(arguments)));};};
_.partial=function(func){var args=slice.call(arguments,1);return function(){return func.apply(this,args.concat(slice.call(arguments)));};};
_.bindAll=function(obj){var funcs=slice.call(arguments,1);if(funcs.length===0)funcs=_.functions(obj);each(funcs,function(f){obj[f]=_.bind(obj[f],obj);});return obj;};_.memoize=function(func,hasher){var memo={};hasher||(hasher=_.identity);return function(){var key=hasher.apply(this,arguments);return _.has(memo,key)?memo[key]:(memo[key]=func.apply(this,arguments));};};
_.delay=function(func,wait){var args=slice.call(arguments,2);return setTimeout(function(){return func.apply(null,args);},wait);};
_.defer=function(func){return _.delay.apply(_,[func,1].concat(slice.call(arguments,1)));};
_.throttle=function(func,wait){var context,args,timeout,result;var previous=0;var later=function(){previous=new Date;timeout=null;result=func.apply(context,args);};return function(){var now=new Date;var remaining=wait-(now-previous);context=this;args=arguments;if(remaining<=0){clearTimeout(timeout);timeout=null;previous=now;result=func.apply(context,args);}else if(!timeout){timeout=setTimeout(later,remaining);}
return result;};};


_.debounce=function(func,wait,immediate){var timeout,result;return function(){var context=this,args=arguments;var later=function(){timeout=null;if(!immediate)result=func.apply(context,args);};var callNow=immediate&&!timeout;clearTimeout(timeout);timeout=setTimeout(later,wait);if(callNow)result=func.apply(context,args);return result;};};
_.once=function(func){var ran=false,memo;return function(){if(ran)return memo;ran=true;memo=func.apply(this,arguments);func=null;return memo;};};
_.wrap=function(func,wrapper){return function(){var args=[func];push.apply(args,arguments);return wrapper.apply(this,args);};};
_.compose=function(){var funcs=arguments;return function(){var args=arguments;for(var i=funcs.length-1;i>=0;i--){args=[funcs[i].apply(this,args)];}
return args[0];};};_.after=function(times,func){if(times<=0)return func();return function(){if(--times<1){return func.apply(this,arguments);}};};
_.keys=nativeKeys||function(obj){if(obj!==Object(obj))throw new TypeError('Invalid object');var keys=[];for(var key in obj)if(_.has(obj,key))keys[keys.length]=key;return keys;};_.values=function(obj){var values=[];for(var key in obj)if(_.has(obj,key))values.push(obj[key]);return values;};_.pairs=function(obj){var pairs=[];for(var key in obj)if(_.has(obj,key))pairs.push([key,obj[key]]);return pairs;};_.invert=function(obj){var result={};for(var key in obj)if(_.has(obj,key))result[obj[key]]=key;return result;};_.functions=_.methods=function(obj){var names=[];for(var key in obj){if(_.isFunction(obj[key]))names.push(key);}
return names.sort();};_.extend=function(obj){each(slice.call(arguments,1),function(source){if(source){for(var prop in source){obj[prop]=source[prop];}}});return obj;};_.pick=function(obj){var copy={};var keys=concat.apply(ArrayProto,slice.call(arguments,1));each(keys,function(key){if(key in obj)copy[key]=obj[key];});return copy;};_.omit=function(obj){var copy={};var keys=concat.apply(ArrayProto,slice.call(arguments,1));for(var key in obj){if(!_.contains(keys,key))copy[key]=obj[key];}
return copy;};_.defaults=function(obj){each(slice.call(arguments,1),function(source){if(source){for(var prop in source){if(obj[prop]==null)obj[prop]=source[prop];}}});return obj;};_.clone=function(obj){if(!_.isObject(obj))return obj;return _.isArray(obj)?obj.slice():_.extend({},obj);};
_.tap=function(obj,interceptor){interceptor(obj);return obj;};var eq=function(a,b,aStack,bStack){if(a===b)return a!==0||1/a==1/b;if(a==null||b==null)return a===b;if(a instanceof _)a=a._wrapped;if(b instanceof _)b=b._wrapped;var className=toString.call(a);if(className!=toString.call(b))return false;switch(className){case'[object String]':
return a==String(b);case'[object Number]':
return a!=+a?b!=+b:(a==0?1/a==1/b:a==+b);case'[object Date]':case'[object Boolean]':

return+a==+b;case'[object RegExp]':return a.source==b.source&&a.global==b.global&&a.multiline==b.multiline&&a.ignoreCase==b.ignoreCase;}
if(typeof a!='object'||typeof b!='object')return false;
var length=aStack.length;while(length--){
if(aStack[length]==a)return bStack[length]==b;}
aStack.push(a);bStack.push(b);var size=0,result=true;if(className=='[object Array]'){size=a.length;result=size==b.length;if(result){while(size--){if(!(result=eq(a[size],b[size],aStack,bStack)))break;}}}else{
var aCtor=a.constructor,bCtor=b.constructor;if(aCtor!==bCtor&&!(_.isFunction(aCtor)&&(aCtor instanceof aCtor)&&_.isFunction(bCtor)&&(bCtor instanceof bCtor))){return false;}
for(var key in a){if(_.has(a,key)){size++;if(!(result=_.has(b,key)&&eq(a[key],b[key],aStack,bStack)))break;}}
if(result){for(key in b){if(_.has(b,key)&&!(size--))break;}
result=!size;}}
aStack.pop();bStack.pop();return result;};_.isEqual=function(a,b){return eq(a,b,[],[]);};_.isEmpty=function(obj){if(obj==null)return true;if(_.isArray(obj)||_.isString(obj))return obj.length===0;for(var key in obj)if(_.has(obj,key))return false;return true;};_.isElement=function(obj){return!!(obj&&obj.nodeType===1);}; _.isArray=nativeIsArray||function(obj){return toString.call(obj)=='[object Array]';};_.isObject=function(obj){return obj===Object(obj);};each(['Arguments','Function','String','Number','Date','RegExp'],function(name){_['is'+name]=function(obj){return toString.call(obj)=='[object '+name+']';};});
if(!_.isArguments(arguments)){_.isArguments=function(obj){return!!(obj&&_.has(obj,'callee'));};}
if(typeof(/./)!=='function'){_.isFunction=function(obj){return typeof obj==='function';};}
_.isFinite=function(obj){return isFinite(obj)&&!isNaN(parseFloat(obj));};_.isNaN=function(obj){return _.isNumber(obj)&&obj!=+obj;};_.isBoolean=function(obj){return obj===true||obj===false||toString.call(obj)=='[object Boolean]';};_.isNull=function(obj){return obj===null;};_.isUndefined=function(obj){return obj===void 0;};
_.has=function(obj,key){return hasOwnProperty.call(obj,key);};

_.noConflict=function(){root._=previousUnderscore;return this;};_.identity=function(value){return value;};_.times=function(n,iterator,context){var accum=Array(n);for(var i=0;i<n;i++)accum[i]=iterator.call(context,i);return accum;};_.random=function(min,max){if(max==null){max=min;min=0;}
return min+Math.floor(Math.random()*(max-min+1));};var entityMap={escape:{'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#x27;','/':'&#x2F;'}};entityMap.unescape=_.invert(entityMap.escape);var entityRegexes={escape:new RegExp('['+_.keys(entityMap.escape).join('')+']','g'),unescape:new RegExp('('+_.keys(entityMap.unescape).join('|')+')','g')};_.each(['escape','unescape'],function(method){_[method]=function(string){if(string==null)return'';return(''+string).replace(entityRegexes[method],function(match){return entityMap[method][match];});};});_.result=function(object,property){if(object==null)return null;var value=object[property];return _.isFunction(value)?value.call(object):value;};_.mixin=function(obj){each(_.functions(obj),function(name){var func=_[name]=obj[name];_.prototype[name]=function(){var args=[this._wrapped];push.apply(args,arguments);return result.call(this,func.apply(_,args));};});};var idCounter=0;_.uniqueId=function(prefix){var id=++idCounter+'';return prefix?prefix+id:id;};
_.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};

var noMatch=/(.)^/;
var escapes={"'":"'",'\\':'\\','\r':'r','\n':'n','\t':'t','\u2028':'u2028','\u2029':'u2029'};var escaper=/\\|'|\r|\n|\t|\u2028|\u2029/g;_.template=function(text,data,settings){var render;settings=_.defaults({},settings,_.templateSettings);var matcher=new RegExp([(settings.escape||noMatch).source,(settings.interpolate||noMatch).source,(settings.evaluate||noMatch).source].join('|')+'|$','g');var index=0;var source="__p+='";text.replace(matcher,function(match,escape,interpolate,evaluate,offset){source+=text.slice(index,offset).replace(escaper,function(match){return'\\'+escapes[match];});if(escape){source+="'+\n((__t=("+escape+"))==null?'':_.escape(__t))+\n'";}
if(interpolate){source+="'+\n((__t=("+interpolate+"))==null?'':__t)+\n'";}
if(evaluate){source+="';\n"+evaluate+"\n__p+='";}
index=offset+match.length;return match;});source+="';\n";if(!settings.variable)source='with(obj||{}){\n'+source+'}\n';source="var __t,__p='',__j=Array.prototype.join,"+"print=function(){__p+=__j.call(arguments,'');};\n"+
source+"return __p;\n";try{render=new Function(settings.variable||'obj','_',source);}catch(e){e.source=source;throw e;}
if(data)return render(data,_);var template=function(data){return render.call(this,data,_);};template.source='function('+(settings.variable||'obj')+'){\n'+source+'}';return template;};_.chain=function(obj){return _(obj).chain();};


var result=function(obj){return this._chain?_(obj).chain():obj;};_.mixin(_);each(['pop','push','reverse','shift','sort','splice','unshift'],function(name){var method=ArrayProto[name];_.prototype[name]=function(){var obj=this._wrapped;method.apply(obj,arguments);if((name=='shift'||name=='splice')&&obj.length===0)delete obj[0];return result.call(this,obj);};});each(['concat','join','slice'],function(name){var method=ArrayProto[name];_.prototype[name]=function(){return result.call(this,method.apply(this._wrapped,arguments));};});_.extend(_.prototype,{chain:function(){this._chain=true;return this;},value:function(){return this._wrapped;}});}).call(this);


(function(_,undefined)
{var
plurals=[],singulars=[],uncountables=[];var inflector={gsub:function(word,rule,replacement)
{var pattern=new RegExp(rule.source||rule,'gi');return pattern.test(word)?word.replace(pattern,replacement):null;},plural:function(rule,replacement)
{plurals.unshift([rule,replacement]);},pluralize:function(word,count,includeNumber)
{var result;if(count!==undefined)
{count=Math.round(count);result=(count===1)?this.singularize(word):this.pluralize(word);result=(includeNumber)?[count,result].join(' '):result;}
else
{if(_(uncountables).include(word))
{return word;}
result=word;_(plurals).detect(function(rule)
{var gsub=this.gsub(word,rule[0],rule[1]);return gsub?(result=gsub):false;},this);}
return result;},singular:function(rule,replacement)
{singulars.unshift([rule,replacement]);},singularize:function(word)
{if(_(uncountables).include(word))
{return word;}
var result=word;_(singulars).detect(function(rule)
{var gsub=this.gsub(word,rule[0],rule[1]);return gsub?(result=gsub):false;},this);return result;},irregular:function(singular,plural)
{this.plural('\\b'+singular+'\\b',plural);this.singular('\\b'+plural+'\\b',singular);},uncountable:function(word)
{uncountables.unshift(word);},resetInflections:function()
{plurals=[];singulars=[];uncountables=[];this.plural(/$/,'s');this.plural(/s$/,'s');this.plural(/(ax|test)is$/,'$1es');this.plural(/(octop|vir)us$/,'$1i');this.plural(/(octop|vir)i$/,'$1i');this.plural(/(alias|status)$/,'$1es');this.plural(/(bu)s$/,'$1ses');this.plural(/(buffal|tomat)o$/,'$1oes');this.plural(/([ti])um$/,'$1a');this.plural(/([ti])a$/,'$1a');this.plural(/sis$/,'ses');this.plural(/(?:([^f])fe|([lr])f)$/,'$1$2ves');this.plural(/(hive)$/,'$1s');this.plural(/([^aeiouy]|qu)y$/,'$1ies');this.plural(/(x|ch|ss|sh)$/,'$1es');this.plural(/(matr|vert|ind)(?:ix|ex)$/,'$1ices');this.plural(/([m|l])ouse$/,'$1ice');this.plural(/([m|l])ice$/,'$1ice');this.plural(/^(ox)$/,'$1en');this.plural(/^(oxen)$/,'$1');this.plural(/(quiz)$/,'$1zes');this.singular(/s$/,'');this.singular(/(n)ews$/,'$1ews');this.singular(/([ti])a$/,'$1um');this.singular(/((a)naly|(b)a|(d)iagno|(p)arenthe|(p)rogno|(s)ynop|(t)he)ses$/,'$1$2sis');this.singular(/(^analy)ses$/,'$1sis');this.singular(/([^f])ves$/,'$1fe');this.singular(/(hive)s$/,'$1');this.singular(/(tive)s$/,'$1');this.singular(/([lr])ves$/,'$1f');this.singular(/([^aeiouy]|qu)ies$/,'$1y');this.singular(/(s)eries$/,'$1eries');this.singular(/(m)ovies$/,'$1ovie');this.singular(/(x|ch|ss|sh)es$/,'$1');this.singular(/([m|l])ice$/,'$1ouse');this.singular(/(bus)es$/,'$1');this.singular(/(o)es$/,'$1');this.singular(/(shoe)s$/,'$1');this.singular(/(cris|ax|test)es$/,'$1is');this.singular(/(octop|vir)i$/,'$1us');this.singular(/(alias|status)es$/,'$1');this.singular(/^(ox)en/,'$1');this.singular(/(vert|ind)ices$/,'$1ex');this.singular(/(matr)ices$/,'$1ix');this.singular(/(quiz)zes$/,'$1');this.singular(/(database)s$/,'$1');this.irregular('person','people');this.irregular('man','men');this.irregular('child','children');this.irregular('sex','sexes');this.irregular('move','moves');this.irregular('cow','kine');_('equipment information rice money species series fish sheep jeans'.split(/\s+/)).each(function(word)
{this.uncountable(word);},this);return this;}};_.mixin(inflector.resetInflections());})(_);
(function(){_.sum=function(array){return _.reduce(array,function(memo,num){return memo+num;},0);};})();

!function(root,String){'use strict';var nativeTrim=String.prototype.trim;var nativeTrimRight=String.prototype.trimRight;var nativeTrimLeft=String.prototype.trimLeft;var parseNumber=function(source){return source*1||0;};var strRepeat=function(str,qty){if(qty<1)return'';var result='';while(qty>0){if(qty&1)result+=str;qty>>=1,str+=str;}
return result;};var slice=[].slice;var defaultToWhiteSpace=function(characters){if(characters==null)
return'\\s';else if(characters.source)
return characters.source;else
return'['+_s.escapeRegExp(characters)+']';}; function boolMatch(s,matchers){var i,matcher,down=s.toLowerCase();matchers=[].concat(matchers);for(i=0;i<matchers.length;i+=1){matcher=matchers[i];if(!matcher)continue;if(matcher.test&&matcher.test(s))return true;if(matcher.toLowerCase()===down)return true;}}
var escapeChars={lt:'<',gt:'>',quot:'"',amp:'&',apos:"'"};var reversedEscapeChars={};for(var key in escapeChars)reversedEscapeChars[escapeChars[key]]=key;reversedEscapeChars["'"]='#39';

var sprintf=(function(){function get_type(variable){return Object.prototype.toString.call(variable).slice(8,-1).toLowerCase();}
var str_repeat=strRepeat;var str_format=function(){if(!str_format.cache.hasOwnProperty(arguments[0])){str_format.cache[arguments[0]]=str_format.parse(arguments[0]);}
return str_format.format.call(null,str_format.cache[arguments[0]],arguments);};str_format.format=function(parse_tree,argv){var cursor=1,tree_length=parse_tree.length,node_type='',arg,output=[],i,k,match,pad,pad_character,pad_length;for(i=0;i<tree_length;i++){node_type=get_type(parse_tree[i]);if(node_type==='string'){output.push(parse_tree[i]);}
else if(node_type==='array'){match=parse_tree[i]; if(match[2]){ arg=argv[cursor];for(k=0;k<match[2].length;k++){if(!arg.hasOwnProperty(match[2][k])){throw new Error(sprintf('[_.sprintf] property "%s" does not exist',match[2][k]));}
arg=arg[match[2][k]];}}else if(match[1]){arg=argv[match[1]];}
else{arg=argv[cursor++];}
if(/[^s]/.test(match[8])&&(get_type(arg)!='number')){throw new Error(sprintf('[_.sprintf] expecting number but found %s',get_type(arg)));}
switch(match[8]){case'b':arg=arg.toString(2);break;case'c':arg=String.fromCharCode(arg);break;case'd':arg=parseInt(arg,10);break;case'e':arg=match[7]?arg.toExponential(match[7]):arg.toExponential();break;case'f':arg=match[7]?parseFloat(arg).toFixed(match[7]):parseFloat(arg);break;case'o':arg=arg.toString(8);break;case's':arg=((arg=String(arg))&&match[7]?arg.substring(0,match[7]):arg);break;case'u':arg=Math.abs(arg);break;case'x':arg=arg.toString(16);break;case'X':arg=arg.toString(16).toUpperCase();break;}
arg=(/[def]/.test(match[8])&&match[3]&&arg>=0?'+'+arg:arg);pad_character=match[4]?match[4]=='0'?'0':match[4].charAt(1):' ';pad_length=match[6]-String(arg).length;pad=match[6]?str_repeat(pad_character,pad_length):'';output.push(match[5]?arg+pad:pad+arg);}}
return output.join('');};str_format.cache={};str_format.parse=function(fmt){var _fmt=fmt,match=[],parse_tree=[],arg_names=0;while(_fmt){if((match=/^[^\x25]+/.exec(_fmt))!==null){parse_tree.push(match[0]);}
else if((match=/^\x25{2}/.exec(_fmt))!==null){parse_tree.push('%');}
else if((match=/^\x25(?:([1-9]\d*)\$|\(([^\)]+)\))?(\+)?(0|'[^$])?(-)?(\d+)?(?:\.(\d+))?([b-fosuxX])/.exec(_fmt))!==null){if(match[2]){arg_names|=1;var field_list=[],replacement_field=match[2],field_match=[];if((field_match=/^([a-z_][a-z_\d]*)/i.exec(replacement_field))!==null){field_list.push(field_match[1]);while((replacement_field=replacement_field.substring(field_match[0].length))!==''){if((field_match=/^\.([a-z_][a-z_\d]*)/i.exec(replacement_field))!==null){field_list.push(field_match[1]);}
else if((field_match=/^\[(\d+)\]/.exec(replacement_field))!==null){field_list.push(field_match[1]);}
else{throw new Error('[_.sprintf] huh?');}}}
else{throw new Error('[_.sprintf] huh?');}
match[2]=field_list;}
else{arg_names|=2;}
if(arg_names===3){throw new Error('[_.sprintf] mixing positional and named placeholders is not (yet) supported');}
parse_tree.push(match);}
else{throw new Error('[_.sprintf] huh?');}
_fmt=_fmt.substring(match[0].length);}
return parse_tree;};return str_format;})(); var _s={VERSION:'2.3.0',isBlank:function(str){if(str==null)str='';return(/^\s*$/).test(str);},stripTags:function(str){if(str==null)return'';return String(str).replace(/<\/?[^>]+>/g,'');},capitalize:function(str){str=str==null?'':String(str);return str.charAt(0).toUpperCase()+str.slice(1);},chop:function(str,step){if(str==null)return[];str=String(str);step=~~step;return step>0?str.match(new RegExp('.{1,'+step+'}','g')):[str];},clean:function(str){return _s.strip(str).replace(/\s+/g,' ');},count:function(str,substr){if(str==null||substr==null)return 0;str=String(str);substr=String(substr);var count=0,pos=0,length=substr.length;while(true){pos=str.indexOf(substr,pos);if(pos===-1)break;count++;pos+=length;}
return count;},chars:function(str){if(str==null)return[];return String(str).split('');},swapCase:function(str){if(str==null)return'';return String(str).replace(/\S/g,function(c){return c===c.toUpperCase()?c.toLowerCase():c.toUpperCase();});},escapeHTML:function(str){if(str==null)return'';return String(str).replace(/[&<>"']/g,function(m){return'&'+reversedEscapeChars[m]+';';});},unescapeHTML:function(str){if(str==null)return'';return String(str).replace(/\&([^;]+);/g,function(entity,entityCode){var match;if(entityCode in escapeChars){return escapeChars[entityCode];}else if(match=entityCode.match(/^#x([\da-fA-F]+)$/)){return String.fromCharCode(parseInt(match[1],16));}else if(match=entityCode.match(/^#(\d+)$/)){return String.fromCharCode(~~match[1]);}else{return entity;}});},escapeRegExp:function(str){if(str==null)return'';return String(str).replace(/([.*+?^=!:${}()|[\]\/\\])/g,'\\$1');},splice:function(str,i,howmany,substr){var arr=_s.chars(str);arr.splice(~~i,~~howmany,substr);return arr.join('');},insert:function(str,i,substr){return _s.splice(str,i,0,substr);},include:function(str,needle){if(needle==='')return true;if(str==null)return false;return String(str).indexOf(needle)!==-1;},join:function(){var args=slice.call(arguments),separator=args.shift();if(separator==null)separator='';return args.join(separator);},lines:function(str){if(str==null)return[];return String(str).split("\n");},reverse:function(str){return _s.chars(str).reverse().join('');},startsWith:function(str,starts){if(starts==='')return true;if(str==null||starts==null)return false;str=String(str);starts=String(starts);return str.length>=starts.length&&str.slice(0,starts.length)===starts;},endsWith:function(str,ends){if(ends==='')return true;if(str==null||ends==null)return false;str=String(str);ends=String(ends);return str.length>=ends.length&&str.slice(str.length-ends.length)===ends;},succ:function(str){if(str==null)return'';str=String(str);return str.slice(0,-1)+String.fromCharCode(str.charCodeAt(str.length-1)+1);},titleize:function(str){if(str==null)return'';str=String(str).toLowerCase();return str.replace(/(?:^|\s|-)\S/g,function(c){return c.toUpperCase();});},camelize:function(str){return _s.trim(str).replace(/[-_\s]+(.)?/g,function(match,c){return c?c.toUpperCase():"";});},underscored:function(str){return _s.trim(str).replace(/([a-z\d])([A-Z]+)/g,'$1_$2').replace(/[-\s]+/g,'_').toLowerCase();},dasherize:function(str){return _s.trim(str).replace(/([A-Z])/g,'-$1').replace(/[-_\s]+/g,'-').toLowerCase();},classify:function(str){return _s.titleize(String(str).replace(/[\W_]/g,' ')).replace(/\s/g,'');},humanize:function(str){return _s.capitalize(_s.underscored(str).replace(/_id$/,'').replace(/_/g,' '));},trim:function(str,characters){if(str==null)return'';if(!characters&&nativeTrim)return nativeTrim.call(str);characters=defaultToWhiteSpace(characters);return String(str).replace(new RegExp('\^'+characters+'+|'+characters+'+$','g'),'');},ltrim:function(str,characters){if(str==null)return'';if(!characters&&nativeTrimLeft)return nativeTrimLeft.call(str);characters=defaultToWhiteSpace(characters);return String(str).replace(new RegExp('^'+characters+'+'),'');},rtrim:function(str,characters){if(str==null)return'';if(!characters&&nativeTrimRight)return nativeTrimRight.call(str);characters=defaultToWhiteSpace(characters);return String(str).replace(new RegExp(characters+'+$'),'');},truncate:function(str,length,truncateStr){if(str==null)return'';str=String(str);truncateStr=truncateStr||'...';length=~~length;return str.length>length?str.slice(0,length)+truncateStr:str;},prune:function(str,length,pruneStr){if(str==null)return'';str=String(str);length=~~length;pruneStr=pruneStr!=null?String(pruneStr):'...';if(str.length<=length)return str;var tmpl=function(c){return c.toUpperCase()!==c.toLowerCase()?'A':' ';},template=str.slice(0,length+1).replace(/.(?=\W*\w*$)/g,tmpl);if(template.slice(template.length-2).match(/\w\w/))
template=template.replace(/\s*\S+$/,'');else
template=_s.rtrim(template.slice(0,template.length-1));return(template+pruneStr).length>str.length?str:str.slice(0,template.length)+pruneStr;},words:function(str,delimiter){if(_s.isBlank(str))return[];return _s.trim(str,delimiter).split(delimiter||/\s+/);},pad:function(str,length,padStr,type){str=str==null?'':String(str);length=~~length;var padlen=0;if(!padStr)
padStr=' ';else if(padStr.length>1)
padStr=padStr.charAt(0);switch(type){case'right':padlen=length-str.length;return str+strRepeat(padStr,padlen);case'both':padlen=length-str.length;return strRepeat(padStr,Math.ceil(padlen/2))+str
+strRepeat(padStr,Math.floor(padlen/2));default:padlen=length-str.length;return strRepeat(padStr,padlen)+str;}},lpad:function(str,length,padStr){return _s.pad(str,length,padStr);},rpad:function(str,length,padStr){return _s.pad(str,length,padStr,'right');},lrpad:function(str,length,padStr){return _s.pad(str,length,padStr,'both');},sprintf:sprintf,vsprintf:function(fmt,argv){argv.unshift(fmt);return sprintf.apply(null,argv);},toNumber:function(str,decimals){if(!str)return 0;str=_s.trim(str);if(!str.match(/^-?\d+(?:\.\d+)?$/))return NaN;return parseNumber(parseNumber(str).toFixed(~~decimals));},numberFormat:function(number,dec,dsep,tsep){if(isNaN(number)||number==null)return'';number=number.toFixed(~~dec);tsep=typeof tsep=='string'?tsep:',';var parts=number.split('.'),fnums=parts[0],decimals=parts[1]?(dsep||'.')+parts[1]:'';return fnums.replace(/(\d)(?=(?:\d{3})+$)/g,'$1'+tsep)+decimals;},strRight:function(str,sep){if(str==null)return'';str=String(str);sep=sep!=null?String(sep):sep;var pos=!sep?-1:str.indexOf(sep);return~pos?str.slice(pos+sep.length,str.length):str;},strRightBack:function(str,sep){if(str==null)return'';str=String(str);sep=sep!=null?String(sep):sep;var pos=!sep?-1:str.lastIndexOf(sep);return~pos?str.slice(pos+sep.length,str.length):str;},strLeft:function(str,sep){if(str==null)return'';str=String(str);sep=sep!=null?String(sep):sep;var pos=!sep?-1:str.indexOf(sep);return~pos?str.slice(0,pos):str;},strLeftBack:function(str,sep){if(str==null)return'';str+='';sep=sep!=null?''+sep:sep;var pos=str.lastIndexOf(sep);return~pos?str.slice(0,pos):str;},toSentence:function(array,separator,lastSeparator,serial){separator=separator||', ';lastSeparator=lastSeparator||' and ';var a=array.slice(),lastMember=a.pop();if(array.length>2&&serial)lastSeparator=_s.rtrim(separator)+lastSeparator;return a.length?a.join(separator)+lastSeparator+lastMember:lastMember;},toSentenceSerial:function(){var args=slice.call(arguments);args[3]=true;return _s.toSentence.apply(_s,args);},slugify:function(str){if(str==null)return'';var from="ąàáäâãåæăćęèéëêìíïîłńòóöôõøśșțùúüûñçżź",to="aaaaaaaaaceeeeeiiiilnoooooosstuuuunczz",regex=new RegExp(defaultToWhiteSpace(from),'g');str=String(str).toLowerCase().replace(regex,function(c){var index=from.indexOf(c);return to.charAt(index)||'-';});return _s.dasherize(str.replace(/[^\w\s-]/g,''));},surround:function(str,wrapper){return[wrapper,str,wrapper].join('');},quote:function(str,quoteChar){return _s.surround(str,quoteChar||'"');},unquote:function(str,quoteChar){quoteChar=quoteChar||'"';if(str[0]===quoteChar&&str[str.length-1]===quoteChar)
return str.slice(1,str.length-1);else return str;},exports:function(){var result={};for(var prop in this){if(!this.hasOwnProperty(prop)||prop.match(/^(?:include|contains|reverse)$/))continue;result[prop]=this[prop];}
return result;},repeat:function(str,qty,separator){if(str==null)return'';qty=~~qty;if(separator==null)return strRepeat(String(str),qty); for(var repeat=[];qty>0;repeat[--qty]=str){}
return repeat.join(separator);},naturalCmp:function(str1,str2){if(str1==str2)return 0;if(!str1)return-1;if(!str2)return 1;var cmpRegex=/(\.\d+)|(\d+)|(\D+)/g,tokens1=String(str1).toLowerCase().match(cmpRegex),tokens2=String(str2).toLowerCase().match(cmpRegex),count=Math.min(tokens1.length,tokens2.length);for(var i=0;i<count;i++){var a=tokens1[i],b=tokens2[i];if(a!==b){var num1=parseInt(a,10);if(!isNaN(num1)){var num2=parseInt(b,10);if(!isNaN(num2)&&num1-num2)
return num1-num2;}
return a<b?-1:1;}}
if(tokens1.length===tokens2.length)
return tokens1.length-tokens2.length;return str1<str2?-1:1;},levenshtein:function(str1,str2){if(str1==null&&str2==null)return 0;if(str1==null)return String(str2).length;if(str2==null)return String(str1).length;str1=String(str1);str2=String(str2);var current=[],prev,value;for(var i=0;i<=str2.length;i++)
for(var j=0;j<=str1.length;j++){if(i&&j)
if(str1.charAt(j-1)===str2.charAt(i-1))
value=prev;else
value=Math.min(current[j],current[j-1],prev)+1;else
value=i+j;prev=current[j];current[j]=value;}
return current.pop();},toBoolean:function(str,trueValues,falseValues){if(typeof str==="number")str=""+str;if(typeof str!=="string")return!!str;str=_s.trim(str);if(boolMatch(str,trueValues||["true","1"]))return true;if(boolMatch(str,falseValues||["false","0"]))return false;}}; _s.strip=_s.trim;_s.lstrip=_s.ltrim;_s.rstrip=_s.rtrim;_s.center=_s.lrpad;_s.rjust=_s.lpad;_s.ljust=_s.rpad;_s.contains=_s.include;_s.q=_s.quote;_s.toBool=_s.toBoolean;
 if(typeof exports!=='undefined'){if(typeof module!=='undefined'&&module.exports)
module.exports=_s;exports._s=_s;}
if(typeof define==='function'&&define.amd)
define('underscore.string',[],function(){return _s;});
root._=root._||{};root._.string=root._.str=_s;}(this,String);



(function(undefined){var moment,VERSION="2.4.0",round=Math.round,i,YEAR=0,MONTH=1,DATE=2,HOUR=3,MINUTE=4,SECOND=5,MILLISECOND=6, languages={}, hasModule=(typeof module!=='undefined'&&module.exports), aspNetJsonRegex=/^\/?Date\((\-?\d+)/i,aspNetTimeSpanJsonRegex=/(\-)?(?:(\d*)\.)?(\d+)\:(\d+)(?:\:(\d+)\.?(\d{3})?)?/,
 isoDurationRegex=/^(-)?P(?:(?:([0-9,.]*)Y)?(?:([0-9,.]*)M)?(?:([0-9,.]*)D)?(?:T(?:([0-9,.]*)H)?(?:([0-9,.]*)M)?(?:([0-9,.]*)S)?)?|([0-9,.]*)W)$/, formattingTokens=/(\[[^\[]*\])|(\\)?(Mo|MM?M?M?|Do|DDDo|DD?D?D?|ddd?d?|do?|w[o|w]?|W[o|W]?|YYYYY|YYYY|YY|gg(ggg?)?|GG(GGG?)?|e|E|a|A|hh?|HH?|mm?|ss?|S{1,4}|X|zz?|ZZ?|.)/g,localFormattingTokens=/(\[[^\[]*\])|(\\)?(LT|LL?L?L?|l{1,4})/g, parseTokenOneOrTwoDigits=/\d\d?/, parseTokenOneToThreeDigits=/\d{1,3}/, parseTokenThreeDigits=/\d{3}/, parseTokenFourDigits=/\d{1,4}/, parseTokenSixDigits=/[+\-]?\d{1,6}/, parseTokenDigits=/\d+/, parseTokenWord=/[0-9]*['a-z\u00A0-\u05FF\u0700-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]+|[\u0600-\u06FF\/]+(\s*?[\u0600-\u06FF]+){1,2}/i,parseTokenTimezone=/Z|[\+\-]\d\d:?\d\d/i, parseTokenT=/T/i,parseTokenTimestampMs=/[\+\-]?\d+(\.\d{1,3})?/,

isoRegex=/^\s*\d{4}-(?:(\d\d-\d\d)|(W\d\d$)|(W\d\d-\d)|(\d\d\d))((T| )(\d\d(:\d\d(:\d\d(\.\d+)?)?)?)?([\+\-]\d\d:?\d\d|Z)?)?$/,isoFormat='YYYY-MM-DDTHH:mm:ssZ',isoDates=['YYYY-MM-DD','GGGG-[W]WW','GGGG-[W]WW-E','YYYY-DDD'], isoTimes=[['HH:mm:ss.SSSS',/(T| )\d\d:\d\d:\d\d\.\d{1,3}/],['HH:mm:ss',/(T| )\d\d:\d\d:\d\d/],['HH:mm',/(T| )\d\d:\d\d/],['HH',/(T| )\d\d/]],parseTimezoneChunker=/([\+\-]|\d\d)/gi, proxyGettersAndSetters='Date|Hours|Minutes|Seconds|Milliseconds'.split('|'),unitMillisecondFactors={'Milliseconds':1,'Seconds':1e3,'Minutes':6e4,'Hours':36e5,'Days':864e5,'Months':2592e6,'Years':31536e6},unitAliases={ms:'millisecond',s:'second',m:'minute',h:'hour',d:'day',D:'date',w:'week',W:'isoWeek',M:'month',y:'year',DDD:'dayOfYear',e:'weekday',E:'isoWeekday',gg:'weekYear',GG:'isoWeekYear'},camelFunctions={dayofyear:'dayOfYear',isoweekday:'isoWeekday',isoweek:'isoWeek',weekyear:'weekYear',isoweekyear:'isoWeekYear'}, formatFunctions={}, ordinalizeTokens='DDD w W M D d'.split(' '),paddedTokens='M D H h m s w W'.split(' '),formatTokenFunctions={M:function(){return this.month()+1;},MMM:function(format){return this.lang().monthsShort(this,format);},MMMM:function(format){return this.lang().months(this,format);},D:function(){return this.date();},DDD:function(){return this.dayOfYear();},d:function(){return this.day();},dd:function(format){return this.lang().weekdaysMin(this,format);},ddd:function(format){return this.lang().weekdaysShort(this,format);},dddd:function(format){return this.lang().weekdays(this,format);},w:function(){return this.week();},W:function(){return this.isoWeek();},YY:function(){return leftZeroFill(this.year()%100,2);},YYYY:function(){return leftZeroFill(this.year(),4);},YYYYY:function(){return leftZeroFill(this.year(),5);},gg:function(){return leftZeroFill(this.weekYear()%100,2);},gggg:function(){return this.weekYear();},ggggg:function(){return leftZeroFill(this.weekYear(),5);},GG:function(){return leftZeroFill(this.isoWeekYear()%100,2);},GGGG:function(){return this.isoWeekYear();},GGGGG:function(){return leftZeroFill(this.isoWeekYear(),5);},e:function(){return this.weekday();},E:function(){return this.isoWeekday();},a:function(){return this.lang().meridiem(this.hours(),this.minutes(),true);},A:function(){return this.lang().meridiem(this.hours(),this.minutes(),false);},H:function(){return this.hours();},h:function(){return this.hours()%12||12;},m:function(){return this.minutes();},s:function(){return this.seconds();},S:function(){return toInt(this.milliseconds()/100);},SS:function(){return leftZeroFill(toInt(this.milliseconds()/10),2);},SSS:function(){return leftZeroFill(this.milliseconds(),3);},SSSS:function(){return leftZeroFill(this.milliseconds(),3);},Z:function(){var a=-this.zone(),b="+";if(a<0){a=-a;b="-";}
return b+leftZeroFill(toInt(a/60),2)+":"+leftZeroFill(toInt(a)%60,2);},ZZ:function(){var a=-this.zone(),b="+";if(a<0){a=-a;b="-";}
return b+leftZeroFill(toInt(10*a/6),4);},z:function(){return this.zoneAbbr();},zz:function(){return this.zoneName();},X:function(){return this.unix();}},lists=['months','monthsShort','weekdays','weekdaysShort','weekdaysMin'];function padToken(func,count){return function(a){return leftZeroFill(func.call(this,a),count);};}
function ordinalizeToken(func,period){return function(a){return this.lang().ordinal(func.call(this,a),period);};}
while(ordinalizeTokens.length){i=ordinalizeTokens.pop();formatTokenFunctions[i+'o']=ordinalizeToken(formatTokenFunctions[i],i);}
while(paddedTokens.length){i=paddedTokens.pop();formatTokenFunctions[i+i]=padToken(formatTokenFunctions[i],2);}
formatTokenFunctions.DDDD=padToken(formatTokenFunctions.DDD,3);function Language(){} 
function Moment(config){checkOverflow(config);extend(this,config);} 
function Duration(duration){var normalizedInput=normalizeObjectUnits(duration),years=normalizedInput.year||0,months=normalizedInput.month||0,weeks=normalizedInput.week||0,days=normalizedInput.day||0,hours=normalizedInput.hour||0,minutes=normalizedInput.minute||0,seconds=normalizedInput.second||0,milliseconds=normalizedInput.millisecond||0; this._input=duration; this._milliseconds=+milliseconds+
seconds*1e3+ minutes*6e4+ hours*36e5;

 this._days=+days+
weeks*7;

this._months=+months+
years*12;this._data={};this._bubble();}
function extend(a,b){for(var i in b){if(b.hasOwnProperty(i)){a[i]=b[i];}}
if(b.hasOwnProperty("toString")){a.toString=b.toString;}
if(b.hasOwnProperty("valueOf")){a.valueOf=b.valueOf;}
return a;}
function absRound(number){if(number<0){return Math.ceil(number);}else{return Math.floor(number);}}
 
function leftZeroFill(number,targetLength){var output=number+'';while(output.length<targetLength){output='0'+output;}
return output;} 
function addOrSubtractDurationFromMoment(mom,duration,isAdding,ignoreUpdateOffset){var milliseconds=duration._milliseconds,days=duration._days,months=duration._months,minutes,hours;if(milliseconds){mom._d.setTime(+mom._d+milliseconds*isAdding);} 
if(days||months){minutes=mom.minute();hours=mom.hour();}
if(days){mom.date(mom.date()+days*isAdding);}
if(months){mom.month(mom.month()+months*isAdding);}
if(milliseconds&&!ignoreUpdateOffset){moment.updateOffset(mom);} 
if(days||months){mom.minute(minutes);mom.hour(hours);}} 
function isArray(input){return Object.prototype.toString.call(input)==='[object Array]';}
function isDate(input){return Object.prototype.toString.call(input)==='[object Date]'||input instanceof Date;} 
function compareArrays(array1,array2,dontConvert){var len=Math.min(array1.length,array2.length),lengthDiff=Math.abs(array1.length-array2.length),diffs=0,i;for(i=0;i<len;i++){if((dontConvert&&array1[i]!==array2[i])||(!dontConvert&&toInt(array1[i])!==toInt(array2[i]))){diffs++;}}
return diffs+lengthDiff;}
function normalizeUnits(units){if(units){var lowered=units.toLowerCase().replace(/(.)s$/,'$1');units=unitAliases[units]||camelFunctions[lowered]||lowered;}
return units;}
function normalizeObjectUnits(inputObject){var normalizedInput={},normalizedProp,prop,index;for(prop in inputObject){if(inputObject.hasOwnProperty(prop)){normalizedProp=normalizeUnits(prop);if(normalizedProp){normalizedInput[normalizedProp]=inputObject[prop];}}}
return normalizedInput;}
function makeList(field){var count,setter;if(field.indexOf('week')===0){count=7;setter='day';}
else if(field.indexOf('month')===0){count=12;setter='month';}
else{return;}
moment[field]=function(format,index){var i,getter,method=moment.fn._lang[field],results=[];if(typeof format==='number'){index=format;format=undefined;}
getter=function(i){var m=moment().utc().set(setter,i);return method.call(moment.fn._lang,m,format||'');};if(index!=null){return getter(index);}
else{for(i=0;i<count;i++){results.push(getter(i));}
return results;}};}
function toInt(argumentForCoercion){var coercedNumber=+argumentForCoercion,value=0;if(coercedNumber!==0&&isFinite(coercedNumber)){if(coercedNumber>=0){value=Math.floor(coercedNumber);}else{value=Math.ceil(coercedNumber);}}
return value;}
function daysInMonth(year,month){return new Date(Date.UTC(year,month+1,0)).getUTCDate();}
function daysInYear(year){return isLeapYear(year)?366:365;}
function isLeapYear(year){return(year%4===0&&year%100!==0)||year%400===0;}
function checkOverflow(m){var overflow;if(m._a&&m._pf.overflow===-2){overflow=m._a[MONTH]<0||m._a[MONTH]>11?MONTH:m._a[DATE]<1||m._a[DATE]>daysInMonth(m._a[YEAR],m._a[MONTH])?DATE:m._a[HOUR]<0||m._a[HOUR]>23?HOUR:m._a[MINUTE]<0||m._a[MINUTE]>59?MINUTE:m._a[SECOND]<0||m._a[SECOND]>59?SECOND:m._a[MILLISECOND]<0||m._a[MILLISECOND]>999?MILLISECOND:-1;if(m._pf._overflowDayOfYear&&(overflow<YEAR||overflow>DATE)){overflow=DATE;}
m._pf.overflow=overflow;}}
function initializeParsingFlags(config){config._pf={empty:false,unusedTokens:[],unusedInput:[],overflow:-2,charsLeftOver:0,nullInput:false,invalidMonth:null,invalidFormat:false,userInvalidated:false,iso:false};}
function isValid(m){if(m._isValid==null){m._isValid=!isNaN(m._d.getTime())&&m._pf.overflow<0&&!m._pf.empty&&!m._pf.invalidMonth&&!m._pf.nullInput&&!m._pf.invalidFormat&&!m._pf.userInvalidated;if(m._strict){m._isValid=m._isValid&&m._pf.charsLeftOver===0&&m._pf.unusedTokens.length===0;}}
return m._isValid;}
function normalizeLanguage(key){return key?key.toLowerCase().replace('_','-'):key;}
extend(Language.prototype,{set:function(config){var prop,i;for(i in config){prop=config[i];if(typeof prop==='function'){this[i]=prop;}else{this['_'+i]=prop;}}},_months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_"),months:function(m){return this._months[m.month()];},_monthsShort:"Jan_Feb_Mar_Apr_May_Jun_Jul_Aug_Sep_Oct_Nov_Dec".split("_"),monthsShort:function(m){return this._monthsShort[m.month()];},monthsParse:function(monthName){var i,mom,regex;if(!this._monthsParse){this._monthsParse=[];}
for(i=0;i<12;i++){ if(!this._monthsParse[i]){mom=moment.utc([2000,i]);regex='^'+this.months(mom,'')+'|^'+this.monthsShort(mom,'');this._monthsParse[i]=new RegExp(regex.replace('.',''),'i');} 
if(this._monthsParse[i].test(monthName)){return i;}}},_weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),weekdays:function(m){return this._weekdays[m.day()];},_weekdaysShort:"Sun_Mon_Tue_Wed_Thu_Fri_Sat".split("_"),weekdaysShort:function(m){return this._weekdaysShort[m.day()];},_weekdaysMin:"Su_Mo_Tu_We_Th_Fr_Sa".split("_"),weekdaysMin:function(m){return this._weekdaysMin[m.day()];},weekdaysParse:function(weekdayName){var i,mom,regex;if(!this._weekdaysParse){this._weekdaysParse=[];}
for(i=0;i<7;i++){ if(!this._weekdaysParse[i]){mom=moment([2000,1]).day(i);regex='^'+this.weekdays(mom,'')+'|^'+this.weekdaysShort(mom,'')+'|^'+this.weekdaysMin(mom,'');this._weekdaysParse[i]=new RegExp(regex.replace('.',''),'i');} 
if(this._weekdaysParse[i].test(weekdayName)){return i;}}},_longDateFormat:{LT:"h:mm A",L:"MM/DD/YYYY",LL:"MMMM D YYYY",LLL:"MMMM D YYYY LT",LLLL:"dddd, MMMM D YYYY LT"},longDateFormat:function(key){var output=this._longDateFormat[key];if(!output&&this._longDateFormat[key.toUpperCase()]){output=this._longDateFormat[key.toUpperCase()].replace(/MMMM|MM|DD|dddd/g,function(val){return val.slice(1);});this._longDateFormat[key]=output;}
return output;},isPM:function(input){
return((input+'').toLowerCase().charAt(0)==='p');},_meridiemParse:/[ap]\.?m?\.?/i,meridiem:function(hours,minutes,isLower){if(hours>11){return isLower?'pm':'PM';}else{return isLower?'am':'AM';}},_calendar:{sameDay:'[Today at] LT',nextDay:'[Tomorrow at] LT',nextWeek:'dddd [at] LT',lastDay:'[Yesterday at] LT',lastWeek:'[Last] dddd [at] LT',sameElse:'L'},calendar:function(key,mom){var output=this._calendar[key];return typeof output==='function'?output.apply(mom):output;},_relativeTime:{future:"in %s",past:"%s ago",s:"a few seconds",m:"a minute",mm:"%d minutes",h:"an hour",hh:"%d hours",d:"a day",dd:"%d days",M:"a month",MM:"%d months",y:"a year",yy:"%d years"},relativeTime:function(number,withoutSuffix,string,isFuture){var output=this._relativeTime[string];return(typeof output==='function')?output(number,withoutSuffix,string,isFuture):output.replace(/%d/i,number);},pastFuture:function(diff,output){var format=this._relativeTime[diff>0?'future':'past'];return typeof format==='function'?format(output):format.replace(/%s/i,output);},ordinal:function(number){return this._ordinal.replace("%d",number);},_ordinal:"%d",preparse:function(string){return string;},postformat:function(string){return string;},week:function(mom){return weekOfYear(mom,this._week.dow,this._week.doy).week;},_week:{dow:0,doy:6
},_invalidDate:'Invalid date',invalidDate:function(){return this._invalidDate;}});

function loadLang(key,values){values.abbr=key;if(!languages[key]){languages[key]=new Language();}
languages[key].set(values);return languages[key];}
function unloadLang(key){delete languages[key];}



function getLangDefinition(key){var i=0,j,lang,next,split,get=function(k){if(!languages[k]&&hasModule){try{require('./lang/'+k);}catch(e){}}
return languages[k];};if(!key){return moment.fn._lang;}
if(!isArray(key)){ lang=get(key);if(lang){return lang;}
key=[key];}

 
while(i<key.length){split=normalizeLanguage(key[i]).split('-');j=split.length;next=normalizeLanguage(key[i+1]);next=next?next.split('-'):null;while(j>0){lang=get(split.slice(0,j).join('-'));if(lang){return lang;}
if(next&&next.length>=j&&compareArrays(split,next,true)>=j-1){ break;}
j--;}
i++;}
return moment.fn._lang;}
function removeFormattingTokens(input){if(input.match(/\[[\s\S]/)){return input.replace(/^\[|\]$/g,"");}
return input.replace(/\\/g,"");}
function makeFormatFunction(format){var array=format.match(formattingTokens),i,length;for(i=0,length=array.length;i<length;i++){if(formatTokenFunctions[array[i]]){array[i]=formatTokenFunctions[array[i]];}else{array[i]=removeFormattingTokens(array[i]);}}
return function(mom){var output="";for(i=0;i<length;i++){output+=array[i]instanceof Function?array[i].call(mom,format):array[i];}
return output;};} 
function formatMoment(m,format){if(!m.isValid()){return m.lang().invalidDate();}
format=expandFormat(format,m.lang());if(!formatFunctions[format]){formatFunctions[format]=makeFormatFunction(format);}
return formatFunctions[format](m);}
function expandFormat(format,lang){var i=5;function replaceLongDateFormatTokens(input){return lang.longDateFormat(input)||input;}
localFormattingTokens.lastIndex=0;while(i>=0&&localFormattingTokens.test(format)){format=format.replace(localFormattingTokens,replaceLongDateFormatTokens);localFormattingTokens.lastIndex=0;i-=1;}
return format;} 
function getParseRegexForToken(token,config){var a;switch(token){case'DDDD':return parseTokenThreeDigits;case'YYYY':case'GGGG':case'gggg':return parseTokenFourDigits;case'YYYYY':case'GGGGG':case'ggggg':return parseTokenSixDigits;case'S':case'SS':case'SSS':case'DDD':return parseTokenOneToThreeDigits;case'MMM':case'MMMM':case'dd':case'ddd':case'dddd':return parseTokenWord;case'a':case'A':return getLangDefinition(config._l)._meridiemParse;case'X':return parseTokenTimestampMs;case'Z':case'ZZ':return parseTokenTimezone;case'T':return parseTokenT;case'SSSS':return parseTokenDigits;case'MM':case'DD':case'YY':case'GG':case'gg':case'HH':case'hh':case'mm':case'ss':case'M':case'D':case'd':case'H':case'h':case'm':case's':case'w':case'ww':case'W':case'WW':case'e':case'E':return parseTokenOneOrTwoDigits;default:a=new RegExp(regexpEscape(unescapeFormat(token.replace('\\','')),"i"));return a;}}
function timezoneMinutesFromString(string){var tzchunk=(parseTokenTimezone.exec(string)||[])[0],parts=(tzchunk+'').match(parseTimezoneChunker)||['-',0,0],minutes=+(parts[1]*60)+toInt(parts[2]);return parts[0]==='+'?-minutes:minutes;} 
function addTimeToArrayFromToken(token,input,config){var a,datePartArray=config._a;switch(token){ case'M': case'MM':if(input!=null){datePartArray[MONTH]=toInt(input)-1;}
break;case'MMM': case'MMMM':a=getLangDefinition(config._l).monthsParse(input);if(a!=null){datePartArray[MONTH]=a;}else{config._pf.invalidMonth=input;}
break; case'D': case'DD':if(input!=null){datePartArray[DATE]=toInt(input);}
break; case'DDD': case'DDDD':if(input!=null){config._dayOfYear=toInt(input);}
break; case'YY':datePartArray[YEAR]=toInt(input)+(toInt(input)>68?1900:2000);break;case'YYYY':case'YYYYY':datePartArray[YEAR]=toInt(input);break; case'a': case'A':config._isPm=getLangDefinition(config._l).isPM(input);break; case'H': case'HH': case'h': case'hh':datePartArray[HOUR]=toInt(input);break; case'm': case'mm':datePartArray[MINUTE]=toInt(input);break; case's': case'ss':datePartArray[SECOND]=toInt(input);break; case'S':case'SS':case'SSS':case'SSSS':datePartArray[MILLISECOND]=toInt(('0.'+input)*1000);break; case'X':config._d=new Date(parseFloat(input)*1000);break; case'Z': case'ZZ':config._useUTC=true;config._tzm=timezoneMinutesFromString(input);break;case'w':case'ww':case'W':case'WW':case'd':case'dd':case'ddd':case'dddd':case'e':case'E':token=token.substr(0,1);case'gg':case'gggg':case'GG':case'GGGG':case'GGGGG':token=token.substr(0,2);if(input){config._w=config._w||{};config._w[token]=input;}
break;}}

function dateFromConfig(config){var i,date,input=[],currentDate,yearToUse,fixYear,w,temp,lang,weekday,week;if(config._d){return;}
currentDate=currentDateArray(config); if(config._w&&config._a[DATE]==null&&config._a[MONTH]==null){fixYear=function(val){return val?(val.length<3?(parseInt(val,10)>68?'19'+val:'20'+val):val):(config._a[YEAR]==null?moment().weekYear():config._a[YEAR]);};w=config._w;if(w.GG!=null||w.W!=null||w.E!=null){temp=dayOfYearFromWeeks(fixYear(w.GG),w.W||1,w.E,4,1);}
else{lang=getLangDefinition(config._l);weekday=w.d!=null?parseWeekday(w.d,lang):(w.e!=null?parseInt(w.e,10)+lang._week.dow:0);week=parseInt(w.w,10)||1; if(w.d!=null&&weekday<lang._week.dow){week++;}
temp=dayOfYearFromWeeks(fixYear(w.gg),week,weekday,lang._week.doy,lang._week.dow);}
config._a[YEAR]=temp.year;config._dayOfYear=temp.dayOfYear;} 
if(config._dayOfYear){yearToUse=config._a[YEAR]==null?currentDate[YEAR]:config._a[YEAR];if(config._dayOfYear>daysInYear(yearToUse)){config._pf._overflowDayOfYear=true;}
date=makeUTCDate(yearToUse,0,config._dayOfYear);config._a[MONTH]=date.getUTCMonth();config._a[DATE]=date.getUTCDate();}


 
for(i=0;i<3&&config._a[i]==null;++i){config._a[i]=input[i]=currentDate[i];} 
for(;i<7;i++){config._a[i]=input[i]=(config._a[i]==null)?(i===2?1:0):config._a[i];} 
input[HOUR]+=toInt((config._tzm||0)/60);input[MINUTE]+=toInt((config._tzm||0)%60);config._d=(config._useUTC?makeUTCDate:makeDate).apply(null,input);}
function dateFromObject(config){var normalizedInput;if(config._d){return;}
normalizedInput=normalizeObjectUnits(config._i);config._a=[normalizedInput.year,normalizedInput.month,normalizedInput.day,normalizedInput.hour,normalizedInput.minute,normalizedInput.second,normalizedInput.millisecond];dateFromConfig(config);}
function currentDateArray(config){var now=new Date();if(config._useUTC){return[now.getUTCFullYear(),now.getUTCMonth(),now.getUTCDate()];}else{return[now.getFullYear(),now.getMonth(),now.getDate()];}} 
function makeDateFromStringAndFormat(config){config._a=[];config._pf.empty=true;var lang=getLangDefinition(config._l),string=''+config._i,i,parsedInput,tokens,token,skipped,stringLength=string.length,totalParsedInputLength=0;tokens=expandFormat(config._f,lang).match(formattingTokens)||[];for(i=0;i<tokens.length;i++){token=tokens[i];parsedInput=(getParseRegexForToken(token,config).exec(string)||[])[0];if(parsedInput){skipped=string.substr(0,string.indexOf(parsedInput));if(skipped.length>0){config._pf.unusedInput.push(skipped);}
string=string.slice(string.indexOf(parsedInput)+parsedInput.length);totalParsedInputLength+=parsedInput.length;} 
if(formatTokenFunctions[token]){if(parsedInput){config._pf.empty=false;}
else{config._pf.unusedTokens.push(token);}
addTimeToArrayFromToken(token,parsedInput,config);}
else if(config._strict&&!parsedInput){config._pf.unusedTokens.push(token);}} 
config._pf.charsLeftOver=stringLength-totalParsedInputLength;if(string.length>0){config._pf.unusedInput.push(string);} 
if(config._isPm&&config._a[HOUR]<12){config._a[HOUR]+=12;} 
if(config._isPm===false&&config._a[HOUR]===12){config._a[HOUR]=0;}
dateFromConfig(config);checkOverflow(config);}
function unescapeFormat(s){return s.replace(/\\(\[)|\\(\])|\[([^\]\[]*)\]|\\(.)/g,function(matched,p1,p2,p3,p4){return p1||p2||p3||p4;});} 
function regexpEscape(s){return s.replace(/[-\/\\^$*+?.()|[\]{}]/g,'\\$&');} 
function makeDateFromStringAndArray(config){var tempConfig,bestMoment,scoreToBeat,i,currentScore;if(config._f.length===0){config._pf.invalidFormat=true;config._d=new Date(NaN);return;}
for(i=0;i<config._f.length;i++){currentScore=0;tempConfig=extend({},config);initializeParsingFlags(tempConfig);tempConfig._f=config._f[i];makeDateFromStringAndFormat(tempConfig);if(!isValid(tempConfig)){continue;} 
currentScore+=tempConfig._pf.charsLeftOver; currentScore+=tempConfig._pf.unusedTokens.length*10;tempConfig._pf.score=currentScore;if(scoreToBeat==null||currentScore<scoreToBeat){scoreToBeat=currentScore;bestMoment=tempConfig;}}
extend(config,bestMoment||tempConfig);} 
function makeDateFromString(config){var i,string=config._i,match=isoRegex.exec(string);if(match){config._pf.iso=true;for(i=4;i>0;i--){if(match[i]){ config._f=isoDates[i-1]+(match[6]||" ");break;}}
for(i=0;i<4;i++){if(isoTimes[i][1].exec(string)){config._f+=isoTimes[i][0];break;}}
if(parseTokenTimezone.exec(string)){config._f+="Z";}
makeDateFromStringAndFormat(config);}
else{config._d=new Date(string);}}
function makeDateFromInput(config){var input=config._i,matched=aspNetJsonRegex.exec(input);if(input===undefined){config._d=new Date();}else if(matched){config._d=new Date(+matched[1]);}else if(typeof input==='string'){makeDateFromString(config);}else if(isArray(input)){config._a=input.slice(0);dateFromConfig(config);}else if(isDate(input)){config._d=new Date(+input);}else if(typeof(input)==='object'){dateFromObject(config);}else{config._d=new Date(input);}}
function makeDate(y,m,d,h,M,s,ms){ var date=new Date(y,m,d,h,M,s,ms); if(y<1970){date.setFullYear(y);}
return date;}
function makeUTCDate(y){var date=new Date(Date.UTC.apply(null,arguments));if(y<1970){date.setUTCFullYear(y);}
return date;}
function parseWeekday(input,language){if(typeof input==='string'){if(!isNaN(input)){input=parseInt(input,10);}
else{input=language.weekdaysParse(input);if(typeof input!=='number'){return null;}}}
return input;} 
function substituteTimeAgo(string,number,withoutSuffix,isFuture,lang){return lang.relativeTime(number||1,!!withoutSuffix,string,isFuture);}
function relativeTime(milliseconds,withoutSuffix,lang){var seconds=round(Math.abs(milliseconds)/1000),minutes=round(seconds/60),hours=round(minutes/60),days=round(hours/24),years=round(days/365),args=seconds<45&&['s',seconds]||minutes===1&&['m']||minutes<45&&['mm',minutes]||hours===1&&['h']||hours<22&&['hh',hours]||days===1&&['d']||days<=25&&['dd',days]||days<=45&&['M']||days<345&&['MM',round(days/30)]||years===1&&['y']||['yy',years];args[2]=withoutSuffix;args[3]=milliseconds>0;args[4]=lang;return substituteTimeAgo.apply({},args);}





function weekOfYear(mom,firstDayOfWeek,firstDayOfWeekOfYear){var end=firstDayOfWeekOfYear-firstDayOfWeek,daysToDayOfWeek=firstDayOfWeekOfYear-mom.day(),adjustedMoment;if(daysToDayOfWeek>end){daysToDayOfWeek-=7;}
if(daysToDayOfWeek<end-7){daysToDayOfWeek+=7;}
adjustedMoment=moment(mom).add('d',daysToDayOfWeek);return{week:Math.ceil(adjustedMoment.dayOfYear()/7),year:adjustedMoment.year()};} 
function dayOfYearFromWeeks(year,week,weekday,firstDayOfWeekOfYear,firstDayOfWeek){var d=new Date(Date.UTC(year,0)).getUTCDay(),daysToAdd,dayOfYear;weekday=weekday!=null?weekday:firstDayOfWeek;daysToAdd=firstDayOfWeek-d+(d>firstDayOfWeekOfYear?7:0);dayOfYear=7*(week-1)+(weekday-firstDayOfWeek)+daysToAdd+1;return{year:dayOfYear>0?year:year-1,dayOfYear:dayOfYear>0?dayOfYear:daysInYear(year-1)+dayOfYear};}
function makeMoment(config){var input=config._i,format=config._f;if(typeof config._pf==='undefined'){initializeParsingFlags(config);}
if(input===null){return moment.invalid({nullInput:true});}
if(typeof input==='string'){config._i=input=getLangDefinition().preparse(input);}
if(moment.isMoment(input)){config=extend({},input);config._d=new Date(+input._d);}else if(format){if(isArray(format)){makeDateFromStringAndArray(config);}else{makeDateFromStringAndFormat(config);}}else{makeDateFromInput(config);}
return new Moment(config);}
moment=function(input,format,lang,strict){if(typeof(lang)==="boolean"){strict=lang;lang=undefined;}
return makeMoment({_i:input,_f:format,_l:lang,_strict:strict,_isUTC:false});}; moment.utc=function(input,format,lang,strict){var m;if(typeof(lang)==="boolean"){strict=lang;lang=undefined;}
m=makeMoment({_useUTC:true,_isUTC:true,_l:lang,_i:input,_f:format,_strict:strict}).utc();return m;};moment.unix=function(input){return moment(input*1000);}; moment.duration=function(input,key){var isDuration=moment.isDuration(input),isNumber=(typeof input==='number'),duration=(isDuration?input._input:(isNumber?{}:input)), match=null,sign,ret,parseIso,timeEmpty,dateTimeEmpty;if(isNumber){if(key){duration[key]=input;}else{duration.milliseconds=input;}}else if(!!(match=aspNetTimeSpanJsonRegex.exec(input))){sign=(match[1]==="-")?-1:1;duration={y:0,d:toInt(match[DATE])*sign,h:toInt(match[HOUR])*sign,m:toInt(match[MINUTE])*sign,s:toInt(match[SECOND])*sign,ms:toInt(match[MILLISECOND])*sign};}else if(!!(match=isoDurationRegex.exec(input))){sign=(match[1]==="-")?-1:1;parseIso=function(inp){
var res=inp&&parseFloat(inp.replace(',','.')); return(isNaN(res)?0:res)*sign;};duration={y:parseIso(match[2]),M:parseIso(match[3]),d:parseIso(match[4]),h:parseIso(match[5]),m:parseIso(match[6]),s:parseIso(match[7]),w:parseIso(match[8])};}
ret=new Duration(duration);if(isDuration&&input.hasOwnProperty('_lang')){ret._lang=input._lang;}
return ret;}; moment.version=VERSION; moment.defaultFormat=isoFormat;moment.updateOffset=function(){};

moment.lang=function(key,values){var r;if(!key){return moment.fn._lang._abbr;}
if(values){loadLang(normalizeLanguage(key),values);}else if(values===null){unloadLang(key);key='en';}else if(!languages[key]){getLangDefinition(key);}
r=moment.duration.fn._lang=moment.fn._lang=getLangDefinition(key);return r._abbr;}; moment.langData=function(key){if(key&&key._lang&&key._lang._abbr){key=key._lang._abbr;}
return getLangDefinition(key);}; moment.isMoment=function(obj){return obj instanceof Moment;}; moment.isDuration=function(obj){return obj instanceof Duration;};for(i=lists.length-1;i>=0;--i){makeList(lists[i]);}
moment.normalizeUnits=function(units){return normalizeUnits(units);};moment.invalid=function(flags){var m=moment.utc(NaN);if(flags!=null){extend(m._pf,flags);}
else{m._pf.userInvalidated=true;}
return m;};moment.parseZone=function(input){return moment(input).parseZone();};extend(moment.fn=Moment.prototype,{clone:function(){return moment(this);},valueOf:function(){return+this._d+((this._offset||0)*60000);},unix:function(){return Math.floor(+this/1000);},toString:function(){return this.clone().lang('en').format("ddd MMM DD YYYY HH:mm:ss [GMT]ZZ");},toDate:function(){return this._offset?new Date(+this):this._d;},toISOString:function(){return formatMoment(moment(this).utc(),'YYYY-MM-DD[T]HH:mm:ss.SSS[Z]');},toArray:function(){var m=this;return[m.year(),m.month(),m.date(),m.hours(),m.minutes(),m.seconds(),m.milliseconds()];},isValid:function(){return isValid(this);},isDSTShifted:function(){if(this._a){return this.isValid()&&compareArrays(this._a,(this._isUTC?moment.utc(this._a):moment(this._a)).toArray())>0;}
return false;},parsingFlags:function(){return extend({},this._pf);},invalidAt:function(){return this._pf.overflow;},utc:function(){return this.zone(0);},local:function(){this.zone(0);this._isUTC=false;return this;},format:function(inputString){var output=formatMoment(this,inputString||moment.defaultFormat);return this.lang().postformat(output);},add:function(input,val){var dur;if(typeof input==='string'){dur=moment.duration(+val,input);}else{dur=moment.duration(input,val);}
addOrSubtractDurationFromMoment(this,dur,1);return this;},subtract:function(input,val){var dur;if(typeof input==='string'){dur=moment.duration(+val,input);}else{dur=moment.duration(input,val);}
addOrSubtractDurationFromMoment(this,dur,-1);return this;},diff:function(input,units,asFloat){var that=this._isUTC?moment(input).zone(this._offset||0):moment(input).local(),zoneDiff=(this.zone()-that.zone())*6e4,diff,output;units=normalizeUnits(units);if(units==='year'||units==='month'){ diff=(this.daysInMonth()+that.daysInMonth())*432e5;
 output=((this.year()-that.year())*12)+(this.month()-that.month());
output+=((this-moment(this).startOf('month'))-
(that-moment(that).startOf('month')))/diff; output-=((this.zone()-moment(this).startOf('month').zone())-
(that.zone()-moment(that).startOf('month').zone()))*6e4/diff;if(units==='year'){output=output/12;}}else{diff=(this-that);output=units==='second'?diff/1e3: units==='minute'?diff/6e4: units==='hour'?diff/36e5: units==='day'?(diff-zoneDiff)/864e5: units==='week'?(diff-zoneDiff)/6048e5: diff;}
return asFloat?output:absRound(output);},from:function(time,withoutSuffix){return moment.duration(this.diff(time)).lang(this.lang()._abbr).humanize(!withoutSuffix);},fromNow:function(withoutSuffix){return this.from(moment(),withoutSuffix);},calendar:function(){var diff=this.diff(moment().zone(this.zone()).startOf('day'),'days',true),format=diff<-6?'sameElse':diff<-1?'lastWeek':diff<0?'lastDay':diff<1?'sameDay':diff<2?'nextDay':diff<7?'nextWeek':'sameElse';return this.format(this.lang().calendar(format,this));},isLeapYear:function(){return isLeapYear(this.year());},isDST:function(){return(this.zone()<this.clone().month(0).zone()||this.zone()<this.clone().month(5).zone());},day:function(input){var day=this._isUTC?this._d.getUTCDay():this._d.getDay();if(input!=null){input=parseWeekday(input,this.lang());return this.add({d:input-day});}else{return day;}},month:function(input){var utc=this._isUTC?'UTC':'',dayOfMonth;if(input!=null){if(typeof input==='string'){input=this.lang().monthsParse(input);if(typeof input!=='number'){return this;}}
dayOfMonth=this.date();this.date(1);this._d['set'+utc+'Month'](input);this.date(Math.min(dayOfMonth,this.daysInMonth()));moment.updateOffset(this);return this;}else{return this._d['get'+utc+'Month']();}},startOf:function(units){units=normalizeUnits(units);
switch(units){case'year':this.month(0);case'month':this.date(1);case'week':case'isoWeek':case'day':this.hours(0);case'hour':this.minutes(0);case'minute':this.seconds(0);case'second':this.milliseconds(0);} 
if(units==='week'){this.weekday(0);}else if(units==='isoWeek'){this.isoWeekday(1);}
return this;},endOf:function(units){units=normalizeUnits(units);return this.startOf(units).add((units==='isoWeek'?'week':units),1).subtract('ms',1);},isAfter:function(input,units){units=typeof units!=='undefined'?units:'millisecond';return+this.clone().startOf(units)>+moment(input).startOf(units);},isBefore:function(input,units){units=typeof units!=='undefined'?units:'millisecond';return+this.clone().startOf(units)<+moment(input).startOf(units);},isSame:function(input,units){units=typeof units!=='undefined'?units:'millisecond';return+this.clone().startOf(units)===+moment(input).startOf(units);},min:function(other){other=moment.apply(null,arguments);return other<this?this:other;},max:function(other){other=moment.apply(null,arguments);return other>this?this:other;},zone:function(input){var offset=this._offset||0;if(input!=null){if(typeof input==="string"){input=timezoneMinutesFromString(input);}
if(Math.abs(input)<16){input=input*60;}
this._offset=input;this._isUTC=true;if(offset!==input){addOrSubtractDurationFromMoment(this,moment.duration(offset-input,'m'),1,true);}}else{return this._isUTC?offset:this._d.getTimezoneOffset();}
return this;},zoneAbbr:function(){return this._isUTC?"UTC":"";},zoneName:function(){return this._isUTC?"Coordinated Universal Time":"";},parseZone:function(){if(typeof this._i==='string'){this.zone(this._i);}
return this;},hasAlignedHourOffset:function(input){if(!input){input=0;}
else{input=moment(input).zone();}
return(this.zone()-input)%60===0;},daysInMonth:function(){return daysInMonth(this.year(),this.month());},dayOfYear:function(input){var dayOfYear=round((moment(this).startOf('day')-moment(this).startOf('year'))/864e5)+1;return input==null?dayOfYear:this.add("d",(input-dayOfYear));},weekYear:function(input){var year=weekOfYear(this,this.lang()._week.dow,this.lang()._week.doy).year;return input==null?year:this.add("y",(input-year));},isoWeekYear:function(input){var year=weekOfYear(this,1,4).year;return input==null?year:this.add("y",(input-year));},week:function(input){var week=this.lang().week(this);return input==null?week:this.add("d",(input-week)*7);},isoWeek:function(input){var week=weekOfYear(this,1,4).week;return input==null?week:this.add("d",(input-week)*7);},weekday:function(input){var weekday=(this.day()+7-this.lang()._week.dow)%7;return input==null?weekday:this.add("d",input-weekday);},isoWeekday:function(input){

return input==null?this.day()||7:this.day(this.day()%7?input:input-7);},get:function(units){units=normalizeUnits(units);return this[units]();},set:function(units,value){units=normalizeUnits(units);if(typeof this[units]==='function'){this[units](value);}
return this;},

lang:function(key){if(key===undefined){return this._lang;}else{this._lang=getLangDefinition(key);return this;}}}); function makeGetterAndSetter(name,key){moment.fn[name]=moment.fn[name+'s']=function(input){var utc=this._isUTC?'UTC':'';if(input!=null){this._d['set'+utc+key](input);moment.updateOffset(this);return this;}else{return this._d['get'+utc+key]();}};}
for(i=0;i<proxyGettersAndSetters.length;i++){makeGetterAndSetter(proxyGettersAndSetters[i].toLowerCase().replace(/s$/,''),proxyGettersAndSetters[i]);}
makeGetterAndSetter('year','FullYear'); moment.fn.days=moment.fn.day;moment.fn.months=moment.fn.month;moment.fn.weeks=moment.fn.week;moment.fn.isoWeeks=moment.fn.isoWeek; moment.fn.toJSON=moment.fn.toISOString;extend(moment.duration.fn=Duration.prototype,{_bubble:function(){var milliseconds=this._milliseconds,days=this._days,months=this._months,data=this._data,seconds,minutes,hours,years;
data.milliseconds=milliseconds%1000;seconds=absRound(milliseconds/1000);data.seconds=seconds%60;minutes=absRound(seconds/60);data.minutes=minutes%60;hours=absRound(minutes/60);data.hours=hours%24;days+=absRound(hours/24);data.days=days%30;months+=absRound(days/30);data.months=months%12;years=absRound(months/12);data.years=years;},weeks:function(){return absRound(this.days()/7);},valueOf:function(){return this._milliseconds+
this._days*864e5+
(this._months%12)*2592e6+
toInt(this._months/12)*31536e6;},humanize:function(withSuffix){var difference=+this,output=relativeTime(difference,!withSuffix,this.lang());if(withSuffix){output=this.lang().pastFuture(difference,output);}
return this.lang().postformat(output);},add:function(input,val){var dur=moment.duration(input,val);this._milliseconds+=dur._milliseconds;this._days+=dur._days;this._months+=dur._months;this._bubble();return this;},subtract:function(input,val){var dur=moment.duration(input,val);this._milliseconds-=dur._milliseconds;this._days-=dur._days;this._months-=dur._months;this._bubble();return this;},get:function(units){units=normalizeUnits(units);return this[units.toLowerCase()+'s']();},as:function(units){units=normalizeUnits(units);return this['as'+units.charAt(0).toUpperCase()+units.slice(1)+'s']();},lang:moment.fn.lang,toIsoString:function(){ var years=Math.abs(this.years()),months=Math.abs(this.months()),days=Math.abs(this.days()),hours=Math.abs(this.hours()),minutes=Math.abs(this.minutes()),seconds=Math.abs(this.seconds()+this.milliseconds()/1000);if(!this.asSeconds()){return'P0D';}
return(this.asSeconds()<0?'-':'')+'P'+
(years?years+'Y':'')+
(months?months+'M':'')+
(days?days+'D':'')+
((hours||minutes||seconds)?'T':'')+
(hours?hours+'H':'')+
(minutes?minutes+'M':'')+
(seconds?seconds+'S':'');}});function makeDurationGetter(name){moment.duration.fn[name]=function(){return this._data[name];};}
function makeDurationAsGetter(name,factor){moment.duration.fn['as'+name]=function(){return+this/factor;};}
for(i in unitMillisecondFactors){if(unitMillisecondFactors.hasOwnProperty(i)){makeDurationAsGetter(i,unitMillisecondFactors[i]);makeDurationGetter(i.toLowerCase());}}
makeDurationAsGetter('Weeks',6048e5);moment.duration.fn.asMonths=function(){return(+this-this.years()*31536e6)/2592e6+this.years()*12;};moment.lang('en',{ordinal:function(number){var b=number%10,output=(toInt(number%100/10)===1)?'th':(b===1)?'st':(b===2)?'nd':(b===3)?'rd':'th';return number+output;}});function makeGlobal(deprecate){var warned=false,local_moment=moment;if(typeof ender!=='undefined'){return;}
 
if(deprecate){this.moment=function(){if(!warned&&console&&console.warn){warned=true;console.warn("Accessing Moment through the global scope is "+"deprecated, and will be removed in an upcoming "+"release.");}
return local_moment.apply(null,arguments);};}else{this['moment']=moment;}} 
if(hasModule){module.exports=moment;makeGlobal(true);}else if(typeof define==="function"&&define.amd){define("moment",function(require,exports,module){if(module.config().noGlobal!==true){ makeGlobal(module.config().noGlobal===undefined);}
return moment;});}else{makeGlobal();}}).call(this);(function(global){if(!Array.prototype.forEach){Array.prototype.forEach=function(fn,scope){for(var i=0,len=this.length;i<len;++i){fn.call(scope||this,this[i],i,this);}};}
function decode(s){s=decodeURIComponent(s);s=s.replace('+',' ');return s;}
function parseUri(str){var parser=/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/,parserKeys=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"],m=parser.exec(str||''),parts={};parserKeys.forEach(function(key,i){parts[key]=m[i]||'';});return parts;}
function parseQuery(str){var i,ps,p,kvp,k,v,pairs=[];if(typeof(str)==='undefined'||str===null||str===''){return pairs;}
if(str.indexOf('?')===0){str=str.substring(1);}
ps=str.toString().split(/[&;]/);for(i=0;i<ps.length;i++){p=ps[i];kvp=p.split('=');k=kvp[0];v=p.indexOf('=')===-1?null:(kvp[1]===null?'':kvp[1]);pairs.push([k,v]);}
return pairs;}
function Uri(str){this.uriParts=parseUri(str);this.queryPairs=parseQuery(this.uriParts.query);this.hasAuthorityPrefixUserPref=null;}
['protocol','userInfo','host','port','path','anchor'].forEach(function(key){Uri.prototype[key]=function(val){if(typeof val!=='undefined'){this.uriParts[key]=val;}
return this.uriParts[key];};});Uri.prototype.hasAuthorityPrefix=function(val){if(typeof val!=='undefined'){this.hasAuthorityPrefixUserPref=val;}
if(this.hasAuthorityPrefixUserPref===null){return(this.uriParts.source.indexOf('//')!==-1);}else{return this.hasAuthorityPrefixUserPref;}};Uri.prototype.query=function(val){var s='',i,param;if(typeof val!=='undefined'){this.queryPairs=parseQuery(val);}
for(i=0;i<this.queryPairs.length;i++){param=this.queryPairs[i];if(s.length>0){s+='&';}
if(param[1]===null){s+=param[0];}else{s+=param[0];s+='=';if(param[1]){s+=encodeURIComponent(param[1]);}}}
return s.length>0?'?'+s:s;};Uri.prototype.getQueryParamValue=function(key){var param,i;for(i=0;i<this.queryPairs.length;i++){param=this.queryPairs[i];if(decode(key)===decode(param[0])){return param[1];}}};Uri.prototype.getQueryParamValues=function(key){var arr=[],i,param;for(i=0;i<this.queryPairs.length;i++){param=this.queryPairs[i];if(decode(key)===decode(param[0])){arr.push(param[1]);}}
return arr;};Uri.prototype.deleteQueryParam=function(key,val){var arr=[],i,param,keyMatchesFilter,valMatchesFilter;for(i=0;i<this.queryPairs.length;i++){param=this.queryPairs[i];keyMatchesFilter=decode(param[0])===decode(key);valMatchesFilter=decode(param[1])===decode(val);if((arguments.length===1&&!keyMatchesFilter)||(arguments.length===2&&!keyMatchesFilter&&!valMatchesFilter)){arr.push(param);}}
this.queryPairs=arr;return this;};Uri.prototype.addQueryParam=function(key,val,index){if(arguments.length===3&&index!==-1){index=Math.min(index,this.queryPairs.length);this.queryPairs.splice(index,0,[key,val]);}else if(arguments.length>0){this.queryPairs.push([key,val]);}
return this;};Uri.prototype.replaceQueryParam=function(key,newVal,oldVal){var index=-1,i,param;if(arguments.length===3){for(i=0;i<this.queryPairs.length;i++){param=this.queryPairs[i];if(decode(param[0])===decode(key)&&decodeURIComponent(param[1])===decode(oldVal)){index=i;break;}}
this.deleteQueryParam(key,oldVal).addQueryParam(key,newVal,index);}else{for(i=0;i<this.queryPairs.length;i++){param=this.queryPairs[i];if(decode(param[0])===decode(key)){index=i;break;}}
this.deleteQueryParam(key);this.addQueryParam(key,newVal,index);}
return this;};['protocol','hasAuthorityPrefix','userInfo','host','port','path','query','anchor'].forEach(function(key){var method='set'+key.charAt(0).toUpperCase()+key.slice(1);Uri.prototype[method]=function(val){this[key](val);return this;};});Uri.prototype.scheme=function(){var s='';if(this.protocol()){s+=this.protocol();if(this.protocol().indexOf(':')!==this.protocol().length-1){s+=':';}
s+='//';}else{if(this.hasAuthorityPrefix()&&this.host()){s+='//';}}
return s;};Uri.prototype.origin=function(){var s=this.scheme();if(this.userInfo()&&this.host()){s+=this.userInfo();if(this.userInfo().indexOf('@')!==this.userInfo().length-1){s+='@';}}
if(this.host()){s+=this.host();if(this.port()){s+=':'+this.port();}}
return s;};Uri.prototype.toString=function(){var s=this.origin();if(this.path()){s+=this.path();}else{if(this.host()&&(this.query().toString()||this.anchor())){s+='/';}}
if(this.query().toString()){if(this.query().toString().indexOf('?')!==0){s+='?';}
s+=this.query().toString();}
if(this.anchor()){if(this.anchor().indexOf('#')!==0){s+='#';}
s+=this.anchor();}
return s;};Uri.prototype.clone=function(){return new Uri(this.toString());};if(typeof define==='function'&&define.amd){define(function(){return Uri;});}else if(typeof module!=='undefined'&&typeof module.exports!=='undefined'){module.exports=Uri;}else{global.Uri=Uri;}}(this));var JClipboard=(function(){var instance,_defaults={moviePath:"JClipboard.swf",trustedOrigins:null,allowScriptAccess:"always",useNoCache:true};function JClipboard(){var that=this; that.initialize=function(){that.options=_defaults;that.$el=null;that.isReady=false;that.copyable=null;that.$copyableEl=null;if(detectFlashSupport()){$(document.body).append(render().$el);}};that.dispatch=function(eventName,args){switch(eventName){case"load":_onLoaded();break;case"mouseOver":_onMouseOver();break;case"mouseOut":_onMouseOut();break;case"dataRequested":_onDataRequested();break;case"complete":_onComplete();break;}};that.bindTo=function(copyable,$copyableEl){that.copyable=copyable;that.$copyableEl=$copyableEl;var position=$copyableEl.offset(), width=$copyableEl.outerWidth(),height=$copyableEl.outerHeight();reposition(position);resize(width,height);};that.unbind=function(){if(that.copyable){ that.copyable=that.$copyableEl=null;var position={top:-9999,left:-9999},width=1,height=1;reposition(position);resize(width,height);}}; function detectFlashSupport(){var hasFlash=false;if(typeof ActiveXObject==="function"){try{if(new ActiveXObject("ShockwaveFlash.ShockwaveFlash")){hasFlash=true;}}catch(error){}}
if(!hasFlash&&navigator.mimeTypes["application/x-shockwave-flash"]){hasFlash=true;}
return hasFlash;} 
function render(){var template="<div id='sm-clipboard-html-bridge' class='global-zeroclipboard-container'></div>";var $el=$(template),flashvars=_buildFlashVars(that.options),html='<object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" id="sm-clipboard-flash-bridge" width="100%" height="100%">'+'<param name="movie" value="'+that.options.moviePath+_noCache(that.options.moviePath,that.options)+'"/>'+'<param name="allowScriptAccess" value="'+that.options.allowScriptAccess+'"/>'+'<param name="scale" value="exactfit"/>'+'<param name="loop" value="false"/>'+'<param name="menu" value="false"/>'+'<param name="quality" value="best" />'+'<param name="bgcolor" value="#ffffff"/>'+'<param name="wmode" value="transparent"/>'+'<param name="flashvars" value="'+flashvars+'"/>'+'<embed src="'+that.options.moviePath+_noCache(that.options.moviePath,that.options)+'"loop="false" menu="false" quality="best" bgcolor="#ffffff" width="100%" height="100%"'+'name="sm-clipboard-flash-bridge" allowScriptAccess="always" allowFullScreen="false"'+'type="application/x-shockwave-flash" wmode="transparent"'+'pluginspage="http://www.macromedia.com/go/getflashplayer"'+'flashvars="'+flashvars+'"'+'scale="exactfit"></embed></object>';$el.css({position:"absolute",left:0,top:0,width:"10px",height:"100px",zIndex:"9999"});$el.html(html);that.$el=$el;that.flashBridge=$el.find("[name=sm-clipboard-flash-bridge]").get(0); return that;}
function _noCache(path,options){var useNoCache=!(options&&options.useNoCache===false);if(useNoCache){return(path.indexOf("?")===-1?"?":"&")+"nocache="+new Date().getTime();}else{return"";}}
function _buildFlashVars(options){var str=[],trustedOrigins=options.trustedOrigins;if(trustedOrigins){if(!trustedOrigins.length){throw("You must provide an array of domains for trustedOrigins. "+"For example: ['www.example.com', 'staging.example.com']");}
str.push("trustedOrigins="+encodeURIComponent(trustedOrigins.join(",")));}
return str.join("&");}
function _setText(text){if(that.isReady){that.flashBridge.setText(text);}}
function reposition(position){that.$el.css({top:position.top,left:position.left});}
function resize(width,height){that.$el.css({width:width,height:height});that.flashBridge.setSize(width,height);}
function _onLoaded(){that.isReady=true;that.flashBridge.setHandCursor(true);}
function _onMouseOver(){var hoverClass=that.copyable.options.hoverClass;if(hoverClass){that.$copyableEl.addClass(hoverClass);}}
function _onMouseOut(){var hoverClass=that.copyable.options.hoverClass;if(hoverClass){that.$copyableEl.removeClass(hoverClass);}
that.unbind();}
function _onDataRequested(){var text=that.copyable.getText(that.$copyableEl);_setText(text);}
function _onComplete(){that.$copyableEl.trigger("click");that.unbind();}} 
return{getInstance:function(){if(instance===undefined){instance=new JClipboard();instance.initialize();instance.constructor=null;}
return instance;},init:function(options){$.extend(_defaults,options);window.JClipboard=this.getInstance();}};})();var Copyable=function($elements,options){var that=this,_defaults={hoverClass:null,activeClass:null};that.getText=function($el){return that.text($el);};function initialize($elements,options){if(JClipboard.init){throw"You must initialize JClipboard before calling copyable()";}
that.$elements=$elements;that.options=$.extend(true,_defaults,options);that.text=options.text; _bindEvents();}
function _bindEvents(){that.$elements.on("mouseover",_onMouseOver);}
function _onMouseOver(e){var $target=$(e.target);JClipboard.bindTo(that,$target);}
initialize($elements,options);};
$.fn["copyable"]=function(options){var $elements=$(this);new Copyable($elements,options);};(function($,undefined){var uuid=0,runiqueId=/^ui-id-\d+$/;$.ui=$.ui||{};$.extend($.ui,{version:"1.10.3",keyCode:{BACKSPACE:8,COMMA:188,DELETE:46,DOWN:40,END:35,ENTER:13,ESCAPE:27,HOME:36,LEFT:37,NUMPAD_ADD:107,NUMPAD_DECIMAL:110,NUMPAD_DIVIDE:111,NUMPAD_ENTER:108,NUMPAD_MULTIPLY:106,NUMPAD_SUBTRACT:109,PAGE_DOWN:34,PAGE_UP:33,PERIOD:190,RIGHT:39,SPACE:32,TAB:9,UP:38}});$.fn.extend({focus:(function(orig){return function(delay,fn){return typeof delay==="number"?this.each(function(){var elem=this;setTimeout(function(){$(elem).focus();if(fn){fn.call(elem);}},delay);}):orig.apply(this,arguments);};})($.fn.focus),scrollParent:function(){var scrollParent;if(($.ui.ie&&(/(static|relative)/).test(this.css("position")))||(/absolute/).test(this.css("position"))){scrollParent=this.parents().filter(function(){return(/(relative|absolute|fixed)/).test($.css(this,"position"))&&(/(auto|scroll)/).test($.css(this,"overflow")+$.css(this,"overflow-y")+$.css(this,"overflow-x"));}).eq(0);}else{scrollParent=this.parents().filter(function(){return(/(auto|scroll)/).test($.css(this,"overflow")+$.css(this,"overflow-y")+$.css(this,"overflow-x"));}).eq(0);}
return(/fixed/).test(this.css("position"))||!scrollParent.length?$(document):scrollParent;},zIndex:function(zIndex){if(zIndex!==undefined){return this.css("zIndex",zIndex);}
if(this.length){var elem=$(this[0]),position,value;while(elem.length&&elem[0]!==document){

 position=elem.css("position");if(position==="absolute"||position==="relative"||position==="fixed"){


value=parseInt(elem.css("zIndex"),10);if(!isNaN(value)&&value!==0){return value;}}
elem=elem.parent();}}
return 0;},uniqueId:function(){return this.each(function(){if(!this.id){this.id="ui-id-"+(++uuid);}});},removeUniqueId:function(){return this.each(function(){if(runiqueId.test(this.id)){$(this).removeAttr("id");}});}});function focusable(element,isTabIndexNotNaN){var map,mapName,img,nodeName=element.nodeName.toLowerCase();if("area"===nodeName){map=element.parentNode;mapName=map.name;if(!element.href||!mapName||map.nodeName.toLowerCase()!=="map"){return false;}
img=$("img[usemap=#"+mapName+"]")[0];return!!img&&visible(img);}
return(/input|select|textarea|button|object/.test(nodeName)?!element.disabled:"a"===nodeName?element.href||isTabIndexNotNaN:isTabIndexNotNaN)&& visible(element);}
function visible(element){return $.expr.filters.visible(element)&&!$(element).parents().addBack().filter(function(){return $.css(this,"visibility")==="hidden";}).length;}
$.extend($.expr[":"],{data:$.expr.createPseudo?$.expr.createPseudo(function(dataName){return function(elem){return!!$.data(elem,dataName);};}): function(elem,i,match){return!!$.data(elem,match[3]);},focusable:function(element){return focusable(element,!isNaN($.attr(element,"tabindex")));},tabbable:function(element){var tabIndex=$.attr(element,"tabindex"),isTabIndexNaN=isNaN(tabIndex);return(isTabIndexNaN||tabIndex>=0)&&focusable(element,!isTabIndexNaN);}});if(!$("<a>").outerWidth(1).jquery){$.each(["Width","Height"],function(i,name){var side=name==="Width"?["Left","Right"]:["Top","Bottom"],type=name.toLowerCase(),orig={innerWidth:$.fn.innerWidth,innerHeight:$.fn.innerHeight,outerWidth:$.fn.outerWidth,outerHeight:$.fn.outerHeight};function reduce(elem,size,border,margin){$.each(side,function(){size-=parseFloat($.css(elem,"padding"+this))||0;if(border){size-=parseFloat($.css(elem,"border"+this+"Width"))||0;}
if(margin){size-=parseFloat($.css(elem,"margin"+this))||0;}});return size;}
$.fn["inner"+name]=function(size){if(size===undefined){return orig["inner"+name].call(this);}
return this.each(function(){$(this).css(type,reduce(this,size)+"px");});};$.fn["outer"+name]=function(size,margin){if(typeof size!=="number"){return orig["outer"+name].call(this,size);}
return this.each(function(){$(this).css(type,reduce(this,size,true,margin)+"px");});};});}
if(!$.fn.addBack){$.fn.addBack=function(selector){return this.add(selector==null?this.prevObject:this.prevObject.filter(selector));};}
if($("<a>").data("a-b","a").removeData("a-b").data("a-b")){$.fn.removeData=(function(removeData){return function(key){if(arguments.length){return removeData.call(this,$.camelCase(key));}else{return removeData.call(this);}};})($.fn.removeData);}
$.ui.ie=!!/msie [\w.]+/.exec(navigator.userAgent.toLowerCase());$.support.selectstart="onselectstart"in document.createElement("div");$.fn.extend({disableSelection:function(){return this.bind(($.support.selectstart?"selectstart":"mousedown")+".ui-disableSelection",function(event){event.preventDefault();});},enableSelection:function(){return this.unbind(".ui-disableSelection");}});$.extend($.ui,{plugin:{add:function(module,option,set){var i,proto=$.ui[module].prototype;for(i in set){proto.plugins[i]=proto.plugins[i]||[];proto.plugins[i].push([option,set[i]]);}},call:function(instance,name,args){var i,set=instance.plugins[name];if(!set||!instance.element[0].parentNode||instance.element[0].parentNode.nodeType===11){return;}
for(i=0;i<set.length;i++){if(instance.options[set[i][0]]){set[i][1].apply(instance.element,args);}}}}, hasScroll:function(el,a){ if($(el).css("overflow")==="hidden"){return false;}
var scroll=(a&&a==="left")?"scrollLeft":"scrollTop",has=false;if(el[scroll]>0){return true;}

 
el[scroll]=1;has=(el[scroll]>0);el[scroll]=0;return has;}});})(jQuery);(function($,undefined){var uuid=0,slice=Array.prototype.slice,_cleanData=$.cleanData;$.cleanData=function(elems){for(var i=0,elem;(elem=elems[i])!=null;i++){try{$(elem).triggerHandler("remove");}catch(e){}}
_cleanData(elems);};$.widget=function(name,base,prototype){var fullName,existingConstructor,constructor,basePrototype,
proxiedPrototype={},namespace=name.split(".")[0];name=name.split(".")[1];fullName=namespace+"-"+name;if(!prototype){prototype=base;base=$.Widget;} 
$.expr[":"][fullName.toLowerCase()]=function(elem){return!!$.data(elem,fullName);};$[namespace]=$[namespace]||{};existingConstructor=$[namespace][name];constructor=$[namespace][name]=function(options,element){ if(!this._createWidget){return new constructor(options,element);}

if(arguments.length){this._createWidget(options,element);}}; $.extend(constructor,existingConstructor,{version:prototype.version,
 _proto:$.extend({},prototype),
 _childConstructors:[]});basePrototype=new base();

 basePrototype.options=$.widget.extend({},basePrototype.options);$.each(prototype,function(prop,value){if(!$.isFunction(value)){proxiedPrototype[prop]=value;return;}
proxiedPrototype[prop]=(function(){var _super=function(){return base.prototype[prop].apply(this,arguments);},_superApply=function(args){return base.prototype[prop].apply(this,args);};return function(){var __super=this._super,__superApply=this._superApply,returnValue;this._super=_super;this._superApply=_superApply;returnValue=value.apply(this,arguments);this._super=__super;this._superApply=__superApply;return returnValue;};})();});constructor.prototype=$.widget.extend(basePrototype,{

 widgetEventPrefix:existingConstructor?basePrototype.widgetEventPrefix:name},proxiedPrototype,{constructor:constructor,namespace:namespace,widgetName:name,widgetFullName:fullName});


if(existingConstructor){$.each(existingConstructor._childConstructors,function(i,child){var childPrototype=child.prototype;
 $.widget(childPrototype.namespace+"."+childPrototype.widgetName,constructor,child._proto);});
 delete existingConstructor._childConstructors;}else{base._childConstructors.push(constructor);}
$.widget.bridge(name,constructor);};$.widget.extend=function(target){var input=slice.call(arguments,1),inputIndex=0,inputLength=input.length,key,value;for(;inputIndex<inputLength;inputIndex++){for(key in input[inputIndex]){value=input[inputIndex][key];if(input[inputIndex].hasOwnProperty(key)&&value!==undefined){ if($.isPlainObject(value)){target[key]=$.isPlainObject(target[key])?$.widget.extend({},target[key],value): $.widget.extend({},value);}else{target[key]=value;}}}}
return target;};$.widget.bridge=function(name,object){var fullName=object.prototype.widgetFullName||name;$.fn[name]=function(options){var isMethodCall=typeof options==="string",args=slice.call(arguments,1),returnValue=this; options=!isMethodCall&&args.length?$.widget.extend.apply(null,[options].concat(args)):options;if(isMethodCall){this.each(function(){var methodValue,instance=$.data(this,fullName);if(!instance){return $.error("cannot call methods on "+name+" prior to initialization; "+"attempted to call method '"+options+"'");}
if(!$.isFunction(instance[options])||options.charAt(0)==="_"){return $.error("no such method '"+options+"' for "+name+" widget instance");}
methodValue=instance[options].apply(instance,args);if(methodValue!==instance&&methodValue!==undefined){returnValue=methodValue&&methodValue.jquery?returnValue.pushStack(methodValue.get()):methodValue;return false;}});}else{this.each(function(){var instance=$.data(this,fullName);if(instance){instance.option(options||{})._init();}else{$.data(this,fullName,new object(options,this));}});}
return returnValue;};};$.Widget=function(){};$.Widget._childConstructors=[];$.Widget.prototype={widgetName:"widget",widgetEventPrefix:"",defaultElement:"<div>",options:{disabled:false, create:null},_createWidget:function(options,element){element=$(element||this.defaultElement||this)[0];this.element=$(element);this.uuid=uuid++;this.eventNamespace="."+this.widgetName+this.uuid;this.options=$.widget.extend({},this.options,this._getCreateOptions(),options);this.bindings=$();this.hoverable=$();this.focusable=$();if(element!==this){$.data(element,this.widgetFullName,this);this._on(true,this.element,{remove:function(event){if(event.target===element){this.destroy();}}});this.document=$(element.style? element.ownerDocument: element.document||element);this.window=$(this.document[0].defaultView||this.document[0].parentWindow);}
this._create();this._trigger("create",null,this._getCreateEventData());this._init();},_getCreateOptions:$.noop,_getCreateEventData:$.noop,_create:$.noop,_init:$.noop,destroy:function(){this._destroy();
this.element.unbind(this.eventNamespace)

.removeData(this.widgetName).removeData(this.widgetFullName)

.removeData($.camelCase(this.widgetFullName));this.widget().unbind(this.eventNamespace).removeAttr("aria-disabled").removeClass(this.widgetFullName+"-disabled "+"ui-state-disabled"); this.bindings.unbind(this.eventNamespace);this.hoverable.removeClass("ui-state-hover");this.focusable.removeClass("ui-state-focus");},_destroy:$.noop,widget:function(){return this.element;},option:function(key,value){var options=key,parts,curOption,i;if(arguments.length===0){ return $.widget.extend({},this.options);}
if(typeof key==="string"){options={};parts=key.split(".");key=parts.shift();if(parts.length){curOption=options[key]=$.widget.extend({},this.options[key]);for(i=0;i<parts.length-1;i++){curOption[parts[i]]=curOption[parts[i]]||{};curOption=curOption[parts[i]];}
key=parts.pop();if(value===undefined){return curOption[key]===undefined?null:curOption[key];}
curOption[key]=value;}else{if(value===undefined){return this.options[key]===undefined?null:this.options[key];}
options[key]=value;}}
this._setOptions(options);return this;},_setOptions:function(options){var key;for(key in options){this._setOption(key,options[key]);}
return this;},_setOption:function(key,value){this.options[key]=value;if(key==="disabled"){this.widget().toggleClass(this.widgetFullName+"-disabled ui-state-disabled",!!value).attr("aria-disabled",value);this.hoverable.removeClass("ui-state-hover");this.focusable.removeClass("ui-state-focus");}
return this;},enable:function(){return this._setOption("disabled",false);},disable:function(){return this._setOption("disabled",true);},_on:function(suppressDisabledCheck,element,handlers){var delegateElement,instance=this; if(typeof suppressDisabledCheck!=="boolean"){handlers=element;element=suppressDisabledCheck;suppressDisabledCheck=false;} 
if(!handlers){handlers=element;element=this.element;delegateElement=this.widget();}else{ element=delegateElement=$(element);this.bindings=this.bindings.add(element);}
$.each(handlers,function(event,handler){function handlerProxy(){

 if(!suppressDisabledCheck&&(instance.options.disabled===true||$(this).hasClass("ui-state-disabled"))){return;}
return(typeof handler==="string"?instance[handler]:handler).apply(instance,arguments);} 
if(typeof handler!=="string"){handlerProxy.guid=handler.guid=handler.guid||handlerProxy.guid||$.guid++;}
var match=event.match(/^(\w+)\s*(.*)$/),eventName=match[1]+instance.eventNamespace,selector=match[2];if(selector){delegateElement.delegate(selector,eventName,handlerProxy);}else{element.bind(eventName,handlerProxy);}});},_off:function(element,eventName){eventName=(eventName||"").split(" ").join(this.eventNamespace+" ")+this.eventNamespace;element.unbind(eventName).undelegate(eventName);},_delay:function(handler,delay){function handlerProxy(){return(typeof handler==="string"?instance[handler]:handler).apply(instance,arguments);}
var instance=this;return setTimeout(handlerProxy,delay||0);},_hoverable:function(element){this.hoverable=this.hoverable.add(element);this._on(element,{mouseenter:function(event){$(event.currentTarget).addClass("ui-state-hover");},mouseleave:function(event){$(event.currentTarget).removeClass("ui-state-hover");}});},_focusable:function(element){this.focusable=this.focusable.add(element);this._on(element,{focusin:function(event){$(event.currentTarget).addClass("ui-state-focus");},focusout:function(event){$(event.currentTarget).removeClass("ui-state-focus");}});},_trigger:function(type,event,data){var prop,orig,callback=this.options[type];data=data||{};event=$.Event(event);event.type=(type===this.widgetEventPrefix?type:this.widgetEventPrefix+type).toLowerCase();
 event.target=this.element[0]; orig=event.originalEvent;if(orig){for(prop in orig){if(!(prop in event)){event[prop]=orig[prop];}}}
this.element.trigger(event,data);return!($.isFunction(callback)&&callback.apply(this.element[0],[event].concat(data))===false||event.isDefaultPrevented());}};$.each({show:"fadeIn",hide:"fadeOut"},function(method,defaultEffect){$.Widget.prototype["_"+method]=function(element,options,callback){if(typeof options==="string"){options={effect:options};}
var hasOptions,effectName=!options?method:options===true||typeof options==="number"?defaultEffect:options.effect||defaultEffect;options=options||{};if(typeof options==="number"){options={duration:options};}
hasOptions=!$.isEmptyObject(options);options.complete=callback;if(options.delay){element.delay(options.delay);}
if(hasOptions&&$.effects&&$.effects.effect[effectName]){element[method](options);}else if(effectName!==method&&element[effectName]){element[effectName](options.duration,options.easing,callback);}else{element.queue(function(next){$(this)[method]();if(callback){callback.call(element[0]);}
next();});}};});})(jQuery);(function($,undefined){var mouseHandled=false;$(document).mouseup(function(){mouseHandled=false;});$.widget("ui.mouse",{version:"1.10.3",options:{cancel:"input,textarea,button,select,option",distance:1,delay:0},_mouseInit:function(){var that=this;this.element.bind("mousedown."+this.widgetName,function(event){return that._mouseDown(event);}).bind("click."+this.widgetName,function(event){if(true===$.data(event.target,that.widgetName+".preventClickEvent")){$.removeData(event.target,that.widgetName+".preventClickEvent");event.stopImmediatePropagation();return false;}});this.started=false;},
 _mouseDestroy:function(){this.element.unbind("."+this.widgetName);if(this._mouseMoveDelegate){$(document).unbind("mousemove."+this.widgetName,this._mouseMoveDelegate).unbind("mouseup."+this.widgetName,this._mouseUpDelegate);}},_mouseDown:function(event){ if(mouseHandled){return;}
(this._mouseStarted&&this._mouseUp(event));this._mouseDownEvent=event;var that=this,btnIsLeft=(event.which===1),
elIsCancel=(typeof this.options.cancel==="string"&&event.target.nodeName?$(event.target).closest(this.options.cancel).length:false);if(!btnIsLeft||elIsCancel||!this._mouseCapture(event)){return true;}
this.mouseDelayMet=!this.options.delay;if(!this.mouseDelayMet){this._mouseDelayTimer=setTimeout(function(){that.mouseDelayMet=true;},this.options.delay);}
if(this._mouseDistanceMet(event)&&this._mouseDelayMet(event)){this._mouseStarted=(this._mouseStart(event)!==false);if(!this._mouseStarted){event.preventDefault();return true;}}
if(true===$.data(event.target,this.widgetName+".preventClickEvent")){$.removeData(event.target,this.widgetName+".preventClickEvent");} 
this._mouseMoveDelegate=function(event){return that._mouseMove(event);};this._mouseUpDelegate=function(event){return that._mouseUp(event);};$(document).bind("mousemove."+this.widgetName,this._mouseMoveDelegate).bind("mouseup."+this.widgetName,this._mouseUpDelegate);event.preventDefault();mouseHandled=true;return true;},_mouseMove:function(event){ if($.ui.ie&&(!document.documentMode||document.documentMode<9)&&!event.button){return this._mouseUp(event);}
if(this._mouseStarted){this._mouseDrag(event);return event.preventDefault();}
if(this._mouseDistanceMet(event)&&this._mouseDelayMet(event)){this._mouseStarted=(this._mouseStart(this._mouseDownEvent,event)!==false);(this._mouseStarted?this._mouseDrag(event):this._mouseUp(event));}
return!this._mouseStarted;},_mouseUp:function(event){$(document).unbind("mousemove."+this.widgetName,this._mouseMoveDelegate).unbind("mouseup."+this.widgetName,this._mouseUpDelegate);if(this._mouseStarted){this._mouseStarted=false;if(event.target===this._mouseDownEvent.target){$.data(event.target,this.widgetName+".preventClickEvent",true);}
this._mouseStop(event);}
return false;},_mouseDistanceMet:function(event){return(Math.max(Math.abs(this._mouseDownEvent.pageX-event.pageX),Math.abs(this._mouseDownEvent.pageY-event.pageY))>=this.options.distance);},_mouseDelayMet:function(){return this.mouseDelayMet;}, _mouseStart:function(){},_mouseDrag:function(){},_mouseStop:function(){},_mouseCapture:function(){return true;}});})(jQuery);(function($,undefined){function isOverAxis(x,reference,size){return(x>reference)&&(x<(reference+size));}
function isFloating(item){return(/left|right/).test(item.css("float"))||(/inline|table-cell/).test(item.css("display"));}
$.widget("ui.sortable",$.ui.mouse,{version:"1.10.3",widgetEventPrefix:"sort",ready:false,options:{appendTo:"parent",axis:false,connectWith:false,containment:false,cursor:"auto",cursorAt:false,dropOnEmpty:true,forcePlaceholderSize:false,forceHelperSize:false,grid:false,handle:false,helper:"original",items:"> *",opacity:false,placeholder:false,revert:false,scroll:true,scrollSensitivity:20,scrollSpeed:20,scope:"default",tolerance:"intersect",zIndex:1000, activate:null,beforeStop:null,change:null,deactivate:null,out:null,over:null,receive:null,remove:null,sort:null,start:null,stop:null,update:null},_create:function(){var o=this.options;this.containerCache={};this.element.addClass("ui-sortable"); this.refresh(); this.floating=this.items.length?o.axis==="x"||isFloating(this.items[0].item):false; this.offset=this.element.offset(); this._mouseInit(); this.ready=true;},_destroy:function(){this.element.removeClass("ui-sortable ui-sortable-disabled");this._mouseDestroy();for(var i=this.items.length-1;i>=0;i--){this.items[i].item.removeData(this.widgetName+"-item");}
return this;},_setOption:function(key,value){if(key==="disabled"){this.options[key]=value;this.widget().toggleClass("ui-sortable-disabled",!!value);}else{ $.Widget.prototype._setOption.apply(this,arguments);}},_mouseCapture:function(event,overrideHandle){var currentItem=null,validHandle=false,that=this;if(this.reverting){return false;}
if(this.options.disabled||this.options.type==="static"){return false;} 
this._refreshItems(event); $(event.target).parents().each(function(){if($.data(this,that.widgetName+"-item")===that){currentItem=$(this);return false;}});if($.data(event.target,that.widgetName+"-item")===that){currentItem=$(event.target);}
if(!currentItem){return false;}
if(this.options.handle&&!overrideHandle){$(this.options.handle,currentItem).find("*").addBack().each(function(){if(this===event.target){validHandle=true;}});if(!validHandle){return false;}}
this.currentItem=currentItem;this._removeCurrentsFromItems();return true;},_mouseStart:function(event,overrideHandle,noActivation){var i,body,o=this.options;this.currentContainer=this; this.refreshPositions(); this.helper=this._createHelper(event); this._cacheHelperProportions(); this._cacheMargins(); this.scrollParent=this.helper.scrollParent(); this.offset=this.currentItem.offset();this.offset={top:this.offset.top-this.margins.top,left:this.offset.left-this.margins.left};$.extend(this.offset,{click:{ left:event.pageX-this.offset.left,top:event.pageY-this.offset.top},parent:this._getParentOffset(),relative:this._getRelativeOffset()
});
 this.helper.css("position","absolute");this.cssPosition=this.helper.css("position"); this.originalPosition=this._generatePosition(event);this.originalPageX=event.pageX;this.originalPageY=event.pageY;(o.cursorAt&&this._adjustOffsetFromHelper(o.cursorAt)); this.domPosition={prev:this.currentItem.prev()[0],parent:this.currentItem.parent()[0]}; if(this.helper[0]!==this.currentItem[0]){this.currentItem.hide();} 
this._createPlaceholder(); if(o.containment){this._setContainment();}
if(o.cursor&&o.cursor!=="auto"){ body=this.document.find("body"); this.storedCursor=body.css("cursor");body.css("cursor",o.cursor);this.storedStylesheet=$("<style>*{ cursor: "+o.cursor+" !important; }</style>").appendTo(body);}
if(o.opacity){ if(this.helper.css("opacity")){this._storedOpacity=this.helper.css("opacity");}
this.helper.css("opacity",o.opacity);}
if(o.zIndex){ if(this.helper.css("zIndex")){this._storedZIndex=this.helper.css("zIndex");}
this.helper.css("zIndex",o.zIndex);} 
if(this.scrollParent[0]!==document&&this.scrollParent[0].tagName!=="HTML"){this.overflowOffset=this.scrollParent.offset();} 
this._trigger("start",event,this._uiHash()); if(!this._preserveHelperProportions){this._cacheHelperProportions();} 
if(!noActivation){for(i=this.containers.length-1;i>=0;i--){this.containers[i]._trigger("activate",event,this._uiHash(this));}} 
if($.ui.ddmanager){$.ui.ddmanager.current=this;}
if($.ui.ddmanager&&!o.dropBehaviour){$.ui.ddmanager.prepareOffsets(this,event);}
this.dragging=true;this.helper.addClass("ui-sortable-helper");this._mouseDrag(event); return true;},_mouseDrag:function(event){var i,item,itemElement,intersection,o=this.options,scrolled=false; this.position=this._generatePosition(event);this.positionAbs=this._convertPositionTo("absolute");if(!this.lastPositionAbs){this.lastPositionAbs=this.positionAbs;} 
if(this.options.scroll){if(this.scrollParent[0]!==document&&this.scrollParent[0].tagName!=="HTML"){if((this.overflowOffset.top+this.scrollParent[0].offsetHeight)-event.pageY<o.scrollSensitivity){this.scrollParent[0].scrollTop=scrolled=this.scrollParent[0].scrollTop+o.scrollSpeed;}else if(event.pageY-this.overflowOffset.top<o.scrollSensitivity){this.scrollParent[0].scrollTop=scrolled=this.scrollParent[0].scrollTop-o.scrollSpeed;}
if((this.overflowOffset.left+this.scrollParent[0].offsetWidth)-event.pageX<o.scrollSensitivity){this.scrollParent[0].scrollLeft=scrolled=this.scrollParent[0].scrollLeft+o.scrollSpeed;}else if(event.pageX-this.overflowOffset.left<o.scrollSensitivity){this.scrollParent[0].scrollLeft=scrolled=this.scrollParent[0].scrollLeft-o.scrollSpeed;}}else{if(event.pageY-$(document).scrollTop()<o.scrollSensitivity){scrolled=$(document).scrollTop($(document).scrollTop()-o.scrollSpeed);}else if($(window).height()-(event.pageY-$(document).scrollTop())<o.scrollSensitivity){scrolled=$(document).scrollTop($(document).scrollTop()+o.scrollSpeed);}
if(event.pageX-$(document).scrollLeft()<o.scrollSensitivity){scrolled=$(document).scrollLeft($(document).scrollLeft()-o.scrollSpeed);}else if($(window).width()-(event.pageX-$(document).scrollLeft())<o.scrollSensitivity){scrolled=$(document).scrollLeft($(document).scrollLeft()+o.scrollSpeed);}}
if(scrolled!==false&&$.ui.ddmanager&&!o.dropBehaviour){$.ui.ddmanager.prepareOffsets(this,event);}} 
this.positionAbs=this._convertPositionTo("absolute"); if(!this.options.axis||this.options.axis!=="y"){this.helper[0].style.left=this.position.left+"px";}
if(!this.options.axis||this.options.axis!=="x"){this.helper[0].style.top=this.position.top+"px";} 
for(i=this.items.length-1;i>=0;i--){ item=this.items[i];itemElement=item.item[0];intersection=this._intersectsWithPointer(item);if(!intersection){continue;}




if(item.instance!==this.currentContainer){continue;}

 
if(itemElement!==this.currentItem[0]&&this.placeholder[intersection===1?"next":"prev"]()[0]!==itemElement&&!$.contains(this.placeholder[0],itemElement)&&(this.options.type==="semi-dynamic"?!$.contains(this.element[0],itemElement):true)){this.direction=intersection===1?"down":"up";if(this.options.tolerance==="pointer"||this._intersectsWithSides(item)){this._rearrange(event,item);}else{break;}
this._trigger("change",event,this._uiHash());break;}} 
this._contactContainers(event); if($.ui.ddmanager){$.ui.ddmanager.drag(this,event);} 
this._trigger("sort",event,this._uiHash());this.lastPositionAbs=this.positionAbs;return false;},_mouseStop:function(event,noPropagation){if(!event){return;} 
if($.ui.ddmanager&&!this.options.dropBehaviour){$.ui.ddmanager.drop(this,event);}
if(this.options.revert){var that=this,cur=this.placeholder.offset(),axis=this.options.axis,animation={};if(!axis||axis==="x"){animation.left=cur.left-this.offset.parent.left-this.margins.left+(this.offsetParent[0]===document.body?0:this.offsetParent[0].scrollLeft);}
if(!axis||axis==="y"){animation.top=cur.top-this.offset.parent.top-this.margins.top+(this.offsetParent[0]===document.body?0:this.offsetParent[0].scrollTop);}
this.reverting=true;$(this.helper).animate(animation,parseInt(this.options.revert,10)||500,function(){that._clear(event);});}else{this._clear(event,noPropagation);}
return false;},cancel:function(){if(this.dragging){this._mouseUp({target:null});if(this.options.helper==="original"){this.currentItem.css(this._storedCSS).removeClass("ui-sortable-helper");}else{this.currentItem.show();} 
for(var i=this.containers.length-1;i>=0;i--){this.containers[i]._trigger("deactivate",null,this._uiHash(this));if(this.containers[i].containerCache.over){this.containers[i]._trigger("out",null,this._uiHash(this));this.containers[i].containerCache.over=0;}}}
if(this.placeholder){if(this.placeholder[0].parentNode){this.placeholder[0].parentNode.removeChild(this.placeholder[0]);}
if(this.options.helper!=="original"&&this.helper&&this.helper[0].parentNode){this.helper.remove();}
$.extend(this,{helper:null,dragging:false,reverting:false,_noFinalSort:null});if(this.domPosition.prev){$(this.domPosition.prev).after(this.currentItem);}else{$(this.domPosition.parent).prepend(this.currentItem);}}
return this;},serialize:function(o){var items=this._getItemsAsjQuery(o&&o.connected),str=[];o=o||{};$(items).each(function(){var res=($(o.item||this).attr(o.attribute||"id")||"").match(o.expression||(/(.+)[\-=_](.+)/));if(res){str.push((o.key||res[1]+"[]")+"="+(o.key&&o.expression?res[1]:res[2]));}});if(!str.length&&o.key){str.push(o.key+"=");}
return str.join("&");},toArray:function(o){var items=this._getItemsAsjQuery(o&&o.connected),ret=[];o=o||{};items.each(function(){ret.push($(o.item||this).attr(o.attribute||"id")||"");});return ret;},_intersectsWith:function(item){var x1=this.positionAbs.left,x2=x1+this.helperProportions.width,y1=this.positionAbs.top,y2=y1+this.helperProportions.height,l=item.left,r=l+item.width,t=item.top,b=t+item.height,dyClick=this.offset.click.top,dxClick=this.offset.click.left,isOverElementHeight=(this.options.axis==="x")||((y1+dyClick)>t&&(y1+dyClick)<b),isOverElementWidth=(this.options.axis==="y")||((x1+dxClick)>l&&(x1+dxClick)<r),isOverElement=isOverElementHeight&&isOverElementWidth;if(this.options.tolerance==="pointer"||this.options.forcePointerForContainers||(this.options.tolerance!=="pointer"&&this.helperProportions[this.floating?"width":"height"]>item[this.floating?"width":"height"])){return isOverElement;}else{return(l<x1+(this.helperProportions.width/2)&& x2-(this.helperProportions.width/2)<r&& t<y1+(this.helperProportions.height/2)&& y2-(this.helperProportions.height/2)<b);}},_intersectsWithPointer:function(item){var isOverElementHeight=(this.options.axis==="x")||isOverAxis(this.positionAbs.top+this.offset.click.top,item.top,item.height),isOverElementWidth=(this.options.axis==="y")||isOverAxis(this.positionAbs.left+this.offset.click.left,item.left,item.width),isOverElement=isOverElementHeight&&isOverElementWidth,verticalDirection=this._getDragVerticalDirection(),horizontalDirection=this._getDragHorizontalDirection();if(!isOverElement){return false;}
return this.floating?(((horizontalDirection&&horizontalDirection==="right")||verticalDirection==="down")?2:1):(verticalDirection&&(verticalDirection==="down"?2:1));},_intersectsWithSides:function(item){var isOverBottomHalf=isOverAxis(this.positionAbs.top+this.offset.click.top,item.top+(item.height/2),item.height),isOverRightHalf=isOverAxis(this.positionAbs.left+this.offset.click.left,item.left+(item.width/2),item.width),verticalDirection=this._getDragVerticalDirection(),horizontalDirection=this._getDragHorizontalDirection();if(this.floating&&horizontalDirection){return((horizontalDirection==="right"&&isOverRightHalf)||(horizontalDirection==="left"&&!isOverRightHalf));}else{return verticalDirection&&((verticalDirection==="down"&&isOverBottomHalf)||(verticalDirection==="up"&&!isOverBottomHalf));}},_getDragVerticalDirection:function(){var delta=this.positionAbs.top-this.lastPositionAbs.top;return delta!==0&&(delta>0?"down":"up");},_getDragHorizontalDirection:function(){var delta=this.positionAbs.left-this.lastPositionAbs.left;return delta!==0&&(delta>0?"right":"left");},refresh:function(event){this._refreshItems(event);this.refreshPositions();return this;},_connectWith:function(){var options=this.options;return options.connectWith.constructor===String?[options.connectWith]:options.connectWith;},_getItemsAsjQuery:function(connected){var i,j,cur,inst,items=[],queries=[],connectWith=this._connectWith();if(connectWith&&connected){for(i=connectWith.length-1;i>=0;i--){cur=$(connectWith[i]);for(j=cur.length-1;j>=0;j--){inst=$.data(cur[j],this.widgetFullName);if(inst&&inst!==this&&!inst.options.disabled){queries.push([$.isFunction(inst.options.items)?inst.options.items.call(inst.element):$(inst.options.items,inst.element).not(".ui-sortable-helper").not(".ui-sortable-placeholder"),inst]);}}}}
queries.push([$.isFunction(this.options.items)?this.options.items.call(this.element,null,{options:this.options,item:this.currentItem}):$(this.options.items,this.element).not(".ui-sortable-helper").not(".ui-sortable-placeholder"),this]);for(i=queries.length-1;i>=0;i--){queries[i][0].each(function(){items.push(this);});}
return $(items);},_removeCurrentsFromItems:function(){var list=this.currentItem.find(":data("+this.widgetName+"-item)");this.items=$.grep(this.items,function(item){for(var j=0;j<list.length;j++){if(list[j]===item.item[0]){return false;}}
return true;});},_refreshItems:function(event){this.items=[];this.containers=[this];var i,j,cur,inst,targetData,_queries,item,queriesLength,items=this.items,queries=[[$.isFunction(this.options.items)?this.options.items.call(this.element[0],event,{item:this.currentItem}):$(this.options.items,this.element),this]],connectWith=this._connectWith();if(connectWith&&this.ready){ for(i=connectWith.length-1;i>=0;i--){cur=$(connectWith[i]);for(j=cur.length-1;j>=0;j--){inst=$.data(cur[j],this.widgetFullName);if(inst&&inst!==this&&!inst.options.disabled){queries.push([$.isFunction(inst.options.items)?inst.options.items.call(inst.element[0],event,{item:this.currentItem}):$(inst.options.items,inst.element),inst]);this.containers.push(inst);}}}}
for(i=queries.length-1;i>=0;i--){targetData=queries[i][1];_queries=queries[i][0];for(j=0,queriesLength=_queries.length;j<queriesLength;j++){item=$(_queries[j]);item.data(this.widgetName+"-item",targetData);items.push({item:item,instance:targetData,width:0,height:0,left:0,top:0});}}},refreshPositions:function(fast){ if(this.offsetParent&&this.helper){this.offset.parent=this._getParentOffset();}
var i,item,t,p;for(i=this.items.length-1;i>=0;i--){item=this.items[i]; if(item.instance!==this.currentContainer&&this.currentContainer&&item.item[0]!==this.currentItem[0]){continue;}
t=this.options.toleranceElement?$(this.options.toleranceElement,item.item):item.item;if(!fast){item.width=t.outerWidth();item.height=t.outerHeight();}
p=t.offset();item.left=p.left;item.top=p.top;}
if(this.options.custom&&this.options.custom.refreshContainers){this.options.custom.refreshContainers.call(this);}else{for(i=this.containers.length-1;i>=0;i--){p=this.containers[i].element.offset();this.containers[i].containerCache.left=p.left;this.containers[i].containerCache.top=p.top;this.containers[i].containerCache.width=this.containers[i].element.outerWidth();this.containers[i].containerCache.height=this.containers[i].element.outerHeight();}}
return this;},_createPlaceholder:function(that){that=that||this;var className,o=that.options;if(!o.placeholder||o.placeholder.constructor===String){className=o.placeholder;o.placeholder={element:function(){var nodeName=that.currentItem[0].nodeName.toLowerCase(),element=$("<"+nodeName+">",that.document[0]).addClass(className||that.currentItem[0].className+" ui-sortable-placeholder").removeClass("ui-sortable-helper");if(nodeName==="tr"){that.currentItem.children().each(function(){$("<td>&#160;</td>",that.document[0]).attr("colspan",$(this).attr("colspan")||1).appendTo(element);});}else if(nodeName==="img"){element.attr("src",that.currentItem.attr("src"));}
if(!className){element.css("visibility","hidden");}
return element;},update:function(container,p){
 if(className&&!o.forcePlaceholderSize){return;} 
if(!p.height()){p.height(that.currentItem.innerHeight()-parseInt(that.currentItem.css("paddingTop")||0,10)-parseInt(that.currentItem.css("paddingBottom")||0,10));}
if(!p.width()){p.width(that.currentItem.innerWidth()-parseInt(that.currentItem.css("paddingLeft")||0,10)-parseInt(that.currentItem.css("paddingRight")||0,10));}}};} 
that.placeholder=$(o.placeholder.element.call(that.element,that.currentItem)); that.currentItem.after(that.placeholder);o.placeholder.update(that,that.placeholder);},_contactContainers:function(event){var i,j,dist,itemWithLeastDistance,posProperty,sizeProperty,base,cur,nearBottom,floating,innermostContainer=null,innermostIndex=null; for(i=this.containers.length-1;i>=0;i--){ if($.contains(this.currentItem[0],this.containers[i].element[0])){continue;}
if(this._intersectsWith(this.containers[i].containerCache)){ if(innermostContainer&&$.contains(this.containers[i].element[0],innermostContainer.element[0])){continue;}
innermostContainer=this.containers[i];innermostIndex=i;}else{ if(this.containers[i].containerCache.over){this.containers[i]._trigger("out",event,this._uiHash(this));this.containers[i].containerCache.over=0;}}} 
if(!innermostContainer){return;} 
if(this.containers.length===1){if(!this.containers[innermostIndex].containerCache.over){this.containers[innermostIndex]._trigger("over",event,this._uiHash(this));this.containers[innermostIndex].containerCache.over=1;}}else{ dist=10000;itemWithLeastDistance=null;floating=innermostContainer.floating||isFloating(this.currentItem);posProperty=floating?"left":"top";sizeProperty=floating?"width":"height";base=this.positionAbs[posProperty]+this.offset.click[posProperty];for(j=this.items.length-1;j>=0;j--){if(!$.contains(this.containers[innermostIndex].element[0],this.items[j].item[0])){continue;}
if(this.items[j].item[0]===this.currentItem[0]){continue;}
if(floating&&!isOverAxis(this.positionAbs.top+this.offset.click.top,this.items[j].top,this.items[j].height)){continue;}
cur=this.items[j].item.offset()[posProperty];nearBottom=false;if(Math.abs(cur-base)>Math.abs(cur+this.items[j][sizeProperty]-base)){nearBottom=true;cur+=this.items[j][sizeProperty];}
if(Math.abs(cur-base)<dist){dist=Math.abs(cur-base);itemWithLeastDistance=this.items[j];this.direction=nearBottom?"up":"down";}} 
if(!itemWithLeastDistance&&!this.options.dropOnEmpty){return;}
if(this.currentContainer===this.containers[innermostIndex]){return;}
itemWithLeastDistance?this._rearrange(event,itemWithLeastDistance,null,true):this._rearrange(event,null,this.containers[innermostIndex].element,true);this._trigger("change",event,this._uiHash());this.containers[innermostIndex]._trigger("change",event,this._uiHash(this));this.currentContainer=this.containers[innermostIndex]; this.options.placeholder.update(this.currentContainer,this.placeholder);this.containers[innermostIndex]._trigger("over",event,this._uiHash(this));this.containers[innermostIndex].containerCache.over=1;}},_createHelper:function(event){var o=this.options,helper=$.isFunction(o.helper)?$(o.helper.apply(this.element[0],[event,this.currentItem])):(o.helper==="clone"?this.currentItem.clone():this.currentItem); if(!helper.parents("body").length){$(o.appendTo!=="parent"?o.appendTo:this.currentItem[0].parentNode)[0].appendChild(helper[0]);}
if(helper[0]===this.currentItem[0]){this._storedCSS={width:this.currentItem[0].style.width,height:this.currentItem[0].style.height,position:this.currentItem.css("position"),top:this.currentItem.css("top"),left:this.currentItem.css("left")};}
if(!helper[0].style.width||o.forceHelperSize){helper.width(this.currentItem.width());}
if(!helper[0].style.height||o.forceHelperSize){helper.height(this.currentItem.height());}
return helper;},_adjustOffsetFromHelper:function(obj){if(typeof obj==="string"){obj=obj.split(" ");}
if($.isArray(obj)){obj={left:+obj[0],top:+obj[1]||0};}
if("left"in obj){this.offset.click.left=obj.left+this.margins.left;}
if("right"in obj){this.offset.click.left=this.helperProportions.width-obj.right+this.margins.left;}
if("top"in obj){this.offset.click.top=obj.top+this.margins.top;}
if("bottom"in obj){this.offset.click.top=this.helperProportions.height-obj.bottom+this.margins.top;}},_getParentOffset:function(){ this.offsetParent=this.helper.offsetParent();var po=this.offsetParent.offset();

 if(this.cssPosition==="absolute"&&this.scrollParent[0]!==document&&$.contains(this.scrollParent[0],this.offsetParent[0])){po.left+=this.scrollParent.scrollLeft();po.top+=this.scrollParent.scrollTop();}
 
if(this.offsetParent[0]===document.body||(this.offsetParent[0].tagName&&this.offsetParent[0].tagName.toLowerCase()==="html"&&$.ui.ie)){po={top:0,left:0};}
return{top:po.top+(parseInt(this.offsetParent.css("borderTopWidth"),10)||0),left:po.left+(parseInt(this.offsetParent.css("borderLeftWidth"),10)||0)};},_getRelativeOffset:function(){if(this.cssPosition==="relative"){var p=this.currentItem.position();return{top:p.top-(parseInt(this.helper.css("top"),10)||0)+this.scrollParent.scrollTop(),left:p.left-(parseInt(this.helper.css("left"),10)||0)+this.scrollParent.scrollLeft()};}else{return{top:0,left:0};}},_cacheMargins:function(){this.margins={left:(parseInt(this.currentItem.css("marginLeft"),10)||0),top:(parseInt(this.currentItem.css("marginTop"),10)||0)};},_cacheHelperProportions:function(){this.helperProportions={width:this.helper.outerWidth(),height:this.helper.outerHeight()};},_setContainment:function(){var ce,co,over,o=this.options;if(o.containment==="parent"){o.containment=this.helper[0].parentNode;}
if(o.containment==="document"||o.containment==="window"){this.containment=[0-this.offset.relative.left-this.offset.parent.left,0-this.offset.relative.top-this.offset.parent.top,$(o.containment==="document"?document:window).width()-this.helperProportions.width-this.margins.left,($(o.containment==="document"?document:window).height()||document.body.parentNode.scrollHeight)-this.helperProportions.height-this.margins.top];}
if(!(/^(document|window|parent)$/).test(o.containment)){ce=$(o.containment)[0];co=$(o.containment).offset();over=($(ce).css("overflow")!=="hidden");this.containment=[co.left+(parseInt($(ce).css("borderLeftWidth"),10)||0)+(parseInt($(ce).css("paddingLeft"),10)||0)-this.margins.left,co.top+(parseInt($(ce).css("borderTopWidth"),10)||0)+(parseInt($(ce).css("paddingTop"),10)||0)-this.margins.top,co.left+(over?Math.max(ce.scrollWidth,ce.offsetWidth):ce.offsetWidth)-(parseInt($(ce).css("borderLeftWidth"),10)||0)-(parseInt($(ce).css("paddingRight"),10)||0)-this.helperProportions.width-this.margins.left,co.top+(over?Math.max(ce.scrollHeight,ce.offsetHeight):ce.offsetHeight)-(parseInt($(ce).css("borderTopWidth"),10)||0)-(parseInt($(ce).css("paddingBottom"),10)||0)-this.helperProportions.height-this.margins.top];}},_convertPositionTo:function(d,pos){if(!pos){pos=this.position;}
var mod=d==="absolute"?1:-1,scroll=this.cssPosition==="absolute"&&!(this.scrollParent[0]!==document&&$.contains(this.scrollParent[0],this.offsetParent[0]))?this.offsetParent:this.scrollParent,scrollIsRootNode=(/(html|body)/i).test(scroll[0].tagName);return{top:(pos.top+ this.offset.relative.top*mod+ this.offset.parent.top*mod-((this.cssPosition==="fixed"?-this.scrollParent.scrollTop():(scrollIsRootNode?0:scroll.scrollTop()))*mod)),left:(pos.left+ this.offset.relative.left*mod+ this.offset.parent.left*mod-((this.cssPosition==="fixed"?-this.scrollParent.scrollLeft():scrollIsRootNode?0:scroll.scrollLeft())*mod))};},_generatePosition:function(event){var top,left,o=this.options,pageX=event.pageX,pageY=event.pageY,scroll=this.cssPosition==="absolute"&&!(this.scrollParent[0]!==document&&$.contains(this.scrollParent[0],this.offsetParent[0]))?this.offsetParent:this.scrollParent,scrollIsRootNode=(/(html|body)/i).test(scroll[0].tagName);

 if(this.cssPosition==="relative"&&!(this.scrollParent[0]!==document&&this.scrollParent[0]!==this.offsetParent[0])){this.offset.relative=this._getRelativeOffset();}
if(this.originalPosition){ if(this.containment){if(event.pageX-this.offset.click.left<this.containment[0]){pageX=this.containment[0]+this.offset.click.left;}
if(event.pageY-this.offset.click.top<this.containment[1]){pageY=this.containment[1]+this.offset.click.top;}
if(event.pageX-this.offset.click.left>this.containment[2]){pageX=this.containment[2]+this.offset.click.left;}
if(event.pageY-this.offset.click.top>this.containment[3]){pageY=this.containment[3]+this.offset.click.top;}}
if(o.grid){top=this.originalPageY+Math.round((pageY-this.originalPageY)/o.grid[1])*o.grid[1];pageY=this.containment?((top-this.offset.click.top>=this.containment[1]&&top-this.offset.click.top<=this.containment[3])?top:((top-this.offset.click.top>=this.containment[1])?top-o.grid[1]:top+o.grid[1])):top;left=this.originalPageX+Math.round((pageX-this.originalPageX)/o.grid[0])*o.grid[0];pageX=this.containment?((left-this.offset.click.left>=this.containment[0]&&left-this.offset.click.left<=this.containment[2])?left:((left-this.offset.click.left>=this.containment[0])?left-o.grid[0]:left+o.grid[0])):left;}}
return{top:(pageY- this.offset.click.top-this.offset.relative.top- this.offset.parent.top+((this.cssPosition==="fixed"?-this.scrollParent.scrollTop():(scrollIsRootNode?0:scroll.scrollTop())))),left:(pageX- this.offset.click.left-this.offset.relative.left- this.offset.parent.left+((this.cssPosition==="fixed"?-this.scrollParent.scrollLeft():scrollIsRootNode?0:scroll.scrollLeft())))};},_rearrange:function(event,i,a,hardRefresh){a?a[0].appendChild(this.placeholder[0]):i.item[0].parentNode.insertBefore(this.placeholder[0],(this.direction==="down"?i.item[0]:i.item[0].nextSibling));


 this.counter=this.counter?++this.counter:1;var counter=this.counter;this._delay(function(){if(counter===this.counter){this.refreshPositions(!hardRefresh);}});},_clear:function(event,noPropagation){this.reverting=false;
 var i,delayedTriggers=[];
if(!this._noFinalSort&&this.currentItem.parent().length){this.placeholder.before(this.currentItem);}
this._noFinalSort=null;if(this.helper[0]===this.currentItem[0]){for(i in this._storedCSS){if(this._storedCSS[i]==="auto"||this._storedCSS[i]==="static"){this._storedCSS[i]="";}}
this.currentItem.css(this._storedCSS).removeClass("ui-sortable-helper");}else{this.currentItem.show();}
if(this.fromOutside&&!noPropagation){delayedTriggers.push(function(event){this._trigger("receive",event,this._uiHash(this.fromOutside));});}
if((this.fromOutside||this.domPosition.prev!==this.currentItem.prev().not(".ui-sortable-helper")[0]||this.domPosition.parent!==this.currentItem.parent()[0])&&!noPropagation){delayedTriggers.push(function(event){this._trigger("update",event,this._uiHash());});}

if(this!==this.currentContainer){if(!noPropagation){delayedTriggers.push(function(event){this._trigger("remove",event,this._uiHash());});delayedTriggers.push((function(c){return function(event){c._trigger("receive",event,this._uiHash(this));};}).call(this,this.currentContainer));delayedTriggers.push((function(c){return function(event){c._trigger("update",event,this._uiHash(this));};}).call(this,this.currentContainer));}} 
for(i=this.containers.length-1;i>=0;i--){if(!noPropagation){delayedTriggers.push((function(c){return function(event){c._trigger("deactivate",event,this._uiHash(this));};}).call(this,this.containers[i]));}
if(this.containers[i].containerCache.over){delayedTriggers.push((function(c){return function(event){c._trigger("out",event,this._uiHash(this));};}).call(this,this.containers[i]));this.containers[i].containerCache.over=0;}} 
if(this.storedCursor){this.document.find("body").css("cursor",this.storedCursor);this.storedStylesheet.remove();}
if(this._storedOpacity){this.helper.css("opacity",this._storedOpacity);}
if(this._storedZIndex){this.helper.css("zIndex",this._storedZIndex==="auto"?"":this._storedZIndex);}
this.dragging=false;if(this.cancelHelperRemoval){if(!noPropagation){this._trigger("beforeStop",event,this._uiHash());for(i=0;i<delayedTriggers.length;i++){delayedTriggers[i].call(this,event);} 
this._trigger("stop",event,this._uiHash());}
this.fromOutside=false;return false;}
if(!noPropagation){this._trigger("beforeStop",event,this._uiHash());}
this.placeholder[0].parentNode.removeChild(this.placeholder[0]);if(this.helper[0]!==this.currentItem[0]){this.helper.remove();}
this.helper=null;if(!noPropagation){for(i=0;i<delayedTriggers.length;i++){delayedTriggers[i].call(this,event);} 
this._trigger("stop",event,this._uiHash());}
this.fromOutside=false;return true;},_trigger:function(){if($.Widget.prototype._trigger.apply(this,arguments)===false){this.cancel();}},_uiHash:function(_inst){var inst=_inst||this;return{helper:inst.helper,placeholder:inst.placeholder||$([]),position:inst.position,originalPosition:inst.originalPosition,offset:inst.positionAbs,item:inst.currentItem,sender:_inst?_inst.element:null};}});})(jQuery);SM.Model={
 __create:function(kwargs){},__validators:undefined, __setters:undefined, __getters:undefined, __counter:0, __defaults:undefined,

 __initSettings:function(options){var key,overrides;this.__settings={};if(options){overrides={};for(key in this.__defaults){if(this.__defaults.hasOwnProperty(key)&&options.hasOwnProperty(key)){overrides[key]=options[key];}}
this.__settings=SM.Object.extend(this.__defaults,overrides);}else if(this.__defaults){this.__settings=SM.Object.copy(this.__defaults);}}, get:function(key,obj){var getters=this.__getters;if(key===undefined){return;}
if(getters&&getters[key]){return getters[key](this,obj);}else{return this[key];}}, set:function(key,val,options){var setters=this.__setters,oldVal=this[key],defaults={notify:false,validate:false},settings;if(options){settings=SM.Object.extend(defaults,options);}else{settings=defaults;}
if(settings.validate&&!this.validate(key,val)){return this;}
if(setters&&setters[key]){setters[key](this,val,settings);}else{this[key]=val;}
if(settings.notify){if(val!==oldVal){this._trigger({type:key+".changed",property:key,old:oldVal,value:val});}
this._trigger({type:key+".set",property:key,old:oldVal,value:val});}
return this;},on:function(event,data,callback){if(arguments.length<3){throw new Error("model.bind requires three arguments");}else if(!event||!data||!callback){throw new Error("model.bind must be passed an event, data, and callback");}
this._$.on(event,data,callback);return this;},off:function(event,callback){this._$.off(event,callback);},validateKeyValue:function(key,value){var validation=this.__validators[key]?this.__validators[key](this,value):{isValid:true};if(!validation.isValid){validation.property=key;validation.value=value;return validation;}
return{isValid:true};},validateGroup:function(group){var key,validation,validations={isValid:true,invalids:{}};for(key in group){if(!group.hasOwnProperty(key)){continue;}
validation=this.validateKeyValue(key,group[key]);if(!validation.isValid){validations.isValid=false;validations.invalids[key]=validation;}}
return validations;},validate:function(){var self=this,validators=this.__validators,validations,group,value,key;if(validators){if(arguments.length===0){

 validations=this.validateGroup(this._getValidatables());}else if(arguments.length===1){if(typeof arguments[0]==="string"){
 group={};key=arguments[0];value=this.state[key];group[key]=value;validations=this.validateGroup(group);}else if(typeof arguments[0]==="object"){
 validations=this.validateGroup(arguments[0]);}}else if(arguments.length===2){
 group={};key=arguments[0];value=arguments[1];group[key]=value;validations=this.validateGroup(group);}}else{validations=this.validateGroup({});}
if(!validations.isValid){this._trigger({type:"validated",validations:validations});}
return validations;},_trigger:function(event){var evt={};try{if(event===null||event===undefined){throw new Error("model._trigger: triggering a null or undefined event");}
if(typeof event==='string'){evt.type=event;}else{if(event.type===null||event.type===undefined){throw new Error("model._trigger: triggering a null or undefined event");}
evt=event;}
this._$.trigger(evt);}catch(e){SM.Error.log(e,"Error model triggering "+evt.type);}
return this;},_getValidatables:function(){var key,validatables={},validators=this.__validators;for(key in validators){validatables[key]=this.get(key);}
return validatables;}};SM.Models={_models:{},_types:{},create:function(name,kwargs){var inst,modelName,type;if(name===undefined){throw new Error("a model name is required to create an instance");}
modelName=name+"Model";type=SM[modelName];if(type===undefined){throw new Error("attempted to create an unregistered model name: "+modelName);}
return this._create(type,kwargs);},register:function(name,prototype){var modelName;if(arguments.length!==2){throw new Error("a string model name and model prototype is required to register a model");}
if(name===undefined||typeof name!=="string"){throw new Error("a string model name is required to register a model");}
modelName=name+"Model";if(SM[modelName]!==undefined){throw new Error("a model of this type has already been registered");}
SM[modelName]=SM.Object.extend(SM.Model,prototype); SM[modelName].__counter=0;SM[modelName].__NAME=name;return SM[modelName];},extend:function(name,baseModel,overrides){var extended=SM.Object.deepExtend(baseModel,overrides);return this.register(name,extended);},_create:function(type,kwargs){var inst=SM.Object.create(type);inst._$=$({}); inst.__initSettings(kwargs); inst.__uid=type.__counter++; kwargs=kwargs||{}; inst.__create(kwargs);return inst;}};SM.log=function(str){if(SM.DEBUG){if(window.console){if(console&&console.log&&console.log.apply){console.log.apply(console,arguments);}else if(console&&console.log){Function.apply.apply(console.log,[null,arguments]);}}}};SM.Date={getDaysInMonth:function(month,year){var self=this;return 32-(new Date(year,month,32)).getDate();},getSimpleDate:function(date){if(!date){return{};}
return{month:date.getMonth(),year:date.getFullYear(),day:date.getDate()};},timestamp:function(){return(new Date()).getTime();},toISOString:function(datetime){var pad=function(n){return n<10?'0'+n:n;};if(!Date.prototype.toISOString){return[this.getUTCFullYear(),'-',pad(this.getUTCMonth()+1),'-',pad(this.getUTCDate()),'T',pad(this.getUTCHours()),':',pad(this.getUTCMinutes()),':',pad(this.getUTCSeconds()),'Z'].join("");}else{return datetime.toISOString();}},stdTimezoneOffset:function(){
 var d=new Date(),year=d.getFullYear(),jan=new Date(year,0,1),jul=new Date(year,6,1);return Math.max(jan.getTimezoneOffset(),jul.getTimezoneOffset());},utcOffset:function(){return(new Date()).getTimezoneOffset()*-60000;},toAge:function(ms){var seconds,minutes,hours,days,totalSeconds,totalMinutes,totalHours,totalDays;totalSeconds=Math.floor(ms/1000);seconds=totalSeconds%60;totalMinutes=Math.floor(totalSeconds/60);minutes=totalMinutes%60;totalHours=Math.floor(totalMinutes/60);hours=totalHours%24;totalDays=Math.floor(totalHours/24);days=totalDays%365;return{seconds:seconds,minutes:minutes,hours:hours,days:days};},ageToMilliseconds:function(age){var increments=age.split(" "),self,i=0,increment,number,unit,ms=0;for(;i<increments.length;i++){increment=increments[i];number=parseInt(increment,10),unit=increment.charAt(increment.length-1);unit=this._millisecondMap[unit];if(unit){ms+=(number*unit);}}
return ms;},formatDigitalTime:function(hours,minutes,seconds){var ageStr='';ageStr=this._addDigitalTimeString(ageStr,hours)+':';ageStr=this._addDigitalTimeString(ageStr,minutes)+':';return this._addDigitalTimeString(ageStr,seconds);},_millisecondMap:{s:1000,m:1000*60,h:1000*60*60,d:1000*60*60*24,o:1000*60*60*24*30,y:1000*60*60*24*365},_addDigitalTimeString:function(ageStr,timeIncrement){if(timeIncrement>9){ageStr=ageStr+timeIncrement;}else if(timeIncrement>0){ageStr=ageStr+'0'+timeIncrement;}else{ageStr=ageStr+'00';}
return ageStr;}};(function(){var $doc;jQuery.event.special.leave={add:function(handleObj){var oldHandler=handleObj.handler,self=this,el=this;if(!$doc){$doc=$(document);}
handleObj.handler=function(e){if(e.type===SM.Event.FOCUSIN){ if(!SM.DOM.contains(el,e.target)&&e.target.tagName.toLowerCase()!=="body"){oldHandler.apply(this,arguments);}}
if(e.type===SM.Event.CLICK){if(!SM.DOM.contains(el,e.target)){oldHandler.apply(this,arguments);}}}; setTimeout(function(){$doc.on(SM.Event.FOCUSIN+"."+handleObj.guid,handleObj.data,handleObj.handler).on(SM.Event.CLICK+"."+handleObj.guid,handleObj.data,handleObj.handler);},0);},remove:function(handleObj){$doc.off(SM.Event.FOCUSIN+"."+handleObj.guid).off(SM.Event.CLICK+"."+handleObj.guid);}};})();SM.Cookies={get:function(name){var map=this.getAll();return map[name];},set:function(name,value,expires,options){var date,ms;options=SM.Object.extend({path:'/'},options);if(typeof expires==='string'){ms=SM.Date.ageToMilliseconds(expires);}else{ms=expires;}
date=new Date();date.setTime(date.getTime()+ms);expires=date.toGMTString();document.cookie=[name+"="+value,"expires="+expires,"path="+options.path].join("; ");return this;},remove:function(name,options){options=SM.Object.extend({path:'/'},options);return this.set(name,'','-1s',options);},getAll:function(){var map={},split,cookies=document.cookie.split(';');$.each(cookies,function(i,cookie){cookie=$.trim(cookie);split=cookie.split("=");if(split.length===2){map[split[0]]=split[1];}});return map;}};

(function(global){function parseDomains(host){var domainParts=host.split("."),l=domainParts.length,i=0,rootDomain=domainParts[l-2],subDomains=[],subDomain;if(l>2){for(;i<(l-2);i++){subDomain=domainParts[i];subDomains.push(subDomain);}}
return[].concat(rootDomain).concat(subDomains);}
Uri.prototype.getDomains=function(){this.uriParts.domains=this.uriParts.domains||parseDomains(this.uriParts.host);return this.uriParts.domains;};Uri.prototype.getRootDomain=function(){var domains=this.getDomains();return domains[0];};Uri.prototype.getSubDomains=function(){var domains=this.getDomains();return domains.slice(1,domains.length);};})(this);SM.BaseMenu={__NAME:"menu",__defaults:{position:{my:"left top",at:"left bottom",offset:"0 -1"},parentEl:document.body},__init:function(){var self=this;if(this.__settings.menuView){this._menuView=this.__settings.menuView;}
this.bind("click",this._onClick).bind("keydown",this._onKeydown);},__onClick:function(e){e.preventDefault();if(this._isOpen){this.close();}else{this.open();}},__onClosedKeydown:function(e){var kc=e.which;if(kc===SM.KeyCodes.ENTER||kc===SM.KeyCodes.NUMPAD_ENTER){e.preventDefault();e.stopPropagation();this.$el.click();}},__onWindowResize:function(e){this.position();},__onMenuInit:function(){},__onBeforeMenuOpen:function(){$(window).on(SM.Event.RESIZE+"."+this.__NAME+this.__uid,{self:this},this._onResize);this.subscribe(SM.Event.FOCUSIN,this._onDocumentFocusin).subscribe(SM.Event.CLICK,this._onDocumentClick).subscribe(SM.Event.KEYDOWN,this._onDocumentKeydown);},__onMenuAddedToPage:function(){},__onAfterMenuOpen:function(){},__onClickOutside:function(e){this.close();},__onFocusOutside:function(e){this.close();},__onOpenKeydown:function(e){var kc=e.which;if(kc===SM.KeyCodes.ESCAPE){e.preventDefault();this.close();}},__onBeforeMenuClose:function(){},__onAfterMenuClose:function(){$(window).off(SM.Event.RESIZE+"."+this.__NAME+this.__uid,this._onResize);this.unsubscribe(SM.Event.FOCUSIN,this._onDocumentFocusin).unsubscribe(SM.Event.KEYDOWN,this._onDocumentKeydown).unsubscribe(SM.Event.CLICK,this._onDocumentClick);},__setters:{position:function(self,val){SM.Object.update(self.__settings.position,val);if(self.isOpen()){self.position();}},parentEl:function(self,val){self.__settings.parentEl=val;if(self.isOpen()){self.position();}}},__getters:{menuView:function(self,val){if(!self._menu){self._initMenu();}
return self._menu;}},bindMenu:function(event,callback){this._menu.$el.on(this._menu.__NAME+"."+event,{self:this},callback);return this;},open:function(){var menuView;if(this.$el.hasClass("disabled")){return;}
menuView=this.get("menuView");if(this._isOpen){return;}
this.trigger("beforeOpen");this.__onBeforeMenuOpen();menuView.$el.on("click",".close-menu-btn",{self:this},this._onCloseMenuClick);menuView.$el.appendTo(this.__settings.parentEl);this.$el.addClass("open");this.__onMenuAddedToPage();this.position();this._isOpen=true;this.trigger("afterOpen");this.__onAfterMenuOpen();},close:function(){var menuView;if(!this._isOpen){return;}
menuView=this.get("menuView");this.trigger("beforeClose");this.__onBeforeMenuClose();menuView.$el.off("click",".close-menu-btn",this._onCloseMenuClick);menuView.$el.detach();this._isOpen=false;this.$el.removeClass("open");this.trigger("afterClose");this.__onAfterMenuClose();},isOpen:function(){return this._isOpen;},position:function(){var position;if(!this.__settings.position.of){this.__settings.position.of=this.$el;}
if(this.__settings.parentEl){this.__settings.position.within=this.__settings.parentEl;}
position=$.migrationFixPosition({my:this.__settings.position.my,at:this.__settings.position.at,of:this.__settings.position.of,offset:this.__settings.position.offset,within:this.__settings.position.within,collision:this.__settings.position.collision});this._menu.$el.position(position);this.trigger("position");},_initMenu:function(){var MenuView;if(!this._menu){MenuView=SM[this._menuView];if(!MenuView){throw new Error("A menu requires a menuView key");}
this._menu=SM.Views.create(MenuView,this.__settings); this._menu.$el.css({top:0,left:0});this.trigger("menuInit");this.__onMenuInit();}
return this._menu;},__destroy:function(){if(this._menu){this.__onAfterMenuClose();this._isOpen=false;if(this._menu.$el){this._menu.$el.remove();}
this._menu=null;}
this.$el.off("click",this._onClick).off("keydown",this._onKeydown).data(this.__NAME,null);},_menu:null,_menuView:"BaseMenuView",_isOpen:false,_onClick:function(e){var self=e.data.self;self.__onClick(e);},_onKeydown:function(e){var self=e.data.self;if(!self._isOpen){self.__onClosedKeydown(e);}},_onDocumentKeydown:function(e){var self=e.data.self;self.__onOpenKeydown(e);},_onDocumentClick:function(e){var self=e.data.self;if(!self._menuContains(e.target)&&!self._isStepChild(e.target)&&!self._contains(e.target)){self.__onClickOutside(e);}},_onDocumentFocusin:function(e){var self=e.data.self; if(e.target===document){return;}
if(!self._menuContains(e.target)&&!self._isStepChild(e.target)&&!self._contains(e.target)&&e.target.tagName.toLowerCase()!=="body"){self.__onFocusOutside(e);}},_onResize:function(e){var self=e.data.self;self.__onWindowResize(e);},_menuContains:function(el){return SM.DOM.contains(this._menu.el,el);},_isStepChild:function(el){return false;},_onCloseMenuClick:function(e){e.data.self.close();},_contains:function(el){return SM.DOM.contains(this.el,el);}};SM.Menu=SM.Widgets.register(SM.BaseMenu);SM.ActionMenu=SM.Widgets.deepExtend(SM.BaseMenu,{__NAME:"actionMenu",__defaults:{saveState:false,selectedAction:null},__onMenuInit:function(){this.bindMenu("actionSelected",this._onActionSelected).bindMenu("optionClicked",this._onOptionClicked);},__setters:{selectedAction:function(self,action){var menuView=self.get("menuView");menuView.set("selectedAction",action);},actions:function(self,actions){var menuView=self.get("menuView");menuView.set("actions",actions);}},_onOptionClicked:function(e){var self=e.data.self;self.$el.focus();self.close();},hasAction:function(action){var menuView=this.get("menuView");return menuView.hasAction(action);},_menuView:"ActionMenuView",_onActionSelected:function(e){var self=e.data.self;if(self.__settings.saveState&&self.__settings.selectedAction===e.action){return;}
if(self.__settings.saveState){self.__settings.selectedAction=e.action;}
self.trigger({type:"actionSelected",action:e.action,$action:e.$action});},__onOpenKeydown:function(e){var kc=e.which;SM.BaseMenu.__onOpenKeydown.call(this,e);if(kc===SM.KeyCodes.DOWN){this._menu.nextCurrent();e.preventDefault();}else if(kc===SM.KeyCodes.UP){this._menu.prevCurrent();e.preventDefault();}else if(kc===SM.KeyCodes.ENTER||kc===SM.KeyCodes.NUMPAD_ENTER){this._menu.selectCurrent();e.preventDefault();}},__onAfterMenuClose:function(){SM.BaseMenu.__onAfterMenuClose.call(this);if(this._menu){this._menu.set("currentIndex",-1);}}});SM.SelectMenu=SM.Widgets.deepExtend(SM.BaseMenu,{__NAME:"selectMenu",__defaults:{selectedValue:null},__init:function(options){var menuView;SM.BaseMenu.__init.call(this);menuView=this.get("menuView");this.bind("keypress",this._onClosedKeypress);this.__settings.selectedValue=menuView.get("selectedValue");this._setDisplay(menuView.get("valueText"));},__onMenuInit:function(){this.bindMenu("change",this._onMenuChange);},__onClosedKeydown:function(e){var kc=e.which;SM.BaseMenu.__onClosedKeydown.call(this,e);if(kc===SM.KeyCodes.DOWN){this._menu.nextSelect();e.preventDefault();}else if(kc===SM.KeyCodes.UP){this._menu.prevSelect();e.preventDefault();}},__onOpenKeydown:function(e){var kc=e.which;SM.BaseMenu.__onOpenKeydown.call(this,e);if(kc===SM.KeyCodes.DOWN){this._menu.nextCurrent();e.preventDefault();}else if(kc===SM.KeyCodes.UP){this._menu.prevCurrent();e.preventDefault();}else if(kc===SM.KeyCodes.ENTER||kc===SM.KeyCodes.NUMPAD_ENTER){this._menu.selectCurrent();e.preventDefault();}},__onBeforeMenuOpen:function(){SM.BaseMenu.__onBeforeMenuOpen.call(this);this.subscribe(SM.Event.KEYPRESS,this._onOpenKeypress);},__onAfterMenuClose:function(){SM.BaseMenu.__onAfterMenuClose.call(this);this.unsubscribe(SM.Event.KEYPRESS,this._onOpenKeypress);this._menu.set("currentIndex",-1);},__onAfterMenuOpen:function(){SM.BaseMenu.__onAfterMenuOpen.call(this);this._menu.scrollToItem(this._menu._selectedIndex);},__setters:{value:function(self,value){self._menu.set("selectedValue",value);},options:function(self,options){self._menu.set("options",options);}},__getters:{value:function(self,val){return self.__settings.selectedValue;}},_menuView:"SelectMenuView",_searchTerm:undefined,_setDisplay:function(text){var $display=this.$el.find(".display");$display.text(text);},_getNewSearchTerm:function(letter){return this._searchTerm?this._searchTerm+letter:letter;},_searchSelect:function(letter){var index,searchTerm,startIndex; if(!letter){return;} 
searchTerm=this._getNewSearchTerm(letter);index=this._menu.searchOptions(searchTerm);
 if(this._searchTerm&&index===-1){this._searchTerm=undefined;index=this._menu.searchOptions(letter);}
 
if(index!==-1){this._menu.set("selectedIndex",index);this._searchTerm=this._getNewSearchTerm(letter);}else{this._searchTerm=undefined;}},_getLetter:function(e){var charCode=e.charCode!==undefined?e.charCode:e.keyCode;return String.fromCharCode(charCode).toLowerCase();},_onClosedKeypress:function(e){var self=e.data.self,letter;if(!self.isOpen()){letter=self._getLetter(e);if(e.which===SM.KeyCodes.SPACE){e.preventDefault();}
self._searchSelect(letter);}},_onOpenKeypress:function(e){var self=e.data.self,letter=self._getLetter(e);if(e.which===SM.KeyCodes.SPACE){e.preventDefault();}
self._searchSelect(letter);},_onMenuChange:function(e){var self=e.data.self;if(self.__settings.selectedValue===e.value){self.$el.focus();self.close();return;}
self._setDisplay(e.displayText);self.__settings.selectedValue=e.value;self.trigger({type:"change",value:e.value,displayText:e.displayText});self.$el.focus();self.close();}});SM.Autocomplete=SM.Widgets.deepExtend(SM.BaseMenu,{__NAME:"autocomplete",__defaults:{minLength:2,delay:0,maxResults:50,source:[],search:function(term){var source=this.__settings.source,maxResults=this.__settings.maxResults,matches=0,results;results=$.map(source,function(value,index){var lowerValue=value.toLowerCase(),lowerTerm=term.toLowerCase();if(matches>=maxResults){return false;}
if(lowerValue.indexOf(lowerTerm)!==-1){matches++;return{value:value,text:value};}});this.set("results",results);},position:{collision:'none'},enabled:true,setInputOnSelect:true,matchInputWidth:true},__getters:{input:function(self){return self._getInput();},results:function(self){var menuView=self.get("menuView");return menuView.get("results");}},__setters:{input:function(self,input){self._setInput(input);},results:function(self,results){var menuView=self.get("menuView");if(results.length>self.__settings.maxResults){results=results.slice(0,self.__settings.maxResults);}
menuView.set("results",results);if(results.length>0){self.open();}else{self.close();}},enabled:function(self,enabled){if(enabled&&!self.__settings.enabled){self._bindEvents();}else if(!enabled&&self.__settings.enabled){self.close();self.$el.off("keydown",self._onKeydown).off("keyup",self._onKeyup).off("paste",self._onPaste);}
self.__settings.enabled=enabled;}},__init:function(options){var tagName=this.el.tagName.toLowerCase();if(this.__settings.enabled){this._bindEvents();}
if(this.__settings.menuView){this._menuView=this.__settings.menuView;}
this._hasVal=tagName==="input"||tagName==="textarea";this._height=this.$el.height();this._width=this.$el.outerWidth();},__onMenuInit:function(){this.bindMenu("selected",this._onOptionSelected);},__onBeforeMenuOpen:function(){SM.BaseMenu.__onBeforeMenuOpen.call(this);},__onMenuAddedToPage:function(){SM.BaseMenu.__onMenuAddedToPage.call(this);if(this.__settings.matchInputWidth){this._matchInputSize();}},__onAfterMenuClose:function(){SM.BaseMenu.__onAfterMenuClose.call(this);this._menu.set("currentIndex",-1);},__onWindowResize:function(){this._matchInputSize();SM.BaseMenu.__onWindowResize.call(this);},_matchInputSize:function(){var menuView=this.get("menuView"),$el=this.$el,inputWidth=$el.outerWidth(),menuViewBorderLeftWidth=parseInt(menuView.$el.css("border-left-width"),10),menuViewBorderRightWidth=parseInt(menuView.$el.css("border-right-width"),10);menuView.$el.css('width',inputWidth-menuViewBorderLeftWidth-menuViewBorderRightWidth);},_bindEvents:function(){this.bind("keydown",this._onKeydown).bind("keyup",this._onKeyup).bind("paste",this._onPaste);},_menuView:"AutocompleteMenuView",_pipeInput:function(){var searchCandidate=this._getInput();if(searchCandidate.length>=this.__settings.minLength){this._checkHeight();if(this.__settings.delay>0){this._delaySearch(searchCandidate);}else{this._checkSearch(searchCandidate);}}else{this.close();}},_checkHeight:function(){var currHeight=this.$el.height();if(this._height!==currHeight&&this.isOpen()){this.position();this._height=currHeight;}},_delaySearch:function(searchCandidate){var self=this;setTimeout(function(){self._checkSearch(searchCandidate);},self.__settings.delay);},_checkSearch:function(searchCandidate){var currentInput=this._getInput(),results;if(currentInput===searchCandidate){this.__settings.search.call(this,searchCandidate);}},_getInput:function(){var $el=this.$el;return $.trim(this._hasVal?$el.val():$el.text());},_setInput:function(input){var $el=this.$el;if(this._hasVal){$el.val(input);}else{$el.text(input);}},_onOptionSelected:function(e){var self=e.data.self;if(self.__settings.setInputOnSelect){self._setInput(e.text);}
self.trigger({type:"selected",text:e.text,value:e.value});self.close();},_onKeyup:function(e){var self=e.data.self,kc=e.which;if(kc===SM.KeyCodes.DOWN||kc===SM.KeyCodes.UP||kc===SM.KeyCodes.ENTER||kc===SM.KeyCodes.NUMPAD_ENTER||kc===SM.KeyCodes.ESCAPE){e.preventDefault();return;}
if(kc===SM.KeyCodes.SHIFT||kc===SM.KeyCodes.CTRL||kc===SM.KeyCodes.CAPS||kc===SM.KeyCodes.ALT||kc===SM.KeyCodes.HOME||kc===SM.KeyCodes.END||kc===SM.KeyCodes.LEFT_WINDOW||kc===SM.KeyCodes.RIGHT_WINDOW||kc===SM.KeyCodes.RIGHT_WINDOW||kc===SM.KeyCodes.SELECT){return;}
self._pipeInput();},_onPaste:function(e){var self=e.data.self;self._pipeInput();},_onKeydown:function(e){var self=e.data.self,kc=e.which;if(self.isOpen()){if(kc===SM.KeyCodes.DOWN){self._menu.nextCurrent();e.preventDefault();}else if(kc===SM.KeyCodes.UP){self._menu.prevCurrent();e.preventDefault();}else if(kc===SM.KeyCodes.ENTER||kc===SM.KeyCodes.NUMPAD_ENTER){self._menu.selectCurrent();e.preventDefault();}}}});SM.Datepicker=SM.Widgets.deepExtend(SM.BaseMenu,{__NAME:"datepicker",__defaults:{selectedDate:null,minDate:null,maxDate:null,selectMenus:false,dateFormat:"d"},__init:function(options){this.bind("focusin",this._onFocusIn).bind("click",this._onClick).bind("keyup",this._onKeyup).bind("paste",this._onPaste);if(this.$el.siblings(".datepicker-icon").length){this.$icon=this.$el.siblings(".datepicker-icon").first();this.$icon.on("click",{self:this},this._onIconClick);}
this._setInitialValue();},__onMenuInit:function(){this.bindMenu("dateSelected",this._onDateSelected);},__onBeforeMenuOpen:function(){SM.BaseMenu.__onBeforeMenuOpen.call(this);this._menu.resetDisplayDate(this.__settings);this._menu.render();},__setters:{selectedDate:function(self,val){self._setSelectedDate(val);self.trigger("dateSelected");},minDate:function(self,val){self._setMinDate(val);},maxDate:function(self,val){self._setMaxDate(val);},selectMenus:function(self,val){self.__settings.selectMenus=val;}},_menuView:"CalendarMenuView",_setSelectedDate:function(date){var state=this.__settings;if(date){if(state.minDate&&date<state.minDate){state.selectedDate=new Date(state.minDate);}else if(state.maxDate&&date>state.maxDate){state.selectedDate=new Date(state.maxDate);}else{state.selectedDate=date;}
this.$el.val(Globalize.format(state.selectedDate,state.dateFormat));}else{state.selectedDate=null;this.$el.val('');}
return this;},_setMinDate:function(date){var state=this.__settings;if(date){if(state.selectedDate&&date>state.selectedDate){state.minDate=new Date(state.selectedDate);}else if(state.maxDate&&date>state.maxDate){state.minDate=new Date(state.maxDate);}else{state.minDate=date;}}else{state.minDate=null;}
return this;},_setMaxDate:function(date){var state=this.__settings;if(date){if(state.selectedDate&&date<state.selectedDate){state.maxDate=new Date(state.selectedDate);}else if(state.minDate&&date<state.minDate){state.maxDate=new Date(state.minDate);}else{state.maxDate=date;}}else{state.maxDate=null;}
return this;},_setInitialValue:function(){var selectedDate=this.__settings.selectedDate;if(selectedDate){this._setSelectedDate(selectedDate);}
return this;},_parseDate:function(dateString){var date=Globalize.parseDate(dateString,this.get('dateFormat'));if(date){this.set("selectedDate",date);}else{this.set("selectedDate",null);}},_isStepChild:function(el){return this.$icon&&this.$icon.get(0)===el;},_onFocusIn:function(e){var self=e.data.self;self.open();},_onClick:function(e){var self=e.data.self;self.open();},_onDateSelected:function(e){var self=e.data.self;self.set("selectedDate",e.date);self.$el.focus();self.close();},_onKeyup:function(e){var self=e.data.self,val=self.$el.val();self._parseDate(val);},_onPaste:function(e){var self=e.data.self,val=self.$el.val();self._parseDate(val);},_onIconClick:function(e){var self=e.data.self;self.open();}});SM.DateRange=SM.Widgets.register({__NAME:"dateRangePicker",__getters:{startMinDate:function(self){return self._start.get("minDate");},startMaxDate:function(self){return self._start.get("maxDate");},startSelectedDate:function(self){return self._start.get("selectedDate");},endMinDate:function(self){return self._end.get("minDate");},endMaxDate:function(self){return self._end.get("maxDate");},endSelectedDate:function(self){return self._end.get("selectedDate");}},__setters:{startMinDate:function(self,val){self._start.set("minDate",val);},startMaxDate:function(self,val){self._start.set("maxDate",val);},startSelectedDate:function(self,val){self._start.set("selectedDate",val);},endMinDate:function(self,val){self._end.set("minDate",val);},endMaxDate:function(self,val){self._end.set("maxDate",val);},endSelectedDate:function(self,val){self._end.set("selectedDate",val);}},__init:function(options){var start=this.$el.find(".datepicker.date-start"),end=this.$el.find(".datepicker.date-end");if(start.length===0||end.length===0){throw new Error(".date-start or .date-end not found inside daterange element");}
start.datepicker({minDate:options.startMinDate,maxDate:options.startMaxDate,selectedDate:options.startSelectedDate,selectMenus:options.selectMenus});end.datepicker({minDate:options.endMinDate,maxDate:options.endMaxDate,selectedDate:options.endSelectedDate,selectMenus:options.selectMenus});this._initStartMaxDate=options.startMaxDate;this._initEndMinDate=options.endMinDate;this._start=start.data("datepicker");this._end=end.data("datepicker");this._start.$el.on("datepicker.beforeOpen",{daterange:this},this._startDateOpen);this._end.$el.on("datepicker.dateSelected",{daterange:this},this._onEndDateSelected).on("datepicker.beforeOpen",{daterange:this},this._endDateOpen);}, _start:undefined,_end:undefined,_initStartMaxDate:undefined,_initEndMinDate:undefined, _startDateOpen:function(e){var self=e.data.daterange,selectedEndDate=self._end.get("selectedDate"),startMaxDate=self._start.get("maxDate"),endMaxDate=self._end.get("maxDate");if(selectedEndDate&&self._initStartMaxDate&&selectedEndDate<self._initStartMaxDate){self._start.set("maxDate",selectedEndDate);}else if(selectedEndDate&&!self._initStartMaxDate){self._start.set("maxDate",selectedEndDate);}else if(self._initStartMaxDate){self._start.set("maxDate",self._initStartMaxDate);}else if(endMaxDate){self._start.set("maxDate",endMaxDate);}},_endDateOpen:function(e){var self=e.data.daterange,selectedStartDate=self._start.get("selectedDate"),endMinDate=self._end.get("minDate"),startMinDate=self._start.get("minDate");if(selectedStartDate&&self._initEndMinDate&&selectedStartDate>self._initEndMinDate){self._end.set("minDate",selectedStartDate);}else if(selectedStartDate&&!self._initEndMinDate){self._end.set("minDate",selectedStartDate);}else if(self._initEndMinDate){self._end.set("minDate",self._initEndMinDate);}else if(startMinDate){self._end.set("minDate",startMinDate);}},_onEndDateSelected:function(e){var self=e.datepicker,selectedDate=self.get("selectedDate");if(selectedDate){selectedDate.setMilliseconds(999);selectedDate.setSeconds(59);selectedDate.setMinutes(59);selectedDate.setHours(23);self._setSelectedDate(selectedDate);}}});SM.Accordion=SM.Widgets.register({ __NAME:"accordion",__defaults:{multiOpen:false,overflowAuto:true},__init:function(){this._cacheData()._bindEvents();if(SM.Browser.isIE8){ this.$el.find("div.key > header > h3").prepend('<span class="accordion-arrow"></span>');}}, KEY_ATTR:"data-panel-key", close:function(panelKey){var panel;panelKey=this._getNormalizedStringPanelkey(panelKey);panel=this._panels[panelKey];if(panel&&this._openPanels[panelKey]){this._close(panel);}
return this;},open:function(panelKey){var panel;panelKey=this._getNormalizedStringPanelkey(panelKey);panel=this._panels[panelKey];if(panel&&!this._openPanels[panelKey]){if(!this.__settings.multiOpen){this._closeOpenPanels();}
this._open(panel);}
return this;},disable:function(panelKey,disabled){var $header;panelKey=this._getNormalizedStringPanelkey(panelKey);$header=this.$el.find("#"+panelKey).siblings("header");if(panelKey){if(disabled){this._disabledPanels[panelKey]=true;$header.addClass("disabled");}else{delete this._disabledPanels[panelKey];$header.removeClass("disabled");}}
return this;},isOpen:function(panelKey){panelKey=this._getNormalizedStringPanelkey(panelKey);return!!this._openPanels[panelKey];},isDisabled:function(panelKey){panelKey=this._getNormalizedStringPanelkey(panelKey);return!!this._disabledPanels[panelKey];}, _openPanels:undefined,_panels:undefined,_disabledPanels:undefined, _close:function(panel){panel.$section.css("overflow-y","hidden");this.__trigger({type:"beforeClose",index:panel.index,id:panel.key});delete this._openPanels[panel.key];panel.$section.animate({height:0},200,this._onClose);},_open:function(panel){var height;panel.$panel.addClass("opening");this.__trigger({type:"beforeOpen",index:panel.index,id:panel.key});this._openPanels[panel.key]=true;if(!this.$el.hasClass("static")){
 height=panel.$section.css("height","auto").height();panel.$section.css("height",0); this.$el.one("accordion.afterOpen",function(){panel.$section.css("height","auto");});}else{ panel.$panel.addClass("open");height=panel.$section.height();panel.$panel.removeClass("open");}
panel.$section.animate({height:height},200,this._onOpen);},_cacheData:function(){var i=0,$panels,$panel,id,$section,panelLen,$header; this._openPanels={};this._panels={};this._disabledPanels={};$panels=this.$el.children("div.key");panelLen=$panels.length;for(;i<panelLen;i++){$panel=$panels.eq(i);$header=$panel.find('header');id=$header.find('a.keyOpener').attr('target').substr(1);$section=this.$el.find('#'+id);this._panels[id]={index:i,key:id,$panel:$panel,$section:$section};if($panel.hasClass("open")){this._openPanels[id]=true;}
if($header.hasClass("disabled")){this.disable(id,true);}}
return this;},_closeOpenPanels:function(){var panels=this._panels,openPanels=this._openPanels,panel;for(panel in openPanels){if(openPanels[panel]){this._close(panels[panel]);}}},_bindEvents:function(){this.$el.on("click",".key > header",{accordion:this},this._onKeyClick);return this;},_getNormalizedStringPanelkey:function(index){if(typeof index==="string"){return index;}
var panel,panels=this._panels;for(panel in panels){if(panels[panel].index===index){return panels[panel].key;}}},_getSingleOpenedPanelkey:function(){


 for(var panelKey in this._openPanels){return panelKey;}}, _onClose:function(){var $section=$(this),self=$section.closest(".accordion").data(SM.Accordion.__NAME),panelKey=$section.attr("id"),panel=self._panels[panelKey];panel.$panel.removeClass("open");$section.removeAttr("style");self.__trigger({type:"afterClose",index:panel.index,id:panel.key});},_onOpen:function(){var $section=$(this),self=$section.closest(".accordion").data(SM.Accordion.__NAME),panelKey=$section.attr("id"),panel=self._panels[panelKey];panel.$panel.removeClass("opening");panel.$panel.addClass("open");if(self.__settings.overflowAuto){$section.css("overflow-y","auto");}
self.__trigger({type:"afterOpen",index:panel.index,id:panel.key});},_onKeyClick:function(e){var self=e.data.accordion,panelKey=$(this).find('a.keyOpener').attr('target').substring(1),openedKey=self._getSingleOpenedPanelkey();e.preventDefault();if(self.isDisabled(panelKey)){return;}
if(!self.__settings.multiOpen&&openedKey&&self.isDisabled(openedKey)){return;}
if(self._openPanels[panelKey]){self.close(panelKey);}else{self.open(panelKey);}}});SM.Popout=SM.Widgets.register({ __NAME:"popout",__defaults:{tipSideX:"left",tipSideY:"top",parentElement:document.body,offsetX:null,offsetY:null,at:'left top'},__init:function(options){this.$el.on("mouseenter",{popout:this},this._onMouseenter).on("mouseleave",{popout:this},this._onMouseleave);this.$el.on("click",this._onClick);}, _isHovered:false,_isMsgSetup:false,_$msg:undefined,_offsetX:undefined,_offsetY:undefined,_tipSideX:undefined,_tipSideY:undefined,_positions:{left:{css:"tip-left",offset:"+32",flip:"right"},right:{css:"tip-right",offset:"-15",flip:"left"},bottom:{css:"tip-bottom",offset:"+34",flip:"top"},top:{css:"tip-top",offset:"-14",flip:"bottom"}}, _beforeShow:function(){if(this.__settings.offsetX){this._offsetX=this.__settings.offsetX;}else{this._offsetX=this._positions[this.__settings.tipSideX].offset;}
if(this.__settings.offsetY){this._offsetY=this.__settings.offsetY;}else{this._offsetY=this._positions[this.__settings.tipSideY].offset;}
this._$msg=this.$el.find(".popout");if(this._$msg.length===0){this.$el.append("<div class='popout'></div>");this._$msg=this.$el.find('.popout').html($('#'+this.$el.attr('data-help')).html());}
this._$msg=this._$msg.clone();this._$msg.on("mouseenter",{popout:this},this._onMessageMouseenter).on("mouseleave",{popout:this},this._onMessageMouseleave).on("position.horizontal.flip",{popout:this,offsetKey:"_offsetX",tipKey:"tipSideX"},this._onMessageFlip)
.on("position.vertical.flip",{popout:this,offsetKey:"_offsetY",tipKey:"tipSideY"},this._onMessageFlip).on("click",".close",{popout:this},this._onCloseClick).addClass(this._positions[this.__settings.tipSideX].css).addClass(this._positions[this.__settings.tipSideY].css).append('<span class="tip"></span>').append('<a class="close"><span aria-hidden="true"></span>Close</a>').appendTo(this.__settings.parentElement);this._isMsgSetup=true;return this;},_show:function(){var self=this;setTimeout(function(){if(self._isHovered){self._$msg.addClass("open").position($.migrationFixPosition({my:self.__settings.tipSideX+" "+self.__settings.tipSideY,at:self.__settings.at,of:self.$el,offset:self._offsetX+" "+self._offsetY}));}},750);return self;},_hide:function(){var self=this;setTimeout(function(){if(!self._isHovered){self._$msg.remove();self._isMsgSetup=false;}},500);return self;}, _onMessageFlip:function(e){var self=e.data.popout,dir=self.__settings[e.data.tipKey],current=self._positions[dir],next=self._positions[current.flip];self[e.data.offsetKey]=next.offset;self._$msg.removeClass(current.css).addClass(next.css);},_onMouseenter:function(e){var self=e.data.popout;self._isHovered=true;if(!self._isMsgSetup){self._beforeShow()._show();}},_onMouseleave:function(e){var self=e.data.popout;self._isHovered=false;self._hide();},_onMessageMouseenter:function(e){var self=e.data.popout;self._isHovered=true;},_onMessageMouseleave:function(e){var self=e.data.popout;self._isHovered=false;self._hide();},_onCloseClick:function(e){var self=e.data.popout;self._isHovered=false;self._$msg.remove();self._isMsgSetup=false;e.stopPropagation();},_onClick:function(e){e.preventDefault();e.stopPropagation();}});SM.Form=SM.Widgets.register({ __NAME:"form",__defaults:{formErrorsClass:"form-errors",formGroupErrorClass:"has-error",formControlErrorsClass:"form-control-errors",formControlErrorMessageClass:"form-control-error-message"}, __init:function(options){var self=this;self.options=SM.Object.deepUpdate(self.__defaults,options);self.formView=self.options.formView;self.validations=self.formView.validations;self.errors=[];},
 attrs:function(){var attrs={},attrList;attrList=this.$el.serializeArray();_.each(attrList,function(attr){attrs[attr.name]=attr.value;});return attrs;}, validate:function(){var self=this,formErrorsClass=self.options.formErrorsClass,formGroupErrorClass=self.options.formGroupErrorClass,formControlErrorsClass=self.options.formControlErrorsClass,formControlErrorMessageClass=self.options.formControlErrorMessageClass;var validator=function(attrs,selector){var shouldValidate=true,$checkbox,fieldValue;if(attrs['if']){shouldValidate=attrs['if']();}else if(attrs['ifChecked']){$checkbox=self.$el.find(attrs['ifChecked']);if($checkbox.length){shouldValidate=$checkbox.prop("checked");}else{SM.log("Could not find "+attrs['ifChecked']);}}
if(shouldValidate){if(attrs.type==="presence"){fieldValue=self.$el.find(selector).val();if(_.isEmpty(fieldValue)){self.errors.push([selector,attrs.message]);}}else if(attrs.type==="length"){fieldValue=self.$el.find(selector).val();if(_.has(attrs,'exactly')&&fieldValue.length!==attrs.exactly){self.errors.push([selector,attrs.message]);}
if(_.has(attrs,'min')&&fieldValue.length<attrs.min){self.errors.push([selector,attrs.message]);}
if(_.has(attrs,'max')&&fieldValue.length>attrs.max){self.errors.push([selector,attrs.message]);}}}}; self.errors=[];self.$el.find("."+formErrorsClass).hide();self.$el.find("."+formGroupErrorClass).removeClass(formGroupErrorClass);self.$el.find("."+formControlErrorsClass).remove();_.each(self.validations,function(obj,selector){if(!_.isArray(obj)){validator(obj,selector);}else{_.each(obj,function(attrs){validator(attrs,selector);});}});var selector,message,$formControl,$formControlErrors;if(self.errors.length){self.$el.find("."+formErrorsClass).show();_.each(self.errors,function(error){selector=error[0];message=error[1];$formControl=self.$el.find(selector);$formControl.parents(".form-group").eq(0).addClass(formGroupErrorClass);$formControlErrors=$formControl.next("."+formControlErrorsClass);if(!$formControlErrors.length){$formControlErrors=$("<div class='"+formControlErrorsClass+"'></div>");$formControl.after($formControlErrors);}
$formControlErrors.append("<p class='"+formControlErrorMessageClass+"'>"+message+"</p>");});}},isValid:function(){this.validate();return _.isEmpty(this.errors);}});SM.Tabs=SM.Widgets.register({ __NAME:"tabs",__defaults:{requireOpenTab:true},__setters:{selectedTab:function(self,val){self.open(val);}},__getters:{selectedTab:function(self){return self._selectedTab;}},__init:function(){this._cacheData()._initTab()._bindEvents();}, open:function(tabKey){var tab,selectedTab=this._selectedTab; if(typeof tabKey!=="string"){tabKey=this._getKeyFromIndex(tabKey);}
tab=this._tabs[tabKey];if(!tab){return this;} 
if(tab.$tab.hasClass("disabled")||selectedTab===tabKey){return this;} 
this._closeOpenTab();this._open(tab);return this;}, close:function(tabKey){var tab,selectedTab=this._selectedTab;if(tabKey===undefined&&!this.__settings.requireOpenTab){ this._closeOpenTab();return this;} 
if(typeof tabKey!=="string"){tabKey=this._getKeyFromIndex(tabKey);}
tab=this._tabs[tabKey];

if(tab&&selectedTab===tab.key&&!this.__settings.requireOpenTab){this._close(tab);this._selectedTab=undefined;}
return this;}, _selectedTab:undefined,_tabs:undefined, _close:function(tab){tab.$panel.removeClass("open");tab.$tab.removeClass("active");this.__trigger({type:"afterClose",tab:tab});return this;},_open:function(tab){this.__trigger({type:"beforeOpen",tab:tab});this._setOpenView(tab);return this;},_setOpenView:function(tab){this._selectedTab=tab.key;tab.$tab.addClass("active");tab.$panel.addClass("open");},_bindEvents:function(){this.$el.children("nav").find(".tab").on("click",{tabs:this},this._onTabClick);return this;},_initTab:function(){var $activeTab=this.$el.children("nav").find(".tab.active"),tabKey,tab; if($activeTab.length){tabKey=$activeTab.attr('tab-target');tab=this._tabs[tabKey];this._setOpenView(tab);}
return this;},_closeOpenTab:function(){var selectedTab=this._selectedTab,tab; if(selectedTab===undefined){return this;}
tab=this._tabs[selectedTab];this._close(tab);this._selectedTab=undefined;return this;},_cacheData:function(){var id,len,i=0,$tab,$panel,$tabs;$tabs=this.$el.children("nav").find(".tab");len=$tabs.length;this._tabs={};for(;i<len;i++){$tab=$tabs.eq(i);id=$tab.attr("tab-target");$panel=this.$el.find(".panel[tab="+id+"]");this._tabs[id]={index:i,$tab:$tab,key:id,$panel:$panel};}
return this;},_getKeyFromIndex:function(index){var tab,tabs=this._tabs;for(tab in tabs){if(tabs[tab].index===index){return tabs[tab].key;}}}, _onTabClick:function(e){var tabs=e.data.tabs,$tab=$(this),tabKey;e.preventDefault();tabKey=$tab.attr('tab-target');if(tabs.__settings.noClickTab===tabKey){return;}
if(tabs._selectedTab===tabKey){tabs.close(tabKey);}else{tabs.open(tabKey);}}});


SM.SideTab=SM.Widgets.register({ __NAME:"sideTab",__init:function(){var self=this,bottom; if(SM.Browser.isIE7){return;}
 
if(!this._supportsMediaQuery){this._bindWindowResize();} 
this.$el.appendTo(document.body); bottom=this._getBottomValue();this.$el.css("bottom",bottom); setTimeout(function(){var right=self._getRightValues();self.$el.css("right",right.normal);self.$el.hover(function(){self.$el.addClass("fast").css("right",right.hover);},function(){self.$el.css("right",right.normal);});if(!self._supportsMediaQuery){self._hasShown=true;self._$window.trigger("resize");}},1800);},_supportsMediaQuery:SM.Browser.support.mediaQuery(),_$window:$(window),MIN_SCREEN_WIDTH:1040,INITIAL_BOTTOM:30,SPACING:7,_bindWindowResize:function(){var self=this;this._hasShown=false;this._$window.on("resize",function(e){if(self._hasShown){if(self._$window.width()>self.MIN_SCREEN_WIDTH){self.$el.show();}else{self.$el.hide();}}});},_getRightValues:function(){var width=this.$el.outerWidth(),height=this.$el.outerHeight(),hoverRight,right;if(SM.Browser.isIE8){right=-1*((height-width));}else{right=-1*((width-height)/2);}
hoverRight=Math.floor(right);right=hoverRight-5;return{hover:hoverRight,normal:hoverRight-5};},_getBottomValue:function(){var $prev=this.$el.prev(".sidetab"),bottom;if($prev.length){bottom=this._getPreviousTopValue($prev)+this.SPACING;}else{bottom=this.INITIAL_BOTTOM;}
return bottom+this._getRotationAdjustment();},_getRotationAdjustment:function(){var width=this.$el.outerWidth(),height=this.$el.outerHeight();if(SM.Browser.isIE8){return height-width;}else{return width-((width+height)/2);}},_getPreviousTopValue:function($prev){var prevWidth=$prev.outerWidth(),prevHeight=$prev.outerHeight(),prevBottom=parseInt($prev.css("bottom"),10),prevRotationAdjustment;if(SM.Browser.isIE8){prevRotationAdjustment=prevWidth;return prevRotationAdjustment+prevBottom;}else{prevRotationAdjustment=((prevWidth+prevHeight)/2);return prevRotationAdjustment+prevBottom;}}});SM.Timepicker=SM.Widgets.register({ __NAME:"timepicker",__defaults:{minuteIncrement:15,militaryTime:false,time:null},__init:function(){var timeData={hours:-1,minutes:-1,ampm:"AM"};if(this.__settings.time){timeData=this._parseTime(this.__settings.time);}
this._createMenus(timeData);this.bind("selectMenu.change",".hour-menu-btn",this._hoursPicked).bind("selectMenu.change",".minute-menu-btn",this._minutesPicked);if(!this.__settings.militaryTime){this.bind("selectMenu.change",".ampm-menu-btn",this._ampmPicked);}},__setters:{date:function(self,date){var timeData=self._parseTime(date);self._setMenus(timeData);},hours:function(self,hours){var ampm;if(!self.__settings.militaryTime){if(hours===12){ampm="PM";}else if(hours>12){hours=hours-12;ampm="PM";}else{ampm="AM";if(hours===0){hours=12;}}
self._ampm.set("value",ampm);}
self._hours.set("value",hours);},minutes:function(self,val){self._minutes.set("value",val);},ampm:function(self,val){self._ampm.set("value",val);},time:function(self,date){self.set('date',date);}},__getters:{time:function(self){var hours=parseInt(self._hours.get("value"),10),minutes=parseInt(self._minutes.get("value"),10),ampm;if(!self.__settings.militaryTime&&hours>=0){ampm=self._ampm.get("value");if(hours===12){if(ampm==="AM"){hours=0;}}else{if(ampm==="PM"){hours+=12;}}}
return{hours:hours,minutes:minutes};}},_createMenus:function(timeData){this._hours=this.$el.find(".hour-menu-btn").selectMenu({menuView:"HourSelectMenuView",selectedValue:timeData.hours,militaryTime:this.__settings.militaryTime}).data("selectMenu");this._minutes=this.$el.find(".minute-menu-btn").selectMenu({menuView:"MinuteSelectMenuView",selectedValue:timeData.minutes,increment:this.__settings.minuteIncrement}).data("selectMenu");if(!this.__settings.militaryTime){this._ampm=this.$el.find(".ampm-menu-btn").selectMenu({templateID:"ampm-select-menu-template",selectedValue:timeData.ampm}).data("selectMenu");}},_setMenus:function(timeData){this._hours.set("value",timeData.hours.toString());this._minutes.set("value",timeData.minutes.toString());if(!this.__settings.militaryTime){this._ampm.set("value",timeData.ampm);}}, _parseTime:function(time){var hours=time.getHours(),minutes=time.getMinutes(),ampm,i=this.__settings.minuteIncrement,r; r=minutes%i;if(r>0){if(Math.floor(i/2)-r>0){minutes=minutes-r;}else{minutes=minutes-r+i;if(minutes>=60){hours++;minutes=0;if(hours===24){hours=0;}}}}
if(!this.__settings.militaryTime){if(hours===12){ampm="PM";}else if(hours>12){hours=hours-12;ampm="PM";}else{ampm="AM";if(hours===0){hours=12;}}}
return{hours:hours,minutes:minutes,ampm:ampm};},_hoursPicked:function(e){var self=e.data.self;self.trigger("change");},_minutesPicked:function(e){var self=e.data.self;self.trigger("change");},_ampmPicked:function(e){var self=e.data.self;self.trigger("change");}});SM.Waterpark=SM.Widgets.register({ __NAME:"waterpark",__init:function(){this.calculateAttributes()._bindEvents()._displayLocation(this.__settings.location);},__defaults:{location:{slide:0}},__setters:{location:function(self,val){self._setLocation(val);}},calculateAttributes:function(){var $slides=this.$el.find(".slide"),slideCount=$slides.length,slideWidth,totalWidth;
 if(slideCount%2!==0){slideCount+=1;}
slideWidth=SM.Math.toPercentString((1/slideCount),6),totalWidth=""+(slideCount*100)+"%";this.$el.find(".mover").css("width",totalWidth);$slides.css("width",slideWidth);return this;},_bindEvents:function(){this.$el.on("click","a.shifter",{waterpark:this},this._onShifterClick).on("click","a.custom-shifter",{waterpark:this},this._onCustomShiftClick).on("click","a.back-shifter",{waterpark:this},this._onBackClick);return this;},_setLocation:function(location){var currentLoc=this.__settings.location,self=this,$slide; if(!location||location.slide===undefined){return this;}
if(currentLoc&&location.slide===currentLoc.slide&&location.lane===currentLoc.lane){return this;}
this._displayLocation(location);this.__settings.location.slide=location.slide;this.__settings.location.lane=location.lane;this.__trigger("shift");this._startAfterTimer(location.slide,location.lane);return this;},_startAfterTimer:function(slide,lane){var location=this.__settings.location,self=this; setTimeout(function(){if(location.slide===slide&&location.lane===lane){self.trigger("afterShift");}},300);},_displayLocation:function(location){var $slide,distance=""+location.slide*-100+"%";if(!SM.Browser.isIE7){this.$el.find(".mover").css("margin-left",distance);}
$slide=this.$el.find(".slide").removeClass("current").eq(location.slide).addClass("current");if(location.lane){$slide.find(".lane").removeClass("open").filter("."+location.lane).addClass("open");}}, _onShifterClick:function(e){var $el=$(this),waterpark=e.data.waterpark,lane=$el.attr("lane-target"),slide=parseInt($el.attr("slide-target"),10);waterpark._setLocation({slide:slide,lane:lane});e.preventDefault();},_onCustomShiftClick:function(e){var waterpark=e.data.waterpark;waterpark.__trigger("customShift");e.preventDefault();},_onBackClick:function(e){var $el=$(this);var waterpark=e.data.waterpark;var slide=waterpark.get("location").slide-1;waterpark._setLocation({slide:slide});e.preventDefault();}});SM.DialogView=SM.Views.deepExtend({__NAME:"dialog",__templateID:"dialog-template",__defaults:{isModal:false,width:350,position:{my:"center",at:"center",collision:'none'},easyClose:true,closeBtn:true},_hasShownOnce:false,__afterRender:function(){var title;this.$el.css('width',this.__settings.width);if(this.__settings.title){this.$el.attr("title",this.__settings.title);}
title=this.$el.attr("title");if(title){this._addTitlebar(title);this.$el.removeAttr("title");}
if(this.__settings.closeBtn){this._addCloseBtn();}
if(this._hasShownOnce){this.$el.addClass("open");this.$el.removeClass("close");}else{this.$el.addClass("close");this.$el.removeClass("open");}},__onBeforeOpen:function(){var self=this;$(window).on(SM.Event.RESIZE+"."+this.__NAME+this.__uid,{self:this},this._onResize);this.subscribe(SM.Event.KEYDOWN,this._onOpenKeydown);this.$el.on('click',".dialog-close-btn",{self:this},this._onCloseClick);},__onAfterOpen:function(){},__onBeforeClose:function(){$(window).off(SM.Event.RESIZE+"."+this.__NAME+this.__uid,this._onResize);this.unsubscribe(SM.Event.KEYDOWN,this._onOpenKeydown);this.$el.off('click',this._onCloseClick);},__onAfterClose:function(){},__onWindowResize:function(e){this.position();},open:function(options){if(this._isOpen){return this;}
if(options){SM.Object.update(this.__settings,options);}
this.trigger("beforeOpen");this.__onBeforeOpen();this._open();return this;},close:function(){if(!this._isOpen){return this;}
this.trigger("beforeClose");this.__onBeforeClose();this._close();return this;},position:function(){var position;if(!this.__settings.position.of){this.__settings.position.of=window;}
position=$.migrationFixPosition({my:this.__settings.position.my,at:this.__settings.position.at,of:this.__settings.position.of,offset:this.__settings.position.offset,within:this.__settings.position.within,collision:this.__settings.position.collision});this.$el.position(position);this.trigger("position");},isOpen:function(){return this._isOpen;},_$overlay:null,_isOpen:false,_open:function(){var overlay,self=this;overlay=SM.Template.renderHTML("dialog-overlay-template",{isModal:this.__settings.isModal});this._$overlay=$(overlay);this._$overlay.appendTo(document.body);if(this.__settings.easyClose){this._$overlay.on("click",{self:this},self._onOverlayClick);}
this.$el.appendTo(document.body);this.position(); setTimeout(function(){self._fadeIn();},0);},_close:function(){var self=this;this._$overlay.removeClass("open");this.$el.removeClass("open");this.$el.addClass("close");this._isOpen=false;this._hasShownOnce=false; setTimeout(function(){self._fadeOutComplete();},100);},_fadeIn:function(){this._$overlay.addClass("open");this.$el.addClass("open");this.$el.removeClass("close");this._isOpen=true;this._hasShownOnce=true;this.trigger("afterOpen");this.__onAfterOpen();},_fadeOutComplete:function(){this._$overlay.off("click");this._$overlay.remove();this._$overlay=null;this.$el.detach();this.trigger("afterClose");this.__onAfterClose();},_addCloseBtn:function(){var closeBtn=SM.Template.renderHTML("dialog-close-btn-template");this.$el.prepend(closeBtn);},_addTitlebar:function(title){var titleBar=SM.Template.renderHTML("dialog-title-bar-template",{title:title});this.$el.prepend(titleBar);},_onCloseClick:function(e){e.data.self.close();e.preventDefault();},_onOverlayClick:function(e){e.data.self.close();},_onResize:function(e){var self=e.data.self;self.__onWindowResize(e);},_onOpenKeydown:function(e){var self=e.data.self;if(e.which===SM.KeyCodes.ESCAPE){self.close();e.preventDefault();}},_contains:function(el){return SM.DOM.contains(this.el,el);}});SM.BaseNotificationView=SM.Views.register({__NAME:"BaseNotificationView",__templateID:"notification-template",__defaults:{duration:5000,expires:true,tabMessage:null},close:function(){this.notifications.close(this);},isInQueue:function(){this.notifications.isInQueue(this);}});SM.SuccessNotificationView=SM.Views.deepExtend(SM.BaseNotificationView,{__NAME:"SuccessNotificationView",__templateID:"status-notification-template",__defaults:{icon:"2"}});SM.ErrorNotificationView=SM.Views.deepExtend(SM.BaseNotificationView,{__NAME:"ErrorNotificationView",__templateID:"status-notification-template",__defaults:{icon:"!"}});SM.InfoNotificationView=SM.Views.deepExtend(SM.BaseNotificationView,{__NAME:"InfoNotificationView",__templateID:"status-notification-template",__defaults:{icon:"i"}});SM.Notifications={_queuedList:[],CLOSE_ANIMATION_TIME:700,OPEN_ANIMATION_TIME:700,error:function(options){var view=SM.Views.create(SM.ErrorNotificationView,options);this.init();view.$el.addClass("sm-notification-error");this.queue(view);return view;},success:function(options){var view=SM.Views.create(SM.SuccessNotificationView,options);this.init();view.$el.addClass("sm-notification-success");this.queue(view);return view;},info:function(options){var view=SM.Views.create(SM.InfoNotificationView,options);this.init();view.$el.addClass("sm-notification-info");this.queue(view);return view;},template:function(options){var view=SM.Views.create(SM.BaseNotificationView,options);this.init();this.queue(view);return view;},queue:function(notification){
 notification.$el.data("smnotification",notification);notification.notifications=this;this._queuedList.push(notification);


 if(this._isWindowFocused){this._processQueue();}else{this._startTitleMessager();}},init:function(){if(this._hasInit){return;}

 
this._originalTitle=document.title;
 this._titleChangeIntervalID=null;this._isWindowFocused=true; this.el=SM.Template.renderHTML("notifications-container-template");this.$el=$(this.el);$(document.body).append(this.el); $(window).on("focus.smnotification",{self:this},this._onWindowFocus).on("blur.smnotification",{self:this},this._onWindowBlur);this.$el.on("click","[notification-close-btn]",{self:this},this._onCloseClick);this._hasInit=true;},close:function(notification){var $wrapper,index=this._getQueueIndex(notification),self=this; if(index!==-1){this._queuedList.splice(index,1);return;} 
if(!notification.$el){return;}
$wrapper=notification.$el.parents(".sm-notification-wrapper");
 if(!$wrapper.length||$wrapper.hasClass("close")){return;}
 
$wrapper.css({height:$wrapper.height()});notification.set("isOpen",false); setTimeout(function(){$wrapper.addClass("close"); setTimeout(function(){$wrapper.remove();},self.CLOSE_ANIMATION_TIME);},0);},open:function(notification){var self=this,wrapper=SM.Template.renderHTML("notification-wrapper-template"),$wrapper=$(wrapper);$wrapper.append(notification.el);this.$el.prepend($wrapper);$wrapper.css({marginTop:(-1*$wrapper.outerHeight())-10});notification.set("isOpen",true); setTimeout(function(){$wrapper.addClass("open"); if(notification.get("expires")){
 setTimeout(function(){self.close(notification);},self.OPEN_ANIMATION_TIME+notification.get("duration"));}},0);},isInQueue:function(notification){return this._getQueueIndex(notification)!==-1;},_getQueueIndex:function(notification){var index=-1;$.each(this._queuedList,function(i,queued){if(notification.__uid===queued.__uid&&notification.__NAME===queued.__NAME){index=i;return false;}});return index;},_processQueue:function(){var self=this,notification;while(this._queuedList.length>0){notification=this._queuedList.shift();self.open(notification);}},_startTitleMessager:function(){var self=this,index=this._indexOfNextTabMessage(0);if(this._titleChangeIntervalID===null&&index!==-1){

 this._titleChangeIntervalID=setInterval(function(){if(index!==-1){document.title=self._queuedList[index].get("tabMessage");index=self._indexOfNextTabMessage(index+1);}else{document.title=self._originalTitle;index=self._indexOfNextTabMessage(0);}},2500);}},_stopTitleMessager:function(){if(this._titleChangeIntervalID){document.title=this._originalTitle;clearInterval(this._titleChangeIntervalID);this._titleChangeIntervalID=null;}},_indexOfNextTabMessage:function(i){var len=this._queuedList.length;for(;i<len;i++){if(this._queuedList[i].get("tabMessage")){return i;}}
return-1;},_onWindowFocus:function(e){var self=e.data.self;self._isWindowFocused=true;self._stopTitleMessager();self._processQueue();},_onWindowBlur:function(e){var self=e.data.self;self._isWindowFocused=false;},_onCloseClick:function(e){var self=e.data.self,notification,$notification=$(this).parents(".sm-notification");e.preventDefault();if($notification.length){notification=$notification.data("smnotification");if(notification){self.close(notification);}}}};SM.Tooltips={init:function(options){options=SM.Object.extend({selector:"[title]"},options);


 if(!SM.Browser.isOldIE){$(document).on("mouseenter.smtooltips",options.selector,{self:this},this._onMouseenter);}},_onMouseenter:function(e){var self=e.data.self,$el=$(e.currentTarget),attrs;if(!$el.data("tooltip")){attrs=self._getAttrs($el);if(!attrs.text){return;}
$el.data("tooltip",attrs);
 $el.removeAttr("title");

 $el.on("click.smtooltips mouseleave.smtooltips remove.smtooltips",{self:self},self._destroy);setTimeout(function(){ var tipData=$el.data("tooltip");if(tipData&&!tipData.isShown){self._showTipOn($el);}},1500);}},_destroy:function(e){var self=e.data.self,$el=$(this),tipData;tipData=$el.data("tooltip");if(!tipData){return;}
if(tipData.$el){tipData.$el.remove();}
$el.off("mouseleave.smtooltips");$el.off("remove.smtooltips");$el.off("click.smtooltips");$el.attr("title",tipData.text);$el.data("tooltip",null);},_showTipOn:function($el){var attrs=$el.data("tooltip"),position=SM.Object.copy(this._sides[attrs.side].position),$tip=this._build(attrs);attrs.$el=$tip;attrs.isShown=true;document.body.appendChild($tip[0]);position.of=$el;$tip.position($.migrationFixPosition(position));},_build:function(attrs){var div=document.createElement("div"),classes="tool-tip ";classes+=this._sides[attrs.side].className;if(attrs.classes){classes+=attrs.classes;}
div.className=classes;div.innerHTML=attrs.text;return $(div);},_sides:{left:{className:'tool-tip-left',position:{my:"right center",at:"left center",offset:'-5 0',collision:'none'}},right:{className:'tool-tip-right',position:{my:"left center",at:"right center",offset:'5 0',collision:'none'}},top:{className:'tool-tip-top',position:{my:"center bottom",at:"center top",offset:'0 -5',collision:'none'}},bottom:{className:'tool-tip-bottom',position:{my:"center top",at:"center bottom",offset:'0 5',collision:'none'}}},_getAttrs:function($el){return{text:$el.attr("title"),side:$el.attr("sm-tooltip-side")||"top",classes:$el.attr("sm-tooltip-classes")};}};SM.BaseMenuView=SM.Views.register({__NAME:"baseMenuView",__templateID:"base-menu-template"});SM.OptionMenuView=SM.Object.deepExtend({ __init:function(){this.bind("focusin",".option",this._onFocusIn).bind("mouseenter",".option",this._onOptionMouseEnter).bind("mouseleave",this._onMouseLeave);},__setters:{currentIndex:function(self,index){self._$options.removeClass("current");if(index===-1){self._$currentOption=null;}else{self._$currentOption=self._$options.eq(index).addClass('current');}
self._currentIndex=index;},selectedIndex:function(self,index){self._setSelectedIndex(index);}},__getters:{currentIndex:function(self,val){return self._currentIndex;}},nextCurrent:function(){var currentIndex=this._currentIndex;if(currentIndex<this._optionCount-1){this.set("currentIndex",currentIndex+1);this.scrollToItem(this._currentIndex);}},prevCurrent:function(){var currentIndex=this._currentIndex;if(currentIndex>0){this.set("currentIndex",currentIndex-1);this.scrollToItem(this._currentIndex);}},selectCurrent:function(){if(this._$currentOption){this._$currentOption.click();}},_$selectedOption:undefined,_$currentOption:undefined,_$options:undefined,_currentIndex:-1,_selectedIndex:-1,_optionCount:0,_refreshOptionData:function(){this._$options=this.$el.find(".option").not(".disabled").not(".unvailable");this._optionCount=this._$options.length;return this;},_setSelectedIndex:function(index){this._$options.removeClass("selected");if(index>=0&&index<this._optionCount){this._$selectedOption=this._$options.eq(index).addClass('selected');}else{this._$selectedOption=undefined;}
this._selectedIndex=index;return this;},scrollToItem:function(index){var menu=this.el,option=this._$options.eq(index).parent()[0];if(menu.scrollHeight<=menu.offsetHeight){return;}
if(option.offsetTop<menu.scrollTop){menu.scrollTop=option.offsetTop;}else if((option.offsetTop+option.offsetHeight)>(menu.scrollTop+menu.clientHeight)){menu.scrollTop=option.offsetTop+option.offsetHeight-menu.clientHeight;}
return this;},_onOptionMouseEnter:function(e){var self=e.data.self,$option=$(this);if($option.hasClass("disabled")){return;}
self.set("currentIndex",self._$options.index($option));},_onFocusIn:function(e){e.stopPropagation();},_onMouseLeave:function(e){var self=e.data.self;self.set("currentIndex",-1);}});SM.ActionMenuView=SM.Views.deepExtend(SM.OptionMenuView,{__NAME:"actionMenuView",__templateID:"action-menu-template",__init:function(){SM.OptionMenuView.__init.call(this);this.bind("click",".option",this._onOptionClick);},__afterRender:function(){this._refreshOptionData();if(this.__settings.saveState){if(this.__settings.selectedAction){this._setSelectedAction(this.__settings.selectedAction,true);}else{this._setSelectedIndex(-1,true);}}},__setters:{selectedAction:function(self,action){self._setSelectedAction(action,false);},selectedIndex:function(self,index){self._setSelectedIndex(index,false);},actions:function(self,actions){self.__settings.actions=actions;self.render();}},hasAction:function(action){return this.$el.find('[data-action="'+action+'"]').length>0;},_setSelectedAction:function(action,silent){var index=-1,$action=this.$el.find('[data-action="'+action+'"]');if($action.length){index=this._$options.index($action);}
if(this.__settings.saveState){this._setSelectedIndex(index,silent);}
this.__settings.selectedAction=action; if(!silent&&!(index>=0&&this.__settings.saveState)){this.trigger({type:"actionSelected",action:action,$action:$action});}},_setSelectedIndex:function(index,silent){var $action;if(this.__settings.saveState){SM.OptionMenuView._setSelectedIndex.call(this,index);}
if(index>=0&&index<this._optionCount){$action=this._$options.eq(index);this.__settings.selectedAction=$action.attr("data-action");if(!silent){this.trigger({type:"actionSelected",action:$action.attr("data-action"),$action:$action});}}},_onOptionClick:function(e){var self=e.data.self,$option=$(this),split,href=$option.attr("href");

 if(href){split=href.split("#");if(split.length<2){if($option.hasClass("disabled")){e.preventDefault();e.stopPropagation();}else{self.trigger("optionClicked");}
return;}}
e.preventDefault();e.stopPropagation();if($option.hasClass("disabled")){return;}
self.set("selectedAction",$option.attr("data-action"));self.trigger("optionClicked");}});SM.SelectMenuView=SM.Views.deepExtend(SM.OptionMenuView,{__NAME:"SelectMenuView",__templateID:"select-menu-template",__init:function(){SM.OptionMenuView.__init.call(this);this.bind("click",".option",this._onOptionClick);this.bind("click","li",this._onListItemClick);},__afterRender:function(){var options=this.__settings.options,selectedValue=this.__settings.selectedValue;if(options){this.$el.append(SM.Template.render("select-options-template",options));}
this._refreshOptionData();this._collectOptionsText();if(this.__settings.selectedValue!==undefined&&this.__settings.selectedValue!==null){this.set("selectedValue",this.__settings.selectedValue);}else{this.set("selectedIndex",0);}},__setters:{selectedValue:function(self,value){var index=self._getIndexByValue(value),displayText;if(index!==-1){self._setSelectedIndex(index);displayText=self._getText(value);self.trigger({type:"change",value:value,displayText:displayText});}},selectedIndex:function(self,index){var value,displayText;if(index>=0&&index<self._optionCount){self._setSelectedIndex(index);value=self._getValueByIndex(index);displayText=self._getText(value);self.trigger({type:"change",value:value,displayText:displayText});}},options:function(self,options){self.__settings.options=options;self.render();}},__getters:{selectedValue:function(self){return self._getValueByIndex(self._selectedIndex);},valueText:function(self){var value=self._getValueByIndex(self._selectedIndex);return self._getOptionByValue(value).text();}},VALUE_ATTR:"opt-value",searchOptions:function(searchTerm){var options=this._optionsText,optionsLen=options.length,searchTermLen=searchTerm.length,startIndex=this._selectedIndex,i;
 if(searchTermLen>1){i=startIndex;
}else{if(startIndex===-1){i=0;}else{i=startIndex+1;}}
 
for(;i<optionsLen;i++){if(options[i].substr(0,searchTermLen)===searchTerm){return i;}}
 
for(i=0;i<=startIndex;i++){if(options[i].substr(0,searchTermLen)===searchTerm){return i;}}
return-1;},nextSelect:function(){var selectedIndex=this._selectedIndex;if(selectedIndex<this._optionCount-1){this.set("selectedIndex",selectedIndex+1);this.scrollToItem(this._selectedIndex);}},prevSelect:function(){var selectedIndex=this._selectedIndex;if(selectedIndex>0){this.set("selectedIndex",selectedIndex-1);this.scrollToItem(this._selectedIndex);}},_optionsText:undefined,_collectOptionsText:function(){this._optionsText=this._$options.map(function(){return $.trim($(this).text().toLowerCase());}).get();return this;},_getText:function(value){return this._getOptionByValue(value).text();},_getOptionByValue:function(value){return this.$el.find("["+this.VALUE_ATTR+"="+value+"]");},_getIndexByValue:function(value){var $option=this._getOptionByValue(value);return this._$options.index($option);},_getValueByIndex:function(index){var $option=this._$options.eq(index);return $option.attr(this.VALUE_ATTR);},_onOptionClick:function(e){var self=e.data.self,$option=$(this);e.preventDefault();e.stopPropagation();if($option.hasClass("disabled")){return;}
self.set("selectedIndex",self._$options.index($option));},_onListItemClick:function(e){e.stopPropagation();}});SM.CalendarMenuView=SM.Views.register({__NAME:"calendarMenuView",__templateID:"calendar-menu-template",__init:function(){this.bind("click",".nextBtn",this._onNextMonthClick).bind("click",".prevBtn",this._onPrevMonthClick).bind("click","td.day:not(.out-of-range)",this._onDayClick);if(this.__settings.selectMenus){this.bind("selectMenu.change",".yearSelect",this._onSelectYearChange).bind("selectMenu.change",".monthSelect",this._onSelectMonthChange);}},__beforeRender:function(){var weekdays=this._buildDayHeaders(),calendarData=this.__settings,displayDate,minDate,maxDate,selectedDate,currentDate,isPrevBtnDisabled,isNextBtnDisabled,culture=Globalize.culture(),monthName,weeks;displayDate=SM.Date.getSimpleDate(this._displayDate);minDate=SM.Date.getSimpleDate(calendarData.minDate);maxDate=SM.Date.getSimpleDate(calendarData.maxDate);selectedDate=SM.Date.getSimpleDate(calendarData.selectedDate);currentDate=SM.Date.getSimpleDate(this._currentDate);isPrevBtnDisabled=displayDate.year<=minDate.year&&displayDate.month<=minDate.month;isNextBtnDisabled=displayDate.year>=maxDate.year&&displayDate.month>=maxDate.month;monthName=culture.calendars.standard.months.names[displayDate.month],weeks=this._buildDays(displayDate,minDate,maxDate,selectedDate,currentDate);return{weekdays:weekdays,monthName:monthName,displayDate:displayDate,minDate:minDate,maxDate:maxDate,currentDate:currentDate,selectedDate:selectedDate,isPrevBtnDisabled:isPrevBtnDisabled,isNextBtnDisabled:isNextBtnDisabled,selectMenus:calendarData.selectMenus,weeks:weeks,yearFirst:culture.calendar.yearFirst};},__afterRender:function(md){var minMonth,maxMonth;if(this.__settings.selectMenus){this.$el.find(".yearSelect").selectMenu({menuView:"YearSelectMenuView",selectedValue:md.displayDate.year,minYear:md.minDate.year,maxYear:md.maxDate.year});minMonth=0;maxMonth=11;if(md.minDate.year&&md.displayDate.year===md.minDate.year){minMonth=md.minDate.month;}
if(md.maxDate.year&&md.displayDate.year===md.maxDate.year){maxMonth=md.maxDate.month;}
this.$el.find(".monthSelect").selectMenu({menuView:"MonthSelectMenuView",selectedValue:md.displayDate.month,minMonth:minMonth,maxMonth:maxMonth});}},resetDisplayDate:function(settings){var simpleDate,calendarData=this.__settings=settings;this._currentDate=new Date();if(calendarData.selectedDate){simpleDate=SM.Date.getSimpleDate(calendarData.selectedDate);}else if(calendarData.minDate&&this._currentDate<calendarData.minDate){simpleDate=SM.Date.getSimpleDate(calendarData.minDate);}else if(calendarData.maxDate&&this._currentDate>calendarData.maxDate){simpleDate=SM.Date.getSimpleDate(calendarData.maxDate);}else{simpleDate=SM.Date.getSimpleDate(this._currentDate);}
this._displayDate=new Date(simpleDate.year,simpleDate.month,1);},_setDisplayDate:function(year,month){var date=new Date(year,month,1);this._currentDate=new Date();this._displayDate=date;},_buildDayHeaders:function(){var culture=Globalize.culture(),calendar=culture.calendars.standard,i=calendar.firstDay,days=calendar.days.names,shortDays=calendar.days.namesShort,normalizedIndex,weekdays=[],dayCount=7;while(dayCount){normalizedIndex=i<7?i:i-7;weekdays.push({name:days[normalizedIndex],shortName:shortDays[normalizedIndex]});dayCount--;i++;}
return weekdays;},_buildDays:function(displayDate,minDate,maxDate,selectedDate,currentDate){var daysBuilt=0,i,day,dayNumber,selectedMonth=selectedDate.month,selectedYear=selectedDate.year,selectedDay=selectedDate.day,currentMonth=currentDate.month,currentYear=currentDate.year,currentDay=currentDate.day,minMonth=minDate.month,minYear=minDate.year,minDay=minDate.day,maxDay=maxDate.day,maxMonth=maxDate.month,maxYear=maxDate.year,weeks=[],days,displayMonth=displayDate.month,displayYear=displayDate.year,firstDayIndex=Globalize.getWeekdayIndexOfFirstDay(displayMonth,displayYear),daysInMonth=SM.Date.getDaysInMonth(displayMonth,displayYear),isMinMonth=minMonth===displayMonth&&minYear===displayYear,isMaxMonth=maxMonth===displayMonth&&maxYear===displayYear,isSelectedMonth=selectedMonth===displayMonth&&selectedYear===displayYear,isCurrentMonth=currentMonth===displayMonth&&currentYear===displayYear,daysToBeBuilt=7*Math.ceil((daysInMonth+firstDayIndex)/7);while(daysBuilt<daysToBeBuilt){days=[];for(i=0;i<7;i++){dayNumber=(daysBuilt-firstDayIndex)+1;if(daysBuilt<firstDayIndex||dayNumber>daysInMonth){day={isBlank:true,isFirstEnd:dayNumber===daysInMonth+1};}else{day={number:dayNumber,isLast:dayNumber===daysInMonth,isSelected:isSelectedMonth&&selectedDay===dayNumber,isToday:isCurrentMonth&&currentDay===dayNumber,isOutOfRange:((isMinMonth&&daysBuilt>=firstDayIndex&&dayNumber<minDay)||(isMaxMonth&&dayNumber>maxDay&&dayNumber<=daysInMonth))};}
days.push(day);++daysBuilt;}
weeks.push(days);}
return weeks;}, _onPrevMonthClick:function(e){var self=e.data.self,displayDate=SM.Date.getSimpleDate(self._displayDate),$elem=$(this);e.preventDefault();e.stopPropagation();if(!$elem.hasClass("disabled")){self._setDisplayDate(displayDate.year,displayDate.month-1);self.render();}},_onNextMonthClick:function(e){var self=e.data.self,$elem=$(this),displayDate=SM.Date.getSimpleDate(self._displayDate);e.preventDefault();e.stopPropagation();if(!$elem.hasClass("disabled")){self._setDisplayDate(displayDate.year,displayDate.month+1);self.render();}},_onSelectYearChange:function(e){var self=e.data.self,month,year,calendarData=self.__settings,minDate=SM.Date.getSimpleDate(calendarData.minDate),maxDate=SM.Date.getSimpleDate(calendarData.maxDate),displayDate=SM.Date.getSimpleDate(self._displayDate);year=parseInt(e.value,10);month=displayDate.month;if(minDate.year&&year===minDate.year&&minDate.month>displayDate.month){month=minDate.month;}
if(maxDate.year&&year===maxDate.year&&maxDate.month<displayDate.month){month=maxDate.month;}
self._setDisplayDate(year,month);self.render();},_onSelectMonthChange:function(e){var self=e.data.self,displayDate=SM.Date.getSimpleDate(self._displayDate);self._setDisplayDate(displayDate.year,parseInt(e.value,10));self.render();},_onDayClick:function(e){var self=e.data.self,$day=$(e.currentTarget),day=parseInt($day.attr("data-day"),10),displayDate=SM.Date.getSimpleDate(self._displayDate);self.trigger({type:"dateSelected",date:new Date(displayDate.year,displayDate.month,day)});}});SM.AutocompleteMenuView=SM.Views.deepExtend(SM.OptionMenuView,{__NAME:"AutocompleteMenuView",__templateID:"autocomplete-menu-template",__defaults:{results:[]},__init:function(){SM.OptionMenuView.__init.call(this);this.bind("click",".option",this._onOptionClick);},__afterRender:function(){this._refreshOptionData();},__setters:{results:function(self,results){self.__settings.results=results;self.render();self.set("currentIndex",-1);}},_onOptionClick:function(e){var self=e.data.self,$option=$(this);e.preventDefault();e.stopPropagation();if($option.hasClass("disabled")){return;}
self.trigger({type:"selected",text:$option.text(),value:$option.attr("data-value")});}});SM.YearSelectMenuView=SM.Views.deepExtend(SM.SelectMenuView,{__templateID:"years-select-menu-template",__NAME:"yearSelectMenuView",__defaults:{maxYear:null,minYear:null},__beforeRender:function(){var maxYear=this.__settings.maxYear?this.__settings.maxYear:(new Date()).getFullYear(),selectedYear=this.__settings.selectedValue,minYear=this.__settings.minYear,years=[],year=maxYear;for(;year>=minYear;year--){years.push({text:year,value:year,isSelected:year===selectedYear});}
this.__settings.options=years;return this.__settings;}});SM.MonthSelectMenuView=SM.Views.deepExtend(SM.SelectMenuView,{__templateID:"month-select-menu-template",__NAME:"monthSelectMenuView",__defaults:{maxMonth:11,minMonth:0},__beforeRender:function(){var maxMonth=this.__settings.maxMonth,selectedMonth=this.__settings.selectedValue,months=[],culture=Globalize.culture(),monthNamesShort=culture.calendars.standard.months.namesAbbr,month=this.__settings.minMonth;for(;month<=maxMonth;month++){months.push({value:month,text:monthNamesShort[month],isSelected:month===selectedMonth});}
this.__settings.options=months;return this.__settings;}});SM.HourSelectMenuView=SM.Views.deepExtend(SM.SelectMenuView,{__templateID:"hour-select-menu-template",__NAME:"hourSelectMenuView",__defaults:{militaryTime:false},__beforeRender:function(){var i=0,selectedHours=this.__settings.selectedValue,hours=[],len;if(this.__settings.militaryTime){len=23;}else{len=11;i=1;hours.push({value:12,text:"12",isSelected:0===selectedHours});}
while(i<=len){hours.push({value:i,text:i<10?"0"+i:i,isSelected:selectedHours===i});i++;}
this.__settings.options=hours;return this.__settings;}});SM.MinuteSelectMenuView=SM.Views.deepExtend(SM.SelectMenuView,{__templateID:"minute-select-menu-template",__NAME:"minuteSelectMenuView",__defaults:{increment:15},__beforeRender:function(){var len=60,increment=this.__settings.increment,selectedMinutes=this.__settings.selectedValue,minutes=[],i=0;for(;i<len;i+=increment){minutes.push({value:i,text:i<10?"0"+i:i,isSelected:selectedMinutes===i});}
this.__settings.options=minutes;return this.__settings;}});$.extend(SM.Object,{getOneKey:function(obj){for(var key in obj){return key;}},getOnlyKey:function(obj){var i=-1;for(var key in obj){i++;if(i>0){throw"getOnlyKey() called on object with more than one key";}}
return key;},hasOnlyProperty:function(obj,prop){var property;for(property in obj){if(obj.hasOwnProperty(property)&&property!==prop){return false;}}
return true;}});SM.String.containsWordBoundary=function(str){return str.match(/(?=\w)\S+(?!\w)/);};SM.String.truncateMiddle=function(fullStr,strLen,separator){if(fullStr.length<=strLen)return fullStr;separator=separator||'...';var sepLen=separator.length,charsToShow=strLen-sepLen,frontChars=Math.ceil(charsToShow/2),backChars=Math.floor(charsToShow/2);return fullStr.substr(0,frontChars)+
separator+
fullStr.substr(fullStr.length-backChars);};SM.String.NON_BREAKING_HYPHEN=SM.Html.parse("&#8209;")[0].nodeValue;SM.Error={init:function(){window.onerror=this._onWindowError;},log:function(exception,details){var trace=exception.stack;if(!exception){return;}
if(!exception.message){exception.message='no message';}
if(!exception.name){exception.name='UndefinedException';}
if(SM.DEBUG){setTimeout(function(){if(details){SM.log(details);} 
if(trace){SM.log(trace);}
throw exception;},0);}else{if(!details){details='No details.';}
if(!trace){trace='No trace.';}
SM.Ajax.logError({name:exception.name,message:exception.message,details:details,trace:trace});}},_isThirdPartyScript:function(url){var splitScriptHost,splitDocumentHost;url=this._parseUrl(url);if(!url||!url.host){ return false;}
splitScriptHost=url.host.split(".");if(splitScriptHost.length!==3){ return true;}
splitDocumentHost=window.location.host.split("."); if(splitScriptHost[1]!==splitDocumentHost[1]){return true;} 
return false;},_parseUrl:function(url){var a;if(!url){return null;}
a=document.createElement("a");a.href=url;return{raw:a.href,host:a.hostname,scheme:a.protocol,path:a.pathname,query:a.query,hash:a.hash};},_onWindowError:function(message,url,lineNumber){if(SM.DEBUG||SM.TEST){return false;}else{try{if(SM.Error._isThirdPartyScript(url)){SM.Ajax.logWarning({name:'ThirdPartyException',message:message,scriptUrl:url});}else{SM.Ajax.logError({name:'UncaughtException',message:message});}}catch(e){}
window.onerror=undefined;return true;}}};SM.Ajax={init:function(surveyID,appVersion){this.surveyID=surveyID;this.appVersion=appVersion;},Statuses:{SUCCESS:0,CONFLICT:409, SERVER_ERROR:500},Urls:{LOG_INFO:"/analyze/ajax/log_info",FETCH_RESPONSES:"/analyze/ajax/respondents/responses",FETCH_SHARED_RESPONSES:"/analyze/ajax/shared-view/{shared_view_key}/respondents/responses",DELETE_RESPONDENT:"/analyze/ajax/respondents/delete",FETCH_ROLLUPS:"/analyze/ajax/questions/rollups",FETCH_TREND_ROLLUPS:"/analyze/ajax/questions/trend_rollups",DELETE_VIEW:"/analyze/ajax/view/delete",DUPLICATE_VIEW:"/analyze/ajax/view/duplicate",EDIT_VIEW:"/analyze/ajax/view/edit",SWITCH_VIEW:"/analyze/ajax/view/switch",SHARED_VIEWS_INDEX:"/analyze/ajax/shared_views",EXPORT_DELETE:"/analyze/ajax/export/delete",EXPORT_CREATE:"/analyze/ajax/export/create",EXPORT_LIST:"/analyze/ajax/export/list",TA_GET_ROLLUP_QUESTION:"/analyze/ajax/ta/rollup/by_question",TA_GET_ROLLUP_SHARED_QUESTION:"/analyze/ajax/shared-view/{shared_view_key}/ta/rollup/by_question",TA_GET_ROLLUP_SEARCH:"/analyze/ajax/ta/rollup/by_search",TA_GET_ROLLUP_PHRASE:"/analyze/ajax/ta/rollup/by_phrase",TA_TEXT_TAG_ALL:'/analyze/ajax/ta/response_texts/tag_all',TA_TEXT_TAG_EXCEPT:'/analyze/ajax/ta/response_texts/tag_except',TA_EDIT_TAG:"/analyze/ajax/ta/question_tags/update",TA_DELETE_TAG:"/analyze/ajax/ta/question_tags/delete",TA_CREATE_TAG:"/analyze/ajax/ta/question_tags/create", BM_GET_BENCHMARK_ROLLUP:"/analyze/ajax/bm/get_benchmark_rollup",BM_GET_BENCHMARK_DISTRIBUTION_ROLLUP:"/analyze/ajax/bm/get_benchmark_distribution_rollup"},get:function(url,data){var ajaxOptions={dataType:'json',type:'GET',contentType:"application/json",processData:false,url:url,cache:false,headers:{}},urlWithQueryString,request;if(data){urlWithQueryString=new Uri(url);_.each(data,function(v,k){urlWithQueryString.addQueryParam(k,v);});ajaxOptions.url=urlWithQueryString.toString();} 
ajaxOptions.headers['SM-Analyze-Version']=this.appVersion;SM.log("Ajax GET:",JSON.stringify(ajaxOptions));request=$.ajax(ajaxOptions);request=this._normalizeRequest(request);return request;},post:function(url,data){var ajaxOptions={dataType:'json',type:'POST',data:JSON.stringify(data),contentType:"application/json",processData:false,url:url,cache:false,headers:{}},request;SM.log("Ajax POST:",JSON.stringify(ajaxOptions)); ajaxOptions.headers['SM-Analyze-Version']=this.appVersion;request=$.ajax(ajaxOptions);request=this._normalizeRequest(request);return request;},destroy:function(url,data){var ajaxOptions={dataType:'json',type:'DELETE',data:JSON.stringify(data),contentType:"application/json",processData:false,url:url,cache:false,headers:{}},request;SM.log("Ajax DELETE:",JSON.stringify(ajaxOptions)); ajaxOptions.headers['SM-Analyze-Version']=this.appVersion;request=$.ajax(ajaxOptions);request=this._normalizeRequest(request);return request;},logInfo:function(data,ajaxOptions){data.level="info";data.url=window.location.href;this.post(this.Urls.LOG_INFO,data);},logError:function(data,ajaxOptions){data.level="error";data.url=window.location.href;this.post(this.Urls.LOG_INFO,data,ajaxOptions);},logWarning:function(data,ajaxOptions){data.level="warning";data.url=window.location.href;this.post(this.Urls.LOG_INFO,data,ajaxOptions);},fetchRespondents:function(data,ajaxOptions){var requestData=SM.Object.extend({survey_id:this.surveyID},data);var url;if(SM.App.isSharingApp()){url=this.Urls.FETCH_SHARED_RESPONSES.replace('{shared_view_key}',SM.App.sharedView.get("key"));}else{url=this.Urls.FETCH_RESPONSES;}
return this.post(url,requestData,ajaxOptions);},deleteRespondent:function(data,ajaxOptions){return this.post(this.Urls.DELETE_RESPONDENT,data,ajaxOptions);},fetchRollups:function(data,ajaxOptions){var requestData=SM.Object.extend({survey_id:this.surveyID},data);return this.post(this.Urls.FETCH_ROLLUPS,requestData,ajaxOptions);},fetchTrends:function(data,ajaxOptions){var requestData=SM.Object.extend({survey_id:this.surveyID},data);return this.post(this.Urls.FETCH_TREND_ROLLUPS,requestData,ajaxOptions);},editView:function(data,ajaxOptions){var requestData=SM.Object.extend({survey_id:this.surveyID},data);return this.post(this.Urls.EDIT_VIEW,requestData,ajaxOptions);},deleteView:function(data,ajaxOptions){var requestData=SM.Object.extend({survey_id:this.surveyID},data);return this.post(this.Urls.DELETE_VIEW,requestData,ajaxOptions);},duplicateView:function(data,ajaxOptions){var requestData=SM.Object.extend({survey_id:this.surveyID},data);return this.post(this.Urls.DUPLICATE_VIEW,requestData,ajaxOptions);},switchView:function(data,ajaxOptions){var requestData=SM.Object.extend({survey_id:this.surveyID},data);return this.post(this.Urls.SWITCH_VIEW,requestData,ajaxOptions);},createExport:function(data,ajaxOptions){var requestData=SM.Object.extend({survey_id:this.surveyID},data);return this.post(this.Urls.EXPORT_CREATE,requestData,ajaxOptions);},getExportList:function(data,ajaxOptions){var requestData=SM.Object.extend({survey_id:this.surveyID},data);return this.post(this.Urls.EXPORT_LIST,requestData,ajaxOptions);},deleteExport:function(data,ajaxOptions){var requestData=SM.Object.extend({survey_id:this.surveyID},data);return this.post(this.Urls.EXPORT_DELETE,requestData,ajaxOptions);},taGetRollupQuestion:function(data,ajaxOptions){var requestData=SM.Object.extend({survey_id:this.surveyID},data);var url;if(SM.App.isSharingApp()){url=this.Urls.TA_GET_ROLLUP_SHARED_QUESTION.replace('{shared_view_key}',SM.App.sharedView.get("key"));}else{url=this.Urls.TA_GET_ROLLUP_QUESTION;}
return this.post(url,requestData,ajaxOptions);},taGetRollupSearch:function(data,ajaxOptions){var requestData=SM.Object.extend({survey_id:this.surveyID},data);return this.post(this.Urls.TA_GET_ROLLUP_SEARCH,requestData,ajaxOptions);},taGetRollupPhrase:function(data,ajaxOptions){var requestData=SM.Object.extend({survey_id:this.surveyID},data);return this.post(this.Urls.TA_GET_ROLLUP_PHRASE,requestData,ajaxOptions);},taTagAllText:function(data,ajaxOptions){var requestData=SM.Object.extend({survey_id:this.surveyID},data);return this.post(this.Urls.TA_TEXT_TAG_ALL,requestData,ajaxOptions);},taTagExceptText:function(data,ajaxOptions){var requestData=SM.Object.extend({survey_id:this.surveyID},data);return this.post(this.Urls.TA_TEXT_TAG_EXCEPT,requestData,ajaxOptions);},taDeleteTag:function(data,ajaxOptions){var requestData=SM.Object.extend({survey_id:this.surveyID},data);return this.post(this.Urls.TA_DELETE_TAG,requestData,ajaxOptions);},taCreateTag:function(data,ajaxOptions){var requestData=SM.Object.extend({survey_id:this.surveyID},data);return this.post(this.Urls.TA_CREATE_TAG,requestData,ajaxOptions);},taEditTag:function(data,ajaxOptions){var requestData=SM.Object.extend({survey_id:this.surveyID},data);return this.post(this.Urls.TA_EDIT_TAG,requestData,ajaxOptions);},bmFetchBenchmarkRollup:function(data,ajaxOptions){var requestData=SM.Object.extend({survey_id:this.surveyID},data);return this.post(this.Urls.BM_GET_BENCHMARK_ROLLUP,requestData,ajaxOptions);},bmFetchBenchmarkDistributionRollup:function(data,ajaxOptions){var requestData=SM.Object.extend({survey_id:this.surveyID},data);return this.post(this.Urls.BM_GET_BENCHMARK_DISTRIBUTION_ROLLUP,requestData,ajaxOptions);},_normalizeRequest:function(request){var dfd=$.Deferred();$.when({dfd:dfd},request).done(this._done).fail(function(jqXHR,textStatus,exception){SM.Ajax._fail(dfd,jqXHR,textStatus);});return dfd;},_done:function(context,doneArgs){var data=doneArgs[0],textStatus=doneArgs[1],jqXHR=doneArgs[2],dfd=context.dfd;if(data.status===SM.Ajax.Statuses.SUCCESS||data.status===200){if(data.data){dfd.resolve(data.data,textStatus,jqXHR);}else{dfd.resolve(data,textStatus,jqXHR);}}else{SM.log("Ajax done but not successful:",JSON.stringify(data));dfd.reject(data,textStatus,jqXHR);}},_fail:function(request,jqXHR,textStatus){var data;SM.log("Ajax fail, response text:",jqXHR.responseText);try{data=JSON.parse(jqXHR.responseText);if(data.status===SM.Ajax.Statuses.CONFLICT){SM.PubSub.publish('HTTP_CONFLICT');


return;}}catch(e){data={error_message:jqXHR.responseText};}
request.reject(data,textStatus,jqXHR);}};SM.Benchmarker={time:function(func,name){var st=(new Date()).getTime();func();var et=(new Date()).getTime();if(name){SM.log("Took "+(et-st)+"ms to call "+name);}else{SM.log("Took "+(et-st)+"ms");}}};SM.TrendLib={getDefaultScales:function(timeframe,active,trend_by){var hours=timeframe/this.HOUR,zoomMapping=active?this.zoomMapping:this.zoomMapping_inactive,scales={},trendIdx,zoomIdx,zoom;for(zoom in zoomMapping){if(hours<=zoomMapping[zoom]){scales.zoom=zoom;scales.zoomMax=zoom;scales.trend=trend_by;scales.label=this.getLabelUnit(scales.zoom,scales.trend);break;}}
return scales;},getLabelUnit:function(zoom,trend){if((zoom==='max'&&_.contains(['quarter','month','week','day'],trend))){return'year';}else if((zoom==='year'&&trend==='week')||(zoom==='three_years'&&_.contains(['week','day'],trend))){return'month';}else{return trend;}},smallerTimeUnit:{week:'day',month:'week',quarter:'month',year:'quarter','three_years':'year',max:'quarter'},HOUR:1000*3600,timeUnits:['day','week','month','quarter','year','three_years','max'],timeIdx:{'day':0,'week':1,'month':2,'quarter':3,'year':4,'three_years':5,'max':6},Trend2ZoomOptions:{'day':{list:['week','month'],selected:'week'},'week':{list:['month','quarter','year'],selected:'month'},'month':{list:['quarter','year','three_years'],selected:'quarter'},'quarter':{list:['year','three_years','max'],selected:'year'},'year':{list:['three_years','max'],selected:'three_years'}},Trend2ZoomOptions_inactive:{'day':{list:['week','month'],selected:'week'},'week':{list:['month','quarter','year'],selected:'month'},'month':{list:['quarter','year','three_years'],selected:'quarter'},'quarter':{list:['year','three_years','max'],selected:'year'},'year':{list:['three_years','max'],selected:'year'}},trendMapping:{day:24,'7days':24*7,week:24*7,'30days':24*30,month:24*30,quarter:24*30*3,year:24*30*12,'three_years':24*30*12*3,max:24*366*15},zoomMapping:{week:24*7,month:24*30,quarter:24*30*3,year:24*30*12,'three_years':24*30*12*3,max:24*366*15},zoomMapping_inactive:{month:24*30,quarter:24*30*3,year:24*30*12,'three_years':24*30*12*3,max:24*366*15},getBucket:function(ts,unit){var bucket={startsAt:SM.TrendLib._getStartOfBucket(ts,unit).valueOf(),endsAt:SM.TrendLib._getEndOfBucket(ts,unit).valueOf(),unit:unit};return bucket;},_getStartOfBucket:function(ts,unit){var firstMonthOfQuarter,mdate=this.localize(ts),quarter;switch(unit){case'hour':return moment(ts).startOf('hour');case'day':return moment(ts).startOf('day');case'week':return moment(ts).startOf('week');case'month':return moment(ts).startOf('month');case'quarter':firstMonthOfQuarter=Math.floor((mdate.month())/3)*3;quarter=mdate.month(firstMonthOfQuarter);return quarter.startOf('month');case'year':return moment(ts).startOf('year');default:return null;}},_getEndOfBucket:function(ts,unit){var lastMonthOfQuarter,mdate=this.localize(ts),quarter;switch(unit){case'hour':return moment(ts).endOf('hour');case'day':return moment(ts).endOf('day');case'week':return moment(ts).endOf('week');case'month':return moment(ts).endOf('month');case'quarter':lastMonthOfQuarter=Math.floor((mdate.month())/3)*3+2;quarter=mdate.month(lastMonthOfQuarter);return quarter.endOf('month');case'year':return moment(ts).endOf('year');default:return null;}},getBucketDiff:function(duration,unit){var hours=duration/this.HOUR,count=Math.ceil(hours/this.trendMapping[unit]);return count;},getPreviousBucket:function(bucket,n){var mdate=this.localize(bucket.startsAt),unit=bucket.unit;if(n===undefined){n=1;}
switch(unit){case'hour':mdate.subtract('hour',1*n);return this.getBucket(mdate,unit);case'day':mdate.subtract('day',1*n);return this.getBucket(mdate,unit);case'week':mdate.subtract('week',1*n);return this.getBucket(mdate,unit);case'month':mdate.subtract('month',1*n);return this.getBucket(mdate,unit);case'quarter':mdate.subtract('month',3*n);return this.getBucket(mdate,unit);case'year':mdate.subtract('year',1*n);return this.getBucket(mdate,unit);default:return null;}},getNextBucket:function(bucket,n){var mdate=this.localize(bucket.startsAt),unit=bucket.unit;if(n===undefined){n=1;}
switch(unit){case'hour':mdate.add('hour',1*n);return this.getBucket(mdate,unit);case'day':mdate.add('day',1*n);return this.getBucket(mdate,unit);case'week':mdate.add('week',1*n);return this.getBucket(mdate,unit);case'month':mdate.add('month',1*n);return this.getBucket(mdate,unit);case'quarter':mdate.add('month',3*n);return this.getBucket(mdate,unit);case'year':mdate.add('year',1*n);return this.getBucket(mdate,unit);default:return null;}},getLabelName:function(ts,label){var culture=Globalize.culture(),calendar=culture.calendars.standard,shortMonths=calendar.months.namesAbbr,mdate=this.localize(ts),year,month,date,hour,labelDate;year=mdate.year();month=mdate.month();date=mdate.date();hour=mdate.hour();labelDate=new Date(year,month,date);switch(label){case'year':return year+'';case'quarter':case'month':return shortMonths[month]+' '+year;case'week':case'day':return Globalize.format(labelDate,'d');case'hour':return Globalize.normalizeHour(hour)+' '+Globalize.format(labelDate,'d');default:return'<invalid-label>';}},toDate:function(mdate){var year,month,date,thisDate;year=mdate.year();month=mdate.month();date=mdate.date();thisDate=new Date(year,month,date);return Globalize.format(thisDate,"d");},isActive:function(lastRespondentMdate){return moment().diff(lastRespondentMdate,'days')<15;},localize:function(timestamp){ var current_lang=moment.lang();moment.lang(current_lang,{week:{dow:1,doy:4
}});return moment(timestamp).zone(moment().zone());},BucketingException:function(options){var bucketIndex=options.bucketIndex,trendDatum=options.trendDatum,respondentBucket=options.respondentBucket,message='trendBucket#'+bucketIndex+': start@'+trendDatum.start.valueOf()+" ("+trendDatum.start.toString()+")"+'; data bucket start@'+respondentBucket.start+" ("+SM.TrendLib.localize(respondentBucket.start).toString()+")"+" end@"+respondentBucket.end+" ("+SM.TrendLib.localize(respondentBucket.end).toString()+")";return{name:"TrendBucketingException",message:message,toString:function(){return this.name+": "+this.message;}};}};SM.BaseAnView={currentSaveRequest:undefined,currentRevertRequest:undefined,isDefault:false,isCurrent:false,clone:function(name){var clone=this.dump(),view;clone.is_default=false;clone.is_current=false;clone.name=name||clone.name+" - "+Globalize.localize("COPY");view=SM.Models.create("AnView",{ID:"new_"+SM.Date.timestamp(),anView:clone});view.anviews=this.anviews;return view;},save:function(){var request=SM.Ajax.editView({view_data:this.dump(),view_id:this.ID});this.set("lastEditRequest",request);return request;}};SM.Models.register("AnViewList",{viewMap:null,viewList:null,currentView:null,defaultView:null,nextSelectedViewID:null,selectedViewID:null,__create:function(options){var self=this;self.survey=options.survey;self.viewMap={};self.viewList=[];}, createViewModels:function(viewData){var currentView=viewData.viewMap[viewData.currentViewID],defaultView=viewData.viewMap[viewData.defaultViewID];delete viewData.viewMap[viewData.currentViewID];delete viewData.viewMap[viewData.defaultViewID];this.selectedViewID=viewData.selectedViewID;this._initStandardViews(viewData);this.defaultView=this._initDefaultView(defaultView);this.currentView=this._initCurrentView(currentView);this.currentView.loadView(currentView);this.currentView.loadMetadata(currentView.metadata);this.currentView.on("isDirty.set",{self:this},this._onCurrentViewDirtySet);},__setters:{selectedViewID:function(self,val){var selectedView=self.getView(val),lastSelectedView=self.getView(self.selectedViewID);if(val===self.selectedViewID){return;}
if(self.currentView.get("isDirty")){self.set("nextSelectedViewID",val,{notify:true});}else{self.selectedViewID=val;self.updateSelectedView();selectedView.set("selected",true,{notify:true});lastSelectedView.set("selected",false,{notify:true});}}},addView:function(anView,isSelected){this.viewMap[anView.ID]=anView;this.viewList.push(anView);this._trigger({type:"viewAdded",anViewModel:anView,isSelected:isSelected});this._trigger("sizeChanged");},removeView:function(anViewModel){var self=this;$.each(this.viewList,function(i,viewItem){if(anViewModel.ID===viewItem.ID){self.viewList.splice(i,1);return false;}});delete this.viewMap[anViewModel.ID];this._trigger("sizeChanged");},deleteView:function(anViewModel){var currentView=this.currentView,defaultViewID=this.defaultView.ID,isDeletingSelectedView=anViewModel.ID===this.get("selectedViewID");if(isDeletingSelectedView){this.set("selectedViewID",this.defaultView.ID);}else if(this.get("nextViewID")===anViewModel.ID){this.set("nextViewID",null);}
this.removeView(anViewModel);return SM.Ajax.deleteView({view_id:anViewModel.ID});},copyView:function(anViewModel){var copy=anViewModel.clone(),request=SM.Ajax.duplicateView({source_view_id:anViewModel.ID,name:copy.get("name")});this.addView(copy,false);$.when({self:this,tempID:copy.ID},request).done(this._onViewCopySuccess);},_onViewCopySuccess:function(context,doneArgs){var self=context.self,data=doneArgs[0],anViewModel=self.getView(context.tempID); anViewModel.ID=data.new_view.view_id;self.viewMap[anViewModel.ID]=anViewModel;delete self.viewMap[context.tempID];anViewModel._trigger("copySuccess");},saveCurrentViewAs:function(name){var viewID=this.get("selectedViewID"),nextViewID=this.get("nextSelectedViewID"),currentView=this.currentView,copy=currentView.clone(name),context={self:this,tempID:copy.ID,switchToNewView:nextViewID===null,requestData:{source_view_id:currentView.ID,name:name}};currentView.set("isDirty",false,{notify:true});this.addView(copy,context.switchToNewView);this.currentView._trigger("savedToNewView");$.when(context,this.currentView.get("lastEditRequest")).always(this._makeSaveAsRequest);if(nextViewID){this.set("selectedViewID",nextViewID);}},_onViewSaveAsSuccess:function(context,doneArgs){var self=context.self,data=doneArgs[0],view=self.getView(context.tempID);view.ID=data.new_view.view_id;self.viewMap[view.ID]=view;delete self.viewMap[context.tempID];view._trigger("createSuccess");if(context.switchToNewView){ self.set("selectedViewID",view.ID);}},getView:function(ID){if(this.currentView.ID===ID){return this.currentView;}
return this.viewMap[ID];},getSelectedView:function(){return this.getView(this.get("selectedViewID"));},_initCurrentView:function(currentView){var currentViewModel=SM.Models.create("CurrentAnView",{ID:currentView.view_id});currentViewModel.anviews=this;currentViewModel.on("committed",{self:this},this._onCurrentViewCommitted);return currentViewModel;},_initDefaultView:function(defaultView){var self=this,defaultViewID=defaultView.view_id,defaultViewModel=SM.Models.create("DefaultAnView",{ID:defaultViewID,anView:defaultView,survey:self.survey});defaultViewModel.anviews=this;defaultViewModel.loadDisplayData();this.viewMap[defaultViewID]=defaultViewModel;this.viewList.push(defaultViewModel);return defaultViewModel;},_makeSaveAsRequest:function(context,doneArgs){var request=SM.Ajax.duplicateView(context.requestData);$.when(context,request).done(context.self._onViewSaveAsSuccess);}, _initStandardViews:function(viewData){var self=this,viewMap=viewData.viewMap,view;$.each(viewMap,function(ID,anView){view=SM.Models.create("AnView",{ID:ID,anView:anView});self.viewMap[ID]=view;self.viewList.push(view);view.anviews=self;});}, updateSelectedView:function(){var context={pageIndex:this.survey.state.get("page"),self:this,timestamp:SM.Date.timestamp()},selectedView=this.getView(this.get("selectedViewID")),previousSwitchRequest=this.currentView.get("lastSwitchRequest");this.currentView.set("lastSwitchStamp",context.timestamp);this._trigger({type:"selectedViewChanged",viewID:this.get("selectedViewID")});$.when(context,previousSwitchRequest).always(function(){context.self._makeSwitchViewRequest(context);});},_makeSwitchViewRequest:function(context){var self=context.self,currentView=self.currentView,request,mode=self.survey.state.get("mode");if(currentView.get("lastSwitchStamp")===context.timestamp){request=SM.Ajax.switchView({selected_view_id:self.get("selectedViewID"),utc_offset:SM.Date.utcOffset(),mode:mode});currentView.set("lastSwitchRequest",request,{notify:true});$.when(context,request).done(self._onViewSwitched).fail(function(data){self._onViewSwitchedFailed(context,data);});}},_onViewSwitched:function(context,response){var self=context.self,data=response[0],currentView=self.currentView,selectedViewID=data.current_view.selected_view_id,selectedView=self.getView(selectedViewID);if(currentView.get("lastSwitchStamp")===context.timestamp){$.extend(true,[],data.current_view.metadata);selectedView.metadata=$.extend(true,[],data.current_view.metadata);currentView.loadView(data.current_view);currentView.loadMetadata(data.current_view.metadata);self._trigger({type:"selectedViewLoaded",anViewModel:selectedView,pageIndex:context.pageIndex,timestamp:context.timestamp,respondentData:data.respondent_data});selectedView.set("isLoaded",true,{notify:true});}},_onViewSwitchedFailed:function(context,errorData){var requestID=errorData&&errorData.request_id,selectedViewID=this.get("selectedViewID"),selectedView=this.getView(selectedViewID);this.currentView.set("failedLoadRequestID",requestID,{notify:true});},_onCurrentViewCommitted:function(e){var self=e.data.self,nextViewID=self.get("nextSelectedViewID");if(nextViewID){self.set("selectedViewID",nextViewID);}},_onCurrentViewDirtySet:function(e){var self=e.data.self;if(e.value===true&&self.nextSelectedViewID!==null){self.set("nextSelectedViewID",null,{notify:true});}}});SM.Models.extend("AnView",SM.BaseAnView,{__create:function(kwargs){var anView=kwargs.anView;this.ID=kwargs.ID;this.show=anView.show;if(this.show.selected===null){this.show.selected=false;}
this.metadata=anView.metadata;this.name=anView.name;this.viewType=anView.type;this.isDirty=false;this.loadFailed=false;},dump:function(){return{view_id:this.ID,survey_id:this.anviews.survey.ID,is_current:false,is_default:false,selected_view_id:null,name:this.name,page:null,show:this.show,type:this.viewType};}});SM.Models.extend("DefaultAnView",SM.BaseAnView,{ __setters:{page:function(self,page){if(self.page!==page){self.page=page;
 if(!SM.App.isSharingApp()){self.save();}}}},isDefault:true,_displayData:{},METADATA_COMPARE_PREFIX:"compare:", __create:function(options){var self=this,anView=options.anView;self.survey=options.survey;self.ID=options.ID;self.name=Globalize.localize(anView.name);self.viewType=anView.type;self.metadata=anView.metadata;self.page=anView.page;self.show={pages:null,questions:null,selected:false};self.filter=null;self.compare=null;}, loadDisplayData:function(){var self=this,questionID;_.each(self.metadata,function(metadatum){questionID=metadatum.question_id;if(_.isEmpty(self._displayData[questionID])){self._displayData[questionID]={};}
self._displayData[questionID][metadatum.key]=metadatum.value;});},getDisplayData:function(questionID,options){options=options||{};var self=this,displayData=self._displayData[questionID],sharedDisplayData=self._displayData["0"],forTrends=!!options.forTrends;if(_.isEmpty(displayData)){displayData={};} 
if(!forTrends&&!!sharedDisplayData){displayData=SM.Object.extend(sharedDisplayData,displayData);}
displayData=SM.Object.deepCopy(displayData);return displayData;},_typifyUpdates:function(questionID,updates,options){var self=this,displayData=self.getDisplayData(questionID),typedUpdates={},typedKey,isCompared=options.isCompared,untypedKeys=options.untypedKeys,comparePrefix=self.METADATA_COMPARE_PREFIX;

 _.each(updates,function(value,key){typedKey=comparePrefix+key;if(isCompared){if(!untypedKeys[key]){
 typedUpdates[typedKey]=value;}else{ if(displayData[typedKey]!==undefined){
 typedUpdates[typedKey]=value;}
 
typedUpdates[key]=value;}}else{typedUpdates[key]=value;}});return typedUpdates;},updateDisplayData:function(questionID,updates,options){var self=this,options=options||{},request,displayData=self._displayData[questionID],metadatum;if(_.isEmpty(displayData)){displayData=self._displayData[questionID]={};}
updates=self._typifyUpdates(questionID,updates,options);_.each(updates,function(value,key){if(_.isEmpty(displayData[key])){metadatum=self.buildDisplayMetadatum(questionID,key,value);self.metadata.push(metadatum);}else{self.updateDisplayMetadatum(questionID,key,value);}
displayData[key]=value;});if(options.save!==false){request=self.save();request.done(options.done).fail(options.fail);}},deleteDisplayData:function(questionIDs,keys,options){var self=this,options=options||{},request,isCompared=options.isCompared,untypedKeys=options.untypedKeys,compareKey,displayData,metadata,index;if(!_.isArray(questionIDs)){questionIDs=[questionIDs];}
_.each(questionIDs,function(questionID){displayData=self._displayData[questionID];if(!_.isEmpty(displayData)){_.each(keys,function(key){
 compareKey=self.METADATA_COMPARE_PREFIX+key;key=(isCompared&&!untypedKeys[key])?compareKey:key;delete displayData[key];metadata=_.filter(self.metadata,function(metadatum){return metadatum.question_id===questionID&&metadatum.view_id==self.ID&&metadatum.key===key;});if(metadata){_.each(metadata,function(metadatum){index=_.indexOf(self.metadata,metadatum);self.metadata.splice(index,1);});}});}});if(options.save!==false){request=self.save();request.done(options.done).fail(options.fail);}},updateSharedDisplayData:function(options){var self=this,request,updates=options.updates,deletedKeys=options.deletedKeys,untypedKeys=options.untypedKeys,isCompared=options.isCompared,questionIDs;questionIDs=_.keys(self.survey.questionRollups.questions);
self.updateDisplayData("0",updates,{save:false,isCompared:isCompared,untypedKeys:untypedKeys});self.deleteDisplayData(questionIDs,deletedKeys,{save:false,isCompared:isCompared,untypedKeys:untypedKeys});request=self.save();request.done(options.done).fail(options.fail);},findMetadatumByQuestionIDAndKey:function(questionID,key){var self=this,metadatum;metadatum=_.filter(self.metadata,function(md){return md.question_id==questionID&&md.key==key;});return _.last(metadatum);},updateDisplayMetadatum:function(questionID,key,value){var self=this,metadatum=self.findMetadatumByQuestionIDAndKey(questionID,key);if(metadatum){metadatum.value=value;}},buildDisplayMetadatum:function(questionID,key,value){var self=this;return{view_id:self.ID,metadata_id:null,question_id:questionID,option_id:null,key:key,value:value};}, dump:function(){return{view_id:this.ID,survey_id:this.anviews.survey.ID,page:this.page,is_current:false,is_default:true,selected_view_id:null,name:this.name,filter:null,compare:null,type:this.viewType,show:{pages:null,questions:null,selected:false},metadata:this.metadata};},copy:function(){SM.Error.log({name:"DefaultViewCopyException",message:"Cannot copy the default view"});}});SM.Models.extend("CurrentAnView",SM.BaseAnView,{lastSaveTimeStamp:-1,lastSaveRequest:null,__setters:{isDirty:function(self,val,options){self.isDirty=val;self.anviews.getSelectedView().set("isDirty",val,options);},failedLoadRequestID:function(self,val){var hasFailed=val!==null;self.anviews.getSelectedView().set("loadFailed",hasFailed,{notify:hasFailed});self.failedLoadRequestID=val;}},__create:function(kwargs){this.ID=kwargs.ID;this.isDirty=false;this.lastSwitchStamp=-1;this.lastSwitchRequest=null;this.rules=null;this.metadataLoaded=false;this.isCurrent=true; this.isSaving=false;},loadView:function(anView){this.show=anView.show;this.viewType=anView.type;this.anviews.survey.updateShownLists(this.show,{notify:false});this.metadataLoaded=false;},loadMetadata:function(metadata){var self=this,sortedRuleAttrs=[];this._clearRuleModels();this.metadata=metadata;_.each(metadata,function(metadataItem,i){if(self._metadataIsRule(metadataItem)){sortedRuleAttrs.push(metadataItem);}});sortedRuleAttrs.sort(function(a,b){return a.metadata_id-b.metadata_id;});this._createRuleModels(sortedRuleAttrs);this.isDirty=false;this.metadataLoaded=true;this.set("failedLoadRequestID",null);this.set("isDirty",this._getDirtyState());},hasShowRule:function(){return this.showRule!==null;},hasCompareRule:function(){return this.compareRule!==null;},hasFilterRule:function(){var family_types=SM.BaseAnRule.FAMILY_TYPES,selected,hasFilter=false;$.each(this.ruleList,function(i,rule){if(rule.get("selected")&&rule.get("ruleFamily")===family_types.FILTER){hasFilter=true;return false;}});return hasFilter;},getFilterRulesSelected:function(){var self=this,family_types=SM.BaseAnRule.FAMILY_TYPES,filtersSelected=[];_.each(this.ruleList,function(rule){if(rule.get("selected")&&rule.get("ruleFamily")===family_types.FILTER){filtersSelected.push(rule);}});return filtersSelected;},hasFilterRule:function(){var self=this;filtersSelected=self.getFilterRulesSelected();return filtersSelected.length>0;},hasRAFilterSelected:function(){var self=this,filtersSelected,raFilter={};filtersSelected=self.getFilterRulesSelected();raFilter=_.find(filtersSelected,function(filter){return filter.isRA;});return!!raFilter;},deleteRule:function(id){var ruleList=this.ruleList,ruleModel=this.rules[id],defaultSelected=this.anviews.defaultView.ID===this.anviews.get("selectedViewID");this._unbindRuleEvents(this.rules[id]);delete this.rules[id];$.each(ruleList,function(i,rule){if(id===rule.ID){ruleList.splice(i,1);return false;}});}, revert:function(){var selectedView=this.anviews.getSelectedView();this.loadView(selectedView.dump());this.set("isDirty",false,{notify:true});this.anviews.updateSelectedView();},commitChanges:function(){var request,selectedView=this.anviews.getSelectedView(),currentViewMetadata=this.dump().metadata,view;selectedView.metadata=currentViewMetadata;$.each(currentViewMetadata,function(i,metadataItem){metadataItem.metadata_id=null;metadataItem.view_id=selectedView.ID;});selectedView.show=this.show;view=selectedView.dump();view.metadata=currentViewMetadata;this.set("isDirty",false,{notify:true});this._trigger("committed");return SM.Ajax.editView({view_data:view,view_id:selectedView.ID});},addRule:function(ruleModel){this._bindRuleEvents(ruleModel);this.ruleList.push(ruleModel);this.rules[ruleModel.ID]=ruleModel;
 if(ruleModel.isShow){this._onShowRuleChanged(ruleModel);this.save();}else{
 if(ruleModel.isCompare&&ruleModel.get("selected")){if(this.compareRule){this.compareRule.set("selected",false,{notify:true});}
this.compareRule=ruleModel;}

 
this.set("isSaving",true,{notify:true});}
 
this._trigger({type:"ruleAdded",ruleModel:ruleModel});},dump:function(){var metadataList,selectedViewID=this.anviews.get("selectedViewID").toString();if(this.metadataLoaded){metadataList=[];_.each(this.ruleList,function(rule){if(!rule.get("isCorrupt")){metadataList.push(rule.dump());}});}
return{view_id:this.ID,survey_id:this.anviews.survey.ID,is_current:true,is_default:false,page:null,selected_view_id:selectedViewID,name:"Current View",show:this.show,type:this.viewType,metadata:metadataList};},hasActiveShowRule:function(){return this.show.selected;}, save:function(){var self=this,requestContext={self:this,timestamp:SM.Date.timestamp()};this.set("isSaving",true,{notify:true});this.set("isDirty",this._getDirtyState(),{notify:true});this.set("lastSaveTimeStamp",requestContext.timestamp);$.when(requestContext,this.get("lastSaveRequest")).always(function(){self._makeSaveRequest(requestContext);});},invalidateNewRules:function(){$.each(this.ruleList,function(i,ruleModel){if(!ruleModel.isPersisted()){ruleModel.set("isCorrupt",true,{notify:true});}});},_metadataIsRule:function(m){return m.key.indexOf(SM.BaseAnRule.BASE_RULE_METADATA_KEY)>=0;},_getDirtyState:function(){var self=this,isDirty=false,currMetadata=this.dump().metadata,currLen=currMetadata.length,equalMetadata=false,selectedView=this.anviews.getSelectedView(),selectedMetadata=$.extend(true,[],selectedView.metadata);if(selectedView.isDefault){return this.ruleList.length>0;}
if(selectedMetadata.length!==currLen){return true;}
$.each(currMetadata,function(i,currMetadataItem){if(self._metadataIsRule(currMetadataItem)){isDirty=true;$.each(selectedMetadata,function(j,selectedMetadataItem){equalMetadata=self._checkMetadataEquality(currMetadataItem,selectedMetadataItem);if(equalMetadata){isDirty=false;selectedMetadata.splice(j,1);return false;}});if(isDirty){return false;}}});if(!isDirty){isDirty=!SM.Object.equals(this.show,selectedView.show);}
return isDirty;},



_checkMetadataEquality:function(currMetadataItem,selectedMetadataItem){var isEqual=true;try{
if(currMetadataItem.value.selected!=selectedMetadataItem.value.selected){isEqual=false;}else{
_.each(currMetadataItem.value,function(value,key){if(key!=="answers"){if(!SM.Object.equals(selectedMetadataItem.value[key],value)){isEqual=false;return;}}});

if(currMetadataItem.value.answers&&selectedMetadataItem.value.answers){if(!SM.Object.equals(currMetadataItem.value.answers[0],selectedMetadataItem.value.answers[0])){isEqual=false;}}}}catch(e){SM.Error.log(e,"error comparing metadata");isEqual=false;}
return isEqual;},_makeSaveRequest:function(requestContext){var self=this,request=SM.Ajax.editView({view_data:this.dump(),view_id:this.ID});this.set("lastSaveRequest",request);$.when(request,requestContext).done(this._onSaveSuccess).always(function(){self._onSavedAlways(requestContext);});},_onShowRuleChanged:function(ruleModel){this.show=ruleModel.get("show");this.anviews.survey.updateShownLists(this.show,{notify:true});this._trigger({type:"showRuleChanged",ruleModel:ruleModel});},_createRuleModels:function(metadataList){var self=this,ruleJSON,ruleModel,params;$.each(metadataList,function(i,ruleMetadata){ruleJSON=ruleMetadata.value;params={ID:ruleMetadata.metadata_id,attrs:ruleJSON,isCorrupt:ruleMetadata.is_corrupt};ruleModel=SM.BaseAnRule.FactoryCreate(params,self.anviews.survey);ruleModel.loadSurvey(self.anviews.survey);if(ruleModel.isShow){self.showRule=ruleModel;}
if(ruleModel.isCompare&&ruleModel.get("selected")){self.compareRule=ruleModel;}
self.ruleList.push(ruleModel);self.rules[ruleModel.ID]=ruleModel;self._bindRuleEvents(ruleModel);});},_clearRuleModels:function(){var self=this;if(this.ruleList){$.each(this.ruleList,function(i,ruleModel){self._unbindRuleEvents(ruleModel);});}
this.showRule=null;this.compareRule=null;this.ruleList=[];this.rules={};},_bindRuleEvents:function(ruleModel){ruleModel.on("customHeading.changed",{self:this},this._onRuleRenamed);ruleModel.on("ruleEdited",{self:this},this._onRuleEdited);ruleModel.on("ruleDeleted",{self:this},this._onRuleDeleted);},_unbindRuleEvents:function(ruleModel){ruleModel.off("customHeading.changed",this._onRuleRenamed);ruleModel.off("ruleEdited",this._onRuleEdited);ruleModel.off("ruleDeleted",this._onRuleDeleted);},_onRuleEdited:function(e){var ruleModel=e.ruleModel,lastCompareRule,self=e.data.self,selected=ruleModel.get("selected");if(ruleModel.isShow){self._onShowRuleChanged(ruleModel);self.save();}else{if(ruleModel.isCompare){lastCompareRule=self.compareRule;

 if(lastCompareRule&&ruleModel!==lastCompareRule&&ruleModel.get("selected")){lastCompareRule.set("selected",false,{notify:true});}
 
self.compareRule=selected?ruleModel:null;}

 
self.set("isSaving",true,{notify:true});}
self._trigger({type:"ruleEdited",ruleModel:ruleModel});},_onRuleRenamed:function(e){var self=e.data.self;self.save();},_onRuleDeleted:function(e){var self=e.data.self,ruleModel=e.ruleModel;self.deleteRule(ruleModel.ID);if(ruleModel.isShow){self.showRule=null;self._onShowRuleChanged(ruleModel);self.save();}else{if(!ruleModel.get("selected")){self.save();}else{if(ruleModel.isCompare){self.compareRule=null;}

 
self.set("isSaving",true,{notify:true});}}
self._trigger({type:"ruleDeleted",ruleModel:ruleModel});}, _onSaveSuccess:function(response,context){var data=response[0],newMetadataIDs=data.created_metadata_ids,self=context.self;if(self.get("lastSaveTimeStamp")===context.timestamp){self.metadata=data.view_edited.metadata;if(!newMetadataIDs){return;}
$.each(newMetadataIDs,function(persistedID,tempID){var newRule=self.rules[tempID];if(newRule){self.rules[persistedID]=newRule;delete self.rules[tempID];newRule.ID=persistedID;}});}},_onSavedAlways:function(context){if(this.get("lastSaveTimeStamp")===context.timestamp){this.set("isSaving",false,{notify:true});}}});SM.Models.register("SharedView",{baseUrl:"/analyze/ajax/shared_views",TYPES:{WEB_LINK:"weblink"},MODES:{SUMMARY:"summary",TRENDS:"trends",BROWSE:"browse"},BRANDING:{DEFAULT:"default",CUSTOM:"custom",NONE:"none"},__create:function(options){this.DEFAULT_NAME=Globalize.localize("Shared Data");this.survey=options.survey;this.list=options.list;this.index=options.index;this.id=options.attrs.id;this.load(options.attrs);_.bindAll(this,"_onSave","_onSaveFail","_onDestroy","_onDestroyFail");}, isNew:function(){return!this.id;},url:function(){return this.isNew()?this.baseUrl:this.baseUrl+"/"+this.key;},attributes:function(){return{id:this.id,survey_id:this.get("survey_id"),default_view_id:this.get("default_view_id"),sharable_view_id:this.get("sharable_view_id"),key:this.get("key"),type:this.TYPES.WEB_LINK,host:this.get("host"),modes:this.get("modes"),enabled:this.get("enabled"),password:this.get("password"),name:this.get("name"),title:this.get("title"),description:this.get("description"),branding:this.get("branding"),hide_open_ended:this.get("hide_open_ended"),is_public:this.get("is_public")};},load:function(attrs){var self=this;self._setDefaults();_.each(attrs,function(v,k){self.set(k,v,{notify:false});});if(self.get("password")===""){self.set("password",null);}},_setDefaults:function(){if(_.isEmpty(this.get("modes"))){this.set("modes",["summary"]);}
if(_.isEmpty(this.get("name"))){this.set("name",this._getDefaultName());}
if(_.isEmpty(this.get("title"))){this.set("title",this.survey.get("title"));}
if(_.isEmpty(this.get("host"))){this.set("host",this._getDefaultHost());}
if(_.isEmpty(this.get("type"))){this.set("type",this.TYPES.WEB_LINK);}
if(_.isNull(this.get("enabled"))||_.isUndefined(this.get("enabled"))){this.set("enabled",true);}
if(_.isNull(this.get("branding"))||_.isUndefined(this.get("branding"))){this.set("branding",this.BRANDING.DEFAULT);}
if(_.isNull(this.get("hide_open_ended"))||_.isUndefined(this.get("hide_open_ended"))){this.set("hide_open_ended",true);}
if(_.isNull(this.get("is_public"))||_.isUndefined(this.get("is_public"))){this.set("is_public",false);}},_getDefaultName:function(){var name,index;index=this.isNew()?this.survey.sharedViews.list.length:this.index;name=this.DEFAULT_NAME+" "+Globalize.format(index+1,"n0");return name;},_getDefaultHost:function(){var uri=new Uri(document.location.href);return uri.host();},loadView:function(view){this.sourceView=view;},save:function(){var self=this,request;self._setDefaults();SM.log(self.attributes());request=SM.Ajax.post(self.url(),self.attributes());$.when(request,{self:this}).done(this._onSave).fail(this._onSaveFail);return request;},_onSave:function(doneArgs,context){var self=this,attrs=doneArgs[0]['shared_view'];self.load(attrs);self.survey.sharedViews.add(self);self._trigger("saved",{notify:true});},_onSaveFail:function(data,error,xhr){SM.log("failed!");},destroy:function(){var self=this,request;request=SM.Ajax.destroy(self.url(),{survey_id:self.get("survey_id")});$.when(request,{self:this}).done(this._onDestroy).fail(this._onDestroyFail);return request;},_onDestroy:function(doneArgs,context){var self=this;self.survey.sharedViews.remove(self);},_onDestroyFail:function(data,error,xhr){SM.log("destroy failed");}, sharedPageURL:function(){var url=new Uri();url.setProtocol('https');url.setHost(this.get("host"));url.setPath(this.sharedPagePath());return url.toString();},sharedPagePath:function(){return"/results/"+this.key+"/";},toggleMode:function(mode,shouldBeDisplayed){var self=this,modes=self.get("modes"),isDisplayed=_.contains(modes,mode),index;if(shouldBeDisplayed&&!isDisplayed){modes.push(mode);}
if(!shouldBeDisplayed&&isDisplayed){index=_.indexOf(modes,mode);modes.splice(index,1);}
self.set("modes",modes);},openEndedHidden:function(){return this.get("hide_open_ended");},hasCustomTitle:function(){var title=this.get("title");return!_.isEmpty(title)&&title!==this.survey.get("title");},hasDescription:function(){var description=this.get("description");return!_.isEmpty(description);},hasCustomName:function(){var name=this.get("name");return!_.isEmpty(name)&&name!==this._getDefaultName();},hasPassword:function(){var password=this.get("password");return!_.isEmpty(password);},canHavePassword:function(){return!this.survey.owner.isBasic();},canHaveTrends:function(){return this.survey.owner.hasTrends();},isTrendsTabEnabled:function(){return _.contains(this.get("modes"),this.MODES.TRENDS)&&this.survey.owner.hasTrends();},isBrowseTabEnabled:function(){return _.contains(this.get("modes"),this.MODES.BROWSE);},isEnabled:function(){return this.get("enabled");},isPublic:function(){return this.get("is_public");},toggleEnabled:function(){this.set("enabled",!this.get("enabled"),{notify:true});this.save();},incrementNumViews:function(){var url="/analyze/ajax/shared_views/"+this.get("key")+"/increment";SM.Ajax.post(url,{survey_id:this.survey.ID});},canCustomizeBranding:function(){return!this.survey.owner.isBasic();},hasHiddenBranding:function(){return this.get("branding")===this.BRANDING.NONE;},setBranding:function(branding,isChecked){if(branding==="none"){branding=isChecked?this.BRANDING.NONE:this.BRANDING.DEFAULT;} 
this.set("branding",branding);},includeOpenEnded:function(){return!this.get("hide_open_ended");}});SM.Models.register("Survey",{__create:function(options){var survey_data=options.survey_data,pageModels;this.ID=survey_data.id;this.language=survey_data.language;this.dateCreated=new Date(survey_data.date_created);this.encryptedID=survey_data.mangled_id;this.previewLink=survey_data.preview_link;this.resourcePath=survey_data.resource_path;this.themeSettings=survey_data.theme_settings;this.designSettings=survey_data.design_settings;this.hasLogic=survey_data.has_logic;this.hasRandomization=survey_data.has_randomization;this.hasPanelPage=survey_data.has_panel_page;this.includeOpenEnded=options.includeOpenEnded;this.title=survey_data.title;this.nickname=survey_data.nickname;this.pageIDs=survey_data.page_ids;this.pageCount=this.pageIDs.length;this.respondentCounts={};this.loadCollectors(survey_data.collectors);this.hasEmailCollector=survey_data.has_email_collector;this.hasOpenCollectors=survey_data.has_open_collector;this.hasCollectors=survey_data.has_collector;this.hasUnconfiguredCollector=survey_data.has_unconfigured_collector;this.hasAllClosedCollectors=survey_data.has_all_closed_collectors;pageModels=this._createPageModels(this.pageIDs,survey_data);this.pages=pageModels.pages;this.pageList=pageModels.pageList;this.questions=pageModels.questions;this.questionList=pageModels.questionList;this.hasQuestions=pageModels.questionList.length>0;this.searchTerms=pageModels.searchTerms;this.answers=pageModels.answers;this.questionCount=this.questionList.length;this.quotas=survey_data.quotas;},__setters:{respondentCounts:function(self,counts){if(!counts||counts.failed){self.respondentCounts={failed:true};}else{SM.Object.update(self.respondentCounts,counts);self.respondentCounts.failed=false;}}},ID:'', encryptedID:'',title:'',nickname:'',pageIDs:[], pages:{},pageList:[],pageCount:0,questions:{},questionList:[],questionCount:0,questionRollups:null,answers:{},searchTerms:null,respondentsList:null,respondentCounts:{},collectors:{},collectorList:[],hasEmailCollector:false,hasOpenCollectors:false,owner:null,anviews:null,SEARCH_NGRAM_SIZE:2,shownPageList:[],shownQuestionList:[],updateShownLists:function(showState,options){var pageList=this.pageList,pageCount=pageList.length,i=0,j,page,pageIndex,questionList,question,questionCount,notify=options.notify&&true;this.shownPageList=[];this.shownQuestionList=[];for(;i<pageCount;i++){page=pageList[i];page.shownQuestionList=[];if(page.isShown(showState)){this.shownPageList.push(page);questionList=page.questionList;questionCount=questionList.length;for(j=0;j<questionCount;j++){question=questionList[j];if(question.isShown(showState)){page.shownQuestionList.push(question);this.shownQuestionList.push(question);}}}}
pageIndex=this._validatePage();this.state.set("page",pageIndex);if(notify){this._trigger("shownListsChanged");}},_validatePage:function(){var pageModel,currPageNumber,pageIndex=this.state.get("page"),isAllPagesSelected=this.state.get("allPagesSelected");if(!isAllPagesSelected){pageModel=this.pageList[pageIndex];if(!pageModel.isShown()){pageModel=this.getFirstShownPage();return pageModel.position-1;}}
return pageIndex;},getPage:function(id){return this.pages[id];},getQuestion:function(id){return this.questions[id];},getAnswer:function(id){return this.answers[id];},getRespondentByID:function(id){return this.respondentsList.map[id];},getRespondentByOffset:function(offset){return this.respondentsList.getOffset(offset);},getCollector:function(id){return this.collectors[id];},getRollup:function(questionID){if(this.questionRollups){return this.questionRollups.questions[questionID]||null;}},getRandomAssignmentRollup:function(questionID,optionTypeID){var question;if(this.questionRollups){question=this.questionRollups.questions[questionID];if(question.nestedQuestionDict[optionTypeID]){return question.nestedQuestionDict[optionTypeID];}else{return this.getRollup(questionID);}}},getBenchmarkRollup:function(questionID){if(this.benchmarkRollups){return this.benchmarkRollups.getRollup(questionID);}},getLastShownPage:function(){var count=this.shownPageList.length;if(!count){return null;}
return this.shownPageList[count-1];},getNextShownPage:function(currentPageIndex){var pageList=this.pageList,i=currentPageIndex+1,page,pageCount=pageList.length;for(;i<pageCount;i++){page=pageList[i];if(page.isShown()){return page;}}
return null;},getPrevShownPage:function(currentPageIndex){var pageList=this.pageList,i=currentPageIndex-1,page;for(;i>=0;i--){page=pageList[i];if(page.isShown()){return page;}}
return null;},getFirstShownPage:function(){var count=this.shownPageList.length;if(!count){return null;}
return this.shownPageList[0];},getShownQuestionIDs:function(pageIndex){var shownList;if(pageIndex!=='all'){shownList=this.survey.pageList[pageIndex].shownQuestionList;}else{shownList=this.shownQuestionList;}
return $.map(shownList,function(question){return question.ID;});},getQuestionTrend:function(questionID){if(this.trendsModel&&this.trendsModel.questionTrends){return this.trendsModel.questionTrends.questionMap[questionID];}},getResponsesTrend:function(){if(this.trendsModel&&this.trendsModel.responseTrends){return this.trendsModel.responseTrends;}},getSelectedView:function(){return this.anviews.getView(this.anviews.get("selectedViewID"));},loadViews:function(viewData){this.anviews=SM.Models.create("AnViewList",{survey:this});this.anviews.createViewModels(viewData);},loadOwner:function(owner){this.owner=SM.Models.create("User",{ID:"owner",user:owner});this.owner.survey=this;},loadCurrentUser:function(currentUser){this.currentUserID=currentUser.id;},loadRespondents:function(respondentData){var selectedOffset=respondentData.status===0?respondentData.data.respondent_offset:null;this.respondentsList=SM.Models.create("RespondentList",{selectedOffset:selectedOffset});this.respondentsList.loadSurvey(this);if(respondentData.status===0&&this.respondentCounts.total_context){this.respondentsList.loadRespondents(respondentData.data.respondents);}else if(respondentData.status!==0){this.respondentsList.set("failedLoad",true);this.respondentsList.set("failedLoadRequestID",respondentData.request_id);}},loadQuestionRollups:function(respondentData){this.questionRollups=SM.Models.create("QuestionRollupList");this.questionRollups.loadSurvey(this);if(respondentData.status===0){this.questionRollups.loadRollups(respondentData.data.question_rollups);}else{this.questionRollups.set("failedLoad",true);this.questionRollups.set("failedLoadRequestID",respondentData.request_id);}},loadSurveyTrends:function(respondentData){this.trendsModel=SM.Models.create("SurveyTrends");this.trendsModel.loadSurvey(this);if(respondentData.status===0){if(respondentData.data.survey_respondent_trends){this.trendsModel.loadResponsesTrends(respondentData.data);}
if(respondentData.data.question_responses_trends){this.trendsModel.loadQuestionTrends(respondentData.data.question_responses_trends,respondentData.data.trend_range);}}else{this.trendsModel.set("failedLoad",true);this.trendsModel.set("failedLoadRequestID",respondentData.request_id);}},loadAnalyzeState:function(state){this.state=SM.Models.create("AnalyzeState",state);this.state.survey=this;},loadExportJobs:function(exportJobList){this.exportJobs=SM.Models.create("ExportJobList",{config:this.config});this.exportJobs.survey=this;this.exportJobs.poller=SM.Models.create("ExportJobPoller",{config:this.config.export_poller});this.exportJobs.poller.loadJobs(this.exportJobs);},loadSharedViews:function(){this.sharedViews=SM.Models.create("SharedViewList",{survey:this});this.sharedViews.fetch();},loadConfig:function(config){this.config=config;},loadBenchmarkRollups:function(benchmarkRollups){this.benchmarkRollups=SM.Models.create("BenchmarkRollupsByQuestionId",{survey:this});this.benchmarkRollups.loadRollups(benchmarkRollups);},isExportFormatTypeEnabled:function(format,type){var formatsEnabled=this.config.export_formats_enabled[type];return!!(formatsEnabled[format]&&this.config.exports_enabled);},isExportEnabled:function(){return this.config['exports_enabled'];},isSharingEnabled:function(){return this.config['sharing_enabled'];},searchQuestions:function(searchTerm){var searchRanking={},results=[],searchTerms=this.searchTerms,words=searchTerm.toLowerCase().split(/[\s,-,?,!,(,)]+/),wordCount=words.length,ngramSize=this.SEARCH_NGRAM_SIZE,i=0,j,word,ngram,partialMatch,match,matches,matchCount,y,rec,id;for(;i<wordCount;i++){word=words[i];ngram=word.substring(0,ngramSize);partialMatch=(i+1)===wordCount&&ngram===word;if(ngram in searchTerms){matches=searchTerms[ngram];matchCount=matches.length;for(j=0;j<matchCount;j++){match=matches[j];if(partialMatch||match.word.substring(0,word.length)===word){id=match.id;if(id in searchRanking){searchRanking[id]++;}else{searchRanking[id]=1;results.push(id);}}}}}
return results.sort(function(a,b){return searchRanking[b]-searchRanking[a];});},hasRespondents:function(){return this.respondentCounts.total>0;},hasFilteredRespondents:function(){return this.respondentCounts.total_context>0;},decrementRespondentCounts:function(){var self=this,counts={};$.each(this.respondentCounts,function(countKey,count){

 if(count!==null&&count!==undefined&&countKey!=="failed"){counts[countKey]=self.respondentCounts[countKey]-1;}});this.set("respondentCounts",counts,{notify:true});},getRespondentUrl:function(respondentID){return"/analyze/browse/"+this.encryptedID+"?respondent_id="+respondentID;},_createPageModels:function(pageIDs,survey_data){var i,pageID,term,pageMap=survey_data.pages,questionMap=survey_data.questions,pages={},pageList=[],questions={},questionList=[],answers={},searchTerms={},pageCount=pageIDs.length,pageModel,page;for(i=0;i<pageCount;i++){pageID=pageIDs[i];page=pageMap[pageID];pageModel=SM.Models.create("Page",{ID:pageID,structure:page});pageModel.survey=this;pageModel.loadQuestions(questionMap,page.question_ids);if(i===pageCount-1){ pageModel.isPanelPage=this.hasPanelPage;}
pages[pageID]=pageModel;pageList.push(pageModel);SM.Object.update(questions,pageModel.questions);SM.Object.update(answers,pageModel.answers);for(term in pageModel.searchTerms){if(searchTerms[term]){searchTerms[term]=searchTerms[term].concat(pageModel.searchTerms[term]);}else{searchTerms[term]=pageModel.searchTerms[term];}}
questionList=questionList.concat(pageModel.questionList);}
return{pages:pages,pageList:pageList,questions:questions,questionList:questionList,answers:answers,searchTerms:searchTerms};},isFiltered:function(){return this.respondentCounts.matching!==null&&this.respondentCounts.matching!==undefined;},loadCollectors:function(collectorList){var map={},list=[],formattedTypes={'weblink':'Web Link','email':'Email','audience':'Targeted Audience','twitter':'Twitter','embed':'Website Survey','facebook-link':'Facebook Link'},maxTitleLength=30,mdate,year,month,date,formattedDate;this.collectorList=$.map(collectorList,function(collector_data){var collector={id:collector_data.collector_id,title:SM.String.truncateMiddle(SM.Html.strip(collector_data.title),maxTitleLength),dateCreated:new Date(collector_data.date_created),isOpen:collector_data.is_open,isClosed:collector_data.is_closed,isClearing:collector_data.is_clearing_responses,isUnconfigured:collector_data.is_new,isArchived:collector_data.is_archived,type:collector_data.collector_type,formattedType:Globalize.localize(formattedTypes[collector_data.collector_type]),isFacebook:collector_data.is_facebook,isTwitter:collector_data.is_twitter,isLink:collector_data.is_weblink,isAudience:collector_data.is_audience,isEmail:collector_data.is_email,isEmbed:collector_data.is_embed,link:collector_data.link,formattedResponseCount:Globalize.format(collector_data.response_count,"n0")};mdate=SM.TrendLib.localize(collector_data.date_created);year=mdate.year();month=mdate.month();date=mdate.date();formattedDate=new Date(year,month,date);collector.formattedDate=Globalize.format(formattedDate,'d');map[collector.id]=collector;return collector;});this.collectors=map;},hasTextAnalysis:function(){return this.owner.hasTextAnalysis();}});SM.Models.register("User",{UNLIMITED:'unlimited',BASIC:'BASIC',GOLD:'GOLD',PLATINUM:'PLATINUM',__create:function(options){this.ID=options.ID;this.disabledExports={spss:!options.user.analyze_export_spss_enabled};this.packageType=options.user.package_type;this.responseLimit=options.user.analyze_response_limit;this.responseDeleteLimit=options.user.response_delete_limit;this.ruleLimit=options.user.analyze_rule_limit;this.textAnalysIsEnabled=options.user.analyze_ta_enabled;this.hasDismissedTaUpgrade=false;this.trendsEnabled=options.user.analyze_trends_enabled;this.sharingEnabled=options.user.sharing_enabled;this.hipaaEnabled=options.user.hipaa_enabled;this.notifFeatureEnabled=options.user.notif_feature_enabled;this.exportEnabled=options.user.analyze_export_enabled;this.logoEnabled=options.user.create_logo;this.logicEnabled=options.user.create_page_logic;this.email=options.user.email||"";this.benchmarkingEnabled=options.user.benchmarking_enabled;},isOverResponseLimit:function(responseCount){return this.responseLimit!==this.UNLIMITED&&this.responseLimit<responseCount;},hasRuleLimit:function(){return this.ruleLimit!==this.UNLIMITED;},isOverRuleLimit:function(){var ruleList=this.survey.anviews.currentView.ruleList;if(!this.hasRuleLimit()){return false;}
if(!ruleList){return this.ruleLimit===0;}
return ruleList.length>=this.ruleLimit;},isBasic:function(){return this.packageType===this.BASIC;},hasTextAnalysis:function(){return this.textAnalysIsEnabled;},hasExports:function(){return this.exportEnabled;},canExport:function(format){if(this.exportEnabled){if(this.disabledExports[format]){return false;}
return true;}
return false;},hasTrends:function(){return this.trendsEnabled;},hasSharing:function(){return this.sharingEnabled;},hasBenchmarking:function(){return this.benchmarkingEnabled;}});SM.Models.register("Page",{__create:function(options){var page=options.structure,questionModels;this.ID=options.ID;this.heading=SM.Html.strip(page.heading);this.shortHeading=SM.String.truncate(this.heading,17);this.position=page.position;this.hasHeading=this.heading.length>0;this.index=page.position-1;this.subheading=page.subheading;this.editLink=page.edit_link;}, ID:'', heading:'',position:null,index:null, subheading:'',
 questions:{}, questionList:[], questionCount:null, answers:{}, searchTerms:{}, survey:null, shownQuestionList:[], loadedQuestionMap:{}, isPanelPage:false,loadQuestions:function(questionMap,questionIDs){var i=0,question,questionModel,questionID,term,list=[],map={},answers={},searchTerms={},questionCount=questionIDs.length;for(;i<questionCount;i++){questionID=questionIDs[i];question=questionMap[questionID];if(question.type.family==="presentation"&&!question.random_assignment_list){continue;}
questionModel=SM.Models.create("Question",{ID:question.id,structure:question});questionModel.page=this;map[question.id]=questionModel;list.push(questionModel);questionModel.loadAnswers(question);questionModel.loadIntoSearch();for(term in questionModel.searchTerms){if(searchTerms[term]){searchTerms[term]=searchTerms[term].concat(questionModel.searchTerms[term]);}else{searchTerms[term]=questionModel.searchTerms[term];}}
SM.Object.update(answers,questionModel.answers);}
this.questions=map;this.questionList=list;this.questionCount=this.questionList.length;this.answers=answers;this.searchTerms=searchTerms;},isShown:function(showState){showState=showState||this.survey.anviews.currentView.show;var shownPages=showState.pages;return!showState.selected||(shownPages&&shownPages[this.ID]);}});SM.Models.register("Question",{QTYPE:{open_ended:'open_ended',datetime:'datetime',demographic:'demographic',numerical:'numerical',single_choice:'single_choice',multiple_choice:'multiple_choice',horiz:'horiz',matrix:'matrix',menu:'menu',menu_matrix:'menu_matrix',single:'single',simple:'simple',rating_scale:'rating',ranking:'ranking',essay:'essay',other_option:'other_option',presentation:'presentation',multi:'multi',descriptive_text:'descriptive_text',image:'image'},compareMap:{"single_choice":"matrix","multiple_choice":"matrix","matrix":"menu_matrix","open_ended":"matrix","demographic":"matrix","datetime":"matrix"},ID:null,title:'',number:null,family:null,subtype:null, searchTerms:{}, options:null, rowList:[], colList:[], colChoices:{}, page:null, commentField:null, randomAssignmentMap:null,__create:function(options){var structure=options.structure;this.ID=structure.id;this.logicalID=structure.logical_id;this.structure=structure;this.heading=SM.Html.strip(structure.heading);this.position=structure.position;this.family=structure.type.family;this.subtype=structure.type.subtype;this.randomAssignmentList=structure.random_assignment_list;this.searchTerms={};this._models={};},loadIntoSearch:function(){this._addToSearchTerms("Q"+this.position);this._addToSearchTerms(this.heading);}, hasRollupLoaded:function(){var model=this.getRollup();return model&&model.type!=='null_rollup';},hasTrendLoaded:function(){var model=this.getTrend();return model.get("isLoaded");},hasRandomAssignment:function(){return!!this.randomAssignmentList&&this.randomAssignmentList.length>0;}, isAfterLastLoadedRollup:function(){return this.page.survey.questionRollups.isAfterLastLoadedQuestion(this);},isAfterLastLoadedTrend:function(){return this.page.survey.trendsModel.questionTrends.isAfterLastLoadedQuestion(this);},setCompareStructure:function(compareStructure){this.compareStructure=compareStructure;},


 isComparable:function(){return!!this.compareMap[this.family]&&!(this.subtype===this.QTYPE.menu&&this.family===this.QTYPE.matrix);},


hasComparableOptions:function(){return(this.family===this.QTYPE.matrix&&this.subtype!==this.QTYPE.menu||this.family===this.QTYPE.multiple_choice||this.family===this.QTYPE.single_choice);},isBenchmarkable:function(){return this.structure.is_benchmarkable;},hasChartView:function(){return(this.family===this.QTYPE.matrix||this.family===this.QTYPE.multiple_choice||this.family===this.QTYPE.single_choice||this.subtype===this.QTYPE.numerical);},getCompareType:function(){return this.compareMap[this.family];},getContextStructure:function(){if(this.isCompared()){return this.compareStructure;}
return this.structure;},isCompared:function(){return this.compareStructure!==undefined;},isShown:function(showState){showState=showState||this.page.survey.anviews.currentView.show;var shownQuestions=showState.questions;return!showState.selected||(shownQuestions&&shownQuestions[this.ID]);},getRollup:function(){var hasRandomAssignment=!!(this.randomAssignmentList&&this.randomAssignmentOption);if(hasRandomAssignment){return this.getRandomAssignmentRollup();}else{return this.page.survey.getRollup(this.ID);}},getRandomAssignmentRollup:function(){

 return this.page.survey.getRandomAssignmentRollup(this.ID,this.randomAssignmentOption);},getRandomAssignmentOption:function(option_id){this.randomAssignmentMap=this.randomAssignmentMap||this._createRandomAssignmentMap();return this.randomAssignmentMap[option_id];},_createRandomAssignmentMap:function(){var randomAssignmentMap={},randomAssignmentList=this.randomAssignmentList,variableID,randomAssignmentOption;_.each(randomAssignmentList,function(randomAssignmentOption){variableID=randomAssignmentOption.variable_id;randomAssignmentMap[variableID]=randomAssignmentOption;});return randomAssignmentMap;},getTrend:function(){return this.page.survey.getQuestionTrend(this.ID);},getResponse:function(respondentID){var respondent=this.page.survey.respondentsList.map[respondentID];return respondent.getResponse(this.ID);},getCrossedQuestion:function(){var survey=this.page.survey,currentView=survey.anviews.currentView;if(this.isCompared()&&currentView.compareRule){return survey.getQuestion(currentView.compareRule.get("questionID"));}},loadAnswers:function(structure){this.answers={};if(structure.answers.rows){this._parseRowAnswers(structure.answers.rows);this.rowList=structure.answers.rows;}else{structure.answers.rows=[];}
if(structure.answers.cols){this._parseColAnswers(structure.answers.cols);this.colList=structure.answers.cols;if(this.subtype==="ranking"){this._initRankingWeights();}}
if(structure.answers.other){this._parseOtherAnswers(structure.answers.other);this.commentFieldList=structure.answers.other;this.commentField=this.commentFieldList[0];}},getAnswer:function(id){return this.answers[id];},summaryType:function(){var self=this,rollup=self.getRollup(),summary=rollup.summary;return self.isCompared()?summary.summary.type:summary.type;},depthType:function(){var self=this;if(self.isMatrix()){if(self.isMenuMatrix()){return self.QTYPE.menu_matrix;}
else{return self.QTYPE.matrix;}}else{return self.QTYPE.single;}},isSimple:function(){if(this.isCompared()){return false;}
return this.family===this.QTYPE.multiple_choice||this.family===this.QTYPE.single_choice;},isMultipleChoice:function(){return this.family===this.QTYPE.multiple_choice||(this.family===this.QTYPE.matrix&&this.subtype===this.QTYPE.multi);},isNumerical:function(){return this.subtype===this.QTYPE.numerical;},isMatrix:function(){if(this.isCompared()){return this.compareStructure.type.family===this.QTYPE.matrix;}
return this.family===this.QTYPE.matrix;},isMenuMatrix:function(){if(this.isCompared()){return this.compareStructure.type.family===this.QTYPE.matrix&&this.compareStructure.type.subtype===this.QTYPE.menu;}
return this.family===this.QTYPE.matrix&&this.subtype===this.QTYPE.menu;},isMultiResponse:function(){return(this.family==="multiple_choice"||(this.family==="open_ended"&&(this.subtype==="multi"||this.isNumerical()))||this.family==="demographic"||this.family==="datetime"||this.family==="matrix"&&this.subtype==="multi");},isOpenEnded:function(){return this.family==="open_ended"||this.family==="demographic"||this.family==="datetime";},isPresentation:function(){return this.family===this.QTYPE.presentation;},isEssay:function(){return this.family==='open_ended'&&(this.subtype==='essay'||this.subtype==='single');},isRating:function(){return this.subtype==="rating";},isRanking:function(){return this.subtype==="ranking";},hasCommentsPerRow:function(){return!!(this.structure.answers.other&&this.structure.answers.other[0].apply_all_rows);},getOpenEndedType:function(){var family=this.family,subtype=this.subtype;if(family==="open_ended"){return subtype;}
if(family==="demographic"||family==="datetime"){return family;}},_initRankingWeights:function(){var colList=this.colList,len=this.colList.length;$.each(colList,function(i,col){if(col.is_na){len--;}});$.each(colList,function(i,col){ if(col.is_na){col.weight=0;}else{col.weight=len-i;}});},_parseAnswers:function(rows,isOpenEnded){var rowCount=rows.length,i=0,row,answerMap=this.answers,rowID;for(;i<rowCount;i++){row=rows[i];this.sanitizeAnswer(row);answerMap[row.id]=row;this._addToSearchTerms(row.text);row.is_openended=isOpenEnded;}},_parseOtherAnswers:function(otherAnswers){this._parseAnswers(otherAnswers,true);},_parseRowAnswers:function(rows){this._parseAnswers(rows,this.isOpenEnded());},_parseColAnswers:function(cols){var len=cols.length,i,j,answerMap=this.answers,col,choices,choiceCount,choice,colID;for(i=0;i<len;i++){col=cols[i];this.sanitizeAnswer(col);if(col.is_na){this.naCol=col;}
answerMap[col.id]=col;this._addToSearchTerms(col.text);choices=col.items?col.items:[];choiceCount=choices.length;for(j=0;j<choiceCount;j++){choice=choices[j];this.sanitizeAnswer(choice);answerMap[choice.id]=choice;this._addToSearchTerms(choice.text);}}
if(this.naCol&&this.naCol.position===0){cols.shift();cols.push(this.naCol);this.naCol.position=len;}},_addToSearchTerms:function(searchItem){ var words=searchItem.toLowerCase().split(/[\s,-,?,!,(,),\/]+/),wordCount=words.length,ngramSize=this.page.survey.SEARCH_NGRAM_SIZE,searchTerms=this.searchTerms,i=0,word,ngram;for(;i<wordCount;i++){word=words[i];ngram=word.substring(0,ngramSize);if(!word.length){continue;}else if(ngram in searchTerms){searchTerms[ngram].push({'word':word,'id':this.ID});}else{searchTerms[ngram]=[{'word':word,'id':this.ID}];}}},mungeCompareMenuMatrix:function(rollup,crossedQuestion){var heading,crossedColID,crossedRow,answers=rollup.crossed_cols||rollup.crossed_rows,crossedRowID,crossedCol,compareStructure,structure=this.structure,rowList=this.rowList,rowLen=rowList.length,colList=this.colList,colLen=colList.length,i=0,j=0;compareStructure=SM.Object.deepCopy(structure);compareStructure.type={family:"matrix",subtype:"menu"}; for(i=0;i<colLen;i++){compareStructure.answers.cols[i].items=[];for(j=0;j<answers.length;j++){heading="Q"+crossedQuestion.position+": ";if(rollup.crossed_cols){crossedRowID=rollup.crossed_rows[0];crossedRow=crossedQuestion.answers[crossedRowID];crossedColID=rollup.crossed_cols[j];crossedCol=crossedQuestion.answers[crossedColID];crossedCol=SM.Object.copy(crossedCol);heading=heading+[crossedRow.text,crossedCol.text].join(": ");compareStructure.answers.cols[i].items[j]=crossedCol;}else{crossedRowID=rollup.crossed_rows[j];crossedRow=crossedQuestion.answers[crossedRowID];crossedRow=SM.Object.copy(crossedRow);heading=heading+crossedRow.text;compareStructure.answers.cols[i].items[j]=crossedRow;}
compareStructure.answers.cols[i].items[j].text=heading;}}
for(i=0;i<rowLen;i++){compareStructure.answers.rows[i].items=[];for(j=0;j<answers.length;j++){heading="Q"+crossedQuestion.position+": ";if(rollup.crossed_cols){crossedRowID=rollup.crossed_rows[0];crossedRow=crossedQuestion.answers[crossedRowID];crossedColID=rollup.crossed_cols[j];crossedCol=crossedQuestion.answers[crossedColID];crossedCol=SM.Object.copy(crossedCol);heading=heading+[crossedRow.text,crossedCol.text].join(": ");compareStructure.answers.rows[i].items.push(crossedCol);}else{crossedRowID=rollup.crossed_rows[j];crossedRow=crossedQuestion.answers[crossedRowID];crossedRow=SM.Object.copy(crossedRow);heading=heading+crossedRow.text;compareStructure.answers.rows[i].items.push(crossedRow);}
compareStructure.answers.rows[i].items[j].text=heading;}
if(!compareStructure.answers.crossedOptions){compareStructure.answers.crossedOptions=compareStructure.answers.rows[i].items;}}
return compareStructure;},mungeCompareMenuMatrixRA:function(rollup,crossedQuestion){var heading,crossedColID,crossedRow,answers=rollup.crossed_cols||rollup.crossed_rows,crossedRowID,crossedCol,compareStructure,structure=this.structure,rowList=this.rowList,rowLen=rowList.length,colList=this.colList,colLen=colList.length,i=0,j=0;
if(answers.length==0){answers=rollup.crossed_rows;}
compareStructure=SM.Object.deepCopy(structure);compareStructure.type={family:"matrix",subtype:"menu"}; for(i=0;i<colLen;i++){compareStructure.answers.cols[i].items=[];for(j=0;j<answers.length;j++){heading="Q"+crossedQuestion.position+": ";if(rollup.crossed_cols&&rollup.crossed_cols.length>0){crossedRowID=rollup.crossed_rows[0];crossedRow=crossedQuestion.answers[crossedRowID];crossedColID=rollup.crossed_cols[j];crossedCol=crossedQuestion.answers[crossedColID];crossedCol=SM.Object.copy(crossedCol);heading=heading+[crossedRow.text,crossedCol.text].join(": ");compareStructure.answers.cols[i].items[j]=crossedCol;}else{crossedRowID=rollup.crossed_rows[j];for(var k=0;k<crossedQuestion.randomAssignmentList.length;k++){if(crossedRowID==crossedQuestion.randomAssignmentList[k].variable_id){crossedRow=crossedQuestion.randomAssignmentList[k];break;}} 
crossedRow=SM.Object.copy(crossedRow);crossedRow.id=crossedRow.variable_id.toString();if(crossedRow.heading){heading+=crossedRow.heading;}else{heading+=crossedRow.variable_name;}
crossedRow.position=j+1;crossedRow.question_id=parseInt(crossedQuestion.ID);crossedRow.visible=true;crossedRow.type="col";compareStructure.answers.cols[i].items[j]=crossedRow;}
compareStructure.answers.cols[i].items[j].text=heading;}}
for(i=0;i<rowLen;i++){compareStructure.answers.rows[i].items=[];for(j=0;j<answers.length;j++){heading="Q"+crossedQuestion.position+": ";if(rollup.crossed_cols&&rollup.crossed_cols.length>0){crossedRowID=rollup.crossed_rows[0];crossedRow=crossedQuestion.answers[crossedRowID];crossedColID=rollup.crossed_cols[j];crossedCol=crossedQuestion.answers[crossedColID];crossedCol=SM.Object.copy(crossedCol);heading=heading+[crossedRow.text,crossedCol.text].join(": ");compareStructure.answers.rows[i].items.push(crossedCol);}else{crossedRowID=rollup.crossed_rows[j];for(var k=0;k<crossedQuestion.randomAssignmentList.length;k++){if(crossedRowID==crossedQuestion.randomAssignmentList[k].variable_id){crossedRow=crossedQuestion.randomAssignmentList[k];break;}}

crossedRow=SM.Object.copy(crossedRow);crossedRow.id=crossedRow.variable_id.toString();if(crossedRow.heading){heading+=crossedRow.heading;}else{heading+=crossedRow.variable_name;}
crossedRow.position=j+1;crossedRow.question_id=parseInt(crossedQuestion.ID);crossedRow.visible=true;crossedRow.type="row";compareStructure.answers.rows[i].items.push(crossedRow);}
compareStructure.answers.rows[i].items[j].text=heading;}
if(!compareStructure.answers.crossedOptions){compareStructure.answers.crossedOptions=compareStructure.answers.rows[i].items;}}
return compareStructure;},mungeCompareMatrix:function(rollup,crossedQuestion){var structure=this.structure,compareStructure,answers=rollup.crossed_cols||rollup.crossed_rows,crossedRow,crossedRowID,crossedColID,crossedCol,heading,i;compareStructure=SM.Object.deepCopy(structure);compareStructure.type={family:"matrix",subtype:"single"};compareStructure.answers.cols=[];for(i=0;i<answers.length;i++){heading="Q"+crossedQuestion.position+": ";if(rollup.crossed_cols){crossedRowID=rollup.crossed_rows[0];crossedRow=crossedQuestion.answers[crossedRowID];crossedColID=rollup.crossed_cols[i];crossedCol=crossedQuestion.answers[crossedColID];crossedCol=SM.Object.copy(crossedCol);heading=heading+[crossedRow.text,crossedCol.text].join(": ");compareStructure.answers.cols[i]=crossedCol;}else{crossedRowID=rollup.crossed_rows[i];crossedRow=crossedQuestion.answers[crossedRowID];crossedRow=SM.Object.copy(crossedRow);heading=heading+crossedRow.text;compareStructure.answers.cols[i]=crossedRow;}
compareStructure.answers.cols[i].text=heading;}
compareStructure.answers.crossedOptions=compareStructure.answers.cols;if(this.isEssay()){compareStructure.answers.rows=[{id:"0",question_id:this.ID,text:this.heading,type:"row",is_openended:true}];}
return compareStructure;},mungeCompareMatrixRA:function(rollup,crossedQuestion){var structure=this.structure,compareStructure,answers=rollup.crossed_cols||rollup.crossed_rows,crossedRow,crossedRowID,crossedColID,crossedCol,heading,i,j; if(answers.length==0){answers=rollup.crossed_rows;}
compareStructure=SM.Object.deepCopy(structure);compareStructure.type={family:"matrix",subtype:"single"};compareStructure.answers.cols=[];for(i=0;i<answers.length;i++){heading="Q"+crossedQuestion.position+": ";if(rollup.crossed_cols&&rollup.crossed_cols.length>0){crossedRowID=rollup.crossed_rows[0];crossedRow=crossedQuestion.answers[crossedRowID];crossedColID=rollup.crossed_cols[i];crossedCol=crossedQuestion.answers[crossedColID];crossedCol=SM.Object.copy(crossedCol);heading=heading+[crossedRow.text,crossedCol.text].join(": ");compareStructure.answers.cols[i]=crossedCol;}else{crossedRowID=rollup.crossed_rows[i];for(var j=0;j<crossedQuestion.randomAssignmentList.length;j++){if(crossedRowID==crossedQuestion.randomAssignmentList[j].variable_id){crossedRow=crossedQuestion.randomAssignmentList[j];break;}}
crossedRow=SM.Object.copy(crossedRow);crossedRow.id=crossedRow.variable_id.toString();if(crossedRow.heading){heading+=crossedRow.heading;}else{heading+=crossedRow.variable_name;}
compareStructure.answers.cols[i]=crossedRow;}
compareStructure.answers.cols[i].text=heading;}
compareStructure.answers.crossedOptions=compareStructure.answers.cols;if(this.isEssay()){compareStructure.answers.rows=[{id:"0",question_id:this.ID,text:this.heading,type:"row",is_openended:true}];}
 
return compareStructure;},sanitizeAnswer:function(answer){var rawSrc,safeSrc,imgTag,stripped,emptyOption="("+Globalize.localize("no label")+")",img; imgTag=SM.Html.findFirstTag(answer.text,"img"); if(!imgTag){stripped=SM.Html.strip(answer.text,false);imgTag=SM.Html.findFirstTag(stripped,"img");}
 
if(imgTag){imgTag=SM.Html.removeExternalAttributes(imgTag);img=SM.Html.parse(imgTag)[0];}
 
if(img){rawSrc=img.getAttribute("data-src");rawSrc=SM.String.trim(rawSrc);rawSrc=SM.Html.strip(rawSrc);if(SM.String.isHttpUrl(rawSrc)){safeSrc=rawSrc;}} 
if(safeSrc){answer.text=SM.String.afterLast(safeSrc,"/");answer.mediaHTML=SM.Template.render("img",{classes:"img-option",src:safeSrc,alt:answer.text,title:answer.text});}else{ if(!answer.text){answer.text=emptyOption;}else{answer.text=SM.Html.strip(answer.text);}}}});SM.BaseAnRule={CHOICE_SET_SCHEMA:{rows:{}},BASE_RULE_METADATA_KEY:"rule_",MAX_CHOICE_HEADING_LENGTH:2,TEMP_ID_PREFIX:"new_",FAMILY_TYPES:{SHOW:'show',FILTER:'filter',COMPARE:'compare'},ruleTypeToModelMap:{filter:{respondent_data:"FilterRespondentDataAnRule",collector:"FilterCollectorAnRule",completeness:"FilterCompletenessAnRule",time_period:"FilterTimePeriodAnRule",random_assignment:"FilterRandomAssignmentRule",},compare:{random_assignment:"CompareRandomAssignmentRule"},show:{show:"ShowAnRule"}},qnaRuleModelMap:{single_choice:"QnaSimpleAnRule",multiple_choice:"QnaSimpleAnRule",matrix:"QnaMatrixAnRule",menu_matrix:"QnaMenuMatrixAnRule",open_ended:"QnaOpenEndedAnRule",demographic:"QnaOpenEndedAnRule",datetime:"QnaDatetimeAnRule",numerical:"QnaNumericalAnRule",rating_comment_per_row:"QnaRatingCommentPerRowAnRule"},lastValidation:{isValid:true,invalids:[]},__create:function(options){if(!options.ID){this.isNew=true; this.ID=this.TEMP_ID_PREFIX+this.__uid;}else{this.isNew=false;this.ID=options.ID;}
this.loadRuleMetadataValue(options.attrs);this.isCorrupt=options.isCorrupt===true;this.ruleFamily=this.isCompare?'compare':'filter';this.editMode=false;this.isDirty=false;this.isShow=false;this.isQNA=false;this.isRA=false;if(this.metadata_id){delete this.metadata_id;}},loadRuleMetadataValue:function(ruleValue){this.customHeading=ruleValue.custom_heading; this.isCompare=ruleValue.is_compare_rule||false;this.selected=ruleValue.selected;}, FactoryCreate:function(options,survey){var type=options.attrs.rule_type,questionModel,modelKeyword,ruleModel,ruleName,family;if(type==="show"){family="show";}else if(type==="random_assignment"&&options.attrs.is_compare_rule){family="compare";}else{family="filter";}
if(type==="qna"){questionModel=survey.getQuestion(options.attrs.question_id);modelKeyword=questionModel.family;if(questionModel.family==="matrix"&&questionModel.subtype==="menu"){modelKeyword="menu_matrix";}else if(questionModel.subtype==="numerical"){modelKeyword="numerical";}
if(questionModel.commentField&&questionModel.commentField.apply_all_rows){modelKeyword="rating_comment_per_row";}
ruleName=this.qnaRuleModelMap[modelKeyword];ruleModel=SM.Models.create(ruleName,options);if(options.attrs.is_compare_rule){ruleModel.ruleFamily='compare';ruleModel.isCompare=true;}}else if(type==="random_assignment"){ruleName=this.ruleTypeToModelMap[family][type];ruleModel=SM.Models.create(ruleName,options);if(options.attrs.is_compare_rule){ruleModel.ruleFamily='compare';ruleModel.isCompare=true;}}else{ruleName=this.ruleTypeToModelMap[family][type];ruleModel=SM.Models.create(ruleName,options);}
return ruleModel;},loadSurvey:function(survey){this.survey=survey;},__setters:{editMode:function(self,val){if(val===true){ self._ruleBackup=self.dumpRuleValue();}else if(self._ruleBackup){ self.loadRuleMetadataValue(self._ruleBackup);delete self._ruleBackup;}
self.editMode=val;}},__getters:{heading:function(self){return self.customHeading||self.getHeading();},selected:function(self){ return self.selected&&!self.isCorrupt;}},applyRule:function(){if(this.isNew){this.survey.anviews.currentView.addRule(this);this.isNew=false;}else{this._trigger({type:'ruleEdited',ruleModel:this});}},copyRule:function(){var rule=this.copy();this.survey.anviews.currentView.addRule(rule);this.survey.anviews.currentView.save();},toggleRule:function(){var val=!this.get("selected");this.set("selected",val);this._trigger({type:'ruleEdited',ruleModel:this});},deleteRule:function(){this._trigger({type:'ruleDeleted',ruleModel:this});},copy:function(){var copy=SM.Models.create(this.__NAME,{ID:null,attrs:this.dumpRuleValue()}),heading=copy.customHeading||this.get("heading");heading=heading+" - "+Globalize.localize("COPY");copy.set("customHeading",heading);copy.loadSurvey(this.survey);copy.set("selected",false);copy.set("isNew",false);return copy;},isPersisted:function(){return this.ID.substr(0,4)!==this.TEMP_ID_PREFIX;},dump:function(){var key=this.BASE_RULE_METADATA_KEY,metadata_id=this.ID,val,tempID=null;key=[key,this.ruleFamily,"_",this.get("ruleType")].join("");val=this.dumpRuleValue();if(!this.isPersisted()){metadata_id=null;tempID=this.ID;}
return{key:key,temp_id:tempID,is_corrupt:this.isCorrupt,metadata_id:metadata_id,option_id:null,question_id:null,value:val,view_id:this.survey.anviews.currentView.ID};},sanitize:function(){},dumpRuleValue:function(){var self=this,ruleValue={};ruleValue.rule_type=this.ruleType;ruleValue.selected=this.selected;ruleValue.custom_heading=this.customHeading;return SM.Object.deepCopy(ruleValue);},commit:function(){this.sanitize();this.lastValidation=this.validate();if(this.lastValidation.isValid){delete this._ruleBackup;this.editMode=false;}
return this.lastValidation.isValid;}, _getChoiceSetHeading:function(choiceSet,getChoiceText){var text,heading="",len,i=0,max=this.MAX_CHOICE_HEADING_LENGTH,survey=this.survey,indexOfLastChoice;$.each(choiceSet,function(choiceID,val){text=getChoiceText(choiceID);if(i<max){heading+=text+", ";}
len=i+1;i++;});heading=heading.substring(0,heading.length-2); indexOfLastChoice=heading.length;if(len>max){heading+=" +"+(len-max);}
return{heading:heading,numChoices:i,indexOfLastChoice:indexOfLastChoice};}};SM.Models.extend("FilterRespondentDataAnRule",SM.BaseAnRule,{__create:function(options){this.ruleType="respondent_data";SM.BaseAnRule.__create.call(this,options);},loadRuleMetadataValue:function(ruleValue){var self=this;SM.BaseAnRule.loadRuleMetadataValue.call(this,ruleValue); this.timeTotal=ruleValue.time_total;if(!this.get("timeTotal")){this.set("timeTotal",{op:">",unit:"s",value:""});} 
if(ruleValue.txt_rows){$.each(this.respondentAttributes,function(i,attribute){if(ruleValue.txt_rows[attribute.key]){self.set(attribute.id,ruleValue.txt_rows[attribute.key]);}});}},__validators:{email:function(self,value){var emailRegEx=/\S+@\S+\.\S+/,validation={message:Globalize.localize(self._errorMessages.email),isValid:true};if(value&&value.length>0){validation.isValid=emailRegEx.test(value);}
return validation;},ip:function(self,value){var ip=$.trim(value||""),validation={message:Globalize.localize(self._errorMessages.ip),isValid:true},match=null,regex=/^(\d{1,3})\.(\d{1,3})\.(\d{1,3})\.(\d{1,3})$/;if(ip.length>0){match=ip.match(regex);if(match){$.each(match,function(i,currMatch){currMatch=parseInt(currMatch,10);if(currMatch>255||currMatch<0){validation.isValid=false;}});}else{validation.isValid=false;}}
return validation;},timeTotal:function(self,timeTotal){var timeTotalValue=timeTotal.value||"",isValid=true,timeValParsed;timeTotalValue=$.trim(timeTotalValue);if(timeTotalValue.length>0){timeValParsed=parseInt(timeTotalValue,10);if(isNaN(timeValParsed)||!isFinite(timeTotalValue)||timeValParsed===0){isValid=false;}}
return{isValid:isValid};}},_errorMessages:{ip:"Please enter a valid IP address",email:"Please enter a valid email"},respondentAttributes:[{id:"ip",key:"ip",textLabel:"IP Address"},{id:"email",key:"email",textLabel:"Email Address"},{id:"firstName",key:"first_name",textLabel:"First Name"},{id:"lastName",key:"last_name",textLabel:"Last Name"},{id:"custom",key:"custom",textLabel:"Custom Data",popout_id:"custom-data-popout"}],dumpRuleValue:function(){var ruleAttrs=SM.BaseAnRule.dumpRuleValue.call(this),self=this,timeData=self.get("timeTotal"),textInputs={},setter,text;$.each(this.respondentAttributes,function(i,attribute){setter=attribute.id;if(self.get(setter)){text=$.trim(self.get(setter)||"");if(text){textInputs[attribute.key]=text;}}});ruleAttrs.txt_rows=textInputs;if(timeData.value){ruleAttrs.time_total=timeData;}
return SM.Object.deepCopy(ruleAttrs);},getHeading:function(){var timeChoice=this.get("timeTotal"),self=this,heading="",max=2,count=0,culture=Globalize.culture();if(timeChoice&&$.trim(timeChoice.value)){heading+=Globalize.localize("Response time");heading+=" "+timeChoice.op+" "+timeChoice.value;heading+=culture.calendar.timeAbbr[timeChoice.unit]+", ";count++;}
$.each(this.respondentAttributes,function(i,attribute){if(self.get(attribute.id)){if(count<max){heading+=Globalize.localize(attribute.textLabel);heading+=" = "+self.get(attribute.id)+", ";}
count++;}});heading=heading.substring(0,heading.length-2); if(count>max){heading+=" + "+(count-max);}
return heading;},attributeIsVisible:function(attr){if(attr==="first_name"||attr==="last_name"||attr==="email"){return this.survey.hasEmailCollector;}
return true;}});SM.Models.extend("FilterCollectorAnRule",SM.BaseAnRule,{__create:function(options){SM.BaseAnRule.__create.call(this,options);this.ruleType="collector";},loadRuleMetadataValue:function(ruleValue){SM.BaseAnRule.loadRuleMetadataValue.call(this,ruleValue);this.rows=_.isEmpty(ruleValue.rows)?{}:ruleValue.rows;},dumpRuleValue:function(){var ruleValue=SM.BaseAnRule.dumpRuleValue.call(this);ruleValue.rows=this.get("rows");return SM.Object.deepCopy(ruleValue);},getHeading:function(){var survey=this.survey,choiceSetHeading;choiceSetHeading=this._getChoiceSetHeading(this.get("rows"),function(collectorID){var collector=survey.getCollector(collectorID);return collector.title;});return choiceSetHeading.heading;}});SM.Models.extend("FilterCompletenessAnRule",SM.BaseAnRule,{__create:function(options){SM.BaseAnRule.__create.call(this,options);this.ruleType="completeness";},loadRuleMetadataValue:function(ruleValue){SM.BaseAnRule.loadRuleMetadataValue.call(this,ruleValue);this.rows=_.isEmpty(ruleValue.rows)?{}:ruleValue.rows;},dumpRuleValue:function(){var ruleValue=SM.BaseAnRule.dumpRuleValue.call(this);ruleValue.rows=this.get("rows");return SM.Object.deepCopy(ruleValue);},getHeading:function(){var checkedRows=this.get("rows"),complete=Globalize.localize("complete responses"),partial=Globalize.localize("partial responses"),disqualified=Globalize.localize("disqualified responses"),overquota=Globalize.localize("responses over quota"),heading=[];if(checkedRows.completely){heading.push(complete);}
if(checkedRows.partially){heading.push(partial);}
if(checkedRows.disqualified){heading.push(disqualified);}
if(checkedRows.overquota){heading.push(overquota);}
heading=heading.join(", ");heading=heading[0].toUpperCase()+heading.substr(1);return heading;}});SM.Models.extend("FilterTimePeriodAnRule",SM.BaseAnRule,{__create:function(options){var choiceSetData;SM.BaseAnRule.__create.call(this,options);this.ruleType="time_period";},loadRuleMetadataValue:function(ruleValue){SM.BaseAnRule.loadRuleMetadataValue.call(this,ruleValue);this.startDate=ruleValue.start_date;this.endDate=ruleValue.end_date;this.timeType=ruleValue.time_type;},__validators:{endDate:function(self,value){if(!value){return{isValid:false};}
return{isValid:true};},startDate:function(self,value){if(!value){return{isValid:false};}
return{isValid:true};}},getHeading:function(){return Globalize.format(new Date(this.get("startDate")),'d')+" - "+Globalize.format(new Date(this.get("endDate")),'d');},dumpRuleValue:function(){var ruleValue=SM.BaseAnRule.dumpRuleValue.call(this);ruleValue.start_date=this.get('startDate');ruleValue.end_date=this.get('endDate');ruleValue.time_type=this.get('timeType')||'custom';return SM.Object.deepCopy(ruleValue);}});SM.Models.extend("BaseQnaAnRule",SM.BaseAnRule,{__create:function(options){SM.BaseAnRule.__create.call(this,options);this.ruleType="qna";this.isQNA=true;},loadRuleMetadataValue:function(ruleValue){SM.BaseAnRule.loadRuleMetadataValue.call(this,ruleValue);this.questionID=ruleValue.question_id;},getQuestion:function(){return this.survey.getQuestion(this.get('questionID'));},getHeading:function(){var questionModel=this.getQuestion(),letter_q=Globalize.localize("Question").substr(0,1),heading=letter_q+questionModel.position+": ";return heading+this._getQnaHeading();},dumpRuleValue:function(){var ruleValue=SM.BaseAnRule.dumpRuleValue.call(this);if(this.choiceSet){ruleValue.answers=[this.choiceSet.dump()];}
ruleValue.is_compare_rule=this.isCompare;ruleValue.question_id=this.questionID;return SM.Object.deepCopy(ruleValue);},_addCommentFieldHeading:function(headingData,commentChoiceSet){var heading=headingData.heading,commentField=this.getQuestion().commentField,searchTerm,max=this.MAX_CHOICE_HEADING_LENGTH;if(commentChoiceSet.get("commentFieldSelected")){headingData.numChoices++;if(headingData.numChoices<=max){searchTerm=commentChoiceSet.get("searchTerm");if(headingData.numChoices>1){heading+=", ";}
heading+=commentField.text;if(searchTerm){heading+=[' = "',searchTerm,'"'].join("");}
headingData.indexOfLastChoice=heading.length;}else{heading=heading.substring(0,headingData.indexOfLastChoice)+" +"+(headingData.numChoices-max);}
headingData.heading=heading;}
return headingData;}});SM.Models.extend("QnaSimpleAnRule",SM.BaseQnaAnRuleModel,{CHOICE_SET_SCHEMA:{rows:{}},loadRuleMetadataValue:function(ruleValue){var choiceSetData;SM.BaseQnaAnRuleModel.loadRuleMetadataValue.call(this,ruleValue);if(_.isEmpty(ruleValue.answers)){choiceSetData=SM.Object.deepCopy(this.CHOICE_SET_SCHEMA);}else{choiceSetData=ruleValue.answers[0];}
this.choiceSet=SM.Models.create("SimpleQnaRuleChoiceSet",choiceSetData);this.choiceSet.loadRule(this);},__validators:{choiceSet:function(self,choiceSet){return choiceSet.validate();}},sanitize:function(){var text=this.choiceSet.get("searchTerm");if(text){this.choiceSet.set("searchTerm",_.string.trim(text));}},_getQnaHeading:function(){var self=this,survey=this.survey,headingData=this._getChoiceSetHeading(this.choiceSet.rows,function(choiceID){return survey.getAnswer(choiceID).text;});headingData=this._addCommentFieldHeading(headingData,this.get("choiceSet"));return headingData.heading;}});SM.Models.extend("QnaOpenEndedAnRule",SM.BaseQnaAnRuleModel,{CHOICE_SET_SCHEMA:{comment:{search_type:"all",rows:{},search_term:""}},loadRuleMetadataValue:function(ruleValue){var choiceSetData;SM.BaseQnaAnRuleModel.loadRuleMetadataValue.call(this,ruleValue);if(_.isEmpty(ruleValue.answers)){choiceSetData=SM.Object.deepCopy(this.CHOICE_SET_SCHEMA);}else{choiceSetData=ruleValue.answers[0];}
this.choiceSet=SM.Models.create("QnaOpenEndedRuleChoiceSet",choiceSetData);this.choiceSet.loadRule(this);},__validators:{choiceSet:function(self,choiceSet){return choiceSet.validate();}},loadSurvey:function(survey){var questionModel; SM.BaseQnaAnRuleModel.loadSurvey.call(this,survey);questionModel=this.getQuestion();if(questionModel.isEssay()){this.choiceSet.set("selectedRowID","0");}},_getQnaHeading:function(){var questionModel=this.getQuestion(),choiceSet=this.choiceSet,lastChar,heading;if(questionModel.isEssay()){heading=questionModel.heading;}else{heading=questionModel.getAnswer(choiceSet.get("selectedRowID")).text;}
lastChar=heading.substr(-1);if(lastChar===":"||lastChar==="="){heading=heading.substring(0,heading.length-1);}
heading+=' = "'+choiceSet.get("searchTerm")+'"';return heading;}});SM.Models.extend("QnaDatetimeAnRule",SM.BaseQnaAnRuleModel,{CHOICE_SET_SCHEMA:{comment:{search_term:undefined,rows:{},op:"="}},__validators:{choiceSet:function(self,choiceSet){return choiceSet.validate();}},_choiceSetModel:"QnaDateTimeRuleChoiceSet",loadRuleMetadataValue:function(ruleValue){var choiceSetData;SM.BaseQnaAnRuleModel.loadRuleMetadataValue.call(this,ruleValue);if(_.isEmpty(ruleValue.answers)){choiceSetData=SM.Object.deepCopy(this.CHOICE_SET_SCHEMA);}else{choiceSetData=ruleValue.answers[0];}
this.choiceSet=SM.Models.create(this._choiceSetModel,choiceSetData);this.choiceSet.loadRule(this);},_getQnaHeading:function(){var questionModel=this.getQuestion(),operator=this.choiceSet.get("op"),heading=questionModel.getAnswer(this.choiceSet.get("selectedRowID")).text,validation=questionModel.structure.validation,dateFormat=validation&&validation.type,dateMoment=this.choiceSet.selectedDate,date=new Date(dateMoment.year(),dateMoment.month(),dateMoment.date(),dateMoment.hours(),dateMoment.minutes()); if(questionModel.subtype==="date_only"){if(dateFormat==="date_intl"){heading+=" "+operator+" "+Globalize.format(date,'d/M/yyyy');}else{heading+=" "+operator+" "+Globalize.format(date,'d');}}else if(questionModel.subtype==="time_only"){heading+=" "+operator+" "+Globalize.format(date,'t');}else{if(dateFormat==="date_intl"){heading+=" "+operator+" "+Globalize.format(date,'d/M/yyyy h:mm tt');}else{heading+=" "+operator+" "+Globalize.format(date,'M/d/yyyy h:mm tt');}}
return heading;}});SM.Models.extend("QnaNumericalAnRule",SM.BaseQnaAnRuleModel,{CHOICE_SET_SCHEMA:{comment:{op:"=",rows:{},search_term:""}},loadRuleMetadataValue:function(ruleValue){var choiceSetData;SM.BaseQnaAnRuleModel.loadRuleMetadataValue.call(this,ruleValue);if(_.isEmpty(ruleValue.answers)){choiceSetData=SM.Object.deepCopy(this.CHOICE_SET_SCHEMA);}else{choiceSetData=ruleValue.answers[0];}
this.choiceSet=SM.Models.create("QnaNumericalRuleChoiceSet",choiceSetData);this.choiceSet.loadRule(this);},__validators:{choiceSet:function(self,choiceSet){return choiceSet.validate();}},_getQnaHeading:function(){var questionModel=this.getQuestion(),choiceSet=this.choiceSet,heading=questionModel.getAnswer(choiceSet.get("selectedRowID")).text,lastChar;lastChar=heading.substr(-1);if(lastChar===":"||lastChar==="="){heading=heading.substring(0,heading.length-1);}
heading+=' '+this.choiceSet.get("op")+' "'+choiceSet.get("searchTerm")+'"';return heading;},sanitize:function(){
 var number=Globalize.parseFloat(this.choiceSet.searchTerm,10);this.choiceSet.searchTerm=number.toString();}});SM.Models.register("BaseQnaRuleChoiceSet",{__create:function(choiceSet){var comment=choiceSet.comment;if(comment){this.set("commentFieldSelected",true);this.searchType=comment.search_type;this.searchTerm=comment.search_term;}
this.rows=choiceSet.rows;},loadRule:function(parentRuleModel){this.ruleModel=parentRuleModel;},__validators:{searchTerm:function(self,value){var validation={isValid:true};if(!self.get("commentFieldSelected")){return validation;}
 
if(_.isEmpty(value)){return validation;}
if(!SM.String.containsWordBoundary(value)){validation.isValid=false;}
return validation;}},dump:function(){var questionModel=this.ruleModel.getQuestion(),choiceSet=SM.Object.deepCopy({rows:this.rows}),commentField=questionModel.commentField;if(this.get("commentFieldSelected")&&commentField){choiceSet.comment={search_term:this.get("searchTerm")||null,rows:{}};choiceSet.comment.rows[commentField.id]=true;if(choiceSet.comment.search_term){choiceSet.comment.search_type=this.get("searchType")||"all";}}
return choiceSet;}});SM.Models.extend("SimpleQnaRuleChoiceSet",SM.BaseQnaRuleChoiceSetModel,{dump:function(){var choiceSet=SM.BaseQnaRuleChoiceSetModel.dump.call(this),comment=choiceSet.comment;if(this.get("commentFieldSelected")&&comment&&!comment['search_term']){ choiceSet.comment['search_term']="";}
return choiceSet;}});SM.Models.extend("MatrixQnaRuleChoiceSet",SM.BaseQnaRuleChoiceSetModel,{__create:function(choiceSet){SM.BaseQnaRuleChoiceSetModel.__create.call(this,choiceSet);this.cols=choiceSet.cols;if(choiceSet.colChoices){this.colChoices=choiceSet.colChoices;}},dump:function(){var choices=SM.BaseQnaRuleChoiceSetModel.dump.call(this);choices.cols=SM.Object.deepCopy(this.cols);if(this.colChoices){choices.col_choices=SM.Object.deepCopy(this.colChoices);}
return choices;}});SM.Models.extend("QnaDateTimeRuleChoiceSet",SM.BaseQnaRuleChoiceSetModel,{__create:function(choiceSet){ var answerID=SM.Object.getOneKey(choiceSet.comment.rows)||"-1",dateMoment;this.op=choiceSet.comment.op;this.selectedRowID=answerID;if(answerID==="-1"){dateMoment=moment(new Date());dateMoment.startOf('day');}else{dateMoment=moment.utc(choiceSet.comment.search_term);}
this.set("selectedDate",dateMoment);this.set("selectedTime",{hours:dateMoment.hours(),minutes:dateMoment.minutes()});},__validators:{selectedDate:function(self,dateVal){var questionModel=self.ruleModel.getQuestion();if(questionModel.subtype==="date_only"||questionModel.subtype==="both"){return{isValid:dateVal?true:false};}
return{isValid:true};},selectedTime:function(self,timeVal){var questionModel=self.ruleModel.getQuestion();if(questionModel.subtype==="time_only"||questionModel.subtype==="both"){if(!timeVal||timeVal.minutes===-1||timeVal.hours===-1){return{isValid:false};}}
return{isValid:true};},selectedRowID:function(self,value){var validation={isValid:true};if(value==="-1"){validation.isValid=false;}
return validation;}},dump:function(){var value={rows:{},search_term:this.dumpDateTime(),op:this.get("op")};value.rows[this.get("selectedRowID")]=true;return{comment:value};},dumpDateTime:function(){ var dateMoment=this.get("selectedDate")||moment(),time=this.get("selectedTime")||{hours:0,minutes:0};dateMoment.hours(time.hours);dateMoment.minutes(time.minutes);
return moment(dateMoment).utc().format('YYYY-MM-DD[T]HH:mm:ss');}});SM.Models.extend("QnaOpenEndedRuleChoiceSet",SM.BaseQnaRuleChoiceSetModel,{__create:function(choiceSet){this.searchTerm=choiceSet.comment.search_term;this.searchType=choiceSet.comment.search_type;this.selectedRowID=SM.Object.getOneKey(choiceSet.comment.rows)||"-1";},__validators:{searchTerm:function(self,value){var validation={isValid:true};if($.trim(value).length===0||!SM.String.containsWordBoundary(value)){validation.isValid=false;}
return validation;},selectedRowID:function(self,value){var validation={isValid:true};if(value==="-1"){validation.isValid=false;}
return validation;}},dump:function(){var questionModel=this.ruleModel.getQuestion(),value={search_term:this.get("searchTerm"),search_type:this.get("searchType")};if(questionModel.isMultiResponse()){value.rows={};value.rows[this.selectedRowID]=true;}
return{comment:value};}});SM.Models.extend("QnaNumericalRuleChoiceSet",SM.QnaOpenEndedRuleChoiceSetModel,{__create:function(choiceSet){SM.BaseQnaRuleChoiceSetModel.__create.call(this,choiceSet);this.op=choiceSet.comment.op;this.selectedRowID=SM.Object.getOneKey(choiceSet.comment.rows)||"-1";},__validators:{searchTerm:function(self,value){var validation={isValid:true},number=parseFloat(value,10);if(isNaN(number)||number<0){validation.isValid=false;}
return validation;},selectedRowID:function(self,value){var validation={isValid:true};if(value==="-1"){validation.isValid=false;}
return validation;}},dump:function(){var dump=SM.QnaOpenEndedRuleChoiceSetModel.dump.call(this);delete dump.comment.search_type;dump.comment.op=this.get("op");return dump;}});SM.Models.extend("QnaMatrixAnRule",SM.BaseQnaAnRuleModel,{ CHOICE_SET_SCHEMA:{rows:{},cols:{}},__validators:{choiceSetList:function(self,choiceSetList){var allValid=[];if(choiceSetList.length===0&&!self.commentChoiceSet){return false;}
_.each(choiceSetList,function(choiceSet){var setValid=choiceSet.validate();allValid.push(setValid);});return allValid;},commentChoiceSet:function(self,commentChoiceSet){if(commentChoiceSet.get("commentFieldSelected")){return commentChoiceSet.validate();}
return false;}},__create:function(options){SM.BaseQnaAnRuleModel.__create.call(this,options);},loadRuleMetadataValue:function(ruleValue){var self=this,answers=ruleValue.answers,comment=ruleValue.comment;SM.BaseQnaAnRuleModel.loadRuleMetadataValue.call(this,ruleValue);this.choiceSetList=[];if(_.isEmpty(answers)){this.addChoiceSet();}else{_.each(answers,function(choiceSet){self.loadChoiceSet({rows:choiceSet.rows,cols:choiceSet.cols,colChoices:choiceSet.col_choices});});}
this.commentChoiceSet=SM.Models.create("MatrixQnaRuleChoiceSet",{comment:comment});this.commentChoiceSet.loadRule(this);},commit:function(){this.sanitize();this.lastValidation=this.validate();if(this.lastValidation.invalids.commentChoiceSet){ this.lastValidation.isValid=this.lastValidation.invalids.commentChoiceSet.isValid;}else{this.lastValidation.isValid=this.lastValidation.invalids.choiceSetList;}
if(this.lastValidation.isValid){this.lastValidation.invalids=[];delete this._ruleBackup;this.editMode=false;}
return this.lastValidation.isValid;}, addChoiceSet:function(){var choiceSetModel=this.loadChoiceSet(SM.Object.deepCopy(this.CHOICE_SET_SCHEMA));choiceSetModel.loadRule(this);return choiceSetModel;},loadChoiceSet:function(choiceSetData){var choiceSetModel;if(!choiceSetData.cols){return;}
choiceSetModel=SM.Models.create("MatrixQnaRuleChoiceSet",choiceSetData);this.choiceSetList.push(choiceSetModel);choiceSetModel.loadRule(this);return choiceSetModel;},isInvalidSet:function(choiceSet){return SM.Object.getOnlyKey(choiceSet.get("rows"))===undefined||SM.Object.getOneKey(choiceSet.get("cols"))===undefined||(choiceSet.get("colChoices")&&SM.Object.getOneKey(choiceSet.get("colChoices"))===undefined);},sanitize:function(){var choiceSetList=this.choiceSetList,commentChoiceSet=this.commentChoiceSet,text=commentChoiceSet.get("searchTerm"),choiceSetModel,self=this,i=0; for(;i<choiceSetList.length;i++){choiceSetModel=choiceSetList[i];if(self.isInvalidSet(choiceSetModel)){choiceSetList.splice(i,1);i--;}} 
if(text){commentChoiceSet.set("searchTerm",_.string.trim(text));}},_dumpAnswers:function(){var answers=[],self=this;_.each(this.choiceSetList,function(choiceSetModel){if(!self.isInvalidSet(choiceSetModel)){answers.push(choiceSetModel.dump());}});return answers;},dumpRuleValue:function(){var questionModel=this.getQuestion(),ruleValue=SM.BaseQnaAnRuleModel.dumpRuleValue.call(this),commentField=questionModel.commentField,commentChoiceSet=this.get("commentChoiceSet"),commentFieldID,commentFieldSelected,text,commentRow;ruleValue.question_id=this.questionID;ruleValue.answers=this._dumpAnswers();commentFieldSelected=this.get("commentFieldSelected")||(commentChoiceSet&&commentChoiceSet.get("commentFieldSelected"));if(commentField&&commentFieldSelected){ruleValue.comment=this.commentChoiceSet.dump().comment;commentFieldID=commentField.id;text=$.trim(ruleValue.comment.search_term||null);commentRow={rows:{}};commentRow.rows[commentFieldID]={search_type:ruleValue.comment.search_type||null,search_term:text};ruleValue.answers.push(commentRow);}
return SM.Object.deepCopy(ruleValue);},_getQnaHeading:function(){var questionModel=this.getQuestion(),choiceSetList=this.choiceSetList,survey=this.survey,getAnswerText=function(choiceID){return survey.getAnswer(choiceID).text;},heading,rowID,searchTerm,headingData;if(choiceSetList.length>0){rowID=SM.Object.getOnlyKey(choiceSetList[0].get("rows")); if(rowID){heading=questionModel.getAnswer(rowID).text+": ";headingData=this._getChoiceSetHeading(choiceSetList[0].get("cols"),getAnswerText);heading=heading+this._addCommentFieldHeading(headingData,choiceSetList[0]).heading;if(choiceSetList.length>1){rowID=SM.Object.getOnlyKey(choiceSetList[1].get("rows"));heading+="; "+questionModel.getAnswer(rowID).text+": ";if(choiceSetList[1].cols){headingData=this._getChoiceSetHeading(choiceSetList[1].get("cols"),getAnswerText);heading=heading+this._addCommentFieldHeading(headingData,choiceSetList[1]).heading;}
if(choiceSetList.length>2){heading+="...";}}}}
if(this.commentChoiceSet.get("commentFieldSelected")){if(choiceSetList.length<this.MAX_CHOICE_HEADING_LENGTH){searchTerm=this.commentChoiceSet.get("searchTerm");if(heading){heading+="; ";}else{heading="";}
heading+=this.getQuestion().commentField.text;if(searchTerm){heading+=[' = "',searchTerm,'"'].join("");}}else{heading+="...";}}
return heading;}});SM.Models.extend("QnaRatingCommentPerRowAnRule",SM.QnaMatrixAnRuleModel,{dumpRuleValue:function(){var ruleValue=SM.QnaMatrixAnRuleModel.dumpRuleValue.call(this);ruleValue.answers=this._dumpAnswers();return SM.Object.deepCopy(ruleValue);}});SM.Models.extend("QnaMenuMatrixAnRule",SM.QnaMatrixAnRuleModel,{CHOICE_SET_SCHEMA:{rows:{},cols:{},colChoices:{}},_getQnaHeading:function(){var questionModel=this.getQuestion(),choiceSetList=this.choiceSetList,heading="",survey=this.survey,searchTerm;if(choiceSetList.length>0){heading+=this._getRowColHeading(questionModel,choiceSetList[0].rows,choiceSetList[0].cols);heading+=this._getChoiceSetHeading(choiceSetList[0].colChoices,function(choiceID){return survey.getAnswer(choiceID).text;}).heading;if(choiceSetList.length>1){heading+="; "+this._getRowColHeading(questionModel,choiceSetList[1].rows,choiceSetList[1].cols);heading+=this._getChoiceSetHeading(choiceSetList[1].colChoices,function(choiceID){return survey.getAnswer(choiceID).text;}).heading;if(choiceSetList.length>2){heading+="...";}}}
if(this.commentChoiceSet.get("commentFieldSelected")){if(choiceSetList.length<this.MAX_CHOICE_HEADING_LENGTH){searchTerm=this.commentChoiceSet.get("searchTerm");heading+="; "+this.getQuestion().commentField.text;if(searchTerm){heading+=[' = "',searchTerm,'"'].join("");}}else{heading+="...";}}
return heading;},_getRowColHeading:function(questionModel,rowSet,colSet){var subheading="",answerID=SM.Object.getOnlyKey(rowSet);subheading+=questionModel.getAnswer(answerID).text+", ";answerID=SM.Object.getOnlyKey(colSet);subheading+=questionModel.getAnswer(answerID).text+": ";return subheading;}});SM.Models.extend("ShowAnRule",SM.BaseAnRule,{__create:function(options){SM.BaseAnRule.__create.call(this,options);this.ruleFamily="show";this.isShow=true;this.ruleType="show";},__getters:{show:function(self){var show=self.get("showSet").dump();show.selected=self.get("selected");return show;}},loadSurvey:function(survey){this.survey=survey;this.showSet=SM.Models.create("ShowSet");this.showSet.loadView(this.survey.anviews.currentView);

 this.set("selected",this.get("selected")||false);},getHeading:function(){var self=this,showSet=self.showSet,heading="",pageWord=Globalize.localize("Page"),letterQ=Globalize.localize("Question").substr(0,1),maxPageCount=2,pageCount=0;$.each(this.survey.pageList,function(i,page){if(showSet.hasPage(page)){if(pageCount<maxPageCount){heading+=pageWord+" "+page.position;if(showSet.pageQuestionsCheckedCount!==page.questionList.length){heading+=": ";$.each(page.questionList,function(j,question){if(showSet.hasQuestion(question)){heading+=letterQ+question.position+", ";}});heading=heading.replace(/,\s$/,'; ');}else{heading+=", ";}}
pageCount++;}});heading=heading.substring(0,heading.length-1);if(pageCount>maxPageCount){heading+=" +"+(pageCount-maxPageCount);}
return heading;},deleteRule:function(){ this.showSet.clear();this.set("selected",false);this._trigger({type:'ruleDeleted',ruleModel:this});}});SM.Models.register("ShowSet",{show:null, survey:null,pageQuestionCounts:null,totalQuestionCount:0,totalPageCount:0,loadView:function(view){var pID,qID,q,show;this.survey=view.anviews.survey;show=view.show;this.clear();if(show.pages){for(pID in show.pages){this.show.pages[pID]=true;this.totalPageCount++;}}
if(show.questions){for(qID in show.questions){q=this.survey.getQuestion(qID); if(!q){continue;}
this.show.questions[qID]=true;this.pageQuestionCounts[q.page.ID]++;this.totalQuestionCount++;}}},__create:function(options){this.show={pages:{},questions:{}};},allSelected:function(){if(this.totalQuestionCount===this.survey.questionCount){return true;}else{return false;}},togglePage:function(page){if(this.show.pages[page.ID]){if(this.pageQuestionCounts[page.ID]===page.questionList.length){this.removePage(page);return false;}
this.addPage(page);return true;}else{this.addPage(page);return true;}},toggleQuestion:function(question){if(this.show.questions[question.ID]){this.removeQuestion(question);return false;}else{this.addQuestion(question);return true;}},toggleAll:function(){if(this.allSelected()){this.clear();return false;}else{this.addAll();return true;}}, addAll:function(){var pageList=this.survey.pageList,i=0,j,q,page;this.totalQuestionCount=this.survey.questionCount;this.totalPageCount=this.survey.pageList.length;for(;i<pageList.length;i++){page=pageList[i];if(page.questionList.length>0){this.show.pages[page.ID]=true;for(j=0;j<page.questionList.length;j++){q=page.questionList[j];this.show.questions[q.ID]=true;this.pageQuestionCounts[page.ID]++;}}}},clear:function(){var pageQuestionCounts={},i=0,pageList=this.survey.pageList,len=pageList.length;for(;i<len;i++){pageQuestionCounts[pageList[i].ID]=0;}
this.pageQuestionCounts=pageQuestionCounts;this.show.pages={};this.show.questions={};this.totalQuestionCount=0;this.totalPageCount=0;},addQuestion:function(q){if(!this.show.questions[q.ID]){this.show.questions[q.ID]=true;if(!this.show.pages[q.page.ID]){this.show.pages[q.page.ID]=true;}
this.pageQuestionCounts[q.page.ID]++;this.totalQuestionCount++;}},addPage:function(page){var i=0,len=page.questionList.length;if(!this.show.pages[page.ID]){this.show.pages[page.ID]=true;this.totalPageCount++;}
this.pageQuestionCounts[page.ID]=len;for(;i<len;i++){if(!this.show.questions[page.questionList[i].ID]){this.show.questions[page.questionList[i].ID]=true;this.totalQuestionCount++;}}},removePage:function(page){var i=0,q;if(this.show.pages[page.ID]){for(;i<page.questionList.length;i++){q=page.questionList[i];if(this.show.questions[q.ID]){delete this.show.questions[q.ID];this.totalQuestionCount--;}}
delete this.show.pages[page.ID];this.pageQuestionCounts[page.ID]=0;this.totalPageCount--;}},removeQuestion:function(question){var i=0,page=question.page;if(this.show.questions[question.ID]){this.totalQuestionCount--;this.pageQuestionCounts[question.page.ID]--;delete this.show.questions[question.ID];}
if(this.pageQuestionCounts[question.page.ID]===0){delete this.show.pages[question.page.ID];}},hasPage:function(page,set){var self=set||this;return self.show.pages[page.ID];},hasQuestion:function(question,set){var self=set||this;return self.show.questions[question.ID];},questionCheckedCount:function(page){return this.totalQuestionCount;},pageQuestionsCheckedCount:function(page){return this.pageQuestionCounts[page.ID]||0;},dump:function(){var show=this.show;if(this.isEmpty()){show.questions=null;show.pages=null;}
return SM.Object.deepCopy(this.show);},isEmpty:function(){ return $.isEmptyObject(this.show.questions)||$.isEmptyObject(this.show.pages);},_toNumberList:function(list,total,hasItem){var i=0,pageList=this.survey.pageList,str="";if(total===list.length||total===0){return Globalize.localize("All");}
for(;i<list.length;i++){if(hasItem(list[i],this)){str+=[list[i].position,", "].join("");}}
return str.substring(0,str.length-2);},getPageString:function(){return this._toNumberList(this.survey.pageList,this.totalPageCount,this.hasPage);},getQuestionString:function(){return this._toNumberList(this.survey.questionList,this.totalQuestionCount,this.hasQuestion);}});SM.Models.extend("FilterRandomAssignmentRule",SM.BaseAnRule,{__create:function(options){SM.BaseAnRule.__create.call(this,options);this.ruleType="random_assignment";this.isRA=true;},dumpRuleValue:function(){var ruleValue=SM.BaseAnRule.dumpRuleValue.call(this);ruleValue.rows=this.get('rows');ruleValue.question_id=this.get('questionID');ruleValue.family=this.getFamily();ruleValue.subtype=this.getSubtype();return SM.Object.deepCopy(ruleValue);},loadRuleMetadataValue:function(ruleValue){SM.BaseAnRule.loadRuleMetadataValue.call(this,ruleValue);this.rows=_.isEmpty(ruleValue.rows)?{}:ruleValue.rows;this.questionID=ruleValue.question_id;},getFamily:function(){return this.getQuestion().family;},_mapTypeToText:function(family,subtype){var mapper={datetime:{date_only:"Question Test",time_only:"Question Test",both:"Question Test"},demographic:{us:"Question Test",international:"Question Test"},single_choice:{vertical:"Question Test"},multiple_choice:{vertical:"Question Test"},open_ended:{essay:"Question Test",single:"Question Test",multi:"Question Test",numerical:"Question Test"},matrix:{rating:"Question Test",single:"Question Test",multi:"Question Test"},presentation:{image:"Image Test",descriptive_text:"Text Test"}};return mapper[family][subtype];},getHeading:function(){var self=this,question=this.getQuestion(),rows=this.get('rows'),rowsText=[],heading,i,j;_.each(rows,function(value,row){_.each(question.randomAssignmentList,function(option){if(option.variable_id.toString()===row){rowsText.push(option.heading||option.variable_name);}});});heading="Q"+question.position+": ("+this._mapTypeToText(question.family,question.subtype)+") "+rowsText.join(', ');return heading;},getQuestion:function(){return this.survey.getQuestion(this.get('questionID'));},getRandomAssignmentList:function(){return this.getQuestion().randomAssignmentList;},getSubtype:function(){return this.getQuestion().subtype;}});SM.Models.extend("CompareRandomAssignmentRule",SM.BaseAnRule,{__create:function(options){options.attrs.is_compare_rule=true;SM.BaseAnRule.__create.call(this,options);this.ruleType="random_assignment";this.isRA=true;},dumpRuleValue:function(){var ruleValue=SM.BaseAnRule.dumpRuleValue.call(this);ruleValue.rows=this.get('rows');ruleValue.cols=this.get('cols');ruleValue.question_id=this.get('questionID');ruleValue.family=this.getFamily();ruleValue.subtype=this.getSubtype();ruleValue.is_compare_rule=true;return SM.Object.deepCopy(ruleValue);},loadRuleMetadataValue:function(ruleValue){SM.BaseAnRule.loadRuleMetadataValue.call(this,ruleValue);this.rows=_.isEmpty(ruleValue.rows)?{}:ruleValue.rows;this.questionID=ruleValue.question_id;},_mapTypeToText:function(family,subtype){var mapper={datetime:{date_only:"Question Test",time_only:"Question Test",both:"Question Test"},demographic:{us:"Question Test",international:"Question Test"},single_choice:{vertical:"Question Test"},multiple_choice:{vertical:"Question Test"},open_ended:{essay:"Question Test",single:"Question Test",multi:"Question Test",numerical:"Question Test"},matrix:{rating:"Question Test",single:"Question Test",multi:"Question Test"},presentation:{image:"Image Test",descriptive_text:"Text Test"}};return mapper[family][subtype];},getHeading:function(){var self=this,question=this.getQuestion(),rows=this.get('rows'),rowsText=[],heading,i,j;_.each(rows,function(value,row){_.each(question.randomAssignmentList,function(option){if(option.variable_id.toString()===row){rowsText.push(option.heading||option.variable_name);}});});heading="Q"+question.position+": ("+this._mapTypeToText(question.family,question.subtype)+") "+rowsText.join(', ');return heading;},getFamily:function(){return this.getQuestion().family;},getQuestion:function(){return this.survey.getQuestion(this.get('questionID'));},getRandomAssignmentList:function(){return this.getQuestion().randomAssignmentList;},getSubtype:function(){return this.getQuestion().subtype;}});SM.Models.register("AnalyzeState",{SUMMARY_MODE:"summary",BROWSE_MODE:"browse",TREND_MODE:"trends",__create:function(kwargs){this.page=kwargs.pageIndex;this.mode=kwargs.mode;this.viewID=kwargs.viewID;this.nextViewID=null;},__setters:{page:function(self,val){self.page=val;self.survey.anviews.defaultView.set("page",val);},mode:function(self,val){self.mode=val;}},__getters:{page:function(self){return self.survey.anviews.defaultView.get("page");},mode:function(self){return self.mode;},allPagesSelected:function(self){return self.get("page")==="all"||(self.survey&&self.survey.pageList.length<=1);}},isBrowseMode:function(){return this.mode===this.BROWSE_MODE;},isSummaryMode:function(){return this.mode===this.SUMMARY_MODE;},isTrendMode:function(){return this.mode===this.TREND_MODE;},survey:null});SM.SharedViewsRouter=function(options){var that=this; that.initialize=function(options){that.survey=options.survey;}; that.newSharedView=function(options){options=options||{};var sharedView,defaultViewID=this.survey.anviews.defaultView.ID,sharableViewID=_.has(options,'view')?options.view.ID:this.survey.anviews.currentView.ID;sharedView=SM.Models.create("SharedView",{survey:that.survey,attrs:{survey_id:this.survey.ID,default_view_id:defaultViewID,sharable_view_id:sharableViewID}});_renderSharedViewFormView(sharedView);}; that.edit=function(sharedView){_renderSharedViewFormView(sharedView);}; that.show=function(sharedView){window.open(sharedView.sharedPageURL());}; that.destroy=function(sharedView){sharedView.destroy();}; function _renderSharedViewFormView(sharedView){var dialogView,formView;dialogView=SM.Views.create(SM.DialogView,{isModal:true,width:700,easyClose:true,closeBtn:true,templateID:"shared-view-dialog-template"});formView=SM.Views.create(SM.SharedViewFormView,{dialogView:dialogView,sharedView:sharedView});dialogView.$el.find("[shared-view-form-container]").append(formView.$el);dialogView.open();}
that.initialize(options);};SM.Models.register("ExportJobPoller",{EXPONENTIAL_COEFFICIENT:1.5,KILL_SWITCH_CAP:30,interval:6000,iterations:0, isActive:false,__create:function(data){var config=data.config; this.START_INTERVAL=(config.start_interval||6000);this.INTERVAL_CAP=config.interval_cap||60000; this.ITERATION_CAP=config.iteration_cap||15;},loadJobs:function(jobs){this.exportJobs=jobs;},start:function(){var self=this,i=0;this.iterations=0;this.interval=this.START_INTERVAL;if(this.get("isActive")||!this.hasJobsPending()){return;}
this.set("isActive",true,{notify:true});this._poll();},_poll:function(){var self=this;if(this.iterations>this.ITERATION_CAP){if(this.iterations<this.KILL_SWITCH_CAP){ this.interval=this.INTERVAL_CAP*5;}else{ this.stop();return;}}else{if(this.interval>this.INTERVAL_CAP){this.interval=this.INTERVAL_CAP;}}
this.intervalID=setTimeout(function(){self._onePoll();},this.interval);},_onePoll:function(){if(!this.get("isActive")||!this.hasJobsPending()){this.stop();return;}
this.interval*=this.EXPONENTIAL_COEFFICIENT;this.iterations++;this.updateStatuses();this._poll();},hasJobsPending:function(){var jobsList=this.exportJobs.list,len=jobsList.length,i=0,job;for(;i<len;i++){job=jobsList[i];if(job.pending()){return true;}}
return false;},stop:function(){this.set("isActive",false,{notify:true});clearTimeout(this.intervalID);delete this.intervalID;},updateStatuses:function(){var request=SM.Ajax.getExportList();$.when(request,{self:this}).done(this._onFetchedStatuses);},_onFetchedStatuses:function(response,context){var data=response[0],i=0,self=context.self,serverJob,serverJobs=SM.Models.create("ExportJobList");serverJobs.loadJobs(data["exportjob_list"]);$.each(self.exportJobs.list,function(i,currJob){serverJob=serverJobs.map[currJob.ID];if(serverJob){if(serverJob.status!==currJob.status){currJob.downloadLink=serverJob.downloadLink;currJob.set("status",serverJob.status,{notify:true});}}});if(!self.hasJobsPending()){self.stop();}}});SM.Models.register("ExportJobList",{EXPORT:'export',isLoaded:false,__create:function(data){this.list=null;this.map=null;this._cancelledJobs={};this.isUnavailable=false;this.isUserInBillingRetry=false;this.config=data;},isAvailable:function(){return!this.isUnavailable;},isNotAllowedToExport:function(){return this.isUserInBillingRetry;},createJob:function(jobInfo){var job=SM.Models.create("ExportJob",{data:jobInfo});job.exportJobs=this;return job;},addJob:function(job){var sourceView=job.sourceView,edited,request;job.createJobInfo(sourceView);if(sourceView.isCurrent){job.jobInfo.view_name=this.survey.anviews.getSelectedView().name;if(sourceView.get("isDirty")){edited=Globalize.localize("edited");job.jobInfo.view_name+=("("+edited+")");}}
job.loadDate("createDate",new Date().getTime());job.on("status.changed",{self:this,job:job},this._onJobStatusChanged);this.map[job.ID]=job;this.list.unshift(job); request=SM.Ajax.createExport({view_id:sourceView.ID,exportjob:job.dump()});$.when(request,{exportID:job.ID,self:this}).done(this._onExportCreated).fail(function(data){job.set("failedRequestID",data.request_id);if(data.status===601){job.set("status",job.STATUS.TOO_LARGE_ERROR,{notify:true});}else{job.set("status",job.STATUS.SERVER_ERROR,{notify:true});}});this._trigger({type:"jobAdded",job:job});},_onExportCreated:function(response,context){var self=context.self,jobID=response[0].export_job.exportjob_id,localJob=self.map[context.exportID],cancelledJob=self._cancelledJobs[context.exportID];if(localJob){delete self.map[localJob.ID];localJob.set("ID",jobID);self.map[jobID]=localJob;self.poller.start();}else if(cancelledJob){delete self._cancelledJobs[context.exportID];cancelledJob.set("ID",jobID);cancelledJob.deleteJob();}},loadJobs:function(jobs){var self=this;if(!this.get("isLoaded")){this.list=[];this.map={};}
$.each(jobs,function(i,data){var job=SM.Models.create("ExportJob",{data:data});self.map[job.ID]=job;self.list.push(job); job.exportJobs=self;job.on("status.changed",{self:self,job:job},self._onJobStatusChanged);});this.set("isLoaded",true,{notify:true});},hasFullExportPending:function(){var isExporting=false,list=this.list||[];$.each(list,function(i,export_job){if(export_job.type==='full'&&export_job.pending()){isExporting=true;return false;}});return isExporting;},getPendingFullExports:function(){var job=null,list=this.list||[];return $.map(list,function(export_job){if(export_job.type==='full'&&export_job.pending()){return export_job;}});},deleteJob:function(exportJob){var self=this;exportJob.deleteJob();delete self.map[exportJob.ID];exportJob.off("status.changed",self._onJobStatusChanged);self._spliceJob(exportJob.ID);this._trigger({type:"jobDeleted",job:exportJob});},cancelJob:function(exportJob){var self=this;exportJob.set("isCancelled",true,{notify:true});
 self._cancelledJobs[exportJob.ID]=exportJob;delete self.map[exportJob.ID];exportJob.off("status.changed",self._onJobStatusChanged);self._spliceJob(exportJob.ID);this._trigger({type:"jobCancelled",job:exportJob});},_onJobStatusChanged:function(e){var self=e.data.self;self._trigger({type:"jobStatusChanged",job:e.data.job});},fetchJobs:function(){var self=this;if(this.survey.owner.isBasic()){this.loadJobs([]);}else if(!this.get("isLoaded")){$.when(SM.Ajax.getExportList(),{self:this}).done(this._onFetchedJobs).fail(function(data,error,jqHXR){self._onJobFetchFailed(data);});}},_spliceJob:function(exportID){var self=this;$.each(self.list,function(i,currJob){if(exportID===currJob.ID){self.list.splice(i,1);return false;}});},_onFetchedJobs:function(response,context){var self=context.self,data=response[0];self.set("unavailableErrorID",'');self.set("isUnavailable",false,{notify:true});self.set("isUserInBillingRetry",data['is_user_in_billing_retry']);self.loadJobs(data['exportjob_list']);self.poller.start();},_onJobFetchFailed:function(data){if(data.status===503){this.set("unavailableErrorID",data.request_id);this.set("isUnavailable",true,{notify:true});}}});SM.Models.register("ExportJob",{STATUS:{SUCCESS:'succeeded',ENQUEUED:'enqueued',STARTED:'started',SERVER_ERROR:'server_error',FILTER_ERROR:'filter_error',CROSSTAB_ERROR:'crosstab_error',TOO_LARGE_ERROR:'too_large_error'},FORMAT:{CSV:'csv',EXCEL:'excel',EXCEL_PLUS:'excel_plus',GIF:'gif',HTML:'html',JPG:'jpg',PDF:'pdf',PNG:'png',PPTX:'pptx',SPSS:'spss'},TYPE:{SUMMARY_EXPORT:'summary',ALL_EXPORT:'full',CHART_EXPORT:'chart'},sourceView:null,exportExtensionMap:{'csv':'.zip','excel':'.zip','excel_plus':'.zip','gif':'.zip','html':'.zip','jpg':'.zip','pdf':'.pdf','png':'.png','pptx':'.pptx','spss':'.zip'},__create:function(options){this.load(options.data);},__setters:{includeOpenended:function(self,value){self.exportData.include_openended=value;},includeChart:function(self,value){self.exportData.include_chart=value;},pdfOrientation:function(self,value){self.exportData.orientation=value;},pdfPaperSize:function(self,value){self.exportData.dimension=value;},format:function(self,value){if(value===undefined){return;}
self.format=value;self.name=self.generateFileName();self.initExport();},questionDisplay:function(self,value){self.exportData.question_display=value;},columnSetting:function(self,value){self.exportData.column_setting=value;},cellType:function(self,value){self.exportData.cell_type=value;}},__getters:{includeOpenended:function(self){return self.exportData.include_openended;},includeChart:function(self){return self.exportData.include_chart;},pdfOrientation:function(self){return self.exportData.orientation;},pdfPaperSize:function(self){return self.exportData.dimension;},isSingleMode:function(self){return self.exportData.question_id!==undefined;}}, initExport:function(){var typeInitFuncs=this._initByTypeFormat[this.type],typeFormatInitFunc;this.exportData={};if(typeInitFuncs){typeFormatInitFunc=typeInitFuncs[this.format];if(typeFormatInitFunc){typeFormatInitFunc(this);}}
this.exportData['timezone_offset']=SM.Date.stdTimezoneOffset()*60000;},_initByTypeFormat:{summary:{pdf:function(self){self.exportData={orientation:"portrait",include_openended:false,dimension:"letter",headerHeight:"0.8cm",footerHeight:"0.8cm",marginTop:"0.1cm",marginLeft:"1cm",marginRight:"1cm",marginBottom:"0.1cm",zoomFactor:'.9'};self.exportData.footer=SM.Template.render('pdf-footer-template');self.exportData.header=SM.Template.render('pdf-header-template'); if(self.questionID){self.exportData.question_id=self.questionID;self.exportData.questionNumber=self.questionNumber;}},excel:function(self){self.exportData={question_display:"multiple_sheets",include_openended:false,include_chart:true}; if(self.questionID){self.exportData.question_id=self.questionID;self.exportData.questionNumber=self.questionNumber;}},csv:function(self){self.exportData={include_openended:false}; if(self.questionID){self.exportData.question_id=self.questionID;self.exportData.questionNumber=self.questionNumber;}},pptx:function(self){self.exportData={orientation:"portrait",include_openended:false,dimension:"letter",headerHeight:"0.8cm",footerHeight:"0.8cm",marginTop:"0",marginLeft:"1cm",marginRight:"1cm",marginBottom:"0",zoomFactor:'.8'};}},chart:{png:function(self){self.exportData={question_id:self.questionID,questionNumber:self.questionNumber};}},full:{excel:function(self){self.exportData={column_setting:"condensed",cell_type:"actual_choice_text"};},pdf:function(self){self.exportData={orientation:"portrait",include_openended:true,dimension:"letter",headerHeight:"0.8cm",footerHeight:"0.8cm",marginTop:"0.1cm",marginLeft:"1cm",marginRight:"1cm",marginBottom:"0.1cm",zoomFactor:'.8'};self.exportData.footer=SM.Template.render('pdf-footer-template');self.exportData.header=SM.Template.render('pdf-header-template');self.exportData.respondent_id=self.respondentID;}}},load:function(jobData){this.ID=jobData.exportjob_id||"exp-"+this.__uid;this.email=jobData.email||"";this.jobInfo=jobData.job_info||{};this.filterData=jobData.filter_data||null;this.compareData=jobData.crosstab||null;this.format=jobData.format;this.type=jobData.export_type;this.loadDate("createDate",jobData.create_date);this.loadDate("startDate",jobData.start_date);this.loadDate("endDate",jobData.end_date);this.exportPreferences=this.export_pref;this.downloadLink=jobData.download_link;this.status=jobData.job_status||"enqueued";this.size=jobData.size;this.exportData=jobData.export_data;


 if(jobData.export_data){this.questionID=jobData.export_data.question_id;this.respondentID=jobData.export_data.respondent_id;} 
this.questionNumber=jobData.questionNumber; this.respondentNumber=jobData.respondentNumber;this.name=jobData.custom_filename||this.generateFileName();},dump:function(){var questionDisplay=this.exportData.question_display;if(this.type==='summary'&&this.format==="excel"&&questionDisplay!=='multiple_sheets'){ this.set("includeChart",false);}
return{custom_filename:this.name,format:this.format,email:this.email,export_data:this.exportData,export_type:this.type,job_info:this.jobInfo,type:this.type};},generateFileName:function(name){var date=new Date(),type=this.type,format=this.format,ext=this.exportExtensionMap[format],filename,questionNumber,chart,question,data,all,respondent,number;
 if(name){return name+ext;}
if(type==="chart"){chart=Globalize.localize("Chart");question=Globalize.localize("Question")[0];name=chart+"_"+question+this.questionNumber;}else if(type==="summary"&&this.questionNumber!==undefined){data=Globalize.localize("Data");question=Globalize.localize("Question")[0];name=data+"_"+question+this.questionNumber;}else if(type==="full"&&format==='pdf'){if(this.exportData.respondent_id!=='all'){respondent=Globalize.localize("Response");number=this.respondentNumber;}else{respondent=Globalize.localize("Responses");number=Globalize.localize("All");}
name=respondent+"_"+number;}else{data=Globalize.localize("Data");all=Globalize.localize("All");name=data+"_"+all;}
filename=[name+"_",date.getFullYear().toString().substring(2,4),this.doubleDigify(date.getMonth()+1),this.doubleDigify(date.getDate())].join("")+ext;return filename;},loadDate:function(key,datetime){if(datetime){this[key]=new Date(datetime);}else{this[key]=null;}
if(key==="createDate"&&datetime){this.expirationDate=new Date(datetime);this.expirationDate.setDate(this.expirationDate.getDate()+14);}},doubleDigify:function(num){num=num.toString();if(num.length<2){num="0"+num;}
return num;},failed:function(){return this.status===this.STATUS.CROSSTAB_ERROR||this.status===this.STATUS.FILTER_ERROR||this.status===this.STATUS.TOO_LARGE_ERROR||this.status===this.STATUS.SERVER_ERROR;},createJobInfo:function(view){var showSet=SM.Models.create("ShowSet");showSet.loadView(view);this.jobInfo={view_name:view.name,pages:showSet.getPageString(),questions:showSet.getQuestionString()};},getReadableStatus:function(){if(this.failed()){return"failed";}
if(this.done()){return"finished";}
if(this.pending()){return"processing";}},done:function(){return this.status===this.STATUS.SUCCESS;},pending:function(){return this.status===this.STATUS.ENQUEUED||this.status===this.STATUS.STARTED;},deleteJob:function(){SM.Ajax.deleteExport({export_id:this.ID});this._trigger("deleted");},toDateString:function(date){if(!date){return"N/A";}
return Globalize.format(date,"d");},isNew:function(){return SM.String.beginsWith(this.ID,"exp-");}});SM.Models.register("SharedViewList",{url:"/analyze/ajax/shared_views",__defaults:{isLoaded:false},__create:function(options){this.survey=options.survey;this.list=[]; _.bindAll(this,"_onViewsFetched","_onViewsFetchFailed");},add:function(sharedView){var self=this,index;index=_.indexOf(_.pluck(self.list,"key"),sharedView.get("key"));if(index===-1){self.list.push(sharedView);self._trigger({type:"add",sharedView:sharedView});}},remove:function(sharedView){var self=this,index;index=_.indexOf(self.list,sharedView);self.list.splice(index,1);self._trigger({type:"remove",sharedView:sharedView});},load:function(sharedViewsAttrs){var self=this,sharedView,options;_.each(sharedViewsAttrs,function(sharedViewAttrs,index){options={survey:self.survey,list:self,attrs:sharedViewAttrs,index:index};sharedView=SM.Models.create("SharedView",options);self.list.push(sharedView);});self.set("isLoaded",true,{notify:true});},fetch:function(){var data={survey_id:this.survey.ID};$.when(SM.Ajax.get(this.url,data),{self:this}).done(this._onViewsFetched).fail(this._onViewsFetchFailed);},_onViewsFetched:function(doneArgs,context){var data=doneArgs[0],sharedViewsAttrs=data.shared_views;this.load(sharedViewsAttrs);},_onViewsFetchFailed:function(data,error,xhr){}});SM.Models.register("Quota",{__create:function(options){var self=this;self.totalContext=options.quota_data.current_response_count;self.total=options.quota_data.max_response_count;self.label=options.quota_data.display_label;self.filter_group_id=options.quota_data.filter_group_id;self.quota_id=options.quota_data.quota_id;self.quota_equation_id=options.quota_data.quota_equation_id;self.status=options.quota_data.status;if(self.totalContext>self.total){self.totalContext=self.total;}
self.percent=self.totalContext/self.total;}});SM.Models.register("QuotaList",{__create:function(options){var self=this;self.quota_list_data=options.quota_data.model;self.quota_list=[];self.total=0;self.totalContext=0;$.each(self.quota_list_data.equations,function(i,q){self.quota_list.push(SM.Models.create("Quota",{quota_data:q}));self.totalContext+=self.quota_list[i].totalContext;self.total+=self.quota_list[i].total;});if(self.totalContext>self.total){self.totalContext=self.total;}
self.numQuotas=self.quota_list.length;self.percent=self.totalContext/self.total;}});SM.AnalyzeLoaderView=SM.Views.register({__NAME:"analyzeLoaderView",__templateID:"analyze-content-loader-template",__defaults:{defaultTop:200,isFixed:false},__getters:{isFixed:function(self){if(SM.Browser.isIE7){return false;}
return self.__settings.isFixed;}},show:function(){if(this.get("isFixed")){this.$el.css({position:'fixed',top:'50%',marginTop:-(this.$el.outerHeight()/2)});}else{this.$el.css({position:'absolute',top:this.get("defaultTop"),marginTop:0});}
this.$el.removeClass("exit").removeClass("hide");this._isShown=true;},hide:function(){var self=this; if(self._isShown){self._isShown=false;setTimeout(function(){
 if(!self._isShown){self.$el.addClass("exit");self.$el.css("top","-=200");
 setTimeout(function(){if(!self._isShown){self.$el.addClass("hide");}},400);}},400);}}});SM.ResponseLimitUpgradeView=SM.Views.register({__NAME:"responseLimitUpgradeView",__model:"survey",__templateID:"upgrade-response-limit-template",__init:function(){this.bindModel(this.survey,"respondentCounts.changed",{self:this},this._onCountChange);},__beforeRender:function(options){var counts=this.survey.respondentCounts,owner=this.survey.owner;if(this.survey.hasFilteredRespondents()){return{responseCount:Globalize.format(counts.total,"n0"),responseLimit:Globalize.format(owner.responseLimit,"n0"),packageType:owner.packageType,classes:this.__settings.classes,linkSource:this.__settings.linkSource};}
return{classes:this.__settings.classes,linkSource:this.__settings.linkSource};},_onCountChange:function(e){var self=e.data.self;self.render();}});SM.NoResponsesView=SM.Views.register({__NAME:"noResponsesView",__templateID:"no-responses-template",__model:"survey",__beforeRender:function(){var md={surveyIDEncryption:this.survey.encryptedID,classes:this.__settings.classes,shouldShowBuyResponsesButton:Globalize.culture().name==="en",surveyID:this.survey.ID,onSharedPage:SM.App.isSharingApp()};return md;}});SM.AnalyzeContentView=SM.Views.register({__NAME:"analyzeContentView",__model:"survey",__templateID:"analyze-pages-content-container",__init:function(){var state=this.survey.state;if(state.isSummaryMode()){this.bindModel(this.survey.questionRollups,"isLoading.changed",{self:this},this._onIsLoadingChanged);}else if(state.isBrowseMode()){this.bindModel(this.survey,"respondentCounts.changed",{self:this},this._onRespondentCountChanged);this.bindModel(this.survey.respondentsList,"isLoading.changed",{self:this},this._onIsLoadingChanged);}else if(state.isTrendMode()){this.bindModel(this.survey.trendsModel,"isLoading.changed",{self:this},this._onIsLoadingChanged);}},__beforeRender:function(){var hasFilteredRespondents=this.survey.hasFilteredRespondents(),hasRespondents=this.survey.hasRespondents(),hasShownQuestions=this.survey.shownQuestionList.length>0,hasQuestions=this.survey.questionCount>0;return{hasQuestions:hasQuestions,hasShownQuestions:hasShownQuestions,hasRespondents:hasRespondents,hasFilteredResponses:hasFilteredRespondents};},__afterRender:function(md){var content,state=this._getModelState();if(state.failed){content=SM.Template.renderHTML("content-load-error-template",{classes:"mod-no-header",requestID:state.requestID,encryptedSurveyID:this.survey.encryptedID});}else if(!md.hasQuestions){content=SM.Template.renderHTML("no-questions-template",{surveyIDEncryption:this.survey.encryptedID,classes:"mod-no-header"});}else if(!md.hasRespondents){content=SM.Views.create(SM.NoResponsesView,{model:this.survey,classes:"mod-no-header"}).el;}else if(!md.hasFilteredResponses){content=SM.Template.renderHTML("filtered-no-responses-template",{classes:"mod-no-header"});}else if(this.survey.state.isSummaryMode()){content=SM.Views.create(SM.SummaryPageListView,{model:this.survey}).el;}else if(this.survey.state.isBrowseMode()){content=SM.Views.create(SM.RespondentListView,{model:this.survey}).el;}else if(this.survey.state.isTrendMode()){content=SM.Views.create(SM.TrendContainerView,{model:this.survey.trendsModel}).el;}
this.el.appendChild(content);},_getModelState:function(){var survey=this.survey,state=survey.state;if(state.isSummaryMode()){return{requestID:survey.questionRollups.get("failedLoadRequestID"),failed:survey.questionRollups.get("failedLoad")};}else if(state.isBrowseMode()){return{requestID:survey.respondentsList.get("failedLoadRequestID"),failed:survey.respondentsList.get("failedLoad")};}else if(state.isTrendMode()){return{requestID:survey.trendsModel.get("failedLoadRequestID"),failed:survey.trendsModel.get("failedLoad")};}},_onIsLoadingChanged:function(e){var self=e.data.self,isLoading=e.value;if(!isLoading){self.render();self.$el.removeClass("disabled");}else{self.$el.addClass("disabled");}},_onRespondentCountChanged:function(e){var self=e.data.self;
 if(!self.survey.hasRespondents()){self.render();}}});SM.AnalyzeContentWrapperView=SM.Views.register({__NAME:"analyzeContentWrapperView",__model:"survey",__templateID:"analyze-pages-content-wrapper-container",__init:function(){var state=this.survey.state;if(state.isSummaryMode()){this.bindModel(this.survey.questionRollups,"isLoading.changed",{self:this},this._onIsLoadingChanged);this.bindModel(this.survey.questionRollups,"isUpdating.changed",{self:this},this._onIsUpdatingChanged);}else if(state.isBrowseMode()){this.bindModel(this.survey.respondentsList,"isLoading.changed",{self:this},this._onIsLoadingChanged);}else if(state.isTrendMode()){this.bindModel(this.survey.trendsModel,"isLoading.changed",{self:this},this._onIsLoadingChanged);}
this._isLoading=false;this._isUpdating=false;},__destroy:function(){$(window).off("scroll."+this.__uid+"."+this.__NAME);this._loaderView=null;},__afterRender:function(){var contentView,loaderView;this._loaderView=SM.Views.create(SM.AnalyzeLoaderView);contentView=SM.Views.create(SM.AnalyzeContentView,{model:this.survey});this.el.appendChild(this._loaderView.el);this.el.appendChild(contentView.el);},_showSpinner:function(){ this.$el.css({height:this.$el.height(),width:this.$el.width()}); this.$el.find("[analyze-mode-spinner-backdrop]").removeClass("hide").addClass("disabled"); this._loaderView.show(); $(window).on("scroll."+this.__uid+"."+this.__NAME,{self:this},this._onScroll);$(window).scroll();},_hideSpinner:function(e){this.$el.find("[analyze-mode-spinner-backdrop]").addClass("hide").removeClass("disabled");this.$el.css({height:"auto",width:"auto"});$(window).off("scroll."+this.__uid+"."+this.__NAME,this._onScroll);this._loaderView.hide();},_onIsLoadingChanged:function(e){var self=e.data.self,isLoading=e.value;if(isLoading){self._isLoading=true;setTimeout(function(){if(!self._isLoading){return;}
self._showSpinner();},400);}else{self._isLoading=false;setTimeout(function(){self._hideSpinner();},0);}},_onIsUpdatingChanged:function(e){var self=e.data.self,isUpdating=e.value;if(isUpdating){self._isUpdating=true;self._showSpinner();}else{self._isUpdating=false;setTimeout(function(){self._hideSpinner();},0);}}, _onScroll:function(e){var self=e.data.self,parentOffset=self.$el.offset(),scrollTop=$(window).scrollTop(); if(scrollTop<parentOffset.top){self._loaderView.$el.css("top",100);}else{self._loaderView.$el.css("top",100+scrollTop-parentOffset.top);}}});SM.AnRuleListItemView=SM.Views.register({__model:"ruleModel",__templateID:"rule-list-item-view",__NAME:"AnRuleListItemView",__defaults:{rule_id:undefined,isToggleable:true,isDisabled:false,renameMode:false},__init:function(){var self=this;this.$el.on(SM.Event.CLICK,".list-item",{self:this},this._onRuleClick);this.$el.on({'actionMenu.actionSelected':this._onMenuAction,'FunctionListItem.DeleteView.deleteClicked':this._deleteClick,'FunctionListItem.DeleteView.cancelClicked':this.showMenu,'FunctionListItem.RenameView.Canceled':this.showMenu,'FunctionListItem.RenameView.Renamed':function(e){self.ruleModel.set("customHeading",e.newName,{notify:true});self.__settings.isToggleable=true;self.__settings.renameMode=false;self.render();}},{self:this});this.bindModel(this.ruleModel,"ruleEdited",{self:this},this._onRuleChanged);this.bindModel(this.ruleModel,"isCorrupt.changed",{self:this},this._onRuleChanged);if(this.ruleModel.isCompare){
 this.bindModel(this.ruleModel,"selected.changed",{self:this},this._onCompareSelectedChanged);}},__beforeRender:function(){var self=this,md;if(this.ruleModel.get("isCorrupt")){this.__settings.deleteMode=true;}
try{md={name:this.ruleModel.get("heading"),isDisabled:this.__settings.isDisabled,isActive:this.ruleModel.get("selected"),renameMode:this.__settings.renameMode,deleteMode:this.__settings.deleteMode,toggleAnimate:this.__settings.toggleAnimate,isToggleable:this.__settings.isToggleable,isCorrupt:this.ruleModel.get("isCorrupt"),ruleFamily:Globalize.localize(this.ruleModel.ruleFamily)+": ",rule_id:this.ruleModel.ID};}catch(e){self.ruleModel.set("isCorrupt",true);self.__settings.deleteMode=true;md={name:"Corrupted",isDisabled:true,isActive:false,renameMode:false,isCorrupt:true,toggleAnimate:false,isToggleable:false,deleteMode:this.__settings.deleteMode,rule_id:this.ruleModel.ID};self._handleRenderingError(e);}
return md;},__afterRender:function(md){var functionListWidgetView,menuIsShown=!this.__settings.renameMode&&!this.__settings.deleteMode,$listItem=this.$el.children(".list-item");if(menuIsShown){this.$el.find('a.btn-menu-down').actionMenu({templateID:"rule-menu-template",isActive:md.isActive,isDisabled:this.__settings.isDisabled,includeMenuCopy:!this.ruleModel.isShow,disableMenuCopy:this.ruleModel.survey.owner.hasRuleLimit()});}else{if(this.__settings.renameMode){functionListWidgetView=SM.Views.create(SM.FunctionListItemRenameView,{placeholder:md.name});functionListWidgetView.open();}else if(this.__settings.deleteMode){functionListWidgetView=SM.Views.create(SM.FunctionListItemDeleteView,{visible:true,hasCancel:!this.ruleModel.get("isCorrupt")});}
$listItem.prepend(functionListWidgetView.el);}
if(this.__settings.toggleAnimate){this.$el.toggleClass("active",md.isActive);}},_handleRenderingError:function(exception){var self=this;SM.Error.log(exception,"RuleRenderingException: Rule#"+self.ruleModel.ID+", Survey#"+SM.App.survey.ID);},showMenu:function(e){var self=e.data.self;self.__settings.renameMode=false;self.__settings.deleteMode=false;self.__settings.isToggleable=true;self.__settings.toggleAnimate=false;self.render();},_onRuleChanged:function(e){e.data.self.render();},_disable:function(e){var self=e.data.self;self.__settings.isToggleable=false;self.__settings.isDisabled=true;self.__settings.toggleAnimate=false;self.render();},_enable:function(e){var self=e.data.self;self.__settings.isToggleable=true;self.__settings.isDisabled=false;self.__settings.toggleAnimate=false;self.render();},_deleteClick:function(e){var self=e.data.self;e.data.self.ruleModel.deleteRule();self.$el.remove();},_onCompareSelectedChanged:function(e){var self=e.data.self;self.__settings.toggleAnimate=true;self.render();},_onMenuAction:function(e){var self=e.data.self;self[e.action]();},_menuCopyClick:function(){this.ruleModel.copyRule();},_menuEditClick:function(){this.trigger("editClicked");},_menuDeleteClick:function(){this.__settings.isToggleable=false;this.__settings.deleteMode=true;this.__settings.toggleAnimate=false;this.render();},_menuRenameClick:function(){this.__settings.renameMode=true;this.__settings.isToggleable=false;this.__settings.toggleAnimate=false;this.render();},_menuToggleRule:function(){this._toggleRule();},_onRuleClick:function(e){var self=e.data.self;e.preventDefault();if(self.ruleModel.get("isCorrupt")){return;}
if(!self.__settings.isDisabled&&self.__settings.isToggleable){self._toggleRule();}},_toggleRule:function(){this.__settings.toggleAnimate=true;this.ruleModel.toggleRule();}});SM.AnRuleView=SM.Views.register({__model:"ruleModel",__templateID:"an-rule-template",__NAME:"AnRuleView",__init:function(){var self=this,selfDestruct=function(){self.$el.remove();};this.$el.on({"RuleView.destroy":function(){self.ruleModel.set("editMode",false);selfDestruct();},"RuleView.applied":function(){if(!self.ruleModel.isNew){setTimeout(selfDestruct,self.COLLAPSE_DELAY);}else{selfDestruct();}},"RuleButtons.cancelClicked":function(){self.ruleModel.set("editMode",false);if(!self.ruleModel.isNew){setTimeout(selfDestruct,self.COLLAPSE_DELAY);}else{selfDestruct();}}});}, COLLAPSE_DELAY:300,modelEditViewMap:{FilterRespondentDataAnRule:"RespDataRuleEditView",FilterCollectorAnRule:"CollectorRuleEditView",FilterCompletenessAnRule:"CompletenessRuleEditView",FilterTimePeriodAnRule:"TimePeriodRuleEditView",FilterRandomAssignmentRule:"RARuleEditView",CompareRandomAssignmentRule:"RARuleEditView",QnaMatrixAnRule:"QNAMatrixRuleEditView",QnaRatingCommentPerRowAnRule:"QNAMatrixRuleEditView",QnaMenuMatrixAnRule:"QNAMenuMatrixRuleEditView",QnaSimpleAnRule:"QNASimpleRuleEditView",QnaOpenEndedAnRule:"QNA_OEndedRuleEditView",QnaDatetimeAnRule:"QNA_DatetimeRuleEditView",QnaNumericalAnRule:"QNA_NumericalRuleView",ShowAnRule:"ShowRuleEditView"},__afterRender:function(){var editViewClass=this.modelEditViewMap[this.ruleModel.__NAME];var editView=SM.Views.create(SM[editViewClass],{model:this.ruleModel});this.el.appendChild(editView.el);}});SM.BaseRuleEditView={__model:"ruleModel",__templateID:"rule-edit-view",__init:function(){this.$el.on("submit",{self:this},this._onFormSubmit).on("RuleButtons.applyClicked",{self:this},this._applyClk);this.bindModel(this.ruleModel,"isDirty.set",{self:this},this._onRuleDirtySet);if(this.ruleModel.isNew){this.buttons.applyDisable();}},__setters:{applyEnabled:function(self,value){if(value){self.buttons.applyEnable();}else{self.buttons.applyDisable();}}},_buildChoiceGroup:function(options){var self=this;return $.map(options,function(option){return SM.Views.create(SM.SimpleRuleChoiceView,{model:self.ruleModel,text:option.text,id:option.id}).el;});},__afterRender:function(){ this.buttons=SM.Views.create(SM.RuleButtonsView,{model:this.ruleModel});this._renderChoices();this._afterRenderChoices();this.$el.append(this.buttons.el);},_afterRenderChoices:function(){},_renderChoices:function(){},_onRuleDirtySet:function(e){var self=e.data.self,applyEnabled=SM.Object.getOneKey(self.ruleModel.get("rows"))!==undefined;self.set("applyEnabled",applyEnabled);},_onFormSubmit:function(e){e.data.self._applyClk(e);},_applyClk:function(e){var self=e.data.self,ruleModel=self.ruleModel,valid=self.ruleModel.commit();e.preventDefault();if(!valid){self.render();return;}
if(!ruleModel.get("selected")||ruleModel.get("isDirty")){ruleModel.set("selected",true);ruleModel.applyRule();self.dirty=false;}
self.$el.trigger("RuleView.applied",self);}};SM.RuleButtonsView=SM.Views.register({__NAME:"RuleButtonsView",__templateID:"rule-buttons-template",__model:"ruleModel",__init:function(){this.$el.on(SM.Event.CLICK,".btn.cancel",{self:this},this._cancelClk);if(!this._hasUpgradeButton()){this.$el.on(SM.Event.CLICK,".btn.apply-button",{self:this},this._applyClk);}else{this.$el.on(SM.Event.CLICK,".btn.apply-button",{self:this},function(e){e.preventDefault();var dialog=SM.Views.create(SM.DialogView,{width:800,isModal:true,templateID:'rules-upgrade-dialog-template'});dialog.open();});}},__defaults:{applyDisabled:false},__beforeRender:function(){return{applyDisabled:this.__settings.applyDisabled};},applyDisable:function(){if(this._hasUpgradeButton()){return;}
this.__settings.applyDisabled=true;this.render();},applyEnable:function(){if(this._hasUpgradeButton()){return;}
this.__settings.applyDisabled=false;this.render();},_hasUpgradeButton:function(){var user=this.ruleModel.survey.owner;return(user.isOverRuleLimit()&&this.ruleModel.isNew);},_cancelClk:function(e){e.preventDefault();e.data.self.$el.trigger("RuleButtons.cancelClicked");},_applyClk:function(e){var self=e.data.self;e.preventDefault();if(!self.__settings.applyDisabled){self.$el.trigger("RuleButtons.applyClicked");}}});SM.QNARuleEditView=SM.Object.extend(SM.BaseRuleEditView,{__templateID:"qna-rule-edit-view",_afterRenderChoices:function(){var question=this.ruleModel.getQuestion(),commentFieldChoiceView;
if(!this.ruleModel.isCompare){if(question.commentField){commentFieldChoiceView=SM.Views.create(SM.QNA_CommentFieldChoiceView,{model:this.ruleModel.choiceSet});this.$el.append(commentFieldChoiceView.el);}}},_onRuleDirtySet:function(e){var self=e.data.self,applyEnabled=SM.Object.getOneKey(self.ruleModel.choiceSet.get("rows"))!==undefined;self.set("applyEnabled",applyEnabled);},_buildChoiceGroup:function(options){var self=this;return _.map(options,function(option){return SM.Views.create(SM.QNA_SimpleRuleChoiceView,{model:self.ruleModel.choiceSet,text:option.text,id:option.id}).el;});},__beforeRender:function(){var q=this.ruleModel.getQuestion();return{position:q.position,heading:q.heading};}});SM.QNASimpleRuleEditView=SM.Views.extend(SM.QNARuleEditView,{__NAME:"QNASimpleRuleView",_renderChoices:function(){var ruleModel=this.ruleModel,question=ruleModel.getQuestion(),choices;choices=this._buildChoiceGroup(question.rowList);this.$el.find("[rule-choices]").append(choices);},_onRuleDirtySet:function(e){var self=e.data.self,applyEnabled=SM.Object.getOneKey(self.ruleModel.choiceSet.get("rows"))!==undefined;applyEnabled=applyEnabled||self.ruleModel.choiceSet.get("commentFieldSelected");self.set("applyEnabled",applyEnabled);}});SM.QNAMatrixRuleEditView=SM.Views.extend(SM.QNARuleEditView,{__NAME:"QNAMatrixRuleView",__init:function(){SM.QNARuleEditView.__init.call(this);this.$el.on(SM.Event.CLICK,"[add-new-row-btn]",{self:this},this._onAddNewMatrixSelection);},_renderChoices:function(){var choiceSetList=this.ruleModel.choiceSetList,self=this,addNewRowBtn,emptyChoiceSetList=choiceSetList.length===0;if(emptyChoiceSetList){this.ruleModel.addChoiceSet();}
_.each(choiceSetList,function(choiceSetModel){if(choiceSetModel.cols){
 self._appendMatrixSelectionView(choiceSetModel);}});addNewRowBtn=SM.Template.renderHTML("add-matrix-selection-template");if(this.ruleModel.isNew||this.ruleModel.isCompare||emptyChoiceSetList){$(addNewRowBtn).hide();} 
self.$el.append(addNewRowBtn);},_afterRenderChoices:function(){var question=this.ruleModel.getQuestion(),commentFieldChoiceView;
if(!this.ruleModel.isCompare){if(question.commentField&&!question.commentField.apply_all_rows){commentFieldChoiceView=SM.Views.create(SM.QNA_CommentFieldChoiceView,{model:this.ruleModel.commentChoiceSet});this.$el.append(commentFieldChoiceView.el);}}},_appendMatrixSelectionView:function(choiceSetModel){var choicesContainer=this.$el.find("[rule-choices]").get(0),choiceView=SM.Views.create(SM.QNA_MatrixRuleChoiceSetView,{model:choiceSetModel});choicesContainer.appendChild(choiceView.el);},_hasAllSectionsComplete:function(choiceSetName){var allComplete=true,choiceSetList=this.ruleModel.choiceSetList;_.each(choiceSetList,function(choiceSet){if(SM.Object.getOneKey(choiceSet[choiceSetName])===undefined){allComplete=false;return false;}});return allComplete;},_hasOneSectionComplete:function(choiceSetName){var oneSectionComplete=false,choiceSetList=this.ruleModel.choiceSetList;_.each(choiceSetList,function(choiceSet){if(choiceSetName!=='comment'){if(SM.Object.getOneKey(choiceSet[choiceSetName])!==undefined){oneSectionComplete=true;}}else{oneSectionComplete=choiceSet.commentFieldSelected;}
if(oneSectionComplete){return false;}});return oneSectionComplete;},_onRuleDirtySet:function(e){var self=e.data.self,question=self.ruleModel.getQuestion(),rowsComplete=self._hasAllSectionsComplete("rows"),colsComplete=self._hasOneSectionComplete("cols"),commentFieldComplete,$addRowBtn=self.$el.find("[add-new-row-btn]");if(question.commentField&&question.commentField.apply_all_rows){commentFieldComplete=self._hasOneSectionComplete("comment");}else{commentFieldComplete=self.ruleModel.commentChoiceSet.get("commentFieldSelected");}
if(rowsComplete&&!self.ruleModel.isCompare){$addRowBtn.show();}else{$addRowBtn.hide();}
if(colsComplete||commentFieldComplete){self.buttons.applyEnable();}else{self.buttons.applyDisable();}},_onAddNewMatrixSelection:function(e){var self=e.data.self,choiceSetModel=self.ruleModel.addChoiceSet();e.preventDefault();self.$el.find("[add-new-row-btn]").hide();self._appendMatrixSelectionView(choiceSetModel);}});SM.QNAMenuMatrixRuleEditView=SM.Views.extend(SM.QNAMatrixRuleEditView,{__NAME:"QNAMenuMatrixRuleView",_appendMatrixSelectionView:function(choiceSetModel){var choicesContainer=this.$el.find("[rule-choices]").get(0),choiceView=SM.Views.create(SM.QNA_MenuMatrixRuleChoiceSetView,{model:choiceSetModel});choicesContainer.appendChild(choiceView.el);},_onRuleDirtySet:function(e){var self=e.data.self,rowsComplete=self._hasAllSectionsComplete("rows"),colsComplete=self._hasAllSectionsComplete("cols"),commentFieldSelected=self.ruleModel.commentChoiceSet.get("commentFieldSelected"),colChoicesComplete=self._hasOneSectionComplete("colChoices"),$addRowBtn=self.$el.find("[add-new-row-btn]");if(rowsComplete&&colsComplete&&!self.ruleModel.isCompare){$addRowBtn.show();}else{$addRowBtn.hide();}
if(colChoicesComplete||commentFieldSelected){self.buttons.applyEnable();}else{self.buttons.applyDisable();}}});SM.QNA_OEndedRuleEditView=SM.Views.extend(SM.QNARuleEditView,{__NAME:"QNA_OEndedRuleView",_onRuleDirtySet:function(e){var self=e.data.self;self._validateApplyBtn();},_validateApplyBtn:function(){var invalids=this.ruleModel.lastValidation.invalids,applyEnabled=!invalids.searchTerm&&!invalids.selectedRowID;this.set("applyEnabled",applyEnabled);},_renderChoices:function(){var choiceView=SM.QNA_SingleOpenEndedRuleChoiceView;if(this.ruleModel.getQuestion().isMultiResponse()){choiceView=SM.QNA_MultiOpenEndedRuleChoiceView;}
this.openEndedChoice=SM.Views.create(choiceView,{model:this.ruleModel.choiceSet});this.$el.find("[rule-choices]").get(0).appendChild(this.openEndedChoice.el);this._validateApplyBtn();}});SM.QNA_DatetimeRuleEditView=SM.Views.extend(SM.QNARuleEditView,{__NAME:"QNA_DatetimeRuleEditView",_renderChoices:function(){this.dateChoice=SM.Views.create(SM.QNA_DateTimeRuleChoiceView,{model:this.ruleModel.choiceSet});this.$el.find("[rule-choices]").get(0).appendChild(this.dateChoice.el);},_onRuleDirtySet:function(e){var self=e.data.self,invalids=self.ruleModel.lastValidation.invalids;if(invalids.selectedRowID||invalids.selectedTime||invalids.selectedDate){self.buttons.applyDisable();}else{self.buttons.applyEnable();}}});SM.QNA_NumericalRuleView=SM.Views.extend(SM.QNA_OEndedRuleEditView,{__NAME:"QNA_NumericalRuleView",_renderChoices:function(){this.numericalChoice=SM.Views.create(SM.QNA_NumericalRuleChoiceView,{model:this.ruleModel.choiceSet});this.$el.find("[rule-choices]").get(0).appendChild(this.numericalChoice.el);}});SM.RespDataRuleEditView=SM.Views.extend(SM.BaseRuleEditView,{__NAME:"RespDataRuleView",__create:function(){this.survey=this.ruleModel.survey;},__beforeRender:function(){return{heading:Globalize.localize('respondent metadata')};},_renderChoices:function(){var $choices=this.$el.find("[rule-choices]"),textAttrs;this.timeChoice=SM.Views.create(SM.TimeTotalRuleChoiceView,{model:this.ruleModel});$choices.append(this.timeChoice.el);textAttrs=this._renderTxtAttrs();$choices.append(textAttrs);},_renderTxtAttrs:function(){var ruleModel=this.ruleModel;return $.map(ruleModel.respondentAttributes,function(textInput){return SM.Views.create(SM.TextRuleChoiceView,{textLabel:Globalize.localize(textInput.textLabel),model:ruleModel,id:textInput.id,popout_id:textInput.popout_id}).el;});},_onRuleDirtySet:function(e){var self=e.data.self,ruleModel=self.ruleModel,ruleIsPopulated=false,timeTotalChoice=ruleModel.get("timeTotal"),input;if(timeTotalChoice.value!==""){ruleIsPopulated=true;}
if(!ruleIsPopulated){$.each(ruleModel.respondentAttributes,function(i,attribute){input=ruleModel.get(attribute.id);if(input!==""&&input!==undefined){ruleIsPopulated=true;return false;}});}
if(ruleIsPopulated){self.buttons.applyEnable();}else{self.buttons.applyDisable();}}});SM.ShowRuleEditView=SM.Views.extend(SM.BaseRuleEditView,{__NAME:"ShowRuleView",__templateID:"show-rule-edit-view",__defaults:{selectAllChecked:false,applyEnabled:false},__init:function(){var self=this;this.$el.on("submit",{self:this},this._onFormSubmit);this.$el.on("RuleButtons.applyClicked",{self:this},this._applyClk); this.expandStates={}; this.bindModel(this.ruleModel,"isDirty.set",{self:this},function(e){self.render();});this.$el.on(SM.Event.CLICK,".rule-select-all",{self:this},this._onSelectAllClicked).on("pageExpandToggled",function(e,expandState){self.expandStates[expandState.ID]=expandState.val;}).on("RuleButtons.cancelClicked",function(e){ self.ruleModel.showSet=SM.Models.create("ShowSet");self.ruleModel.showSet.loadView(self.ruleModel.survey.anviews.currentView);});},__beforeRender:function(md){return{hasSelectAll:true,applyEnabled:this.__settings.applyEnabled,selectAllChecked:this.ruleModel.showSet.allSelected(),showRuleModel:this.ruleModel};},_renderChoices:function(){var self=this,pageList=this.ruleModel.survey.pageList,showSet=this.ruleModel.showSet,$choices=this.$el.find("[rule-choices]"),expandStates=this.expandStates||{},views;views=$.map(pageList,function(page,i){return SM.Views.create(SM.ShowPageRuleChoiceView,{model:self.ruleModel,pageID:page.ID,isFirstChoice:i===0,isLastChoice:i===pageList.length-1,expanded:expandStates[page.ID]||false}).el;});$choices.append(views);if(showSet.isEmpty()){this.buttons.applyDisable();}else{this.$el.find(".rule-select-all").prop('indeterminate',showSet.questionCheckedCount()<this.ruleModel.survey.questionCount);this.buttons.applyEnable();}},_onSelectAllClicked:function(e){var self=e.data.self,isChecked=self.ruleModel.showSet.toggleAll();self.__settings.selectAllChecked=isChecked;self.__settings.applyEnabled=isChecked;self.ruleModel.set("isDirty",true,{notify:true});}});SM.TimePeriodRuleEditView=SM.Views.extend(SM.BaseRuleEditView,{__NAME:"TimePeriodRuleView",__init:function(){SM.BaseRuleEditView.__init.call(this);this.bindModel(this.ruleModel,"isDirty.set",{self:this},this._onRuleDirtySet);},__beforeRender:function(){return{heading:Globalize.localize('time period')};},_renderChoices:function(){var timeRangeChoice=SM.Views.create(SM.TimeRangeRuleChoiceView,{model:this.ruleModel});this.$el.find("[rule-choices]").append(timeRangeChoice.el);},_onRuleDirtySet:function(e){var self=e.data.self;if(self.ruleModel.get("startDate")&&self.ruleModel.get("endDate")){self.buttons.applyEnable();}else{self.buttons.applyDisable();}}});SM.CompletenessRuleEditView=SM.Views.extend(SM.BaseRuleEditView,{__NAME:"CompletenessRuleView",__beforeRender:function(){return{heading:Globalize.localize('completeness')};},_options:[{text:"Complete responses",id:"completely"},{text:"Partial responses",id:"partially"},{text:"Disqualified responses",id:"disqualified"},{text:"Responses over quota",id:"overquota"}],_renderChoices:function(){var options=$.map(this._options,function(option){return{text:Globalize.localize(option.text),id:option.id};});this.$el.find("[rule-choices]").append(this._buildChoiceGroup(options));}});SM.CollectorRuleEditView=SM.Views.extend(SM.BaseRuleEditView,{__NAME:"CollectorRuleView",__beforeRender:function(){return{heading:Globalize.localize('collector')};},_renderChoices:function(){var options;options=$.map(this.ruleModel.survey.collectorList,function(collector){return{text:collector.title,id:collector.id};});this.$el.find("[rule-choices]").append(this._buildChoiceGroup(options));}});SM.RARuleEditView=SM.Views.extend(SM.BaseRuleEditView,{__NAME:"RARuleEditView",_renderChoices:function(){var options;options=$.map(this.ruleModel.getRandomAssignmentList(),function(randomAssignment){return{text:randomAssignment.heading||randomAssignment.variable_name,id:randomAssignment.variable_id};});this.$el.find("[rule-choices]").append(this._buildChoiceGroup(options));},__beforeRender:function(){var question=this.ruleModel.getQuestion();return{position:question.position,heading:question.heading};}});SM.SimpleRuleChoiceView=SM.Views.register({__NAME:"SimpleRuleChoiceView",__model:"ruleModel",__templateID:"rule-choice-simple",__init:function(){this.$el.on(SM.Event.CLICK,"[rule-choice-checkbox]",{self:this},this._checkboxChanged);}, __beforeRender:function(){var id=this.__settings.id;return{text:this.__settings.text,isVisible:this.__settings.visible,id:id,choiceViewID:this.__NAME+"_"+this.__uid,isChecked:this.ruleModel.rows[id]};},_toggleRow:function(rows,id){if(rows[id]){delete rows[id];}else{rows[id]=true;}
this.render();this.$el.find("input:first").focus();}, _checkboxChanged:function(e){var self=e.data.self,id=self.__settings.id,rows=self.ruleModel.get("rows");self._toggleRow(rows,id);self.ruleModel.set("isDirty",true,{notify:true});}});SM.QNA_SimpleRuleChoiceView=SM.Views.extend(SM.SimpleRuleChoiceView,{__NAME:"QNA_SimpleRuleChoiceView",__model:"choiceSet",__beforeRender:function(){var id=this.__settings.id;return{text:this.__settings.text,isVisible:this.__settings.visible,id:id,choiceViewID:this.__NAME+"_"+this.__uid,isChecked:this.choiceSet.rows[id]};},_checkboxChanged:function(e){var self=e.data.self,id=self.__settings.id,rows=self.choiceSet.get("rows");self._toggleRow(rows,id);self.choiceSet.ruleModel.set("isDirty",true,{notify:true});}});SM.QNA_SingleOpenEndedRuleChoiceView=SM.Views.register({__NAME:"QNA_SingleOpenEndedRuleChoiceView",__templateID:"rule-choice-qna-text",__model:'choiceSet',__create:function(options){this.question=this.choiceSet.ruleModel.getQuestion();},__init:function(options){this.$el.on(SM.Event.KEYUP,"input[type='text']",{self:this},this._onTextEntered);this.$el.on(SM.Event.CHANGE,".search-type",{self:this},this._onSearchTypeChanged);},__beforeRender:function(){var md,searchType,validation,choiceSetInvalids;searchType=this.choiceSet.get("searchType");validation=this.choiceSet.ruleModel.lastValidation;choiceSetInvalids=validation.invalids.choiceSet?validation.invalids.choiceSet.invalids:undefined;if(!choiceSetInvalids){ choiceSetInvalids=validation.invalids.commentChoiceSet?validation.invalids.commentChoiceSet.invalids:undefined;}
md={searchType:{},searchTerm:this.choiceSet.get("searchTerm"),rowSelected:true, invalidInput:choiceSetInvalids};md.searchType[searchType]="selected";return md;},_onTextEntered:function(e){var self=e.data.self,text=$(e.currentTarget).val();self.choiceSet.set("searchTerm",text);self.choiceSet.ruleModel.set("isDirty",true,{notify:true});},_onSearchTypeChanged:function(e){var searchType=$(this).val(),self=e.data.self;self.choiceSet.set("searchType",searchType);self.choiceSet.ruleModel.set("isDirty",true,{notify:true});}});SM.QNA_MultiOpenEndedRuleChoiceView=SM.Views.extend(SM.QNA_SingleOpenEndedRuleChoiceView,{__NAME:"QNA_MultiOpenEndedRuleChoiceView",_operationToTemplateMap:{">":"opGreaterThan","<":"opLessThan","=":"opEquals"},__init:function(){SM.QNA_SingleOpenEndedRuleChoiceView.__init.call(this);this.$el.on(SM.Event.CHANGE,"[row-select]",{self:this},this._onAnswerRowChanged);},__beforeRender:function(){var rowID=this.choiceSet.get("selectedRowID"),validation=this.choiceSet.ruleModel.lastValidation,choiceSetInvalids=validation.invalids.choiceSet?validation.invalids.choiceSet.invalids:undefined,md={searchType:{},isMulti:true,rowSelected:this.choiceSet.get("selectedRowID")!=="-1",rows:$.extend(true,[],this.question.structure.answers.rows),invalidInput:choiceSetInvalids,searchTerm:this.choiceSet.get("searchTerm")},searchType=this.choiceSet.get("searchType")||'all';md.searchType[searchType]="selected";if(rowID!=="-1"){$.each(md.rows,function(i,answerRow){if(rowID===answerRow.id){answerRow.selected=true;return false;}});}
return md;},_onAnswerRowChanged:function(e){var self=e.data.self,rowID=$(this).val();self.choiceSet.set("selectedRowID",rowID);self.choiceSet.ruleModel.set("isDirty",true,{notify:true});self.render();}});SM.QNA_DateTimeRuleChoiceView=SM.Views.extend(SM.QNA_MultiOpenEndedRuleChoiceView,{__NAME:"QNA_DateTimeRuleChoiceView",__templateID:"datetime-qna-choice",_formats:{"date_intl":"d/M/yyyy","date_us":"M/d/yyyy"},_onAnswerRowChanged:function(e){var self=e.data.self,rowID=$(this).val();self.choiceSet.set("selectedRowID",rowID);self.choiceSet.ruleModel.set("isDirty",true,{notify:true});self.render();},__init:function(){this.$el.on(SM.Event.CHANGE,"[row-select]",{self:this},this._onAnswerRowChanged);this.$el.on("datepicker.dateSelected",".datepicker",{self:this},this._onDateSelected).on("timepicker.change",".timepicker",{self:this},this._onTimeSelected).on("change","[op-select]",{self:this},this._onOperatorChanged);},__beforeRender:function(){var questionModel=this.question,md=SM.QNA_MultiOpenEndedRuleChoiceView.__beforeRender.call(this),opSelection=this._operationToTemplateMap[this.choiceSet.get('op')];md.hasDatePicker=questionModel.subtype==="date_only"||questionModel.subtype==="both";md.hasTimePicker=questionModel.subtype==="time_only"||questionModel.subtype==="both";md.isMilitaryTime=Globalize.usesMilitaryTime();md[opSelection]=true;return md;},__afterRender:function(md){var time=this.choiceSet.get("selectedTime"),validation=this.question.structure.validation,dateMoment=this.choiceSet.get("selectedDate"),date=new Date(dateMoment.year(),dateMoment.month(),dateMoment.date(),dateMoment.hour(),dateMoment.minute()),dateFormat;if(!time||(time.hours===-1||time.minutes===-1)){time=undefined;}else{time=new Date(0,0,0,time.hours,time.minutes);}
if(validation&&validation.type){dateFormat=this._formats[validation.type]||'d';}else{dateFormat='d';}
if(this.question.subtype==="date_only"||this.question.subtype==="both"){this.$el.find(".datepicker").datepicker({selectedDate:date,selectMenus:true,dateFormat:dateFormat,minDate:new Date(1900,0,1),maxDate:new Date(2050,11,31)});}
if(this.question.subtype==="time_only"||this.question.subtype==="both"){this.$el.find(".timepicker").timepicker({time:time,minuteIncrement:1,militaryTime:Globalize.usesMilitaryTime()});}},_onOperatorChanged:function(e){e.data.self.choiceSet.set("op",$(this).val());},_onTimeSelected:function(e){var self=e.data.self,time=self.$el.find(".timepicker").data('timepicker').get('time');self.choiceSet.set("selectedTime",time);self.choiceSet.ruleModel.set("isDirty",true,{notify:true});},_onDateSelected:function(e){var self=e.data.self,rowID=self.choiceSet.get("selectedRowID"),selectedDate=self.$el.find(".datepicker").data('datepicker').get('selectedDate');self.choiceSet.set("selectedDate",moment.utc(selectedDate));self.choiceSet.ruleModel.set("isDirty",true,{notify:true});}});SM.QNA_NumericalRuleChoiceView=SM.Views.extend(SM.QNA_MultiOpenEndedRuleChoiceView,{__NAME:"QNA_NumericalRuleChoiceView",__templateID:"qna-rule-numeric-choice",__init:function(){this.$el.on(SM.Event.PASTE,"input[type='text']",{self:this},this._onTextEntered).on(SM.Event.KEYUP,"input[type='text']",{self:this},this._onTextEntered).on(SM.Event.CHANGE,"[row-select]",{self:this},this._onAnswerRowChanged).on(SM.Event.CHANGE,"[op-select]",{self:this},this._onOperatorChanged);},__beforeRender:function(){var md=SM.QNA_MultiOpenEndedRuleChoiceView.__beforeRender.call(this),opSelection=this._operationToTemplateMap[this.choiceSet.get('op')];md[opSelection]=true;return md;},_onOperatorChanged:function(e){var self=e.data.self,operator=$(this).val();self.choiceSet.set("op",operator);self.choiceSet.ruleModel.set("isDirty",true,{notify:true});self.render();}});SM.QNA_CommentFieldChoiceView=SM.Views.register({__NAME:"QNA_CommentFieldChoiceView",__model:"choiceSet",__templateID:"rule-qna-choice-wrapper",__init:function(){this.$el.on(SM.Event.CHANGE,"input[type='checkbox']",{self:this},this._checkboxChanged);},_checkboxChanged:function(e){var self=e.data.self,includeComment=self.choiceSet.get("commentFieldSelected");includeComment=!includeComment;self.choiceSet.set("commentFieldSelected",includeComment);self.choiceSet.ruleModel.set("isDirty",true,{notify:true});self.render();if(includeComment){self.$el.find("input[match-input]").focus();}},__afterRender:function(){var includeComment=this.choiceSet.get("commentFieldSelected"),choiceViewElem,questionModel=this.choiceSet.ruleModel.getQuestion();if(includeComment&&!this.choiceSet.ruleModel.isCompare){choiceViewElem=SM.Views.create(SM.QNA_ExpandedCommentFieldChoiceView,{model:this.choiceSet}).el;}else{choiceViewElem=SM.Template.renderHTML("rule-choice-simple",{isChecked:this.choiceSet.get("commentFieldSelected"),text:questionModel.commentField.text,choiceViewID:this.__NAME+"_"+this.__uid});}
this.$el.append(choiceViewElem);}});SM.QNA_ExpandedCommentFieldChoiceView=SM.Views.extend(SM.QNA_SingleOpenEndedRuleChoiceView,{__NAME:"QNA_ExpandedCommentFieldChoiceView",__beforeRender:function(options){var md=SM.QNA_SingleOpenEndedRuleChoiceView.__beforeRender.call(this,options),questionModel=this.choiceSet.ruleModel.getQuestion();md.isCommentField=true;md.commentFieldHeading=questionModel.commentField.text;return md;}});SM.QNA_MatrixSimpleRuleChoiceView=SM.Views.extend(SM.SimpleRuleChoiceView,{__NAME:"QNA_MatrixSimpleRuleChoiceView",__model:"choiceSetModel",__beforeRender:function(){var id=this.__settings.id,choiceSetName=this.__settings.choiceSetName;return{text:this.__settings.text,isVisible:this.__settings.visible,id:id,isChecked:this.choiceSetModel.get(choiceSetName)[id],choiceViewID:this.__NAME+"_"+this.__uid};},_checkboxChanged:function(e){var self=e.data.self,choiceSetName=self.__settings.choiceSetName,id=self.__settings.id, answerSet=self.choiceSetModel[choiceSetName];if(answerSet[id]){delete answerSet[id];}else{answerSet[id]=true;}
self.render();self.$el.find("input").focus();self.choiceSetModel.ruleModel.set("isDirty",true,{notify:true});}});SM.QNA_MatrixSelectRuleChoiceView=SM.Views.register({__model:"choiceSetModel",__NAME:"matrixSelectRuleChoiceView",__templateID:"rule-choice-matrix-select",__defaults:{prompt:"Choose a row..."},__create:function(){this.__settings.prompt=Globalize.localize(this.__settings.prompt);},__beforeRender:function(){var questionModel=this.choiceSetModel.ruleModel.getQuestion(),choiceSetName=this.__settings.choiceSetName,answerList=$.extend(true,[],questionModel.structure.answers[choiceSetName]),checkedID=SM.Object.getOnlyKey(this.choiceSetModel[choiceSetName]);if(checkedID){_.each(answerList,function(answer){if(answer.id===checkedID){answer.selected="selected";return false;}});}
return{choiceSetName:choiceSetName,answerList:answerList,placeholderPrompt:this.__settings.prompt,isDisabled:this.__settings.isDisabled};}});SM.QNA_MatrixRuleChoiceSetView=SM.Views.register({__NAME:"QNA_MatrixRuleChoiceSetView",__model:"choiceSetModel",__templateID:"rule-qna-choice-wrapper",__init:function(){this.$el.on(SM.Event.CHANGE,"[answer-set='rows']",{self:this},this._onRowChanged);},__afterRender:function(){var rows=this.choiceSetModel.rows,rowIsSelected=SM.Object.getOnlyKey(rows)!==undefined,questionModel=this.choiceSetModel.ruleModel.getQuestion(),choiceList=questionModel.structure.answers["cols"];this._addSelectList("rows",false);if(rowIsSelected){this._buildChoiceList(choiceList,"cols");}},_onRowChanged:function(e){var self=e.data.self,value=$(this).val(),choiceSet=self.choiceSetModel;choiceSet.rows={};choiceSet.cols={};if(value!=="-1"){choiceSet.rows[value]=true;}
self.render();self.$el.find("input[type='checkbox']:first").focus();choiceSet.ruleModel.set("isDirty",true,{notify:true});},_addSelectList:function(choiceSetName,isDisabled){var selectView=SM.Views.create(SM.QNA_MatrixSelectRuleChoiceView,{model:this.choiceSetModel,choiceSetName:choiceSetName,isDisabled:isDisabled});this.$el.append(selectView.el);},_buildChoiceList:function(choiceList,choiceSetName){var self=this,questionModel=this.choiceSetModel.ruleModel.getQuestion(),choices,commentFieldView;choices=_.map(choiceList,function(answer){return SM.Views.create(SM.QNA_MatrixSimpleRuleChoiceView,{model:self.choiceSetModel,text:answer.text,id:answer.id,choiceSetName:choiceSetName}).el;});

this.$el.append(choices);}});SM.QNA_MenuMatrixRuleChoiceSetView=SM.Views.extend(SM.QNA_MatrixRuleChoiceSetView,{__NAME:"QNA_MenuMatrixRuleChoiceView",__templateID:"rule-qna-choice-wrapper",__init:function(){SM.QNA_MatrixRuleChoiceSetView.__init.call(this);this.$el.on(SM.Event.CHANGE,"[answer-set='cols']",{self:this},this._onColChanged);},__afterRender:function(){var sectionIndex=this.__settings.sectionIndex,choiceSetModel=this.choiceSetModel,rows=choiceSetModel.rows,cols=choiceSetModel.cols,rowIsSelected=SM.Object.getOnlyKey(rows)!==undefined,colIsSelected=SM.Object.getOnlyKey(cols)!==undefined,questionModel=choiceSetModel.ruleModel.getQuestion(),answerList,colId,colObj;if(_.isEmpty(cols)){answerList=questionModel.structure.answers["cols"][0].items;}else{_.each(cols,function(value,col){colId=col;});colObj=_.find(questionModel.structure.answers["cols"],function(col){return col.id===colId;});answerList=colObj.items;}
this._addSelectList("rows");this._addSelectList("cols",!rowIsSelected);if(rowIsSelected&&colIsSelected){this._buildChoiceList(answerList,"colChoices");}},_onColChanged:function(e){var self=e.data.self,choiceSet=self.choiceSetModel,value=$(this).val();choiceSet.cols={};choiceSet.colChoices={};if(value!=="-1"){choiceSet.cols[value]=true;}
self.render();self.$el.find("input[type='checkbox']:first").focus();choiceSet.ruleModel.set("isDirty",true,{notify:true});},_onRowChanged:function(e){var self=e.data.self,value=$(this).val(),choiceSet=self.choiceSetModel;choiceSet.rows={};choiceSet.cols={};choiceSet.colChoices={};if(value!=="-1"){choiceSet.rows[value]=true;}
self.render();self.$el.find("select[answer-set='cols']").focus();choiceSet.ruleModel.set("isDirty",true,{notify:true});}});SM.TimeTotalRuleChoiceView=SM.Views.register({__NAME:"TimeTotalRuleChoiceView",__templateID:"rule-choice-time-total",__model:"ruleModel",__init:function(){this.$el.on(SM.Event.CHANGE,".time-unit",{self:this,setter:"unit"},this._onTotalTimeAttributeChanged);this.$el.on(SM.Event.KEYUP,".time-value",{self:this,setter:"value"},this._onTotalTimeAttributeChanged);this.$el.on(SM.Event.CHANGE,".op-select",{self:this,setter:"op"},this._onTotalTimeAttributeChanged);},__beforeRender:function(){var timeData=this.ruleModel.get("timeTotal"),validation=this.ruleModel.lastValidation,isValid=!validation.invalids.timeTotal,md={selected:{},timetext:timeData.value,isValid:isValid};md.selected[timeData.unit]=true;if(timeData.op===">"){md.selected.greaterthan=true;}else if(timeData.op==="<"){md.selected.lessthan=true;}
return md;},_onTotalTimeAttributeChanged:function(e){var self=e.data.self,timeTotalObject=self.ruleModel.get("timeTotal");timeTotalObject[e.data.setter]=$(this).val();self.ruleModel.set("isDirty",true,{notify:true});}});SM.TextRuleChoiceView=SM.Views.register({__NAME:"TextRuleChoiceView",__model:"ruleModel",__templateID:"rule-choice-text",__init:function(){this.$el.on(SM.Event.KEYUP,"input[type='text']",{self:this},this._onTextEntered).on(SM.Event.PASTE,"input[type='text']",{self:this},this._onTextEntered);},__beforeRender:function(){var md=this.__settings,id=this.__settings.id,validation=this.ruleModel.lastValidation;this.popout_id=this.__settings.popout_id;md.isVisible=this.ruleModel.attributeIsVisible(id);md.textEntered=this.ruleModel.get(id);md.isValid=true;if(validation.invalids[id]){md.validationErrorMsg=validation.invalids[id].message;md.isValid=false;}
return md;},_onTextEntered:function(e){var self=e.data.self,textEntered=$(e.currentTarget).val(),id=self.__settings.id;self.ruleModel.set(id,textEntered);self.ruleModel.set("isDirty",true,{notify:true});},__afterRender:function(){this.$textBox=this.$el.find(".fv-textbox");this.$textLabel=this.$el.find(".fv-textlabel");this.$errorMsg=this.$el.find(".fv-error");if(!!this.popout_id){this.$el.append(SM.Views.create(SM.RuleBuilderPopouts,{templateID:this.popout_id}).el);}}});SM.ShowPageRuleChoiceView=SM.Views.register({__NAME:"ShowRuleChoiceView",__model:"ruleModel",__templateID:"rule-choice-show",__defaults:{expanded:false,isFirstChoice:false,isLastChoice:false},__init:function(){var self=this,pageModel=this.ruleModel.survey.getPage(this.__settings.pageID);this.$el.on(SM.Event.CLICK,".choice-expander",function(e){self.__settings.expanded=!self.__settings.expanded;self.$el.trigger("pageExpandToggled",{ID:pageModel.ID,val:self.__settings.expanded});self.render();}).on(SM.Event.CHANGE,"input[rule-choice-checkbox][page-checkbox]",function(e){self.ruleModel.showSet.togglePage(pageModel);self.ruleModel.set("isDirty",true,{notify:true});});},__beforeRender:function(){var pageModel=this.ruleModel.survey.getPage(this.__settings.pageID),heading=""+pageModel.position,showSet=this.ruleModel.showSet;if(pageModel.heading.length>0){heading+=": "+pageModel.heading;}
return{text:heading,id:pageModel.ID,isExpandable:true,isFirstChoice:this.__settings.isFirstChoice,isLastChoice:this.__settings.isLastChoice,hasQuestions:pageModel.questionList.length>0,expanded:this.__settings.expanded,isChecked:showSet.hasPage(pageModel),choiceViewID:this.__NAME+"_"+this.__uid};},__afterRender:function(){var pageModel=this.ruleModel.survey.getPage(this.__settings.pageID),self=this,questionList=pageModel.questionList,shownQuestions=this.ruleModel.showSet.pageQuestionsCheckedCount(pageModel),$questionChoices=this.$el.find(".question-choices"),choices;if(this.__settings.expanded){choices=$.map(questionList,function(questionModel,i){return SM.Views.create(SM.ShowQuestionRuleChoiceView,{questionID:questionModel.ID,model:self.ruleModel,isFirstChoice:i===0,isLastChoice:i===questionList.length-1}).el;});$questionChoices.append(choices);}else{$questionChoices.html("");}
if(shownQuestions>0){if(shownQuestions<questionList.length){this.$el.find("input[rule-choice-checkbox][page-checkbox]").prop('indeterminate',true);}}}});SM.ShowQuestionRuleChoiceView=SM.Views.register({__NAME:"ShowQuestionRuleChoiceView",__model:"ruleModel",__templateID:"rule-choice-simple",__defaults:{isFirstChoice:false,isLastChoice:false},__init:function(){var self=this,questionModel=this.ruleModel.survey.getQuestion(this.__settings.questionID);this.$el.on(SM.Event.CHANGE,"input[rule-choice-checkbox]",function(e){self.ruleModel.showSet.toggleQuestion(questionModel);self.ruleModel.set("isDirty",true,{notify:true});});},__beforeRender:function(){var questionModel=this.ruleModel.survey.getQuestion(this.__settings.questionID),heading=Globalize.localize("Question")[0]+questionModel.position;if(questionModel.heading.length>0){heading+=": "+questionModel.heading;}
return{text:heading,id:questionModel.ID,isIndented:true,isLastChoice:this.__settings.isLastChoice,isFirstChioce:this.__settings.isFirstChoice,isHighlighted:this.__settings.isHighlighted,isVisible:true,isChecked:this.ruleModel.showSet.hasQuestion(questionModel),choiceViewID:this.__NAME+"_"+this.__uid};}});SM.TimeRangeRuleChoiceView=SM.Views.register({__NAME:"TimeRangeRuleChoiceView",__templateID:"rule-choice-date",__model:"ruleModel",__init:function(){this.$el.on("datepicker.afterClose",{self:this},this._onDateChanged);},__afterRender:function(){var startDate=this.ruleModel.get("startDate"),endDate=this.ruleModel.get("endDate");this.$el.dateRangePicker({startMinDate:new Date(1999,0,1),endMaxDate:new Date(2016,11,31),selectMenus:true});this.daterange=this.$el.data("dateRangePicker");if(startDate){ this.daterange.set("startSelectedDate",new Date(startDate));this.daterange.set("endSelectedDate",new Date(endDate));}},_onDateChanged:function(e){var self=e.data.self,dateRangePicker=self.$el.data("dateRangePicker"),start=dateRangePicker.get("startSelectedDate"),end=dateRangePicker.get("endSelectedDate");if(start!==null){self.ruleModel.set("startDate",start.getTime());}
if(end!==null){self.ruleModel.set("endDate",end.getTime());}
self.ruleModel.set("isDirty",true,{notify:true});}});SM.QNARulePickerView=SM.Views.register({__model:"survey",__NAME:"QNARulePickerView",__templateID:"QNARulePickerView",_compareBuilderType:"CompareBuilderView",_filterBuilderType:"FilterBuilderView",__init:function(){var self=this;this.$el.on("autocomplete.selected","[qna-search-text]",{self:this},this._searchResultSelected).on("change","select",{self:this},this._onSelectChange).on("click",".btn-filter-cancel",{self:this},this._onCancelClick);this._autocomplete=this.$el.find("[qna-search-text]").autocomplete({search:function(term){var survey=this.get("survey"),results=survey.searchQuestions(term),question,disabled,isCompare=this.get("isCompare");results=$.map(results,function(questionID,index){question=survey.questions[questionID];disabled=(isCompare&&!question.hasComparableOptions())||question.isPresentation();return{value:question.ID,text:'Q'+question.position+": "+question.heading,isDisabled:disabled};});this.set("results",results);},isCompare:this.__settings.builder_type===this._compareBuilderType,minLength:this.survey.SEARCH_NGRAM_SIZE,survey:this.survey,classes:['searchresults-menu','long']});},__destroy:function(){if(this._autocomplete){if(this._autocomplete.menu){this._autocomplete.menu.$el.remove();this._autocomplete.menu=undefined;}
this._autocomplete=undefined;}},__beforeRender:function(){var questions=this.survey.questionList,i=0,len,option,q,isCompare=this.__settings.builder_type===this._compareBuilderType,md={questions:[],isCompare:isCompare};len=questions.length;for(;i<len;i++){q=questions[i];option={text:q.position+": "+q.heading,id:q.ID};md.questions.push(option);if((isCompare&&!q.hasComparableOptions())||q.isPresentation()){md.questions[i].isDisabled=true;}}
return md;},reset:function(){this.$el.find("[qna-search-text]").val('');this.$el.find("select").val('-1');},_onCancelClick:function(e){var self=e.data.self;e.preventDefault();self.reset();self.$el.trigger("QNARulePickerView.cancelClicked");},_onSelectChange:function(e){var self=e.data.self;if(parseInt(this.value,10)>0){self.$el.trigger("QNARulePickerView.questionSelected",{questionID:this.value});self.reset();}},_searchResultSelected:function(e){var self=e.data.self;self.$el.trigger("QNARulePickerView.questionSelected",{questionID:e.value});self.reset();}});SM.RandomAssignmentRulePickerView=SM.Views.register({__model:"survey",__NAME:"RandomAssignmentRulePickerView",__templateID:"RandomAssignmentRulePickerView",_compareBuilderType:"CompareBuilderView",_filterBuilderType:"FilterBuilderView",__init:function(){var self=this;this.$el.on("change","select",{self:this},this._onSelectChange).on("click",".btn-filter-cancel",{self:this},this._onCancelClick);},__destroy:function(){},_mapTypeToText:function(family,subtype){var mapper={datetime:{date_only:"Question Test",time_only:"Question Test",both:"Question Test"},demographic:{us:"Question Test",international:"Question Test"},single_choice:{vertical:"Question Test"},multiple_choice:{vertical:"Question Test"},open_ended:{essay:"Question Test",single:"Question Test",multi:"Question Test",numerical:"Question Test"},matrix:{rating:"Question Test",single:"Question Test",multi:"Question Test"},presentation:{image:"Image Test",descriptive_text:"Text Test"}};return mapper[family][subtype];},__parseParams:function(value){var qID=parseInt(value.split("_")[1]);return qID;},__makeParams:function(qID){return"qid_"+qID;},__beforeRender:function(){var questions=this.survey.questionList,i=0,len,option,q,isCompare=this.__settings.builder_type===this._compareBuilderType,md={randomAssignments:[],hasRandomAssignment:false,isCompare:isCompare};len=questions.length;for(;i<len;i++){q=questions[i];if(!!q.randomAssignmentList){md.hasRandomAssignment=true;if(q.family=='datetime'||q.family=='open_ended'||q.family=='demographic'){isDisabled=true;}else{isDisabled=false;}
option={text:"Q"+q.position+": ("+this._mapTypeToText(q.family,q.subtype)+") "+q.heading,questionID:q.ID,params:this.__makeParams(q.ID),isDisabled:isDisabled};md.randomAssignments.push(option);}}
return md;},reset:function(){this.$el.find("select").val('-1');},_onCancelClick:function(e){var self=e.data.self;e.preventDefault();self.reset();self.$el.trigger("RandomAssignmentRulePickerView.cancelClicked");},_onSelectChange:function(e){var self=e.data.self,questionID=self.__parseParams(this.value);if(questionID>0){self.$el.trigger("RandomAssignmentRulePickerView.variationSelected",{questionID:questionID});self.reset();}}});SM.BaseBuilderView={__model:"survey",__init:function(){var self=this;this.bindModel(this.survey.anviews,"selectedViewChanged",{self:this},this.close);this.bindModel(this.survey.anviews.currentView,"ruleAdded",{self:this},this.close);this.bindModel(this.survey.anviews.currentView,"ruleEdited",{self:this},this.close);this.$el.on("waterpark.afterShift",{self:this},this._onAfterShift).on(SM.Event.CLICK,".back-shifter",{self:this},this._onBackShifterClick).on('RuleButtons.cancelClicked',{self:this},this.close).on('RuleView.applied',{self:this},this.close).on('QNARulePickerView.cancelClicked',{self:this},this.close).on('QNARulePickerView.questionSelected',{self:this},this._onQuestionSelected).on('RandomAssignmentRulePickerView.variationSelected',{self:this},this._onRandomAssignmentSelected);this.wpark=this.$el.waterpark().data("waterpark");},__beforeRender:function(){return{id:this.__NAME};},__afterRender:function(){this.questionPicker=SM.Views.create(SM.QNARulePickerView,{model:this.survey,builder_type:this.__NAME});this.$el.find("section.lane.qna.select").append(this.questionPicker.el);this.raPicker=SM.Views.create(SM.RandomAssignmentRulePickerView,{model:this.survey,builder_type:this.__NAME});this.$el.find("section.lane.random_assignment.select").append(this.raPicker.el);},_createQNARuleModel:function(questionID,isCompare){var ruleAttrs={question_id:questionID,rule_type:'qna',selected:false},ruleModel;if(isCompare){ruleAttrs.is_compare_rule=true;}
ruleModel=SM.BaseAnRule.FactoryCreate({ID:null,attrs:ruleAttrs},this.survey);ruleModel.loadSurvey(this.survey);return ruleModel;},_createABRuleModel:function(questionID,isCompare){var ruleAttrs={question_id:questionID,rule_type:'random_assignment',selected:false},ruleModel;if(isCompare){ruleAttrs.is_compare_rule=true;}
ruleModel=SM.BaseAnRule.FactoryCreate({ID:null,attrs:ruleAttrs},this.survey);ruleModel.loadSurvey(this.survey);return ruleModel;},_appendRule:function(ruleModel){var slideSelector="section."+ruleModel.get("ruleType");var ruleView=SM.Views.create(SM.AnRuleView,{model:ruleModel,editMode:true});if(ruleModel.isQNA||ruleModel.isRA){slideSelector+=":last";}
var a=this.$el.find(slideSelector);this.$el.find(slideSelector).append(ruleView.el);},_onBackShifterClick:function(e){var self=e.data.self;self.$el.find(".an-rule").trigger("RuleView.destroy");},_onAfterShift:function(e){var self=e.data.self,waterpark=e.waterpark,location=waterpark.get("location");self.$el.find(".slide").eq(location.slide).find("."+location.lane).eq(0).find("input, select, button, textarea").eq(0).focus();},onTabClose:function(){this.$el.find(".an-rule").trigger("RuleView.destroy");this.wpark.set("location",{slide:0});},close:function(e){var self=e.data.self,location=self.wpark.get("location");if(location.slide!==0){self._close();}},_close:function(){this.wpark.set("location",{slide:0});}};SM.FilterBuilderView=SM.Views.extend(SM.BaseBuilderView,{__NAME:"FilterBuilderView",__templateID:"filterBuildersTemplate",__init:function(){var self=this;SM.BaseBuilderView.__init.call(this);this.$el.on("waterpark.shift",{self:this},function(e){var location=self.wpark.get("location"),ruleType=location.lane,ruleModel,ruleView;


if(location.slide===1&&ruleType&&ruleType!=="qna"&&ruleType!=="random_assignment"){ruleModel=SM.BaseAnRule.FactoryCreate({ID:null,attrs:{rule_type:ruleType,selected:true}},self.survey);ruleModel.loadSurvey(self.survey);self._appendRule(ruleModel);}});},_onQuestionSelected:function(e,data){var self=e.data.self,ruleModel=self._createQNARuleModel(data.questionID,false);self._appendRule(ruleModel);self.wpark.set("location",{slide:2,lane:"qna"});},_onRandomAssignmentSelected:function(e,data){var self=e.data.self,ruleModel=self._createABRuleModel(data.questionID,false);self._appendRule(ruleModel);self.wpark.set("location",{slide:2,lane:"random_assignment"});}});SM.CompareBuilderView=SM.Views.extend(SM.BaseBuilderView,{__NAME:"CompareBuilderView",__templateID:"compareBuildersTemplate",__init:function(){var self=this;SM.BaseBuilderView.__init.call(this);this.$el.on("waterpark.shift",{self:this},function(e){var location=self.wpark.get("location"),ruleType=location.lane,ruleModel,ruleView;if(location.slide===1&&ruleType&&ruleType!=="qna"&&ruleType!=="random_assignment"){ruleModel=SM.BaseAnRule.FactoryCreate({ID:null,attrs:{rule_type:ruleType,selected:true}},self.survey);ruleModel.loadSurvey(self.survey);self._appendRule(ruleModel);}});},_onQuestionSelected:function(e,data){var self=e.data.self,ruleModel=self._createQNARuleModel(data.questionID,true);self._appendRule(ruleModel);self.wpark.set("location",{slide:2,lane:"qna"});},_onRandomAssignmentSelected:function(e,data){var self=e.data.self,ruleModel=self._createABRuleModel(data.questionID,true);self._appendRule(ruleModel);self.wpark.set("location",{slide:2,lane:"random_assignment"});}});SM.ShowBuilderView=SM.Views.register({__NAME:"ShowBuilderView",__templateID:"ShowBuilderTemplate",__model:"survey",onTabClose:function(){this.$el.find(".an-rule").trigger("RuleView.destroy");},open:function(){var ruleModel=SM.Models.create("ShowAnRule",{ID:null,attrs:{selected:false}}),ruleView;ruleModel.loadSurvey(this.survey);ruleView=SM.Views.create(SM.AnRuleView,{model:ruleModel,editMode:true});this.el.appendChild(ruleView.el);this.$el.find("input").first().focus();}});SM.RuleBuilderPopouts=SM.Views.register({__NAME:"RuleBuilderPopouts",__templateID:"rule-popout",__afterRender:function(){this.$el.popout();}});SM.RuleListContainerView=SM.Views.register({__model:"currentView",__NAME:"RulesContainerView",__templateID:"RulesContainerTemplate",__afterRender:function(){this.$ruleListSlide=this.$el.find("[rules_slide]");this.$editSlide=this.$el.find("[edit_slide]");this.ruleListView=SM.Views.create(SM.RuleListView,{model:this.currentView});this.$ruleListSlide.append(this.ruleListView.$el);this.resetSlider();return this;},__init:function(){var self=this;this.bindModel(this.currentView.anviews,"selectedViewLoaded",{self:this},this._onRulesChanged);this.slider=this.$el.waterpark().data("waterpark");this.$el.on('RuleButtons.cancelClicked',"[edit_slide]",function(){self.resetSlider();}).on('RuleView.applied',"[edit_slide]",function(){self.resetSlider();}).on('AnRuleListItemView.editClicked',"[rules_slide]",{self:this},this._onRuleEditClicked).on("waterpark.afterShift",{self:this},this._onAfterShift);},__destroy:function(){delete this.slider;},hide:function(){this.$el.hide();return this;},_onRulesChanged:function(e){var self=e.data.self;self.render();},FADE_SPEED:250,resetSlider:function(){if(this.slider){this.slider.calculateAttributes();this.slider.set("location",{slide:0});}
this.$el.show();},_onRuleEditClicked:function(e){var ruleListItem=e.AnRuleListItemView,ruleModel=ruleListItem.ruleModel,self=e.data.self;ruleModel.set("editMode",true);self.$editSlide.append(SM.Views.create(SM.AnRuleView,{AnRuleListItemView:ruleListItem,model:ruleModel}).$el);self.slider.set("location",{slide:1});},_onAfterShift:function(e){var self=e.data.self,waterpark=e.waterpark,location=waterpark.get("location");self.$el.find(".slide").eq(location.slide).find("input, select, button, textarea").eq(0).focus();}});SM.RuleListView=SM.Views.register({__model:"currentView",__templateID:"RuleListTemplate",__NAME:"RuleListView",__init:function(){var self=this;this.bindModel(this.currentView,"ruleDeleted",{self:this},this._onRuleDeleted);this.bindModel(this.currentView,"ruleAdded",{self:this},this._onRuleAdded);this.bindModel(this.currentView,"failedLoadRequestID.set",{self:this},this._onCurrentViewFailedToLoad);},__beforeRender:function(){var owner=this.currentView.anviews.survey.owner;return{hasNoRules:this.currentView.ruleList.length===0,hasUpgradeTrigger:owner.isOverRuleLimit()};},__afterRender:function(){var user=this.currentView.anviews.survey.owner,hasRuleLimit=user.hasRuleLimit(),ruleList=this.currentView.ruleList,len=ruleList.length,self=this,owner=this.currentView.anviews.survey.owner,$listContainer=this.$el.find("ul"),$messageContainer=this.$el.find("[rule-list-messages]"),isDisabled,failedLoadRequestID=this.currentView.get("failedLoadRequestID"),ruleView;if(failedLoadRequestID!==null){$messageContainer.html(SM.Template.render("view-switch-failed",{requestID:failedLoadRequestID,classes:"mod-no-header"}));return;}
if(owner.isOverRuleLimit()){$messageContainer.html(SM.Template.render("rule-limit-upgrade-message-template"));}
_.each(ruleList,function(ruleModel,i){if(!hasRuleLimit||i>=len-user.ruleLimit){isDisabled=false;}else{isDisabled=true;}
ruleView=SM.Views.create(SM.AnRuleListItemView,{isDisabled:isDisabled,model:ruleModel});$listContainer.prepend(ruleView.$el);self.$el.find(".q").popout()});}, _onCurrentViewFailedToLoad:function(e){e.data.self.render();},_onRuleAdded:function(e){e.data.self.render();},_onRuleDeleted:function(e){var self=e.data.self;if(self.currentView.ruleList.length===0){self.render();}}});SM.RuleBuilderContainerView=SM.Views.register({__templateID:"RuleBuilderContainerTemplate",__defaults:{},__model:"survey",__NAME:"RuleBuilderContainerView",_lastPanel:null,_lastTab:null,__beforeRender:function(){return{showTabTitle:this._getShowTabTitle(),compareTabTitle:this._getCompareTabTitle(),shouldDisableShowTab:this._shouldDisableShowTab(),shouldDisableCompareTab:this._shouldDisableCompareTab()};},_getShowTabTitle:function(){if(this._shouldDisableShowTab()){return Globalize.localize("You can apply only one SHOW rule");}else{return Globalize.localize("Show only certain questions");}},_getCompareTabTitle:function(){if(this._shouldDisableCompareTab()){if(this.survey.state.isBrowseMode()){return Globalize.localize("Compare is not allowed for Individual Responses");}else if(this.survey.state.isTrendMode()){return Globalize.localize("Compare is not allowed in Data Trends");}else{return Globalize.localize("Compare is not allowed");}}else{return Globalize.localize("Crosstabulate your data");}},_shouldDisableShowTab:function(){return this.survey.anviews.currentView.hasShowRule();},_shouldDisableCompareTab:function(){return this.survey.state.isTrendMode();},__afterRender:function(){this._cacheElements();this._initWidgets();},_initWidgets:function(){this.$el.find(".q").popout();},__init:function(){var currentView=this.survey.anviews.currentView;this.bindModel(this.survey.anviews,"selectedViewChanged",{self:this},this._disable);this.bindModel(this.survey.anviews,"selectedViewLoaded",{self:this},this._enable);this.bindModel(currentView,"failedLoadRequestID.set",{self:this},this._onCurrentViewFailedToLoad);this.bindModel(currentView,"savedToNewView",{self:this},this._disable);this.bindModel(currentView,"ruleAdded",{self:this},this._onRuleAdded);this.bindModel(currentView,"ruleDeleted",{self:this},this._onRuleDelete);this.$el.on(SM.Event.CLICK,"a.tab",{self:this},this._onTabClick);this.$el.on(SM.Event.CLICK,"#rule_limit_upgrade_message .learn-more",function(e){e.preventDefault();var dialog=SM.Views.create(SM.DialogView,{width:800,isModal:true,templateID:'rules-upgrade-dialog-template'});dialog.open();});this.$el.on({'RuleView.ruleClosed':this._closeTabs,'RuleView.applied':this._closeTabs,'RuleButtons.cancelClicked':this._closeTabs,'QNARulePickerView.cancelClicked':this._closeTabs},{self:this});this.$el.on(SM.Event.CLICK,".waterpark .cancel.btn",{self:this},this._closeTabs);},__destroy:function(){delete this.tabs;},_cacheElements:function(){var panels=this.$el.find(".panels").get(0);this.showBuilder=SM.Views.create(SM.ShowBuilderView,{model:this.survey});this.compareBuilder=SM.Views.create(SM.CompareBuilderView,{model:this.survey});this.filterBuilder=SM.Views.create(SM.FilterBuilderView,{model:this.survey});panels.appendChild(this.filterBuilder.el);panels.appendChild(this.compareBuilder.el);panels.appendChild(this.showBuilder.el);this.showTab=this.$el.find("#ShowBuilderTab");this.currRules=SM.Views.create(SM.RuleListContainerView,{model:this.survey.anviews.currentView});this.el.appendChild(this.currRules.el);return this;},_onTabClick:function(e){var self=e.data.self,lastPanel=self._lastPanel,$tab=$(this),panel=$tab.attr("target");e.preventDefault();if($tab.hasClass("disabled")){return;}
if(!!lastPanel){self.closeTabs();}
if(lastPanel!==panel){self._lastPanel=panel;self._lastTab=$tab.attr("id");self._beforeTabOpen();$(panel).addClass("open");
 $tab.data("title",$tab.attr("title"));$tab.addClass("active").removeAttr("title");}},_beforeTabOpen:function(){this.$el.find(".an-rule").trigger("RuleView.destroy");this.currRules.hide();if(this._lastPanel==="#ShowBuilderView"){this.showBuilder.open();}
}, _closeTabs:function(e){var self=e.data.self,$lastTab,lastPanel=self._lastPanel;if(lastPanel){$(lastPanel).removeClass("open");$lastTab=$("#"+self._lastTab);$lastTab.removeClass("active");if(!$lastTab.attr("title")){$lastTab.attr("title",$lastTab.data("title"));}
self._lastTab=null;self._lastPanel=null;self._afterTabClose(lastPanel);}},closeTabs:function(){this._closeTabs({data:{self:this}});},_afterTabClose:function(lastPanel){if(lastPanel==="#ShowBuilderView"){this.showBuilder.onTabClose();}else if(lastPanel==="#FilterBuilderView"){this.filterBuilder.onTabClose();}else if(lastPanel==="#CompareBuilderView"){this.compareBuilder.onTabClose();}
this.currRules.resetSlider();},_disable:function(e){var self=e.data.self;self.closeTabs();self.$el.find(".rules-loading-icon").fadeIn(100);self.$el.find(".rules-ui-blocker").fadeIn(100);self.$el.find(".tab").addClass("disabled");},_enable:function(e){var self=e.data.self;self.$el.find(".rules-loading-icon").hide();self.$el.find(".rules-ui-blocker").hide();self.$el.find(".tab").removeClass("disabled");self._renderShowTab();self._renderCompareTab();self._initWidgets();},_onCurrentViewFailedToLoad:function(e){var self=e.data.self;self.$el.find(".rules-loading-icon").hide();self.$el.find(".rules-ui-blocker").hide();},_renderShowTab:function(){var $tab=$("#ShowBuilderTab");if(this._shouldDisableShowTab()){$tab.addClass("disabled");}else{$tab.removeClass("disabled");}},_renderCompareTab:function(){var $tab=$("#CompareBuilderTab");if(this._shouldDisableCompareTab()){$tab.addClass("disabled");}else{$tab.removeClass("disabled");}},_onRuleAdded:function(e){var self=e.data.self,ruleView=SM.Views.create(SM.AnRuleListItemView,{model:e.ruleModel});if(e.ruleModel.isShow){$("#ShowBuilderTab").addClass("disabled").attr("title",Globalize.localize("You can apply only one SHOW rule"));}},_onRuleDelete:function(e){var self=e.data.self;if(e.ruleModel.isShow){$("#ShowBuilderTab").removeClass("disabled").attr("title",Globalize.localize("Create a show rule"));}}});SM.AnalyzeSecondaryView=SM.Views.register({__NAME:"AnalyzeSecondaryView",__model:"survey",__templateID:"analyze-secondary-column",__init:function(){var self=this;this.$el.accordion({multiOpen:true,overflowAuto:false});this.$el.on({"accordion.beforeOpen":function(e){if(e.id==="ExportListContainer"){self.exportsHeadingView.set("isOpen",true);self.exportsHeadingView.render();}
if(e.id==="SharedViewsListContainer"){self.sharedViewsHeadingView.set("isOpen",true);self.sharedViewsHeadingView.render();}},"accordion.afterClose":function(e){if(e.id==="ExportListContainer"){self.exportsHeadingView.set("isOpen",false);self.exportsHeadingView.render();}
if(e.id==="SharedViewsListContainer"){self.sharedViewsHeadingView.set("isOpen",false);self.sharedViewsHeadingView.render();}}});},__beforeRender:function(){return{exportsEnabled:this._shouldShowExportsKey(),sharingEnabled:this._shouldShowSharedViewsKey()};},__afterRender:function(){this._renderRulesKey();this._renderSavedViewsKey();if(this._shouldShowExportsKey()){this._renderExportsKey();}
if(this._shouldShowSharedViewsKey()){this._renderSharedViewsKey();}
this.$el.find(".q").popout();},_renderRulesKey:function(){var ruleList;ruleList=SM.Views.create(SM.RuleBuilderContainerView,{model:this.survey});this.$el.find("#RuleBuilderViewContainer").append(ruleList.$el);},_renderSavedViewsKey:function(){var headingView,savedViewList;savedViewList=SM.Views.create(SM.AnViewListView,{model:this.survey.anviews,isOpen:true});headingView=SM.Views.create(SM.SavedViewsHeadingView,{model:this.survey.anviews});this.$el.find("[saved-views-key] .keyOpener").append(headingView.$el);this.$el.find('#view-list-area').append(savedViewList.$el);},_renderExportsKey:function(){var listView;listView=SM.Views.create(SM.ExportJobListView,{model:this.survey.exportJobs});this.exportsHeadingView=SM.Views.create(SM.ExportHeadingView,{model:this.survey.exportJobs,isLoading:this.survey.exportJobs.poller.get("isActive"),hideCount:!this.survey.exportJobs.get("isLoaded")});this.$el.find("[exports-key] .keyOpener").append(this.exportsHeadingView.$el);this.$el.find('#export-job-list-area').append(listView.$el);},_renderSharedViewsKey:function(){var listView;listView=SM.Views.create(SM.SharedViewListView,{survey:this.survey,sharedViews:this.survey.sharedViews});this.sharedViewsHeadingView=SM.Views.create(SM.SharedViewsKeyHeadingView,{sharedViews:this.survey.sharedViews});this.$el.find("[shared-views-key] .keyOpener").append(this.sharedViewsHeadingView.$el);this.$el.find('[shared-view-list]').append(listView.$el);}, _shouldShowExportsKey:function(){return this.survey.isExportEnabled();},_shouldShowSharedViewsKey:function(){return SM.App.isSharingEnabled();}});SM.ExportNullStateView=SM.Views.register({__NAME:"ExportNullStateView",__model:"survey",__templateID:"export-null-state-template",__afterRender:function(){var $menuElem=this.$el.find("p[export-menu]"),exportMenuView=SM.Views.create(SM.ExportAllBtnView,{model:this.survey});$menuElem.append(exportMenuView.el);}});SM.AnalyzeCTAView=SM.Views.register({__NAME:"AnalyzeCTAView",__model:"survey",__templateID:"analyze-cta",__beforeRender:function(){return{encryptedSurveyID:this.survey.encryptedID};},__afterRender:function(){ this.$el.find("[export-btn]").append(SM.Views.create(SM.ExportAllBtnView,{model:this.survey,noBorder:true}).el);}});SM.PageArrowBtnsView=SM.Views.register({__NAME:"pageArrowBtnsView",__model:"survey",__templateID:"page-arrow-btns-template",__init:function(){this.survey.state.on("page.changed",{self:this},this._onPageChange);this.$el.on(SM.Event.CLICK,"[sm-prev-btn]",{self:this},this._onPrevPageClick).on(SM.Event.CLICK,"[sm-next-btn]",{self:this},this._onNextPageClick);},__destroy:function(){this.survey.state.off("page.changed",this._onPageChange);},__beforeRender:function(){var page=this.survey.state.get('page'),lastPage=this.survey.getLastShownPage(),firstPage=this.survey.getFirstShownPage(),onFirstPage=page<=firstPage.position-1,onLastPage=page>=lastPage.position-1,isAllPagesSelected=this.survey.state.get('allPagesSelected');return{prevBtnDisabled:isAllPagesSelected||onFirstPage,nextBtnDisabled:isAllPagesSelected||onLastPage};},_onPageChange:function(e){var self=e.data.self;self.render();},_onNextPageClick:function(e){var self=e.data.self,currPageIndex=self.survey.state.get("page"),isAllPagesSelected=self.survey.state.get("allPagesSelected"),nextPage;e.preventDefault();if(isAllPagesSelected){return;}
nextPage=self.survey.getNextShownPage(currPageIndex);if(!nextPage){return;}
self.survey.state.set("page",nextPage.position-1,{notify:true});},_onPrevPageClick:function(e){var self=e.data.self,currPageIndex=self.survey.state.get("page"),isAllPagesSelected=self.survey.state.get("allPagesSelected"),prevPage;e.preventDefault();if(isAllPagesSelected){return;}
prevPage=self.survey.getPrevShownPage(currPageIndex);if(!prevPage){return;}
self.survey.state.set("page",prevPage.position-1,{notify:true});}});SM.PageMenuBtnView=SM.Views.register({__NAME:"pageMenuBtnView",__model:"survey",__templateID:"page-menu-btn-template",__init:function(options){this.survey.state.on("page.changed",{self:this},this._onPageChange);this.$el.actionMenu({menuView:"PageMenuView",model:this.survey,selectedAction:this.survey.state.get("page").toString(),saveState:true}).on("actionMenu.actionSelected",{self:this},this._onPageSelected).on("actionMenu.beforeOpen",{self:this},this._onBeforeMenuOpen);},__destroy:function(){this.survey.state.off("page.changed",this._onPageChange);},__beforeRender:function(){var pageNumber,pageIndex=this.survey.state.get('page'),hasActiveShowRule=this.survey.anviews.currentView.hasActiveShowRule(),allPagesSelected=this.survey.state.get('allPagesSelected');if(pageIndex!=="all"){pageNumber=pageIndex+1;}
return{hasShowRule:hasActiveShowRule,allPagesSelected:allPagesSelected,pageNumber:pageNumber};},_onPageSelected:function(e){var self=e.data.self,newPageIndex=e.action;if(newPageIndex!=="all"){newPageIndex=parseInt(newPageIndex,10);}
self.survey.state.set("page",newPageIndex,{notify:true});},_onBeforeMenuOpen:function(e){e.actionMenu.get("menuView").render();},_onPageChange:function(e){var self=e.data.self,actionMenu=self.$el.data("actionMenu");actionMenu.set("selectedAction",self.survey.state.get("page"));self.render();}});SM.PageMenuView=SM.Views.deepExtend(SM.ActionMenuView,{__NAME:"pageMenuView",__model:"survey",__templateID:"page-menu-template",__beforeRender:function(){var pageLen=this.survey.pageCount,hasShowRule=this.survey.anviews.currentView.hasActiveShowRule(),pages=[],pageData,pageModel,i=0;for(;i<pageLen;i++){pageModel=this.survey.pageList[i];pageData={};pageData.title=pageModel.heading;pageData.number=pageModel.position;pageData.index=pageModel.position-1;pageData.isShown=pageModel.isShown();pages.push(pageData);}
return{pages:pages,hasShowRule:hasShowRule};}});SM.PageNavView=SM.Views.register({__NAME:"pageNavView",__model:"survey",__templateID:"page-nav-container-template",__init:function(){this.survey.on("shownListsChanged",{self:this},this._onShownListChange);},__destroy:function(){this.survey.off("shownListsChanged",this._onShownListChange);},__beforeRender:function(){return{pageCount:this.survey.pageCount};},__afterRender:function(md){var pageArrowBtnsView,pageMenuBtnView;if(md.pageCount>1){pageMenuBtnView=SM.Views.create(SM.PageMenuBtnView,{model:this.survey});pageArrowBtnsView=SM.Views.create(SM.PageArrowBtnsView,{model:this.survey});this.el.appendChild(pageArrowBtnsView.el);this.el.appendChild(pageMenuBtnView.el);}},_onShownListChange:function(e){var self=e.data.self;self.render();}});SM.ContentNavView=SM.Views.register({__NAME:"contentNavView",__model:"survey",__templateID:"content-nav-view-template",__init:function(){this.bindModel(this.survey,"respondentCounts.changed",{self:this},this._onCountUpdate);this.bindModel(this.survey.anviews,"selectedViewLoaded",{self:this},this._onSelectedViewLoaded);this.bindModel(this.survey,"shownListsChanged",{self:this},this._onShownListChange);},__beforeRender:function(){var pageCount=this.survey.pageCount,isBrowseMode=this.survey.state.isBrowseMode(),hasRespondents=this.survey.respondentCounts.total_context>1,hasRespondent=this.survey.respondentCounts.total_context===1,hasRespondentNav=isBrowseMode&&hasRespondents,hasShownQuestions=this.survey.shownQuestionList.length>0,hasShownPages=this.survey.shownPageList.length>0,hasPageNav=(hasRespondents||hasRespondent)&&pageCount>1&&hasShownQuestions&&hasShownPages,hasNavContent=hasRespondentNav||hasPageNav;return{hasPageNav:hasPageNav,hasRespondentNav:hasRespondentNav,isHidden:!hasPageNav&&!hasRespondentNav};},__afterRender:function(md){var pageNav,respondentNav;if(!md.isHidden){if(md.hasPageNav){pageNav=SM.Views.create(SM.PageNavView,{model:this.survey});this.el.appendChild(pageNav.el);}
if(md.hasRespondentNav){respondentNav=SM.Views.create(SM.RespondentNavView,{model:this.survey});this.el.appendChild(respondentNav.el);}}},_onCountUpdate:function(e){var self=e.data.self;self.render();},_onShownListChange:function(e){var self=e.data.self;self.render();},_onSelectedViewLoaded:function(e){var self=e.data.self;self.render();}});SM.StatsHeaderView=SM.Views.register({__NAME:"statsHeaderView",__templateID:"analyze-stats-header-template",__model:"survey", __init:function(options){this.bindModel(this.survey,'respondentCounts.changed',{self:this},this._onCountChange);}, __beforeRender:function(options){var counts=this.survey.respondentCounts,isFiltered=this.survey.isFiltered(),currentView=this.survey.anviews.currentView,compareRule=currentView.hasCompareRule(),filterRule=currentView.hasFilterRule(),hasBoth=(compareRule&&filterRule);return{totalContext:Globalize.format(counts.total_context,"n0"),isFiltered:isFiltered,compareRule:compareRule,filterRule:filterRule,hasBoth:hasBoth,failedCount:counts.failed,total:Globalize.format(counts.total,"n0"),encryptedID:this.survey.encryptedID};},__afterRender:function(){var $btnContainer=this.$el.find("[global-share-menu]");if(this._shouldShowShareBtn()){$btnContainer.append(SM.Views.create(SM.ShareAllBtnView,{survey:this.survey,noBorder:true}).el);}
if(this._shouldShowExportBtn()){$btnContainer.append(SM.Views.create(SM.ExportAllBtnView,{model:this.survey,noBorder:true}).el);}}, _onCountChange:function(e){var self=e.data.self;self.render();}, _shouldShowShareBtn:function(){return SM.App.isSharingEnabled();},_shouldShowExportBtn:function(){return this.survey.isExportEnabled();}});SM.QuotasHeaderView=SM.Views.register({__NAME:"quotasHeaderView",__templateID:"analyze-quotas-header-template",__model:"quotas",__init:function(options){var self=this;this.$el.accordion();this.$el.on({"accordion.beforeOpen":function(e){self.$el.find('#progress-bar-main').hide();self.$el.find('.q').show();},"accordion.afterClose":function(e){self.$el.find('.q').hide();self.$el.find('#progress-bar-main').show();}});},__beforeRender:function(options){this.quotaList=SM.Models.create("QuotaList",{quota_data:options});return{totalContext:Globalize.format(this.quotaList.totalContext,"n0"),total:Globalize.format(this.quotaList.total,"n0"),totalPercent:Globalize.formatPercent(this.quotaList.percent,0),numQuotas:Globalize.format(this.quotaList.numQuotas,"n0")};},__afterRender:function(){var self=this;this.$el.find('.accordion').accordion();this.$el.find(".q").popout();this.$el.find('.q').hide();this.$el.find(".progress-bar").css('width',(this.quotaList.percent*100)+"%");var quotaListView=SM.Views.create(SM.QuotaListView,{model:self.quotaList});if(this.quotaList.percent===1){var green='#A7C23D';this.$el.find(".progress-bar").css('background-color',green);}
var viewContainer=this.$el.find("#QuotasViewContainer");viewContainer.append(quotaListView.$el);}});SM.QuotaView=SM.Views.register({__NAME:"quotaView",__templateID:"analyze-quotas-template",__model:"quota",__init:function(options){var self=this;},__beforeRender:function(options){this.quota_data=options.model;return{totalContext:Globalize.format(this.quota_data.totalContext,"n0"),total:Globalize.format(this.quota_data.total,"n0"),percent:Globalize.formatPercent(this.quota_data.percent,0),quota_name:this.quota_data.label};},__afterRender:function(){this.$el.find(".progress-bar").css('width',Globalize.formatPercent(this.quota_data.percent,2));if(this.quota_data.percent==1){var green='#A7C23D'
this.$el.find(".progress-bar").css('background-color',green);}}});SM.QuotaListView=SM.Views.register({__NAME:"quotaListView",__templateID:"analyze-quotas-list-template",__model:"quotaList",__init:function(options){var self=this;},__afterRender:function(){var listViewElement=this.$el
$.each(this.quotaList.quota_list,function(i,q){var quotaView=SM.Views.create(SM.QuotaView,{model:q});listViewElement.append(quotaView.$el);});}});SM.ModeTabsView=SM.Views.register({ __NAME:"modeTabsView",__templateID:"analyze-mode-tabs-template",__model:"survey", __beforeRender:function(){return{isSummaryMode:this.survey.state.isSummaryMode(),isBrowseMode:this.survey.state.isBrowseMode(),isTrendMode:this.survey.state.isTrendMode(),displayBrowseTab:this._displayBrowseTab(),displayTrendTab:this._displayTrendsTab(),summaryTabURL:this._summaryTabURL(),browseTabURL:this._browseTabURL(),trendsTabURL:this._trendsTabURL(),isDebug:SM.DEBUG};},__afterRender:function(){

 var $tabsText=this.$el.find("[sm-tab-text]");$tabsText.each(function(i,el){var $el=$(el),text=$el.text(),newText='',words=text.match(/[^\s]+/g);$.each(words,function(j,word){newText+=word; if(j===words.length-1){return false;} 
if(words[j+1].length<=3){newText+=" ";}else{ newText+="<br/>";}});$el.html(newText);});},__init:function(){this.$el.on(SM.Event.CLICK,"#mode_tab_trends",{self:this},this._onTrendsTabClick);}, _onTrendsTabClick:function(e){var self=e.data.self,dialog;if(!self.survey.owner.hasTrends()){e.preventDefault();dialog=SM.Views.create(SM.DialogView,{width:800,isModal:true,templateID:'trends-upgrade-dialog-template'});dialog.open();}}, _displayBrowseTab:function(){if(SM.App.isSharingApp()){return SM.App.sharedView.isBrowseTabEnabled();}else{return SM.DISPLAY_BROWSE_TAB;}},_displayTrendsTab:function(){if(SM.App.isSharingApp()){return SM.App.sharedView.isTrendsTabEnabled();}else{return SM.DISPLAY_TREND_TAB;}},_buildTabURL:function(path){var url=new Uri(path);return url.toString();},_summaryTabURL:function(){var path;if(SM.App.isSharingApp()){path=SM.App.sharedView.sharedPagePath();}else{path="/analyze/"+this.survey.encryptedID;}
return this._buildTabURL(path);},_browseTabURL:function(){var path;if(SM.App.isSharingApp()){path=SM.App.sharedView.sharedPagePath()+"browse/";}else{path="/analyze/browse/"+this.survey.encryptedID;}
return this._buildTabURL(path);},_trendsTabURL:function(){var path;if(SM.App.isSharingApp()){path=SM.App.sharedView.sharedPagePath()+"data-trends/";}else{path="/analyze/data-trends/"+this.survey.encryptedID;}
return this._buildTabURL(path);}});SM.AnalyzeHeaderView=SM.Views.register({ __NAME:"AnalyzeHeaderView",__model:"survey",__templateID:"analyze-header-container-template", __afterRender:function(){this._renderStatsHeaderView();if(this._shouldRenderQuotasHeaderView()){this._renderQuotasHeaderView();}
this._renderModeTabsView();},_renderStatsHeaderView:function(){var statsHeaderView=SM.Views.create(SM.StatsHeaderView,{model:this.survey});this.el.appendChild(statsHeaderView.el);},_renderQuotasHeaderView:function(){var quotasHeaderView=SM.Views.create(SM.QuotasHeaderView,{model:this.survey.quotas});this.el.appendChild(quotasHeaderView.el);},_renderModeTabsView:function(){var modeTabsView=SM.Views.create(SM.ModeTabsView,{model:this.survey});this.el.appendChild(modeTabsView.el);},_shouldRenderQuotasHeaderView:function(){return this.survey.quotas&&!!this.survey.quotas.equations;}});SM.AnalyzeMainView=SM.Views.register({ __NAME:"analyzeMainView",__model:"survey",__templateID:"analyze-main-column-template", __create:function(options){this.userIsOverResponseLimit=this.survey.owner.isOverResponseLimit(this.survey.respondentCounts.total);}, __beforeRender:function(){return{isOverResponseLimit:this.userIsOverResponseLimit};},__afterRender:function(){if(this._shouldRenderResponseLimitUpgradeView()){this._renderResponseLimitUpgradeView();}
this._renderAnalyzeHeaderView();this._renderContentNavView();this._renderAnalyzeContentWrapperView();},_renderAnalyzeHeaderView:function(){var view=SM.Views.create(SM.AnalyzeHeaderView,{model:this.survey});this.el.appendChild(view.el);},_renderContentNavView:function(){var view=SM.Views.create(SM.ContentNavView,{model:this.survey});this.el.appendChild(view.el);},_renderAnalyzeContentWrapperView:function(){var view=SM.Views.create(SM.AnalyzeContentWrapperView,{model:this.survey});this.el.appendChild(view.el);},_renderResponseLimitUpgradeView:function(){var view=SM.Views.create(SM.ResponseLimitUpgradeView,{model:this.survey,classes:"sm-corner-a spacer-mbl",linkSource:'wall_responselimit_beta'});this.el.appendChild(view.el);}, _shouldRenderResponseLimitUpgradeView:function(){if(SM.App.isSharingApp()){return false;}else{return this.userIsOverResponseLimit;}}});SM.FunctionListItemSaveView=SM.Views.register({__NAME:"FunctionListItem.SaveView",__templateID:"functionlist-save-template",__defaults:{visible:false,hasSaveBtn:true},__init:function(){this.$el.on("submit","form",{self:this},this._onFormSubmit).on(SM.Event.CLICK,'[view-save-btn]',{self:this},this._publishSave).on(SM.Event.CLICK,'[view-revert-btn]',{self:this},this._publishRevert);},_onFormSubmit:function(e){var self=e.data.self;e.preventDefault();self.$el.find("[view-save-btn]").click();},_publishSave:function(e){var self=e.data.self;e.preventDefault();self.trigger("saveClicked");self.__settings.visible=false;self.render();},_publishRevert:function(e){var self=e.data.self;e.preventDefault();self.trigger("revertClicked");self.__settings.visible=false;self.render();}});SM.FunctionListItemDeleteView=SM.Views.register({__NAME:"FunctionListItem.DeleteView",__templateID:"functionlist-delete-template",__defaults:{visible:false,hasCancel:true},__init:function(){this.$el.on("submit","form",{self:this},this._onFormSubmit);this.$el.on(SM.Event.CLICK,"[view-delete-btn]",{self:this},this._publishDelete);this.$el.on(SM.Event.CLICK,"[view-delete-cancel-btn]",{self:this},this._publishCancel);},__beforeRender:function(){return{visible:this.__settings.visible,hasCancel:this.__settings.hasCancel};},__afterRender:function(md){if(this.__settings.visible){this.$el.removeClass("hide");}},open:function(){this.__settings.visible=true;this.render();this.$el.find('[view-delete-btn]').focus();},close:function(){this.__settings.visible=false;this.render();},_publishDelete:function(e){var self=e.data.self;e.preventDefault();self.close();self.trigger("deleteClicked");},_onFormSubmit:function(e){var self=e.data.self;e.preventDefault();self.$el.find("[view-delete-btn]").click();},_publishCancel:function(e){var self=e.data.self;self.close();self.trigger("cancelClicked");}});SM.FunctionListItemRenameView=SM.Views.register({__NAME:"FunctionListItem.RenameView",__templateID:"functionlist-rename-template",__defaults:{placeholder:"",visible:false},__init:function(){this.$el.on("submit","form",{self:this},this._onFormSubmit).on(SM.Event.CLICK,'[rename-save-btn]',{self:this},this._publishRename).on(SM.Event.CLICK,'[rename-cancel-btn]',{self:this},this._publishCancel).on(SM.Event.KEYUP,'[rename-text]',{self:this},this._onRename);},__beforeRender:function(){return{placeholder:this.__settings.placeholder,visible:this.__settings.visible};},__afterRender:function(md){if(this.__settings.visible){this.$el.removeClass("hide");}
this.$el.find('[rename-text]').select().focus();},_onFormSubmit:function(e){var self=e.data.self;e.preventDefault();self.$el.find("[rename-save-btn]").click();},_publishRename:function(e){var self=e.data.self,name;e.preventDefault();name=$.trim(self.$el.find('[rename-text]').val());if(name.length>0){self.trigger({type:"Renamed",newName:name});self.close();}},_publishCancel:function(e){var self=e.data.self;self.trigger("Canceled");self.close();},open:function(){this.__settings.visible=true;this.render();},close:function(){this.__settings.visible=false;this.render();},_onRename:function(e){var self=e.data.self;if(e.which===SM.KeyCodes.ESCAPE){self._publishCancel(e);e.preventDefault();}}});SM.AnViewListView=SM.Views.register({__NAME:"AnViewList",__model:"anviews",__templateID:"anview-list-template",__init:function(){this.anviews.on("viewAdded",{self:this},this._onViewCreate);},__destroy:function(){this.anviews.off("viewAdded",this._onViewCreate);},__afterRender:function(md){this._cacheElements();var len=this.anviews.viewList.length,v,viewsContainer=this.$viewList.get(0),selectedViewID=this.anviews.get("selectedViewID"),isSelectedView,i=0; v=this.anviews.defaultView;isSelectedView=v.ID===selectedViewID;viewsContainer.appendChild(SM.Views.create(SM.AnView,{model:v,isSelected:isSelectedView,isSelectable:!isSelectedView,isBasicUser:this.anviews.survey.owner.isBasic()}).el);for(;i<len;i++){v=this.anviews.viewList[i];if(!v.isDefault){isSelectedView=v.ID===selectedViewID;this.$viewList.get(0).appendChild(SM.Views.create(SM.AnView,{model:v,isSelected:isSelectedView,isSelectable:!isSelectedView,isBasicUser:this.anviews.survey.owner.isBasic()}).el);}}
this.saveAsView=SM.Views.create(SM.AnViewSaveAsView,{model:this.anviews.survey,disabled:!this.anviews.currentView.get("isDirty")});this.el.appendChild(this.saveAsView.el);this.$saveAsBtn=this.$el.find(".saveas-btn");},_onViewCreate:function(e){var self=e.data.self;self.$viewList.get(0).appendChild(SM.Views.create(SM.AnView,{model:e.anViewModel,showMenu:false,isSelected:false,isLoading:true,isDisabled:true,isSelectable:false,isBasicUser:self.anviews.survey.owner.isBasic()}).el);},_cacheElements:function(){this.$viewList=this.$el.find("ul.view-item-list");return this;}});SM.BaseAccordionHeadingView={__NAME:"AccordionHeadingView",__templateID:"accordion-heading-view",__defaults:{number:0,isOpen:false,title:null,isLoading:false},__setters:{isOpen:function(self,value){self.__settings.isOpen=value;}}};SM.ExportHeadingView=SM.Views.extend(SM.BaseAccordionHeadingView,{__model:"exportJobs",_title:"Exports",__init:function(options){this.bindModel(this.exportJobs,"isLoaded.changed",{self:this},this._onExportJobsLoadedChanged);this.bindModel(this.exportJobs.poller,"isActive.changed",{self:this},this._onPollerActiveChanged);this.bindModel(this.exportJobs,"jobAdded",{self:this},this._onJobAdded);this.bindModel(this.exportJobs,"jobCancelled",{self:this},this._onJobDeleted);this.bindModel(this.exportJobs,"jobDeleted",{self:this},this._onJobDeleted);},__setters:{isOpen:function(self,value){self.__settings.isOpen=value;if(value===true&&!self.exportJobs.get("isLoaded")){self.exportJobs.fetchJobs();}}},__beforeRender:function(e){var isLoading=!this.__settings.isOpen&&this.exportJobs.poller.get("isActive");return{isOpen:this.__settings.isOpen,isLoading:isLoading,title:Globalize.localize(this._title),number:this.exportJobs.list?this.exportJobs.list.length:null};},_onJobAdded:function(e){var self=e.data.self;self.$el.closest(".accordion").data("accordion").open("ExportListContainer");self.__settings.isOpen=true;},_onJobDeleted:function(e){e.data.self.render();},_onExportJobsLoadedChanged:function(e){e.data.self.render();},_onPollerActiveChanged:function(e){e.data.self.render();}});SM.SavedViewsHeadingView=SM.Views.extend(SM.BaseAccordionHeadingView,{__model:"anviews",__init:function(){this.bindModel(this.anviews,"sizeChanged",{self:this},this._onSizeChanged);},__beforeRender:function(e){return{isLoading:this.__settings.isLoading,title:Globalize.localize("Saved Views"),number:this.anviews.viewList.length};},_onSizeChanged:function(e){e.data.self.render();}});SM.AnViewSaveAsView=SM.Views.register({__NAME:"AnViewSaveAsView",__model:"survey",__templateID:"viewlist-saveas-template",__defaults:{isOpen:false,warn:false,disabled:true},__init:function(){this.bindModel(this.survey.anviews.currentView,"isDirty.changed",{self:this},this._onIsDirtyChanged);this.bindModel(this.survey.anviews,"nextSelectedViewID.changed",{self:this},this._onNextViewIDChanged);this.$el.on(SM.Event.CLICK,"[saveas-btn]",{self:this},this._onSaveAsBtnClick).on("submit","form",{self:this},this._onSubmit).on(SM.Event.CLICK,"[save-new-btn]",{self:this},this._onSaveNewBtnClick).on(SM.Event.CLICK,"[cancel-btn]",{self:this},this._onCancelSaveAs).on(SM.Event.KEYUP,"input[type='text']",{self:this},this._onNameKeyup);},__beforeRender:function(md){var survey=this.survey,selectedView=survey.getSelectedView();md={isOpen:this.__settings.isOpen,disabled:this.__settings.disabled,warn:this.__settings.warn,isBasic:survey.owner.isBasic(),viewName:selectedView.isDefault?Globalize.localize("Saved View"):selectedView.name+", "+Globalize.format(new Date(),'D')};return md;},__afterRender:function(md){if(this.__settings.isOpen){this.$newName=this.$el.find('input');this.$newName.focus();this.$newName.select();}},_onNextViewIDChanged:function(e){var self=e.data.self,nextSelectedViewID=e.value,defaultViewSelected=self.survey.getSelectedView().ID===self.survey.anviews.defaultView.ID;if(defaultViewSelected&&nextSelectedViewID!==null){self.__settings.warn=true;self.render();}},_onSaveAsBtnClick:function(e){var self=e.data.self,dialog;e.preventDefault();if(self.survey.owner.isBasic()){dialog=SM.Views.create(SM.DialogView,{width:800,isModal:true,templateID:'saved-views-upgrade-dialog-template'});dialog.open();}else if(!self.__settings.disabled){self.__settings.isOpen=true;self.render();}},_onNameKeyup:function(e){var self=e.data.self;if(e.which===SM.KeyCodes.ESCAPE){e.preventDefault();self.$el.find("[cancel-btn]").click();}},_onSubmit:function(e){var self=e.data.self;e.preventDefault();self.$el.find("[save-new-btn]").click();},_onSaveNewBtnClick:function(e){var self=e.data.self,name;e.preventDefault();name=$.trim(self.$newName.val());if(name.length===0){return;}
self.survey.anviews.saveCurrentViewAs(name);self.__settings.isOpen=false;self.__settings.warn=false;self.__settings.disabled=true;self.render();},_onCancelSaveAs:function(e){var self=e.data.self;self.survey.anviews.set("nextSelectedViewID",null);self.__settings.isOpen=false;self.__settings.warn=false;self.render();},_onIsDirtyChanged:function(e){var self=e.data.self,isDirty=e.value;if(isDirty){self.__settings.disabled=false;}else{self.__settings.disabled=true;self.__settings.isOpen=false;self.__settings.warn=false;}
self.render();}});SM.AnView=SM.Views.register({__model:"anViewModel",__NAME:"AnView",__templateID:"anview-item-template",__defaults:{isLoading:false,isSelected:false,isDirty:false,isBasicUser:true,isDisabled:false,isSelectable:true,deleteMode:false,renameMode:false},__init:function(){var self=this,anViewModel=this.anViewModel;this.bindModel(anViewModel,"isLoaded.set",{self:this},this._onLoadedSet);this.bindModel(anViewModel,"selected.changed",{self:this},this._onSelectedChange);this.bindModel(anViewModel,"isDirty.changed",{self:this},this._onIsDirtyChanged);this.bindModel(anViewModel,"copySuccess",{self:this},this._onViewReady);this.bindModel(anViewModel,"createSuccess",{self:this},this._onViewReady);this.bindModel(anViewModel,"loadFailed.set",{self:this},this._onLoadFail);this.bindModel(anViewModel.anviews,"nextSelectedViewID.changed",{self:this},this._onNextViewIDChanged);this.bindModel(anViewModel.anviews.currentView,"isSaving.changed",{self:this},this._onCurrentViewSavingChanged);this.$el.on(SM.Event.CLICK,".list-item",{self:this},this._onSelect);this.$el.on({'actionMenu.actionSelected':this._onMenuAction,'FunctionListItem.RenameView.Renamed':function(e){self.__settings.renameMode=false;self.__settings.isSelectable=!self.__settings.isSelected;self.anViewModel.name=e.newName;self.anViewModel.save();self.render();},'FunctionListItem.DeleteView.deleteClicked':function(e){self.anViewModel.anviews.deleteView(self.anViewModel);self.$el.remove();},'FunctionListItem.RenameView.Canceled':function(e){self.__settings.isSelectable=!self.__settings.isSelected;self.__settings.renameMode=false;self.render();},'FunctionListItem.DeleteView.cancelClicked':function(e){self.__settings.isSelectable=!self.__settings.isSelected;self.__settings.deleteMode=false;self.render();},'FunctionListItem.SaveView.saveClicked':function(e){self.anViewModel.anviews.currentView.commitChanges();},'FunctionListItem.SaveView.revertClicked':function(e){self.anViewModel.anviews.currentView.revert();}},{self:this});},__beforeRender:function(options){var isDisabled=this.__settings.isDisabled||(!this.anViewModel.isDefault&&this.__settings.isBasicUser),isDefault=this.anViewModel.isDefault,isDirty=this.anViewModel.get("isDirty"),hideMenu=isDirty||this.__settings.isLoading||this.__settings.renameMode||this.__settings.deleteMode||(!this.anViewModel.anviews.survey.isExportEnabled()&&isDefault)||this.anViewModel.get("loadFailed");this.__settings.isSelectable=!isDisabled&&this.__settings.isSelectable;return{name:this.anViewModel.name,isDefault:isDefault,isLoading:this.__settings.isLoading,isSelected:this.__settings.isSelected,isSelectable:this.__settings.isSelectable,deleteMode:this.__settings.deleteMode,showMenu:!hideMenu,isDisabled:isDisabled,renameMode:this.__settings.renameMode&&!isDirty,isDirty:isDirty,loadFailed:this.anViewModel.get("loadFailed")};},__afterRender:function(md){var $listItem=this.$el.children(".list-item"),functionListWidgetView=null;if(md.showMenu){this.$el.find('a.btn-menu-down').actionMenu({menuView:"AnViewMenuView",isDefault:this.anViewModel.isDefault,isBasic:this.__settings.isBasicUser,exportsEnabled:this.anViewModel.anviews.survey.isExportEnabled(),sharingEnabled:SM.App.isSharingEnabled()});}else{if(this.__settings.renameMode){functionListWidgetView=SM.Views.create(SM.FunctionListItemRenameView,{placeholder:md.name});functionListWidgetView.open();}else if(this.__settings.deleteMode){functionListWidgetView=SM.Views.create(SM.FunctionListItemDeleteView,{visible:true});}else if(this.anViewModel.get("isDirty")){functionListWidgetView=SM.Views.create(SM.FunctionListItemSaveView,{visible:true,warn:this.anViewModel.anviews.get("nextSelectedViewID"),hasSaveBtn:!this.anViewModel.isDefault});this.saveView=functionListWidgetView;}
if(functionListWidgetView){ $listItem.prepend(functionListWidgetView.el);}}},_onIsDirtyChanged:function(e){var self=e.data.self;self.render();},_onNextViewIDChanged:function(e){var self=e.data.self,viewID=e.viewID;if(self.anViewModel===self.anViewModel.anviews.getSelectedView()){self.render();}},_onSelectedChange:function(e){var self=e.data.self,isSelected=self.anViewModel.get("selected");self.__settings.isSelected=isSelected;self.__settings.isLoading=isSelected;self.__settings.isSelectable=!isSelected;self.render();},_onLoadedSet:function(e){var self=e.data.self;if(self.anViewModel.get("isLoaded")){self.__settings.isLoading=false;self.render();}},_onCurrentViewSavingChanged:function(e){var self=e.data.self;self.__settings.isSelectable=!e.value;},_onViewReady:function(e){var self=e.data.self,isSelectedView=self.anViewModel.ID===self.anViewModel.anviews.get("selectedViewID");self.__settings.isLoading=false;self.__settings.isDisabled=false;self.__settings.isSelectable=!isSelectedView;self.render();},_onSelect:function(e){var self=e.data.self,anviews=self.anViewModel.anviews,survey=self.anViewModel.anviews.survey,dialog;e.preventDefault();if(self.__settings.isSelectable){anviews.set("selectedViewID",self.anViewModel.ID);}else if(survey.owner.isBasic()){dialog=SM.Views.create(SM.DialogView,{width:800,isModal:true,templateID:'saved-views-upgrade-dialog-template'});dialog.open();}},_onCurrentReset:function(e){var self=e.data.AnView;if(self.anViewModel.isDefault){self.__settings.isSelected=true;self.__settings.isLoading=true;self.render();}else if(self.__settings.isSelected){self.__settings.isSelected=false;self.render();}},_onLoadFail:function(e){e.data.self.render();},_onMenuAction:function(e){var self=e.data.self;self[e.action]();},_menuRenameClick:function(){this.__settings.isSelectable=false;this.__settings.renameMode=true;this.render();},_menuCopyClick:function(){this.anViewModel.anviews.copyView(this.anViewModel);this.render();},_menuUpgradeClick:function(){var dialog=SM.Views.create(SM.DialogView,{width:800,isModal:true,templateID:'saved-views-upgrade-dialog-template'});dialog.open();},_menuShareClick:function(){SM.AnalyzeApp.SharedViewsRouter.newSharedView({view:this.anViewModel});},_menuExportClick:function(){var self=this,survey=this.anViewModel.anviews.survey,dialog;if(survey.owner.isBasic()){dialog=SM.Views.create(SM.DialogView,{width:800,isModal:true,templateID:'export-upgrade-dialog-template'});dialog.open();}else{if(survey.owner.get("hipaaEnabled")){dialog=SM.Views.create(SM.HipaaExportWarningView,{model:survey,jobType:"export",onContinueClick:function(){self._createExportDialog(survey);}});dialog.open();}else{self._createExportDialog(survey);}}},_createExportDialog:function(survey){var exportJob,dialog;exportJob=survey.exportJobs.createJob({email:survey.owner.email,export_type:'summary',export_data:{respondent_id:'all'}});exportJob.sourceView=this.anViewModel;dialog=SM.Views.create(SM.ExportDialogView,{model:exportJob,viewSelectMode:this.anViewModel.isCurrent});survey.exportJobs.fetchJobs();dialog.open();},_menuDeleteClick:function(){this.__settings.isSelectable=false;this.__settings.deleteMode=true;this.render();}});SM.AnViewMenuView=SM.Views.deepExtend(SM.ActionMenuView,{__NAME:"AnViewMenuView",__templateID:"anview-menu-template",__afterRender:function(){SM.ActionMenuView.__afterRender.call(this);this.$el.find(".q").popout();}});SM.ExportAllBtnView=SM.Views.register({__NAME:"ExportAllBtnView",__model:"survey",__templateID:"export-all-btn-view-template",__init:function(){this.$el.actionMenu({menuView:"ExportAllMenuView",exportEnabled:this.survey.owner.hasExports(),singleMode:this.__settings.singleMode,hasChartView:this.__settings.hasChartView}).on("actionMenu.actionSelected",{self:this},this._onMenuAction);if(this.survey.anviews.currentView.hasCompareRule()&&this.survey.anviews.currentView.compareRule.isRA){this._disableDotNETExports();}else if(this.survey.anviews.currentView.hasFilterRule()&&this.survey.anviews.currentView.hasRAFilterSelected()){this._disableDotNETExports();}else{this._enableDotNETExports();} 
this.question=this.__settings.question;},__beforeRender:function(){return{noBorder:this.__settings.noBorder,singleMode:this.__settings.singleMode};},__afterRender:function(md){this.$el.find(".q").popout();},_disableDotNETExports:function(){var self=this;self.survey.config.export_formats_enabled.full.excel=false;self.survey.config.export_formats_enabled.full.excel_plus=false;self.survey.config.export_formats_enabled.full.spss=false;self.survey.config.export_formats_enabled.summary.excel=false;self.survey.config.export_formats_enabled.summary.csv=false;},_enableDotNETExports:function(){var self=this;self.survey.config.export_formats_enabled.full.excel=true;self.survey.config.export_formats_enabled.full.excel_plus=true;self.survey.config.export_formats_enabled.full.spss=true;self.survey.config.export_formats_enabled.summary.excel=true;self.survey.config.export_formats_enabled.summary.csv=true;},_onMenuAction:function(e){var dialog,self=e.data.self,exportType=e.action,survey=self.survey,individualResponseMode=exportType==="individual";if(exportType==='individual'){exportType='full';}
if(survey.owner.isBasic()){ var templateID='export-upgrade-dialog-template';if(self.__settings.singleMode){switch(exportType){case'summary':templateID='export-single-upgrade-dialog-template';break;case'chart':templateID='export-chart-upgrade-dialog-template';break;}}
dialog=SM.Views.create(SM.DialogView,{width:800,isModal:true,templateID:templateID});dialog.open();}else{if(survey.owner.get("hipaaEnabled")){dialog=SM.Views.create(SM.HipaaExportWarningView,{model:survey,jobType:"export",onContinueClick:function(){self._createExportDialog(survey,exportType,individualResponseMode);}});dialog.open();}else{self._createExportDialog(survey,exportType,individualResponseMode);}}},_createExportDialog:function(survey,exportType,individualResponseMode){var dialog,jobData,jobModel,currentView=survey.anviews.currentView;jobData={email:survey.owner.email,export_type:exportType,export_data:{respondent_id:'all'}}; if(this.question!==undefined){jobData.export_data.question_id=this.question.ID;jobData.questionNumber=this.question.position;if(exportType==='chart'){jobData.format='png';}}
jobModel=survey.exportJobs.createJob(jobData);jobModel.sourceView=currentView;dialog=SM.Views.create(SM.ExportDialogView,{model:jobModel,viewSelectMode:true,individualResponseMode:individualResponseMode,hasChartView:this.__settings.hasChartView,question:this.question});survey.exportJobs.fetchJobs();dialog.open();}});SM.NewExportBtnView=SM.Views.extend(SM.ExportAllBtnView,{__NAME:"NewExportBtnView",__templateID:"new-export-btn-view-template"});SM.ExportAllMenuView=SM.Views.deepExtend(SM.ActionMenuView,{__NAME:"ExportAllMenuView",__templateID:"export-all-menu-template",__afterRender:function(){SM.ActionMenuView.__afterRender.call(this);this.$el.find(".q").popout();}});SM.ExportJobListView=SM.Views.register({__NAME:"ExportJobListView",__model:"exportJobs",__templateID:"export-job-list-template",__init:function(){var self=this;this.$el.on(SM.Event.CLICK,".upgrade-message a[learn-more]",function(e){e.preventDefault();var dialog=SM.Views.create(SM.DialogView,{width:800,isModal:true,templateID:'export-upgrade-dialog-template'});dialog.open();});this.bindModel(this.exportJobs,"jobCancelled",{self:this},this._onJobDeleted);this.bindModel(this.exportJobs,"jobDeleted",{self:this},this._onJobDeleted);this.bindModel(this.exportJobs,"jobAdded",{self:this},this._onJobAdded);this.bindModel(this.exportJobs,"isLoaded.changed",{self:this},this._onExportJobsLoaded);this.bindModel(this.exportJobs,"isUnavailable.set",{self:this},this._onExportJobsUnavailable);},__beforeRender:function(){return{isLoaded:this.exportJobs.get("isLoaded"),exportsIsUnavailable:this.exportJobs.isUnavailable,upgradeRequired:this.exportJobs.survey.owner.isBasic()};},__afterRender:function(md){var html,self=this,user=this.exportJobs.survey.owner,view,$jobsList=this.$el.children(".exported-jobs-list");if(user.isBasic()){this.el.appendChild(SM.Template.renderHTML("export-upgrade-message-template"));return;}
if(this.exportJobs.get("isLoaded")){if(this.exportJobs.list.length===0){view=SM.Views.create(SM.ExportNullStateView,{model:this.exportJobs.survey});$jobsList.append(view.$el);}else{$.each(this.exportJobs.list,function(i,job){view=SM.Views.create(SM.ExportJobView,{model:job,upgradeRequired:user.isBasic()});$jobsList.append(view.$el);});this.$el.find("[export-btn]").append(SM.Views.create(SM.NewExportBtnView,{model:this.exportJobs.survey,noBorder:true}).el);}}else if(this.exportJobs.isUnavailable){html=SM.Template.render("exports-unavailable-template",{requestID:this.exportJobs.unavailableErrorID});this.$el.html(html);}},_onExportJobsUnavailable:function(e){
 if(e.value){e.data.self.render();}},_onExportDialogOpen:function(e){var self=e.data.ExportJobListView,exportDialogView=SM.Views.create(SM.ExportDialogView,{model:e.exportJob,viewModel:e.view||self.exportJobs.survey.anviews.currentView,viewSelectMode:!e.view,tab:e.exportType||"summary"});exportDialogView.open();},_onJobAdded:function(e){var self=e.data.self;self.render();},_onJobDeleted:function(e){var job=e.job,self=e.data.self,exportEnabled=self.exportJobs.survey.owner.hasExports();if(self.exportJobs.list.length===0&&exportEnabled){self.render();}},_onExportJobsLoaded:function(e){e.data.self.render();}});SM.ExportJobView=SM.Views.register({__NAME:"ExportJobView",__model:"exportJob",__templateID:"export-job-template",__defaults:{detailsOn:false,renameMode:false,upgradeRequired:true},__init:function(){var self=this;this.$el.on(SM.Event.CLICK,".list-item",{self:this},this._onSelect);this.$el.on({'actionMenu.actionSelected':this._onMenuAction,'FunctionListItem.DeleteView.deleteClicked':function(e){if(self.exportJob.isNew()){self.exportJob.exportJobs.cancelJob(self.exportJob);}else{self.exportJob.exportJobs.deleteJob(self.exportJob);}},'FunctionListItem.DeleteView.cancelClicked':function(e){self.__settings.deleteMode=false;self.render();}},{self:this});this.bindModel(this.exportJob,"deleted",{self:this},this._onDelete);this.bindModel(this.exportJob,"isCancelled.changed",{self:this},this._onDelete);this.bindModel(this.exportJob,"status.changed",{self:this},this._onStatusChanged);},_readableFormat:{excel:'xls',pdf:'pdf',html:'html',spss:'spss',excel_plus:'xls+',csv:'csv',pptx:'pptx',png:'png'},__beforeRender:function(options){var job=this.exportJob,viewName=this._shortenDisplayName(job.jobInfo.view_name)||"",jobName=this._shortenDisplayName(job.name),fullExport=job.type==='full',jobFormat=this._readableFormat[job.format],upgradeRequired=this.__settings.upgradeRequired,chartMode=job.type==='chart',summaryMode=chartMode||(fullExport&&job.format!=='pdf'),pages,questions;pages=job.jobInfo.pages;questions=job.jobInfo.questions;return{job:job,jobName:jobName,pages:pages,questions:questions,jobFormat:jobFormat,fullExport:fullExport,createDate:job.toDateString(job.createDate),endDate:job.toDateString(job.expirationDate),jobFailed:job.failed(),detailsOn:this.__settings.detailsOn,inProgress:job.pending(),viewName:viewName,upgradeRequired:this.__settings.upgradeRequired,summaryMode:summaryMode,deleteMode:this.__settings.deleteMode,chartMode:chartMode,singleMode:job.get("isSingleMode"),questionNumber:job.exportData.questionNumber};},__afterRender:function(md){var deleteView,$listItem=this.$el.find('.list-item');if(this.__settings.deleteMode){deleteView=SM.Views.create(SM.FunctionListItemDeleteView,{visible:true});$listItem.prepend(deleteView.$el);}else{this.$el.find('a.btn-menu-down').actionMenu({menuView:"ExportJobMenuView",detailsOn:md.detailsOn,isDisabled:this.__settings.isDisabled,jobFailed:md.jobFailed,job:md.job});}},_onStatusChanged:function(e){var self=e.data.self,notification;if(self.exportJob.done()){notification=SM.Notifications.success({title:Globalize.localize("Your export file is complete"),message:Globalize.localize("Export files will appear under EXPORTS for 14 days."),duration:20000,classes:"export-job-success-notification",tabMessage:Globalize.localize("Export complete"),content:SM.Template.render("export-job-notification-download-link-template",{job:self.exportJob})});notification.$el.on("click",".download-btn",function(e){var link=$(e.target).attr('link');e.preventDefault(); window.location=link;notification.close();});}else if(self.exportJob.failed()){notification=SM.Notifications.error({title:Globalize.localize("Your export file is too large to process"),classes:("export-job-failed-notification"),tabMessage:Globalize.localize("Export failed"),content:SM.Template.render("export-job-notification-error-message-template",{job:self.exportJob,exportTooLarge:self.exportJob.get("status")===self.exportJob.STATUS.TOO_LARGE_ERROR}),duration:10000});}
e.data.self.render();},_onSelect:function(e){var self=e.data.self,job=self.exportJob;e.preventDefault();if(!self.__settings.deleteMode){if(job.done()){window.location=job.downloadLink;}else{self._menuDetailsClick();}}},_onDelete:function(e){var self=e.data.self;self.$el.remove();},_onMenuAction:function(e){var self=e.data.self;self[e.action]();},_menuDetailsClick:function(){this.__settings.detailsOn=!this.__settings.detailsOn;this.render();},_menuDownloadClick:function(){}, _menuDisabledDownloadClick:function(){},_menuRetryClick:function(){},_menuDeleteClick:function(){this.__settings.deleteMode=true;this.render();},_shortenDisplayName:function(name){if(!!name&&name.length>25){name=name.substring(0,20)+"...";}
return name;}});SM.ExportJobMenuView=SM.Views.deepExtend(SM.ActionMenuView,{__NAME:"ExportJobMenuView",__templateID:"export-job-menu-template"});SM.ExportDialogView=SM.Views.deepExtend(SM.DialogView,{__NAME:"ExportJobDialogView",__model:"exportJob",__templateID:"export-dialog-view",__defaults:{viewSelectMode:false,responseSelectMode:false,confirmDisabled:true,isModal:true,width:750,individualResponseMode:false},__init:function(options){var self=this,owner=self.exportJob.exportJobs.survey.owner;this.viewID=options.viewID;this.errors={};this.$el.on(SM.Event.CLICK,"div .confirm-btn",{self:this},this._onConfirm).on(SM.Event.CLICK,"div .cancel-btn",{self:this},this._closeDialog).on(SM.Event.CLICK,"ul li a.export-summary-tab",{self:this},this._onSummaryTabClick).on(SM.Event.CLICK,"a[edit-view-select]",{self:this},this._onEditViewSelection).on(SM.Event.CLICK,"ul li a.all-response-tab",{self:this},this._onAllResponseTabClick).on(SM.Event.CLICK,"input[type='radio'][value='current']",{self:this,view:'currentView'},this._onEditViewSelection).on(SM.Event.CLICK,"input[type='radio'][value='original']",{self:this,view:'defaultView'},this._onEditViewSelection).on({"formatClicked":function(e,format){self.buttonsView.render();}});this.bindModel(this.exportJob.exportJobs,"jobDeleted",{self:this},this._onJobDeleted);this.bindModel(this.exportJob.exportJobs,"jobCancelled",{self:this},this._onJobDeleted);this.bindModel(this.exportJob.exportJobs,"isLoaded.changed",{self:this},this._onExportJobsLoadedChanged);this.bindModel(this.exportJob.exportJobs,"jobStatusChanged",{self:this},this._onJobStatusChanged);this.bindModel(this.exportJob.exportJobs,"isUnavailable.set",{self:this},this._onExportJobsUnavailable);},__onAfterClose:function(){this.$el.remove();},_onJobStatusChanged:function(e){var self=e.data.self;if(e.job.type==='full'&&!e.job.pending()){self.render();}},_onJobDeleted:function(e){
 var self=e.data.self;if(!self.exportJob.exportJobs.hasFullExportPending()){self.render();}},_onExportJobsLoadedChanged:function(e){var self=e.data.self;self.render();},_hasNoMatchingResponses:function(){return(!this.exportJob.exportJobs.survey.hasFilteredRespondents()||(this.__settings.question&&this.__settings.question.getRollup().summary.answered===0)&&!this.__settings.question.hasRandomAssignment());},__beforeRender:function(){var exportJob=this.exportJob,exportJobs=exportJob.exportJobs,summaryMode=exportJob.type===exportJob.TYPE.SUMMARY_EXPORT,md={viewModel:this.exportJob.sourceView,viewSelectMode:this.__settings.viewSelectMode,responseSelectMode:this.__settings.responseSelectMode,fullExportsInProgress:!summaryMode&&exportJobs.hasFullExportPending(),exportsLoaded:exportJobs.get("isLoaded"),exportsIsUnavailable:exportJobs.isUnavailable,isAllowedToExport:!exportJobs.isNotAllowedToExport(),singleMode:exportJob.get("isSingleMode")};md[exportJob.type+'Mode']=true;return md;},__afterRender:function(){var html,exportJob=this.exportJob,exportJobs=exportJob.exportJobs,survey=exportJobs.survey,summaryMode=exportJob.type===exportJob.TYPE.SUMMARY_EXPORT,chartMode=exportJob.type===exportJob.TYPE.CHART_EXPORT,fullExportsInProgress=(!summaryMode&&exportJobs.hasFullExportPending()),params={model:exportJob,hasChartView:this.__settings.hasChartView
};SM.DialogView.__afterRender.call(this);if(exportJobs.isAvailable()){if(exportJobs.isNotAllowedToExport()){html=SM.Template.render("retry-export-warning");this.$el.children("section").append(html);}else{if(fullExportsInProgress){this.panel=SM.Views.create(SM.FullExportPendingListView,{model:exportJobs});this.$el.children("section").append(this.panel.el);}else if(this._hasNoMatchingResponses()){ this.panel=SM.Views.create(SM.ExportDialogNoMatchingResponsesView,{survey:survey});this.$el.find('div.current-panel').append(this.panel.$el);}else{if(summaryMode){this.panel=SM.Views.create(SM.ExportDialogSummaryView,params);}else if(chartMode){this.panel=SM.Views.create(SM.ChartExportDialogView,params);}else{this.panel=SM.Views.create(SM.ExportDialogAllResponseView,{model:exportJob,individualResponseMode:this.__settings.individualResponseMode});}
this.$el.find('div.current-panel').append(this.panel.$el);}
this.buttonsView=SM.Views.create(SM.ExportDialogButtonView,{model:exportJob,dialogDisabled:fullExportsInProgress||this._hasNoMatchingResponses(),exportsLoaded:exportJobs.get("isLoaded")});this.$el.find(".buttons-wrapper").append(this.buttonsView.$el);}}else{html=SM.Template.render("exports-unavailable-template",{requestID:exportJobs.unavailableErrorID});this.$el.children("section").html(html);}
this.$el.find(".q").popout();},_onExportJobsUnavailable:function(e){if(e.value){e.data.self.render();}},_onEditViewSelection:function(e){var self=e.data.self,view=e.data.view;self.exportJob.sourceView=self.exportJob.exportJobs.survey.anviews.get(view);},_onSummaryTabClick:function(e){var self=e.data.self;e.preventDefault();self.exportJob.type=self.exportJob.TYPE.SUMMARY_EXPORT;self.exportJob.format=undefined;self.render();},_onAllResponseTabClick:function(e){var self=e.data.self;e.preventDefault();self.exportJob.type=self.exportJob.TYPE.ALL_EXPORT;self.exportJob.format=undefined;self.render();},_closeDialog:function(e){e.preventDefault();e.data.self.close();},_onConfirm:function(e){var self=e.data.self;e.preventDefault(); if(self.exportJob.format!==undefined){if(self.panel.validate()){self.close();self.exportJob.exportJobs.addJob(self.exportJob);}else{self.panel.render();}}}});SM.FullExportPendingListView=SM.Views.register({__NAME:"FullExportPendingListView",__templateID:"pending-full-exports-list-template",__model:"exportJobs",__afterRender:function(){var self=this,$ul=self.$el.find("ul"),jobs=this.exportJobs.getPendingFullExports();$.each(jobs,function(i,job){var view=SM.Views.create(SM.FullExportPendingView,{model:job});$ul.append(view.el);});}});SM.FullExportPendingView=SM.Views.register({__NAME:"FullExportPendingView",__templateID:"pending-full-export-template",__model:"exportJob",__init:function(){var self=this;this.$el.on("click","[cancel-btn]",{self:this},this._onCancelClick);this.bindModel(this.exportJob,"isCancelled.changed",{self:this},this._onDeleteJob);this.bindModel(this.exportJob,"deleted",{self:this},this._onDeleteJob);},__beforeRender:function(){return{job:this.exportJob};},_onDeleteJob:function(e){var self=e.data.self;self.$el.remove();},_onCancelClick:function(e){var self=e.data.self,exportJob=self.exportJob,exportJobs=exportJob.exportJobs;e.preventDefault();if(exportJob.isNew()){exportJobs.cancelJob(exportJob);}else{exportJobs.deleteJob(exportJob);}}});SM.ExportDialogButtonView=SM.Views.register({__NAME:"ExportDialogButtonView",__model:"exportJob",__settings:{dialogDisabled:false,exportsLoaded:true},__templateID:"export-dialog-button-view",__beforeRender:function(){var owner=this.exportJob.exportJobs.survey.owner;return{dialogDisabled:this.__settings.dialogDisabled,upgradeRequired:!owner.canExport(this.exportJob.format),confirmDisabled:this.exportJob.format===undefined,exportsLoaded:this.__settings.exportsLoaded};},__defaults:{confirmDisabled:true}});SM.BaseExportDialogPanelView={__model:"exportJob",__templateID:"export-panel-view",__init:function(options){var self=this,formatsEnabled=this.exportJob.exportJobs.survey.config.export_formats_enabled;this.$el.on({"emailEnter":function(e,val){self.exportJob.email=val;},"filenameEnter":function(e,val){self.exportJob.name=val;},"formatClicked":function(e,format){if(formatsEnabled[self.exportJob.type][format]){if(self.exportJob.format===format){self.exportJob.set('format',undefined);}else{self.exportJob.set('format',format);}
self.render();self.$el.find('.error-msg').hide();}},"useOneExcelSheetChanged":function(e,val){self.exportJob.set("questionDisplay",val);}});},_addTextInputs:function(){var errors=this.errors||{},fileview;this.exportJob.name=this.exportJob.generateFileName();fileview=SM.Views.create(SM.ExportDialogTextInputView,{label:Globalize.localize("File Name"),preferenceType:"filename",textValue:this.exportJob.name,error:errors.filename});this.el.appendChild(fileview.el);},__beforeRender:function(options){var md={format:this.exportJob.format,summaryMode:this.exportJob.type===this.exportJob.TYPE.SUMMARY_EXPORT};if(md.format){md[md.format+"Selected"]=true;}else{md.selectType=null;}
return md;},__afterRender:function(md){var i=0,len=this._exportFormats.length,exportType=this.exportJob.type,formatsEnabled=this.exportJob.exportJobs.survey.config.export_formats_enabled[exportType],selectedFormat=this.exportJob.format,exportTypeList=this.$el.find("tr").get(0);for(;i<len;i++){exportTypeList.appendChild(SM.Views.create(SM.ExportDialogFormatView,{isSelected:this._exportFormats[i]===this.exportJob.format,format:this._exportFormats[i],isDisabled:!formatsEnabled[this._exportFormats[i]]}).el);}
if(selectedFormat){this.renderPreferences(this);this._addTextInputs();}
this.$el.find(".q").popout();},validate:function(){var emailRegEx=/\S+@\S+\.\S+/,nameRegEx=/\S+/,name=$.trim(SM.Html.strip(this.exportJob.name)),email=SM.Html.strip(this.exportJob.email),dotIndex;this.errors={};if(!name.length){name=this.exportJob.generateFileName();}
dotIndex=name.lastIndexOf(".");if(dotIndex!==-1){name=name.substr(0,dotIndex);}else{name=name;}
if(name.length>250){this.errors.filename=Globalize.localize("Max filename length is 250 characters")+".";return false;}
if(!nameRegEx.test(name)){this.errors.filename=Globalize.localize("Please enter a valid filename")+".";return false;}
this.exportJob.email=email;this.exportJob.name=this.exportJob.generateFileName(name);return true;}};SM.ExportDialogNoMatchingResponsesView=SM.Views.register({__NAME:"ExportDialogNoMatchingResponsesView",__templateID:"export-panel-view-no-matching-responses",__beforeRender:function(options){var md={surveyHasRespondents:options.survey.hasRespondents()};return md;}});SM.ExportDialogSummaryView=SM.Views.extend(SM.BaseExportDialogPanelView,{__NAME:"ExportDialogSummaryView",__init:function(options){var self=this;SM.BaseExportDialogPanelView.__init.call(this,options);this.$el.on({"pdfOrientationChanged":function(e,val){self.exportJob.set("pdfOrientation",val);},"pdfPaperSizeChanged":function(e,val){self.exportJob.set("pdfPaperSize",val);},"includeOpenendedChanged":function(e,val){self.exportJob.set("includeOpenended",val);}});},_exportFormats:['pdf','excel','csv'],renderPreferences:function(){var inputViews=[],inputView,exportJob=this.exportJob,self=this; inputView=SM.Views.create(SM.ExportDialogDataFilterView,{model:this.exportJob});inputViews.push(inputView);if(exportJob.format===exportJob.FORMAT.PDF){inputView=SM.Views.create(SM.ExportDialogPdfInputView,{model:this.exportJob});inputViews.push(inputView);}
if(exportJob.format===exportJob.FORMAT.EXCEL){inputView=SM.Views.create(SM.ExportDialogXlsSheetChoiceView,{model:this.exportJob});inputViews.push(inputView);}
inputViews.push(SM.Views.create(SM.ExportDialogCheckboxInputView,{type:"includeOpenended",isChecked:this.__settings.hasChartView===false}));$.each(inputViews,function(i,view){self.$el.append(view.$el);});
 if(self.__settings.hasChartView===false){self.exportJob.set("includeOpenended",true);}}});SM.ChartExportDialogView=SM.Views.extend(SM.BaseExportDialogPanelView,{__NAME:"ChartExportDialogView",__init:function(options){var self=this;SM.BaseExportDialogPanelView.__init.call(this,options);this.exportJob.initExport();},__afterRender:function(md){SM.BaseExportDialogPanelView.__afterRender.call(this,md);this.$el.find(".disabled .folded").hide();},renderPreferences:function(){var inputViews=[],inputView,self=this;

 inputView=SM.Views.create(SM.ExportDialogDataFilterView,{model:this.exportJob});inputViews.push(inputView); $.each(inputViews,function(i,view){self.$el.append(view.$el);});},_exportFormats:['png','','','']});SM.ExportDialogAllResponseView=SM.Views.extend(SM.BaseExportDialogPanelView,{__NAME:"ExportDialogAllResponseView",_exportFormats:['excel','excel_plus','spss','pdf'],__defaults:{individualResponseMode:false},__init:function(options){var self=this;SM.BaseExportDialogPanelView.__init.call(this,options);this.$el.on({"xlsColumnChoiceChanged":function(e,val){self.exportJob.set("columnSetting",val);},"xlsCellChoiceChanged":function(e,val){self.exportJob.set("cellType",val);},"pdfPaperSizeChanged":function(e,val){self.exportJob.set("pdfPaperSize",val);},"respondentChanged":function(e,val){self.editFileName();}});if(this.__settings.individualResponseMode){self.$el.trigger("formatClicked",'pdf');}},renderPreferences:function(){var inputViews=[],exportJob=this.exportJob,inputView,responseSelectMode=exportJob.respondentID!=="all",self=this; inputView=SM.Views.create(SM.ExportDialogDataFilterView,{model:this.exportJob});inputViews.push(inputView);if(exportJob.format==='excel'){inputView=SM.Views.create(SM.ExportDialogXlsColumnCellChoiceView,{model:exportJob});inputViews.push(inputView);}
if(exportJob.format==='pdf'){inputView=SM.Views.create(SM.ExportDialogResponseSelectView,{model:this.exportJob,responseSelectMode:responseSelectMode});inputViews.push(inputView);inputView=SM.Views.create(SM.ExportDialogPdfInputView,{model:this.exportJob,onlyPaperSize:true});inputViews.push(inputView);}
$.each(inputViews,function(i,view){self.$el.append(view.$el);});},editFileName:function(){this.$el.find('[filename]').val(this.exportJob.name);}});SM.ExportDialogCheckboxInputView=SM.Views.register({__NAME:"ExportDialogCheckboxInputView",__templateID:"export-dialog-preference-checkbox",__defaults:{type:null, label:null,isChecked:false},__init:function(){var self=this;this.$el.on(SM.Event.CLICK,function(){self.__settings.isChecked=!self.__settings.isChecked;self.$el.trigger(self.__settings.type+"Changed",self.__settings.isChecked);self.render();});},__beforeRender:function(){return{type:this.__settings.type,isChecked:this.__settings.isChecked};}});SM.ExportDialogTextInputView=SM.Views.register({__NAME:"ExportDialogTextInputView",__templateID:"export-dialog-text-input",__init:function(){var self=this;this.$el.on(SM.Event.KEYUP,"input",function(){self.$el.trigger(self.__settings.preferenceType+"Enter",$(this).val());});},__defaults:{textValue:null,label:null,isLastSection:false,preferenceType:null}});SM.ExportDialogDataFilterView=SM.Views.register({__NAME:"ExportDialogDataFilterView",__model:"exportJob",__templateID:"export-data-filter-view",__init:function(){return;},__beforeRender:function(){var exportJob=this.exportJob,md={viewModel:this.exportJob.sourceView,viewSelectMode:true,singleMode:exportJob.get("isSingleMode"),localizedQuestionLabel:Globalize.localize("Question")+" #"+exportJob.questionNumber};return md;}});SM.ExportDialogPdfInputView=SM.Views.register({__NAME:"ExportDialogPdfInputView",__model:"exportJob",__templateID:"export-dialog-pdf-input-template",__defaults:{onlyPaperSize:false},__init:function(){var self=this;this.$el.on("selectMenu.change","a[orientation]",function(e){self.$el.trigger("pdfOrientationChanged",e.value);}).on("selectMenu.change","a[paper-size]",function(e){self.$el.trigger("pdfPaperSizeChanged",e.value);});},__beforeRender:function(){var md={onlyPaperSize:this.__settings.onlyPaperSize};return md;},__afterRender:function(){this.$el.find('a[orientation]').selectMenu({templateID:"pdf-orientation-menu",selectedValue:this.exportJob.get("pdfOrientation")});this.$el.find('a[paper-size]').selectMenu({templateID:"pdf-paper-size-menu",selectedValue:this.exportJob.get("pdfPaperSize")});}});SM.ExportDialogResponseSelectView=SM.Views.register({__NAME:"ExportDialogResponseSelectView",__model:"exportJob",__templateID:"export-dialog-response-select-template",__defaults:{responseSelectMode:false},__init:function(){var self=this;this.$el.on("change","input[type='radio'][name='response']",{self:this},this._onEditResponseSelection);},__beforeRender:function(){var exportJob=this.exportJob,individualResponse=exportJob.exportData.respondent_id!=='all',md={responseSelectMode:this.__settings.responseSelectMode,individualResponse:individualResponse, respondentID:exportJob.respondentID,respondentNumber:exportJob.respondentNumber,singleRespondentID:this.__NAME+this.__uid+"radio-single-respondent",allRespondentsID:this.__NAME+this.__uid+"radio-all-respondents"};return md;},_onEditResponseSelection:function(e){var self=e.data.self;self.exportJob.exportData.respondent_id=e.currentTarget.value;self.exportJob.name=self.exportJob.generateFileName();self.$el.trigger("respondentChanged",e.currentTarget.value);}});SM.ExportDialogXlsSheetChoiceView=SM.Views.register({__NAME:"ExportDialogXlsSheetChoiceView",__templateID:"export-dialog-xls-sheet-choice-view",__model:"exportJob",__init:function(){var self=this;this.$el.on(SM.Event.CLICK,"input",function(){self.$el.trigger('useOneExcelSheetChanged',$(this).val());});},__beforeRender:function(){return{singleMode:this.exportJob.get("isSingleMode")};}});SM.ExportDialogXlsColumnCellChoiceView=SM.Views.register({__NAME:"ExportDialogXlsColumnCellChoiceView",__model:"exportJob",__templateID:"export-dialog-xls-column-cell-choice-view",__init:function(){var self=this;this.$el.on("selectMenu.change","a[column]",function(e){self.$el.trigger("xlsColumnChoiceChanged",e.value);}).on("selectMenu.change","a[cell]",function(e){self.$el.trigger("xlsCellChoiceChanged",e.value);});},__afterRender:function(){this.$el.find('a[column]').selectMenu({templateID:"excel-column-menu",selectedValue:this.exportJob.exportData.column_setting});this.$el.find('a[cell]').selectMenu({templateID:"excel-cell-menu",selectedValue:this.exportJob.exportData.cell_type});}});SM.ExportDialogFormatView=SM.Views.register({__templateID:"export-dialog-format-view",__NAME:"ExportDialogFormatView",__init:function(options){var self=this;this.$el.on(SM.Event.CLICK,function(e){if(!self.__settings.isDisabled){self.$el.trigger("formatClicked",self.__settings.format);}});}, styleMap:{csv:{ext:"csv",icon:"¼",labelColor:"exp-green",description:"Opens in most analytics software"},excel:{ext:"xls",icon:"¼",labelColor:"exp-green",description:"Opens in Microsoft Excel"},excel_plus:{ext:"xls+",icon:"¼",labelColor:"exp-green",description:"Open in advanced statistical and analytical software"},rdb:{ext:"rdb",icon:"¼",labelColor:"exp-purple",description:"Provides a separate file for each database table"},spss:{ext:"spss",icon:"¼",labelColor:"exp-red",description:"Open in your SPSS analytical software"},html:{ext:"html",icon:"Ü",labelColor:"exp-purple",description:"Ideal for posting directly to a website"},png:{ext:"png",icon:"Ü",labelColor:"exp-orange",description:"Best for adding charts as images to presentations"},pdf:{ext:"pdf",icon:"Ü",labelColor:"exp-red",description:"Ideal for sharing and printing"},pptx:{ext:"pptx",icon:"Ü",labelColor:"exp-green",description:"Ideal for presentations"},pdf_chart:{ext:"pdf",icon:"Ü",labelColor:"exp-red",description:"Ideal for sharing and opening on all computers"}},__defaults:{isSelected:false,isDisabled:false,format:null},__beforeRender:function(){var md=SM.Object.copy(this.styleMap[this.__settings.format]);md.description=Globalize.localize(md.description);md.isSelected=this.__settings.isSelected;md.format=this.__settings.format;md.isDisabled=this.__settings.isDisabled;return md;}});SM.AnalyzeWarningDialogView=SM.Views.deepExtend(SM.DialogView,{__NAME:"AnalyzeWarningDialogView",__model:"survey",__defaults:{width:800},__create:function(options){var self=this;self.onContinueClick=options.onContinueClick;},__init:function(options){var self=this;this.$el.on(SM.Event.CLICK,".continue-btn",{self:this},this._onContinueClick);},_onContinueClick:function(e){var self=e.data.self;self.onContinueClick();}});SM.HipaaExportWarningView=SM.Views.deepExtend(SM.AnalyzeWarningDialogView,{__NAME:"HipaaExportWarningView",__templateID:"hipaa-export-warning",__model:"survey",__defaults:{jobType:"export",width:800},__beforeRender:function(){var jobType=this.__settings.jobType,md={};md[jobType+'Mode']=true;return md;}});SM.QuotaEditWarningView=SM.Views.deepExtend(SM.AnalyzeWarningDialogView,{__NAME:"QuotaEditWarningView",__templateID:"quota-edit-warning",__defaults:{width:600,isModal:true}});SM.ShareAllBtnView=SM.Views.register({__NAME:"ShareAllBtnView",__model:"survey",__templateID:"share-all-btn-view-template", __create:function(options){this.survey=options.survey;_.bindAll(this,"_onClick");}, __beforeRender:function(){return{noBorder:this.__settings.noBorder};},__afterRender:function(md){this.$el.find(".q").popout();},__init:function(){this.$el.on("click",{self:this},this._onClick);},
_renderSharedViewFormView:function(dialogView){var $target,sharedView,sharedViewFormView;$target=dialogView.$el.find("[shared-view-form-container]");sharedView=SM.Models.create("SharedView",{survey_id:this.survey.ID,view_id:this.survey.anviews.currentView.ID,name:"My Shared View",title:"The Survey Title"});sharedView.survey=this.survey;sharedViewFormView=SM.Views.create(SM.SharedViewFormView,{dialogView:dialogView,sharedView:sharedView});$target.html(sharedViewFormView.el);}, _onClick:function(e){var dialog,self=e.data.self,survey=self.survey;e.preventDefault();if(survey.owner.get("hipaaEnabled")){dialog=SM.Views.create(SM.HipaaExportWarningView,{model:survey,jobType:"share",onContinueClick:function(){SM.AnalyzeApp.SharedViewsRouter.newSharedView();}});dialog.open();}else{SM.AnalyzeApp.SharedViewsRouter.newSharedView();}}});SM.SharedViewsKeyHeadingView=SM.Views.extend(SM.BaseAccordionHeadingView,{ __model:"anviews", __create:function(options){this.sharedViews=options.sharedViews; this.set("isOpen",true);}, __beforeRender:function(e){var self=this,numViews=self.sharedViews.list.length;return{isLoading:this.__settings.isLoading,title:Globalize.localize("Shared Data"),number:numViews?numViews.toString():null};},__init:function(){this.bindModel(this.sharedViews,"isLoaded.changed",{self:this},this._onSharedViewsChanged);this.bindModel(this.sharedViews,"add",{self:this},this._onSharedViewsChanged);this.bindModel(this.sharedViews,"remove",{self:this},this._onSharedViewsChanged);}, _onSharedViewsChanged:function(e){e.data.self.render();}});SM.SharedViewListView=SM.Views.register({ __NAME:"SharedViewListView",__model:"sharedViewList",__templateID:"shared-view-list-template", __create:function(options){this.survey=options.survey;this.sharedViews=options.sharedViews;_.bindAll(this,"_onSharedViewsLoaded","_onSharedViewAdded","_onSharedViewRemoved");}, __beforeRender:function(){return{isLoaded:this.sharedViews.get("isLoaded"),hasScrollbar:this.sharedViews.list.length>5};},__afterRender:function(md){var self=this;if(this.sharedViews.get("isLoaded")){if(this.sharedViews.list.length>0){this._renderSharedViewListItemViews();}else{this._renderNullStateView();}}},__init:function(){this.bindModel(this.sharedViews,"isLoaded.changed",{self:this},this._onSharedViewsLoaded);this.bindModel(this.sharedViews,"add",{self:this},this._onSharedViewAdded);this.bindModel(this.sharedViews,"remove",{self:this},this._onSharedViewRemoved);},_renderNullStateView:function(){var view=SM.Views.create(SM.ShareViewsNullStateView,{model:this.survey});this.$el.append(view.el);},_renderSharedViewListItemViews:function(){var self=this,sortedSharedViews;sortedSharedViews=_.sortBy(self.sharedViews.list,function(sharedView){return(1-sharedView.id);});_.each(sortedSharedViews,function(sharedView){var view=SM.Views.create(SM.SharedViewListItemView,{sharedView:sharedView});self.$el.find("[shared-view-list]").append(view.el);});}, _onSharedViewsLoaded:function(e){this.render();},_onSharedViewAdded:function(e){var self=this;self.render();},_onSharedViewRemoved:function(e){var self=this;self.render();}});SM.ShareViewsNullStateView=SM.Views.register({ __NAME:"SharedViewsNullStateView",__model:"survey",__templateID:"shared-views-null-state-template", __afterRender:function(){this._renderShareAllBtn();},_renderShareAllBtn:function(){var $shareAllBtn=this.$el.find("[share-all-btn]");$shareAllBtn.replaceWith(SM.Views.create(SM.ShareAllBtnView,{survey:this.survey,noBorder:false}).el);}});SM.SharedViewListItemView=SM.Views.register({ __NAME:"SharedViewListItemView",__model:"sharedView",__templateID:"shared-view-list-item-template",__settings:{deleteMode:false,renameMode:false}, __create:function(options){this.sharedView=options.sharedView;this.title=Globalize.localize("Click to view shared data");_.bindAll(this,"render","_onSelect","_onActionMenuInit","_onMenuAction","_onDeleteClick","_onCancelDeleteClick","_onRenameClick","_onCancelRenameClick","_setClipboardText");}, __beforeRender:function(){var isRenaming=this.get("renameMode"),isDeleting=this.get("deleteMode");return{sharedView:this.sharedView,deleteMode:isDeleting,renameMode:isRenaming};},__afterRender:function(){var self=this,name=this.sharedView.get("name"),isDeleting=this.get("deleteMode"),isRenaming=this.get("renameMode"),$listItem=this.$el.find("[list-item]"),$actionMenuBtn=this.$el.find('[btn-action-menu]'),deleteView,renameView;if(isDeleting){deleteView=SM.Views.create(SM.FunctionListItemDeleteView,{visible:true});$listItem.prepend(deleteView.$el);}else if(isRenaming){renameView=SM.Views.create(SM.FunctionListItemRenameView,{placeholder:name});renameView.open();$listItem.prepend(renameView.$el);}
if(isRenaming||isDeleting){self.$el.removeAttr("title");}else{$listItem.on(SM.Event.CLICK,{self:self},self._onSelect);self.$el.attr("title",self.title);}
$actionMenuBtn.actionMenu({menuView:"SharedViewListItemMenuView",sharedView:this.sharedView}).on("actionMenu.menuInit",this._onActionMenuInit);},__init:function(){var self=this;this.bindModel(this.sharedView,"enabled.changed",{self:this},this.render);this.bindModel(this.sharedView,"saved",{self:this},this.render);this.$el.on({'actionMenu.actionSelected':this._onMenuAction,'FunctionListItem.DeleteView.deleteClicked':this._onDeleteClick,'FunctionListItem.DeleteView.cancelClicked':this._onCancelDeleteClick,'FunctionListItem.RenameView.Renamed':this._onRenameClick,'FunctionListItem.RenameView.Canceled':this._onCancelRenameClick},{self:this});},_onActionMenuInit:function(e){var self=this,actionMenu=e.actionMenu,menuView=actionMenu.get("menuView"),$copyLinkMenuItem=menuView.$el.find("[data-action='copy-link']");menuView.$el.find(".q").popout();}, _onSelect:function(e){e.preventDefault();SM.AnalyzeApp.SharedViewsRouter.show(this.sharedView);},_onMenuAction:function(e){e.preventDefault();var self=this;if(e.action==="show-view"){self._onShowViewMenuItemClick();}else if(e.action==="edit-view"){self._onEditViewMenuItemClick();}else if(e.action==="delete-view"){self._onDeleteViewMenuItemClick();}else if(e.action==="rename-view"){self._onRenameViewMenuItemClick();}else if(e.action==="copy-link"){self._onCopyLinkMenuItemClick();}else if(e.action==="toggle-view"){self._onToggleMenuItemClick();}},_onShowViewMenuItemClick:function(){SM.AnalyzeApp.SharedViewsRouter.show(this.sharedView);},_onCopyLinkMenuItemClick:function(){SM.Notifications.success({title:Globalize.localize("You copied your sharing web link."),message:Globalize.localize("You can now paste the url into an email or social web site.")});},_onEditViewMenuItemClick:function(){SM.AnalyzeApp.SharedViewsRouter.edit(this.sharedView);},_onToggleMenuItemClick:function(){this.sharedView.toggleEnabled();},_onDeleteViewMenuItemClick:function(){this.set("deleteMode",true);this.render();},_onDeleteClick:function(e){e.preventDefault();SM.AnalyzeApp.SharedViewsRouter.destroy(this.sharedView);},_onCancelDeleteClick:function(e){var self=this;e.preventDefault();self.set("deleteMode",false);self.render();},_onRenameViewMenuItemClick:function(){this.set("renameMode",true);this.render();},_onRenameClick:function(e){var self=this;e.preventDefault();self.sharedView.set("name",e.newName);self.sharedView.save();self.set("renameMode",false);self.render();},_onCancelRenameClick:function(e){var self=this;e.preventDefault();self.set("renameMode",false);self.render();},_setClipboardText:function($el){return this.sharedView.sharedPageURL();}});SM.SharedViewListItemMenuView=SM.Views.deepExtend(SM.ActionMenuView,{__NAME:"SharedViewListItemMenuView",__templateID:"shared-view-list-item-menu-template",__create:function(){this.sharedView=this.__settings.sharedView;},__beforeRender:function(){return{toggleEnabledText:this.sharedView.isEnabled()?Globalize.localize("Turn sharing off"):Globalize.localize("Turn sharing on")};}});SM.SharedViewFormView=SM.Views.register({ __NAME:"NewSharedViewView",__templateID:"shared-view-form-template", __create:function(options){this.dialogView=options.dialogView;this.sharedView=options.sharedView;this.errors=[];this.validations={"#shared_view_title":{type:"presence",message:Globalize.localize("You must enter a title"),ifChecked:"#customize_shared_view_title"},"#shared_view_name":{type:"presence",message:Globalize.localize("You must enter a nickname"),ifChecked:"#customize_shared_view_name"},"#shared_view_description":[{type:"length",max:4000,message:Globalize.localize("Please enter a description less than 4000 characters"),ifChecked:"#customize_shared_view_description"},{type:"presence",message:Globalize.localize("You must enter a description"),ifChecked:"#customize_shared_view_description"}],"#shared_view_password":{type:"length",min:4,max:35,message:Globalize.localize("Please enter a password between 4 and 35 characters"),ifChecked:"#add_shared_view_password"}};_.bindAll(this,"_onUpgradeTriggerFieldToggle","_onCustomizableFieldToggle","_onModeChange","_onBrandingChange","_onIncludeOpenEndedChange","_onIsPublicChange","_onSharedViewLinkClick","_onCustomizeHostBtnClick","_onHostMenuActionSelected","_setClipboardText","_onBackClick","_onSaveClick","_onCancelClick","_onCopyClick","_onPreviewClick","_showSharingUpgradeDialog");}, __beforeRender:function(){var sharedView=this.sharedView,md;md={sharedView:sharedView,openEndedHidden:sharedView.openEndedHidden(),hasCustomTitle:sharedView.hasCustomTitle(),hasCustomName:sharedView.hasCustomTitle(),hasDescription:sharedView.hasDescription(),hasPassword:sharedView.hasPassword(),canHavePassword:sharedView.canHavePassword(),browseTabEnabled:sharedView.isBrowseTabEnabled(),trendsTabEnabled:sharedView.isTrendsTabEnabled(),canHaveTrends:sharedView.canHaveTrends(),sharedPageURL:sharedView.sharedPageURL(),userHasTrends:sharedView.survey.owner.hasTrends(),canCustomizeBranding:sharedView.canCustomizeBranding(),hasHiddenBranding:sharedView.hasHiddenBranding(),sharedViewIsPublic:sharedView.isPublic()};return md;},__init:function(){var self=this;self.$spinner=self.$el.find(".sm-spin"); self.form=self.$el.find("form").form({formView:self}).data("form"); self.$el.on("click",".upgrade-trigger input[type='checkbox']",{self:this},this._onUpgradeTriggerFieldToggle);self.$el.on("click",".customizable-field input[type='checkbox']",{self:this},this._onCustomizableFieldToggle);self.$el.on("click","[data-mode]",{self:this},this._onModeChange);self.$el.on("click","[data-branding]",{self:this},this._onBrandingChange);self.$el.on("click","#customize_shared_view_hide_open_ended",{self:this},this._onIncludeOpenEndedChange);self.$el.on("click","#customize_shared_view_is_public",{self:this},this._onIsPublicChange);self.$el.on("click","[shared-view-link]",{self:this},this._onSharedViewLinkClick);


 self.$el.on("click","[save-btn]",{self:this},this._onSaveClick);self.$el.on("click","[copy-btn]",{self:this},this._onCopyClick);self.$el.on("click","[back-btn]",{self:this},this._onBackClick);self.$el.on("click","[preview-btn]",{self:this},this._onPreviewClick);self.$el.on("click","[cancel-btn]",{self:this},this._onCancelClick);

 self.$el.find(".q").popout();}, _onUpgradeTriggerFieldToggle:function(e){var $target=$(e.currentTarget);
 $target.prop("checked",false);e.stopImmediatePropagation();this._showSharingUpgradeDialog($target.id);},_showSharingUpgradeDialog:function(id){var that=this,$formDialog,upgradeDialog,templateID;if(id==="customize_shared_view_branding"){templateID="white-label-sharing-upgrade-dialog-template";}else{templateID="power-sharing-upgrade-dialog-template";}
$formDialog=that.$el.parents(".dialog:eq(0)");upgradeDialog=SM.Views.create(SM.DialogView,{width:800,isModal:true,templateID:templateID});$formDialog.fadeOut(250,function(){upgradeDialog.open();});upgradeDialog.$el.on("dialog.afterClose",function(){$formDialog.fadeIn(250);});},_onCustomizableFieldToggle:function(e){var $checkbox=$(e.target),$li,$fieldContainer,$field;$li=$checkbox.parents("li").eq(0);$fieldContainer=$li.children(".form-group");$field=$fieldContainer.children(".form-control").eq(0);if($checkbox.prop("checked")){$fieldContainer.removeClass("hide");$field.focus();}else{$fieldContainer.addClass("hide");$field.val('');}},_onModeChange:function(e){var $target=$(e.target),mode=$target.attr("data-mode"),isChecked=$target.prop("checked");this.sharedView.toggleMode(mode,isChecked);},_onBrandingChange:function(e){var $target=$(e.target),branding=$target.attr("data-branding"),isChecked=$target.prop("checked");this.sharedView.setBranding(branding,isChecked);},_onIncludeOpenEndedChange:function(e){var $target=$(e.target),isChecked=$target.prop("checked");this.sharedView.set("hide_open_ended",!isChecked);},_onIsPublicChange:function(e){var $target=$(e.target),isChecked=$target.prop("checked");this.sharedView.set("is_public",isChecked);},_onSharedViewLinkClick:function(e){$(e.target).select();},_onCustomizeHostBtnClick:function(e){},_onHostMenuActionSelected:function(e){var self=this,host=e.action;e.preventDefault();if(!this.sharedView.survey.owner.isBasic()){this._updateHost(host);}}, _onSaveClick:function(e){e.preventDefault();var self=this;if(self.form.isValid()){self._save(function(){ self.$el.find("#edit_shared_view_attrs").hide();self.$el.find("#copy_shared_view_link").show();self.$el.find("[back-btn], [preview-btn], [copy-btn]").show();self.$el.find("[cancel-btn], [save-btn]").hide();self.$el.find("[shared-view-link]").val(self.sharedView.sharedPageURL());},function(){
});}},_onBackClick:function(e){e.preventDefault();var self=this;self.$el.find("#copy_shared_view_link").hide();self.$el.find("#edit_shared_view_attrs").show();self.$el.find("[back-btn]").hide();self.$el.find("[preview-btn], [copy-btn]").hide();self.$el.find("[save-btn], [cancel-btn]").show();},_onCopyClick:function(e){e.preventDefault();SM.Notifications.success({title:Globalize.localize("You copied your sharing web link."),message:Globalize.localize("You can now paste the url into an email or social web site.")});},_onPreviewClick:function(e){e.preventDefault();SM.AnalyzeApp.SharedViewsRouter.show(this.sharedView);},_onCancelClick:function(e){e.preventDefault();this.dialogView.close();}, _save:function(onDone,onFail){var self=this,request;self.$spinner.show();self.sharedView.load(self.form.attrs());request=this.sharedView.save();$.when(request,{self:this}).done(function(){self.$spinner.hide();if(onDone){onDone();}}).fail(function(){self.$spinner.hide();if(onFail){onFail();}});},_updateHost:function(host){var self=this;self.sharedView.set("host",host);self._save(function(){self.$el.find("[shared-view-link]").val(self.sharedView.sharedPageURL());});},_setClipboardText:function($el){return this.sharedView.sharedPageURL();}});SM.CustomizeSharedViewHostMenuView=SM.Views.deepExtend(SM.ActionMenuView,{ __NAME:"CustomizeSharedViewHostMenuView",__templateID:"customize-shared-view-host-menu-template",PRO_DOMAINS:{"localhost":"localscience.com","surveymonkey":"research.net","monkeytest1":"monkeyscience.net","monkeytest2":"monkeyscience.net","monkeytest3":"monkeyscience.net","monkeytest4":"monkeyscience.net","monkeytest5":"monkeyscience.net","monkeytest6":"monkeyscience.net"}, __create:function(){this.survey=this.__settings.survey;}, __beforeRender:function(){var uri=new Uri(document.location.href),rootDomain=uri.getRootDomain(),subDomain=uri.getSubDomains()[0], defaultHost=uri.host(),proHost=subDomain+"."+this.PRO_DOMAINS[rootDomain];return{defaultHost:defaultHost,proHost:proHost,userIsPro:!this.survey.owner.isBasic()};},__init:function(){SM.ActionMenuView.__init.call(this);this.$el.find(".q").popout();}});SM.AnalyzeTourTab={tourInfo:[{featureSelector:"#ShowBuilderTab",dialogOptions:{templateID:"analyze-tour-1"}},{featureSelector:"#view-list-area .list-item:first",dialogOptions:{templateID:"analyze-tour-2"}},{featureSelector:".mode-tabs > li:last",dialogOptions:{templateID:"analyze-tour-3"}},{featureSelector:".sm-question-view .sm-display-options:first",dialogOptions:{templateID:"analyze-tour-4"}},{featureSelector:".stats-header a[export-btn]",dialogOptions:{templateID:"analyze-tour-5"}},{featureSelector:"#feedbackTab",dialogOptions:{templateID:"analyze-tour-6"}}],isLoading:false,_accordion:null,init:function(){$("#tourTab").on("click",{self:this},this._onTabClick);this._accordion=$('.analyze-secondary-column').data("accordion");},_onTabClick:function(e){var self=e.data.self;e.preventDefault();if(!self._accordion.isOpen('ViewListContainer')){self._accordion.open('ViewListContainer');}
if(SM.DialogTour){SM.DialogTour.start(self.tourInfo);}else if(!self.isLoading){self.isLoading=true;$.getScript(SM.TOUR_DIALOGS_URL,function(script,textStatus,jqXHR){self.isLoading=false;SM.DialogTour.start(self.tourInfo);});}}};SM.PubSub.subscribe("HTTP_CONFLICT",function(){
 SM.Notifications.success({expires:false,title:Globalize.localize("New version available!"),message:Globalize.localize("Fresher bananas are available, let us reload this page for you...")});setTimeout(function(){location.reload();},5000);});SM.BaseApp={ERROR_CODES:{MODELS:"1",VIEWS:"2",ROUTERS:"3"},initializers:{beforeInit:[],afterInit:[]},__beforeInit:function(options){var self=this; SM.Browser.support.needsBrowserUpgrade(); SM.Error.init();SM.Tooltips.init();SM.Ajax.init(options.survey_id,options.version); self._renderLoaderView();self._runInitializers("before",options);},__afterInit:function(options){var self=this;self._runInitializers("after",options);},init:function(options){var self=this;
 SM.App=self;self.el=options.el;self.version=options.version;self.dataURL=self._setDataURL(options.data_url);self.JClipboardMovieUrl=options.jclipboard_movie_url;self.dfd=$.Deferred();self.__beforeInit(options); _.bindAll(this,'_onSuccess','_onFail','_onAlways','_loadData'); SM.Ajax.get(self.dataURL).done(self._onSuccess,function(){self.__afterInit(options);}).fail(self._onFail).always(self._onAlways);return self.dfd;},_buildSurveyModel:function(data,options){var survey;survey=SM.Models.create("Survey",{survey_data:data.survey_data,includeOpenEnded:data.include_openended||options.includeOpenEnded});survey.loadAnalyzeState({mode:data.analyze_mode,pageIndex:data.page_index});survey.loadConfig(data.config);survey.loadOwner(data.owner);survey.loadCurrentUser(data.current_user);survey.loadViews({viewMap:data.views,currentViewID:data.current_view_id,defaultViewID:data.default_view_id,selectedViewID:data.selected_view_id});if(options.loadSharedViews){survey.loadSharedViews(data.shared_views);}
if(options.loadExportJobs){survey.loadExportJobs(data.exportjob_list);}
if(data.respondent_data.status===0){survey.set("respondentCounts",data.respondent_data.data.respondent_counts);}else{survey.set("respondentCounts",{failed:true});}
if(survey.state.isBrowseMode()){survey.loadRespondents(data.respondent_data);}else if(survey.state.isSummaryMode()){survey.loadQuestionRollups(data.respondent_data);if(!this.isSharingApp()){
 survey.loadBenchmarkRollups({});}}else if(survey.state.isTrendMode()){survey.loadSurveyTrends(data.respondent_data);}
return survey;},_renderLoaderView:function(){var self=this;self._loaderView=SM.Views.create(SM.AnalyzeLoaderView,{isFixed:true});self.el.appendChild(self._loaderView.el);self._loaderView.show();},_setDataURL:function(dataURL){var url=new Uri(dataURL);url.setProtocol("https");url.addQueryParam("utc_offset",SM.Date.utcOffset().toString());url=url.toString();SM.log("data.js URL: "+url);return url;},_handleLoadingError:function(options){var html=SM.Template.renderHTML("content-load-error-template",{requestID:options.requestID,errorCode:options.errorCode,encryptedSurveyID:options.encryptedSurveyID,classes:"analyze-failed-load mod-no-header"});$(this.el).html(html);},_onSuccess:function(data,status,jqXHR){this.data=data;this._loadData(data);this.dfd.resolve();},_onFail:function(data,status,jqXHR){this._handleLoadingError({requestID:data.request_id,encryptedSurveyID:data.survey_id_encryption});this.dfd.reject();},_onAlways:function(){this._loaderView.hide();},_runInitializers:function(stage,options){if(_.isEmpty(this.initializers)){return;}
var initializers=this.initializers[stage+"Init"]; if(initializers.length){_.each(initializers,function(initializer){initializer.call(this,SM.App,options);});}}, isSharingApp:function(){return!!(this.__NAME&&this.__NAME==="SharedAnalyzeApp");},isSharingEnabled:function(){return this.survey.isSharingEnabled()&&this.survey.owner.hasSharing();},isDebug:function(){return!!SM.DEBUG;}};SM.AnalyzeApp=SM.Object.deepExtend(SM.BaseApp,{_loadData:function(data){var self=this;try{self._initConstants(data);self.survey=self.survey=self._buildSurveyModel(data,{includeOpenEnded:true,loadSharedViews:true,loadExportJobs:true});}catch(e){self.dfd.reject();self._handleLoadingError({errorCode:self.ERROR_CODES.MODELS,encryptedSurveyID:data.survey_id_encryption});SM.Error.log(e,"AnalyzeApp failed to initialize models");return;}
try{self._initRouters();}catch(e){self.dfd.reject();self._handleLoadingError({errorCode:self.ERROR_CODES.ROUTERS,encryptedSurveyID:data.survey_id_encryption});SM.Error.log(e,"AnalyzeApp failed to initialize routers");return;}
try{self._render(self.survey);}catch(e){self.dfd.reject();self._handleLoadingError({errorCode:self.ERROR_CODES.VIEWS,encryptedSurveyID:data.survey_id_encryption});SM.Error.log(e,"AnalyzeApp failed to render");return;}
try{$('.sidetab').sideTab();SM.AnalyzeTourTab.init();if(data.show_tour){$("#tourTab").click();}}catch(e){self.dfd.reject();SM.Error.log(e,"AnalyzeApp sidetabs/tours failed");}},_initConstants:function(data){SM.DISPLAY_BROWSE_TAB=data.display_browse_tab;SM.DISPLAY_TREND_TAB=data.display_trend_tab;SM.TOUR_DIALOGS_URL=data.tour_dialog_js_url;},_initRouters:function(){this.SharedViewsRouter=new SM.SharedViewsRouter({survey:this.survey});},_render:function(survey){this._renderMainView(survey);this._renderSecondaryView(survey);},_renderMainView:function(survey){var view=SM.Views.create(SM.AnalyzeMainView,{model:survey});this.el.appendChild(view.el);},_renderSecondaryView:function(survey){var view=SM.Views.create(SM.AnalyzeSecondaryView,{model:survey});this.el.appendChild(view.el);}});SM.AnalyzeApp.initializers.beforeInit.push(function(app,options){
});